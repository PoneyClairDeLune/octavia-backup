var ce=Object.create;var N=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var fe=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var ge=(t,s)=>()=>(s||t((s={exports:{}}).exports,s),s.exports);var pe=(t,s,a,i)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of de(s))!ue.call(t,r)&&r!==a&&N(t,r,{get:()=>s[r],enumerable:!(i=he(s,r))||i.enumerable});return t};var be=(t,s,a)=>(a=t!=null?ce(fe(t)):{},pe(s||!t||!t.__esModule?N(a,"default",{value:t,enumerable:!0}):a,t));var se=ge((He,U)=>{(function(){"use strict";let t={debug:!1,parse:function(s,a){if(s instanceof Uint8Array)return t.Uint8(s);if(typeof s=="string")return t.Base64(s);if(s instanceof HTMLElement&&s.type==="file")return t.addListener(s,a);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(s,a){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(s===void 0||!(s instanceof HTMLElement)||s.tagName!=="INPUT"||s.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;a=a||function(){},s.addEventListener("change",function(i){if(!i.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let r=new FileReader;r.readAsArrayBuffer(i.target.files[0]),r.onload=function(n){a(t.Uint8(new Uint8Array(n.target.result)))}})},Base64:function(s){let a=function(n){var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(n=n.replace(/^.*?base64,/,""),n=String(n).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(n))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");n+="==".slice(2-(3&n.length));let o,f="",c,h,u=0;for(;u<n.length;)o=l.indexOf(n.charAt(u++))<<18|l.indexOf(n.charAt(u++))<<12|(c=l.indexOf(n.charAt(u++)))<<6|(h=l.indexOf(n.charAt(u++))),f+=c===64?String.fromCharCode(o>>16&255):h===64?String.fromCharCode(o>>16&255,o>>8&255):String.fromCharCode(o>>16&255,o>>8&255,255&o);return f}(s=String(s));var i=a.length;let r=new Uint8Array(new ArrayBuffer(i));for(let n=0;n<i;n++)r[n]=a.charCodeAt(n);return t.Uint8(r)},Uint8:function(r){let a={data:null,pointer:0,movePointer:function(c){return this.pointer+=c,this.pointer},readInt:function(c){if((c=Math.min(c,this.data.byteLength-this.pointer))<1)return-1;let h=0;if(1<c)for(let u=1;u<=c-1;u++)h+=this.data.getUint8(this.pointer)*Math.pow(256,c-u),this.pointer++;return h+=this.data.getUint8(this.pointer),this.pointer++,h},readStr:function(c){let h="";for(let u=1;u<=c;u++)h+=String.fromCharCode(this.readInt(1));return h},backOne:function(){this.pointer--},readIntVLV:function(){let c=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)c=this.readInt(1);else{let u=[];for(;128<=this.data.getUint8(this.pointer);)u.push(this.readInt(1)-128);var h=this.readInt(1);for(let g=1;g<=u.length;g++)c+=u[u.length-g]*Math.pow(128,g);c+=h}return c}};if(a.data=new DataView(r.buffer,r.byteOffset,r.byteLength),a.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;a.readInt(4);let i={};i.formatType=a.readInt(2),i.tracks=a.readInt(2),i.track=[];var r=a.readInt(1),n=a.readInt(1);128<=r?(i.timeDivision=[],i.timeDivision[0]=r-128,i.timeDivision[1]=n):i.timeDivision=256*r+n;for(let c=1;c<=i.tracks;c++){i.track[c-1]={event:[]};var l,o=a.readInt(4);if(o===-1)break;if(o!==1297379947)return!1;a.readInt(4);let h=0,u=!1,g,b;for(;!u&&(h++,i.track[c-1].event[h-1]={},i.track[c-1].event[h-1].deltaTime=a.readIntVLV(),(g=a.readInt(1))!==-1);)if(128<=g?b=g:(g=b,a.movePointer(-1)),g===255){i.track[c-1].event[h-1].type=255,i.track[c-1].event[h-1].metaType=a.readInt(1);var f=a.readIntVLV();switch(i.track[c-1].event[h-1].metaType){case 47:case-1:u=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:i.track[c-1].event[h-1].data=a.readStr(f);break;case 33:case 89:case 81:i.track[c-1].event[h-1].data=a.readInt(f);break;case 84:i.track[c-1].event[h-1].data=[],i.track[c-1].event[h-1].data[0]=a.readInt(1),i.track[c-1].event[h-1].data[1]=a.readInt(1),i.track[c-1].event[h-1].data[2]=a.readInt(1),i.track[c-1].event[h-1].data[3]=a.readInt(1),i.track[c-1].event[h-1].data[4]=a.readInt(1);break;case 88:i.track[c-1].event[h-1].data=[],i.track[c-1].event[h-1].data[0]=a.readInt(1),i.track[c-1].event[h-1].data[1]=a.readInt(1),i.track[c-1].event[h-1].data[2]=a.readInt(1),i.track[c-1].event[h-1].data[3]=a.readInt(1);break;default:this.customInterpreter!==null&&(i.track[c-1].event[h-1].data=this.customInterpreter(i.track[c-1].event[h-1].metaType,a,f)),this.customInterpreter!==null&&i.track[c-1].event[h-1].data!==!1||(a.readInt(f),i.track[c-1].event[h-1].data=a.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((g=g.toString(16).split(""))[1]||g.unshift("0"),i.track[c-1].event[h-1].type=parseInt(g[0],16),i.track[c-1].event[h-1].channel=parseInt(g[1],16),i.track[c-1].event[h-1].type){case 15:this.customInterpreter!==null&&(i.track[c-1].event[h-1].data=this.customInterpreter(i.track[c-1].event[h-1].type,a,!1)),this.customInterpreter!==null&&i.track[c-1].event[h-1].data!==!1||(l=a.readIntVLV(),i.track[c-1].event[h-1].data=a.readInt(l),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:i.track[c-1].event[h-1].data=[],i.track[c-1].event[h-1].data[0]=a.readInt(1),i.track[c-1].event[h-1].data[1]=a.readInt(1);break;case 12:case 13:i.track[c-1].event[h-1].data=a.readInt(1);break;case-1:u=!0;break;default:if(this.customInterpreter!==null&&(i.track[c-1].event[h-1].data=this.customInterpreter(i.track[c-1].event[h-1].metaType,a,!1)),this.customInterpreter===null||i.track[c-1].event[h-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return i},customInterpreter:null};if(typeof U<"u")U.exports=t;else{let s=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;s.MidiParser=t}})()});var S=class{#t={};addEventListener(t,s){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(s)}removeEventListener(t,s){if(this.#t[t]){let a=this.#t[t].indexOf(s);a>-1&&this.#t[t].splice(a,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,s){let a=new Event(t),i=this;a.data=s,this.#t[t]?.length>0&&this.#t[t].forEach(function(r){r?.call(i,a)}),this[`on${t}`]&&this[`on${t}`](a)}};var H=function(t,s){let a=Math.min(t.length,s.length),i=t.slice(0,a),r=s.slice(0,a),n=0,l=0;for(;l<a&&n==0;)n=Math.sign(i[l]-r[l]),l++;return n},k=function(){this.pool=[],this.point=function(t,s=!1){if(this.pool.length>0){let a=this.pool.length,i=1<<Math.floor(Math.log2(a)),r=i,n=64;for(;i>=1&&n>=0;){if(n<=0)throw new Error("TTL reached.");if(r==a)r-=i;else{let o=H(t,this.pool[r]);switch(o){case 0:{n=0;break}case 1:{r+i<=a&&(r+=i);break}case-1:{r!=0&&(r-=i);break}default:console.warn(`Unexpected result ${o}.`)}}i=i>>1,n--}let l=!0;if(r>=this.pool.length)l=!1;else{let o=this;this.pool[r].forEach(function(f,c,h){l&&f!=t[c]&&(l=!1)}),!l&&H(t,this.pool[r])>0&&r++}return l||s?r:-1}else return s?0:-1},this.add=function(t,s){return t.data=s,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let s=this.point(t);if(s>-1)return this.pool[s].data;this.default(t)},this.run=function(t,...s){let a=this.point(t);a>-1?this.pool[a].data(t.slice(this.pool[a].length),...s):this.default(t,...s)}};var R=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),T=["melodic","drum","drum set 1","drum set 2","drum set 3","drum set 4"],$e=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],M=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],X=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],V=function(t){let s=.1,a=-.3;return t>66?(s=5,a=315):t>56?(s=1,a=47):t>46&&(s=.5,a=18.5),s*t-a},z=function(t){return t>105?$e[t-106]:t>100?t*1.1-100:t/10},K=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),C={};`kaa,\u304B
kii,\u304D
kuu,\u304F
kee,\u3051
koo,\u3053
ky,\u304D!
kw,\u304Fl
saa,\u3055
sii,\u3059\u3043
suu,\u3059
see,\u305B
soo,\u305D
shi,\u3057
sh,\u3057!
taa,\u305F
tii,\u3066\u3043
tuu,\u3068\u3045
tee,\u3066
too,\u3068
tchy,\u3061!
tchi,\u3061
tsu,\u3064
ts,\u3064l
naa,\u306A
nii,\u306B
nuu,\u306C
nee,\u306D
noo,\u306E
ny,\u306B!
nn,\u3093
haa,\u306F
hii,\u3072
huu,\u307B\u3045
hee,\u3078
hoo,\u307B
hi,^
hy,\u3072!
faa,\u3075\u3041
fii,\u3075\u3043
fuu,\u3075
fee,\u3075\u3047
foo,\u3075\u3049
maa,\u307E
mii,\u307F
muu,\u3080
mee,\u3081
moo,\u3082
my,\u307F!
mm,
raa,\u3089
rii,\u308A
ruu,\u308B
ree,\u308C
roo,\u308D
ry,\u308A!
waa,\u308F
wii,\u3046\u3043
wee,\u3046\u3047
woo,\u3092
ngaa,\u30AC
ngii,\u30AE
nguu,\u30B0
ngee,\u30B2
ngoo,\u30B4
ngy,\u30AE!
ng,
gaa,\u304C
gii,\u304E
guu,\u3050
gee,\u3052
goo,\u3054
gy,\u304E!
gw,\u3050l
zaa,\u3056
zii,\u305A\u3043
zuu,\u305A
zee,\u305C
zoo,\u305E
jaa,\u3058\u3083
jii,\u3058
juu,\u3058\u3085
jee,\u3058\u3047
joo,\u3058\u3087
jy,\u3058!
daa,\u3060
dii,\u3067\u3043
duu,\u3069\u3045
dee,\u3067
doo,\u3069
dy,\u3067!
baa,\u3070
bii,\u3073
buu,\u3076
bee,\u3079
boo,\u307C
by,\u3073!
vaa,\u3094\u3041
vii,\u3094\u3043
vuu,\u3094
vee,\u3094\u3047
voo,\u3094\u3049
paa,\u3071
pii,\u3074
puu,\u3077
pee,\u30DA
poo,\u307D
py,\u3074!
!yaa,\u3083
!yuu,\u3085
!yee,\u3047
!yoo,\u3087
yaa,\u3084
yuu,\u3086
yee,\u3044\u3047
yoo,\u3088
!aa,\u3083
!uu,\u3085
!ee,\u3047
!oo,\u3087
!a,\u3083
!u,\u3085
!e,\u3047
!o,\u3087
la,\u3041
li,\u3043
lu,\u3045
le,\u3047
lo,\u3049
a,\u3042
i,\u3044
u,\u3046
e,\u3048
o,\u304A
^*,
*,\u3063
~,
^,
_,`.split(`
`).forEach(t=>{let s=t.split(",");C[s[0]]=s[1]});var q=function(t){let s=t;t[0]=="*"&&(s=s.slice(1));for(let a in C)s=s.replaceAll(a,C[a]);return s};var Q=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],j=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],Z=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var me={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},we={66307:["drive"],66309:["vowel",t=>"aiueo"[t]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",t=>["off","LPF","HPF"][t]],94984:["noise type",t=>["white","pink"][t]],94987:["disc type",t=>["LP","SP","EP","RND"]],94990:["hum type",t=>`${t+5}0Hz`],94993:["M/S",t=>["mono","stereo"][t]]},P=function(t){return me[(t[0]<<8)+t[1]]||`0x${t[0].toString(16).padStart(2,"0")}${t[1].toString(16).padStart(2,"0")}`},W=function(t,s,a){let i=(t[0]<<16)+(t[1]<<8)+s,r=we[i]||{},n=r[0];if(n?.length)return n+=`: ${(r[1]||function(){})(a)||a}`,n};var w=function(t=64){return Math.round(2e3*Math.log10(t/64))/100},_=function(t){let s=0;return t.forEach(a=>{s+=a,s>127&&(s%=128)}),128-s},v=function(t,s){let a=0;for(let i=0;i<t.length;i++)i%8!=0&&(s(t[i],a,t),a++)},A=function(t){return Math.floor(t*14.2)};var L=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw","krs","k11","sg"],J=[[0,0,0,0,121,0,0,56,82,81,63,0,0],[0,0,1,0,0,127,0,0,0,0,0,0,0]],E=[120,127,120,127,120,127,61,62,62,62,120,122,127],ye=[0,3,81,84,88],Y={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},G={0:0,1:1,2:3,5:4},ee=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],te=[36,37];var O=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,12,13,16,17,18,19],ke=[33,99,100,32,102,8,9,10],x={};L.forEach((t,s)=>{x[t]=s});var d={length:O.length};O.forEach((t,s)=>{d[t]=s});var ve=function(t){let s=[[]];return t?.forEach(function(a){a==247||(a==240?s.push([]):s[s.length-1].push(a))}),s},ie=function(t,s="",a="",i=2){return t?`${s}${t.toString().padStart(i,"0")}${a}`:""},p={ch:128,cc:O.length,nn:128,pl:512,tr:256,rpn:6},re=class extends S{#t=0;#p=0;#f=0;#h=new Array(11);get#u(){return this.#h[this.#p]}set#u(t){this.#h[this.#p]=t}#o=new Uint8Array(p.ch);#d=new Uint8Array(p.ch);#e=new Uint8ClampedArray(p.ch*p.cc);#n=new Uint8ClampedArray(p.ch);#r=new Uint8ClampedArray(p.ch*p.nn);#g=new Uint8Array(p.ch);#l=new Uint16Array(p.pl);#R=new Int16Array(p.ch);#A=new Array(p.ch);#$=new Uint8Array(p.ch);#I=0;#a=new Uint8Array(p.ch*p.rpn);#G=new Int8Array(p.ch*te.length);#C=0;#E=0;#m=100;#w=0;#L=500;#O=0;#b="";#T=0;#s=!1;#N;#y=new Uint8Array(2);#i=[];#k=new Uint8Array(p.ch);#M=new Uint8Array(p.tr);chRedir(t,s,a){if(this.#M[s])return(this.#M[s]-1)*16+t;if([x.gs,x.ns5r].indexOf(this.#t)>-1){if(a==1)return t;let i=0,r=!0;for(;r;)this.#k[t+i]==0?(this.#k[t+i]=s,console.debug(`Assign track ${s} to channel ${t+i+1}.`),r=!1):this.#k[t+i]==s?r=!1:(i+=16,i>=128&&(i=0,r=!1));return t+i}else return t}#c=[];#U;#v={ano:t=>{this.#l.forEach((s,a,i)=>{let r=s>>7;s==0&&this.#r[0]==0||r==t&&(this.#r[s]=0,i[a]=0)})}};#H={8:function(t){let a=t.channel*128+t.data[0],i=this.#l.indexOf(a);i>-1&&(this.#l[i]=0,this.#r[a]=0)},9:function(t){let s=t.channel;this.#o[s]=1;let a=s*128+t.data[0];if(t.data[1]>0){let i=0;for(;this.#l[i]>0;)i++;i<this.#l.length?(this.#l[i]=a,this.#r[a]=t.data[1],this.#$[s]<t.data[1]&&(this.#$[s]=t.data[1])):console.error("Polyphony exceeded.")}else{let i=this.#l.indexOf(a);i>-1&&(this.#l[i]=0,this.#r[a]=0)}},10:function(t){let a=t.channel*128+t.data[0];this.#l.indexOf(a)>-1&&(this.#r[a]=data[1])},11:function(t){let s=t.channel;this.#o[s]=1;let a=s*p.cc;switch(t.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#v.ano(s),this.#R[s]=0;let i=s*p.cc;this.#e[i+d[1]]=0,this.#e[i+d[5]]=0,this.#e[i+d[64]]=0,this.#e[i+d[65]]=0,this.#e[i+d[66]]=0,this.#e[i+d[67]]=0,this.#e[i+d[11]]=127,this.#e[i+d[101]]=127,this.#e[i+d[100]]=127,this.#e[i+d[99]]=127,this.#e[i+d[98]]=127;return}case 123:{this.#v.ano(s);return}case 124:{this.#v.ano(s);return}case 125:{this.#v.ano(s);return}case 126:{this.#g[s]=1,this.#v.ano(s);return}case 127:{this.#g[s]=0,this.#v.ano(s);return}}if(d[t.data[0]]==null)console.warn(`cc${t.data[0]} is not accepted.`);else{switch(t.data[0]){case 0:{if(this.#t==0)t.data[1]<48?(this.#e[a]>119&&(t.data[1]=this.#e[a],t.data[1]=120,console.debug(`Forced channel ${s+1} to stay drums.`)),t.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${t.data[1]}`),this.switchMode("gs"))):t.data[1]==62?this.switchMode("x5d"):t.data[1]==63&&this.switchMode("krs");else if(this.#t==x.gs)t.data[1]<56&&this.#e[a]>119&&(t.data[1]=this.#e[a],t.data[1]=120,console.debug(`Forced channel ${s+1} to stay drums.`));else if(this.#t==x.gm)t.data[1]<48&&this.#e[a]>119&&(t.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${s+1} to stay drums.`));else if(this.#t==x.x5d){if(t.data[1]>0&&t.data[1]<8)this.switchMode("05rw",!0);else if(t.data[1]==56){let i=0;for(let r=0;r<16;r++){let n=this.#e[p.cc*r];(n==56||n==62)&&i++}i>14&&this.switchMode("ag10",!0)}}break}case 6:{if(this.#I){let i=this.#e[a+d[99]],r=this.#e[a+d[98]];if(i==1){let n=ke.indexOf(r);if(n>-1)this.#e[a+d[71+n]]=t.data[1],console.debug(`Redirected NRPN 1 ${r} to cc${71+n}.`);else{let l=te.indexOf(r);l>-1&&(this.#G[s*10+l]=t.data[1]-64),console.debug(`CH${s+1} voice NRPN ${r} commit`)}}}else{let i=G[this.#e[a+d[100]]];this.#e[a+d[101]]==0&&i!=null&&(console.debug(`CH${s+1} RPN 0 ${this.#e[a+d[100]]} commit: ${t.data[1]}`),t.data[1]=Math.min(Math.max(t.data[1],ee[i][0]),ee[i][1]),this.#a[s*p.rpn+i]=t.data[1])}break}case 38:{this.#I||this.#e[a+101]==0&&G[this.#e[a+100]]!=null&&(this.#a[s*p.rpn+G[this.#e[a+100]]+1]=t.data[1]);break}case 98:case 99:{this.#I=1;break}case 100:case 101:{this.#I=0;break}}this.#e[a+d[t.data[0]]]=t.data[1]}},12:function(t){let s=t.channel;this.#o[s]=1,this.#n[s]=t.data,this.#A[s]=0},13:function(t){let s=this,a=t.channel;this.#l.forEach(function(i){let r=i>>7;a==r&&(s.#r[i]=t.data)})},14:function(t){let s=t.channel;this.#R[s]=t.data[1]*128+t.data[0]-8192},15:function(t){ve(t.data).forEach(s=>{let a=s[0],i=s[1];(this.#z[a]||function(){console.debug(`Unknown manufacturer ${a}.`)})(i,s.slice(2),t.track)})},248:function(t){},250:function(t){},251:function(t){},252:function(t){},254:function(t){},255:function(t){if((this.#c[t.meta]||function(a,i,r){}).call(this,t.data,t.track,t.meta),t.meta!=32&&(this.#w=0),ye.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#z={64:(t,s,a)=>{this.#F.run(s,a,t)},65:(t,s,a)=>{if(s[0]<64)this.#x.run(s,a,t);else{let i=s.pop(),r=_(s.slice(2));i==r?this.#x.run(s,a,t):console.warn(`Bad GS checksum ${i}. Should be ${r}.`)}},66:(t,s,a)=>{this.#S.run(s,a,t)},67:(t,s,a)=>{this.#P.run(s,a,t)},68:(t,s,a)=>{this.#V.run(s,a,t)},71:(t,s,a)=>{this.#X.run(s,a,t)},126:(t,s,a)=>{this.#B.run(s,a,t)},127:(t,s,a)=>{this.switchMode("gm"),this.#D.run(s,a,t)}};#B;#D;#P;#x;#S;#F;#X;#V;buildRchTree(){let t=[];this.#d.forEach((s,a)=>{t[s]?.constructor||(t[s]=[]),t[s].push(a)}),this.#N=t}getActive(){let t=this.#o.slice();return this.#t==x.mt32,t}getCc(t){let s=t*p.cc,a=this.#e.slice(s,s+p.cc);return a[d[0]]=a[d[0]]||this.#C,a[d[32]]=a[d[32]]||this.#E,a}getCcAll(){let t=this.#e.slice();for(let s=0;s<64;s++){let a=s*p.cc;t[a+d[0]]=t[a+d[0]]||this.#C,t[a+d[32]]=t[a+d[32]]||this.#E}return t}getPitch(){return this.#R}getProgram(){return this.#n}getTexts(){return this.#i.slice()}getVel(t){let s=new Map,a=this;return this.#l.forEach(function(i){let r=Math.floor(i/128),n=i%128;t==r&&a.#r[i]>0&&s.set(n,a.#r[i])}),s}getBitmap(){return{bitmap:this.#u,expire:this.#f}}getCustomNames(){return this.#A.slice()}getLetter(){return{text:this.#b,expire:this.#T}}getMode(){return L[this.#t]}getMaster(){return{volume:this.#m}}getRawStrength(){let t=this;return this.#l.forEach(function(s){let a=Math.floor(s/128);t.#r[s]>t.#$[a]&&(t.#$[a]=t.#r[s])}),this.#$}getStrength(){let t=[],s=this;return this.getRawStrength().forEach(function(a,i){t[i]=Math.floor(a*s.#e[i*p.cc+d[7]]*s.#e[i*p.cc+d[11]]*s.#m/803288)}),t}getRpn(){return this.#a}getNrpn(){return this.#G}init(t=0){this.dispatchEvent("mode","?"),this.#t=0,this.#C=0,this.#E=0,this.#w=0,this.#o.fill(0),this.#e.fill(0),this.#n.fill(0),this.#r.fill(0),this.#l.fill(0),this.#$.fill(0),this.#R.fill(0),this.#G.fill(0),this.#m=100,this.#i=[],this.#L=500,this.#O=0,this.#T=0,this.#b="",this.#f=0,this.#p=0,this.#u.fill(0),this.#A.fill(0),this.#s=!1,this.#d.forEach(function(s,a,i){i[a]=a}),this.buildRchTree(),this.#k.fill(0),this.#M.fill(0),this.#e[p.cc*9]=E[0],this.#e[p.cc*25]=E[0],this.#e[p.cc*41]=E[0],this.#e[p.cc*57]=E[0],this.#y.fill(0);for(let s=0;s<64;s++){let a=s*p.cc;this.#e[a+d[7]]=100,this.#e[a+d[11]]=127,this.#e[a+d[10]]=64,this.#e[a+d[71]]=64,this.#e[a+d[72]]=64,this.#e[a+d[73]]=64,this.#e[a+d[74]]=64,this.#e[a+d[75]]=64,this.#e[a+d[76]]=64,this.#e[a+d[77]]=64,this.#e[a+d[78]]=64,this.#e[a+d[91]]=40,this.#e[a+d[101]]=127,this.#e[a+d[100]]=127,this.#e[a+d[99]]=127,this.#e[a+d[98]]=127;let i=s*p.rpn;this.#a[i]=2,this.#a[i+1]=64,this.#a[i+2]=0,this.#a[i+3]=64,this.#a[i+4]=0,this.#a[i+5]=0}}switchMode(t,s=!1){let a=L.indexOf(t);if(a>-1){if(this.#t==0||s){this.#t=a,this.#p=0,this.#C=J[0][a],this.#E=J[1][a];for(let i=0;i<64;i++)E.indexOf(this.#e[i*p.cc])>-1&&(this.#e[i*p.cc]=E[a]);this.dispatchEvent("mode",t)}}else throw new Error(`Unknown mode ${t}`)}newStrength(){this.#$.fill(0)}runJson(t){if(t.type>14)return this.#H[t.type].call(this,t);{let s=this.chRedir(t.part,t.track),a=!1;this.#N[s]?.forEach(i=>{t.channel=i,a=!0,this.#H[t.type].call(this,t)}),a||console.warn(`${Y[t.type]?Y[t.type]:t.type}${[11,12].includes(t.type)?(t.data[0]!=null?t.data[0]:t.data).toString():""} event sent to CH${s+1} without any recipient.`)}this.#i.length>100&&this.#i.splice(100,this.#i.length-99)}runRaw(t){}constructor(){super();let t=this;this.#u=new Uint8Array(256),this.#h[10]=new Uint8Array(512),this.#U=new k,this.#c[1]=function(i){switch(i.slice(0,2)){case"@I":{this.#s=!0,this.#i.unshift(`Kar.Info: ${i.slice(2)}`);break}case"@K":{this.#s=!0,this.#i.unshift("Karaoke mode active."),console.debug(`Karaoke mode active: ${i.slice(2)}`);break}case"@L":{this.#s=!0,this.#i.unshift(`Language: ${i.slice(2)}`);break}case"@T":{this.#s=!0,this.#i.unshift(`Ka.Title: ${i.slice(2)}`);break}case"@V":{this.#s=!0,this.#i.unshift(`Kara.Ver: ${i.slice(2)}`);break}default:this.#s?i[0]=="\\"?this.#i.unshift(`@ ${i.slice(1)}`):i[0]=="/"?this.#i.unshift(i.slice(1)):this.#i[0]+=i:(this.#i[0]=i,this.#i.unshift(""))}},this.#c[2]=function(i){this.#i.unshift(`Copyrite: ${i}`)},this.#c[3]=function(i,r){r<1&&this.#w<1&&this.#i.unshift(`TrkTitle: ${i}`)},this.#c[4]=function(i,r){r<1&&this.#w<1&&this.#i.unshift(`${ie(this.#w,""," ")}Instrmnt: ${i}`)},this.#c[5]=function(i){i.trim()==""?this.#i.unshift(""):this.#i[0]+=`${i}`},this.#c[6]=function(i){this.#i.unshift(`${ie(this.#w,""," ")}C.Marker: ${i}`)},this.#c[7]=function(i){this.#i.unshift(`CuePoint: ${i}`)},this.#c[32]=function(i){this.#w=i[0]+1},this.#c[33]=function(i,r){console.debug(`Track ${r} requests to get assigned to output ${i}.`),t.#M[r]=i+1},this.#c[81]=function(i,r){t.#L=i/1e3},this.#c[127]=function(i,r){t.#U.run(i,r)},this.#U.add([67,0,1],function(i,r){t.#M[r]=i[0]+1}),this.#B=new k,this.#D=new k,this.#P=new k,this.#x=new k,this.#S=new k,this.#F=new k,this.#X=new k,this.#V=new k,this.#B.add([9],i=>{t.switchMode(["gm","?","g2"][i[0]-1],!0),t.#s=t.#s||!1,console.info(`MIDI reset: ${["GM","Init","GM2"][i[0]-1]}`),i[0]==2&&t.init()}),this.#x.add([22,18,127,0,0,1],()=>{t.switchMode("mt32",!0),t.#s=!1,console.info("MIDI reset: MT-32")}),this.#F.add([16,0,8,0,0,0,0],()=>{t.switchMode("k11",!0),t.#s=!1,console.info("MIDI reset: KAWAI GMega/K11")}),this.#D.add([4,1],i=>{t.#m=((i[1]<<7)+i[0])/16383*100}).add([4,3],i=>((i[1]<<7)+i[0]-8192)/8192).add([4,4],i=>i[1]-64),this.#P.add([76,0,0],i=>{switch(i[0]){case 126:{t.switchMode("xg",!0),t.#s=!1,console.info("MIDI reset: XG");break}default:{let r=[0,0,0,0],n=(l,o)=>{r[o]=l};if(i.slice(1).forEach((l,o)=>{let f=o+i[0];[n,n,n,n,c=>{this.#m=c*129/16383*100},c=>{},c=>{}][f](l,o)}),i[0]<4){let l=0;r.forEach(o=>{l=l<<4,l+=o}),l-=1024}}}}).add([76,2,1],i=>{let r="XG ";i[0]<32?(r+="reverb ",i.slice(1).forEach((n,l)=>{([o=>{console.info(`${r}main type: ${R[o]}`)},o=>{console.debug(`${r}sub type: ${o+1}`)},o=>{console.debug(`${r}time: ${V(o)}s`)},o=>{console.debug(`${r}diffusion: ${o}`)},o=>{console.debug(`${r}initial delay: ${o}`)},o=>{console.debug(`${r}HPF cutoff: ${M[o]}Hz`)},o=>{console.debug(`${r}LPF cutoff: ${M[o]}Hz`)},o=>{console.debug(`${r}width: ${o}`)},o=>{console.debug(`${r}height: ${o}`)},o=>{console.debug(`${r}depth: ${o}`)},o=>{console.debug(`${r}wall type: ${o}`)},o=>{console.debug(`${r}dry/wet: ${o}`)},o=>{console.debug(`${r}send: ${w(o)}dB`)},o=>{console.debug(`${r}pan: ${o-64}`)},!1,!1,o=>{console.debug(`${r}delay: ${o}`)},o=>{console.debug(`${r}density: ${o}`)},o=>{console.debug(`${r}balance: ${o}`)},o=>{},o=>{console.debug(`${r}feedback: ${o}`)},o=>{}][i[0]+l]||function(){console.warn(`Unknown XG reverb address: ${i[0]}.`)})(n)})):i[0]<64?(r+="chorus ",i.slice(1).forEach((n,l)=>{([o=>{console.info(`${r}main type: ${R[o]}`)},o=>{console.debug(`${r}sub type: ${o+1}`)},o=>{console.debug(`${r}LFO: ${X[o]}Hz`)},o=>{},o=>{console.debug(`${r}feedback: ${o}`)},o=>{console.debug(`${r}delay offset: ${z(o)}ms`)},o=>{},o=>{console.debug(`${r}low: ${M[o]}Hz`)},o=>{console.debug(`${r}low: ${o-64}dB`)},o=>{console.debug(`${r}high: ${M[o]}Hz`)},o=>{console.debug(`${r}high: ${o-64}dB`)},o=>{console.debug(`${r}dry/wet: ${o}`)},o=>{console.debug(`${r}send: ${w(o)}dB`)},o=>{console.debug(`${r}pan: ${o-64}`)},o=>{console.debug(`${r}to reverb: ${w(o)}dB`)},!1,o=>{},o=>{},o=>{},o=>{console.debug(`${r}LFO phase diff: ${(o-64)*3}deg`)},o=>{console.debug(`${r}input mode: ${o?"stereo":"mono"}`)},o=>{}][i[0]-32+l]||function(){console.warn(`Unknown XG chorus address: ${i[0]}.`)})(n)})):i[0]<86?(r+="variation ",i[0]==64&&console.info(`${r}type: ${R[i[1]]}${i[2]>0?" "+(i[2]+1):""}`)):i[0]<97?(r+="variation ",i.slice(1).forEach((n,l)=>{[o=>{console.debug(`${r}send: ${w(o)}dB`)},o=>{console.debug(`${r}pan: ${o-64}`)},o=>{console.debug(`${r}to reverb: ${w(o)}dB`)},o=>{console.debug(`${r}to chorus: ${w(o)}dB`)},o=>{console.debug(`${r}connection: ${o?"system":"insertion"}`)},o=>{console.debug(`${r}channel: CH${o+1}`)},o=>{console.debug(`${r}mod wheel: ${o-64}`)},o=>{console.debug(`${r}bend wheel: ${o-64}`)},o=>{console.debug(`${r}channel after touch: ${o-64}`)},o=>{console.debug(`${r}AC1: ${o-64}`)},o=>{console.debug(`${r}AC2: ${o-64}`)}][i[0]-86+l](n)})):i[0]>111&&i[0]<118?r+="variation ":console.warn(`Unknown XG variation address: ${i[0]}`)}).add([76,2,64],i=>{i.slice(1).forEach((r,n)=>{let l=n+i[0];if(l==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][r]}`);else{let o=l-1>>2,f=l-1&3,c=`XG EQ ${o} ${["gain","freq","Q","shape"][f]}: `;[()=>{console.debug(`${c}${r-64}dB`)},()=>{console.debug(`${c}${r} (raw)`)},()=>{console.debug(`${c}${r/10}`)},()=>{console.debug(`${c}${["shelf","peak"][+!!r]}`)}][f]()}})}).add([76,3],i=>{}).add([76,6,0],i=>{let r=i[0];t.#b=" ".repeat(r),t.#T=Date.now()+3200,i.slice(1).forEach(function(n){t.#b+=String.fromCharCode(n)}),t.#b=t.#b.padEnd(32," ")}).add([76,7,0],i=>{let r=i[0];t.#f=Date.now()+3200,t.#u.fill(0);let n=i.slice(1);for(let l=0;l<r;l++)n.unshift(0);n.forEach(function(l,o){let f=Math.floor(o/16),c=o%16,h=(c*3+f)*7,u=7,g=0;for(h-=c*5,f==2&&(u=2);g<u;)t.#u[h+g]=l>>6-g&1,g++})}).add([76,8],(i,r)=>{let n=t.chRedir(i[0],r,!0),l=i[1],o=p.cc*n,f=`XG CH${n+1} `,c=`Unknown XG part address ${l}.`;l<1?console.debug(c):l<41?i.slice(2).forEach((h,u)=>{([()=>{t.#e[o+d[0]]=h},()=>{t.#e[o+d[32]]=h},()=>{t.#n[n]=h},()=>{let g=t.chRedir(h,r,!0);t.#d[n]=g,n!=g&&(t.buildRchTree(),console.info(`${f}receives from CH${g+1}`))},()=>{t.#g[n]=+!h},()=>{},()=>{t.#e[o+d[0]]=h>1?127:0,console.debug(`${f}type: ${T[h]}`)},()=>{t.#a[p.rpn*n+3]=h},!1,!1,()=>{t.#e[o+d[7]]=h},!1,!1,()=>{t.#e[o+d[10]]=h||128},!1,!1,()=>{t.#e[o+d[11]]=h},()=>{t.#e[o+d[93]]=h},()=>{t.#e[o+d[91]]=h},()=>{t.#e[o+d[94]]=h},()=>{t.#e[o+d[76]]=h},()=>{t.#e[o+d[77]]=h},()=>{t.#e[o+d[78]]=h},()=>{t.#e[o+d[74]]=h},()=>{t.#e[o+d[71]]=h},()=>{t.#e[o+d[73]]=h},()=>{t.#e[o+d[75]]=h},()=>{t.#e[o+d[72]]=h}][l+u-1]||function(){})()}):l<48?console.debug(c):l<111?l>102&&l<105&&(t.#e[o+d[[5,65][l&1]]]=e):l<114?console.debug(c):l<116?console.debug(`${f}EQ ${["bass","treble"][l&1]} gain: ${e-64}dB`):l<118?console.debug(c):l<120?console.debug(`${f}EQ ${["bass","treble"][l&1]} freq: ${e}`):console.debug(c)}).add([76,10],i=>{}).add([76,16],i=>{}).add([76,17,0,0],i=>{}).add([93,3],(i,r)=>{let n=t.chRedir(i[0],r,!0),l=`PLG-100SG CH${n+1} `,o=Date.now();if(i[1]==0){let f="",c=0;i.slice(2).forEach((h,u)=>{u%2==0?f+=K[h]||h.toString().padStart("0"):c+=h*13}),o>=t.#O&&t.#i.unshift("SG Lyric: "),t.#i[0]+=`${q(f)}`,t.#O=o+Math.ceil(c/2)+t.#L}else console.warn(`Unknown PLG-100SG data: ${i}`)}).add([112],i=>{console.debug(`XG plugin PLG1-${["00VL","00SG","00DX"][i[0]]} enabled for channel ${i[2]+1}.`)}),this.#P.add([76,48],i=>{}).add([76,49],i=>{}).add([76,50],i=>{}).add([76,51],i=>{}),this.#x.add([66,18,0,0,127],i=>{t.switchMode("gs",!0),t.#e[p.cc*9]=120,t.#e[p.cc*25]=120,t.#e[p.cc*41]=120,t.#e[p.cc*57]=120,t.#E=3,t.#s=!1,t.#k.fill(0),console.info(`GS system to ${["single","dual"][i[0]]} mode.`)}).add([66,18,64,0],i=>{switch(i[0]){case 127:{t.switchMode("gs",!0),t.#e[p.cc*9]=120,t.#e[p.cc*25]=120,t.#e[p.cc*41]=120,t.#e[p.cc*57]=120,t.#s=!1,t.#k.fill(0),console.info("MIDI reset: GS");break}default:{let r=[0,0,0,0],n=(l,o)=>{r[o]=l};if(i.slice(1).forEach((l,o)=>{let f=o+i[0];[n,n,n,n,c=>{this.#m=c*129/16383*100},c=>{},c=>{}][f](l,o)}),i[0]<4){let l=0;r.forEach(o=>{l=l<<4,l+=o}),l-=1024}}}}).add([66,18,64,1],i=>{let r=i[0];if(r<16){let n="".padStart(r," ");i.slice(1).forEach((l,o)=>{n+=String.fromCharCode(Math.max(32,l))}),n=n.padEnd(16," "),console.debug(`GS patch name: ${n}`)}else r<48||(r<65?i.slice(1).forEach((n,l)=>{let o=`GS ${r+l>55?"chorus":"reverb"} `;([()=>{console.info(`${o}type: ${Q[n]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${o}predelay: ${n}ms`)},()=>{console.info(`${o}type: ${j[n]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${o}to reverb: ${w(n)}`)},()=>{console.debug(`${o}to delay: ${w(n)}`)}][r+l-48]||function(){})()}):r<80?console.debug(`Unknown GS patch address: ${r}`):r<91?i.slice(1).forEach((n,l)=>{let o="GS delay ";([()=>{console.info(`${o}type: ${Z[n]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${o}to reverb: ${w(n)}`)}][r+l-80]||function(){})()}):console.debug(`Unknown GS patch address: ${r}`))}).add([66,18,64,2],i=>{let r="GS EQ ";i.slice(1).forEach((n,l)=>{([()=>{console.debug(`${r}low freq: ${[200,400][n]}Hz`)},()=>{console.debug(`${r}low gain: ${n-64}dB`)},()=>{console.debug(`${r}high freq: ${[3e3,6e3][n]}Hz`)},()=>{console.debug(`${r}high gain: ${n-64}dB`)}][i[0]+l]||function(){console.warn(`Unknown GS EQ address: ${i[0]+l}`)})()})}).add([66,18,64,3],i=>{let r="GS EFX ",n=function(l,o){let f=W(t.#y,o,l);f&&console.debug(`${r}${P(t.#y)} ${f}`)};i.slice(1).forEach((l,o)=>{([()=>{t.#y[0]=l},()=>{t.#y[1]=l,console.info(`${r}type: ${P(t.#y)}`)},!1,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,()=>{console.debug(`${r}to reverb: ${w(l)}dB`)},()=>{console.debug(`${r}to chorus: ${w(l)}dB`)},()=>{console.debug(`${r}to delay: ${w(l)}dB`)},!1,()=>{console.debug(`${r}1 source: ${l}`)},()=>{console.debug(`${r}1 depth: ${l-64}`)},()=>{console.debug(`${r}2 source: ${l}`)},()=>{console.debug(`${r}2 depth: ${l-64}`)},()=>{console.debug(`${r}to EQ: ${l?"ON":"OFF"}`)}][i[0]+o]||function(f,c){console.warn(`Unknown GS EFX address: ${c}`)})(l,i[0]+o)})}).add([66,18,65],i=>{}).add([69,18,16],i=>{switch(i[0]){case 0:{t.#T=Date.now()+3200;let r=i[1];t.#b=" ".repeat(r),i.slice(2).forEach(function(n){n<128&&(t.#b+=String.fromCharCode(n))});break}case 32:{t.#f=Date.now()+3200,i[1]==0&&(t.#p=Math.max(Math.min(i[2]-1,9),0));break}default:if(i[0]<11){t.#f=Date.now()+3200,t.#h[i[0]-1]?.length||(t.#h[i[0]-1]=new Uint8Array(256));let r=t.#h[i[0]-1],n=i[1];r.fill(0);let l=i.slice(2);for(let o=0;o<n;o++)l.unshift(0);l.forEach(function(o,f){let c=Math.floor(f/16),h=f%16,u=(h*4+c)*5,g=5,b=0;for(u-=h*4,c==3&&(g=1);b<g;)r[u+b]=o>>4-b&1,b++})}else console.warn(`Unknown GS display section: ${i[0]}`)}});let s=function(i,r,n){let l=i[0],o=p.cc*r,f=p.rpn*r,c=`GS CH${r+1} `;l<3?i.slice(1).forEach((h,u)=>{[()=>{t.#e[o+d[0]]=h},()=>{t.#n[r]=h},()=>{let g=t.chRedir(h,n,!0);t.#d[r]=g,r!=g&&(t.buildRchTree(),console.info(`${c}receives from CH${g+1}`))}][l+u]()}):l<19||(l<44?i.slice(1).forEach((h,u)=>{([()=>{t.#g[r]=+!h},!1,()=>{t.#e[o+d[0]]=h?120:0,console.debug(`${c}type: ${h?"drum ":"melodic"}${h||""}`)},()=>{t.#a[f+3]=h},!1,()=>{t.#e[o+d[7]]=h},!1,!1,()=>{t.#e[o+d[10]]=h||128},!1,!1,()=>{console.debug(`${c}CC 1: cc${h}`)},()=>{console.debug(`${c}CC 2: cc${h}`)},()=>{t.#e[o+d[93]]=h},()=>{t.#e[o+d[91]]=h},!1,!1,()=>{t.#a[f+1]=h},()=>{t.#a[f+2]=h},()=>{t.#e[o+d[94]]=h}][l+u-19]||function(){})()}):l<76||console.debug(`Unknown GS part address: ${l}`))},a=function(i,r){let n=i[0],l=`GS CH${r+1} `;n<2?i.slice(1).forEach((o,f)=>{[()=>{t.#e[p.cc*r+d[32]]=o},()=>{}][n+f]()}):n<32?console.warn(`Unknown GS misc address: ${n}`):n<35?i.slice(1).forEach((o,f)=>{[()=>{console.debug(`${l}EQ: o${["ff","n"][o]}`)},()=>{},()=>{console.debug(`${l}EFX: o${["ff","n"][o]}`)}][n+f-32]()}):console.warn(`Unknown GS misc address: ${n}`)};this.#x.add([66,18,64,16],(i,r)=>{s(i,t.chRedir(9,r,!0),r)}).add([66,18,64,17],(i,r)=>{s(i,t.chRedir(0,r,!0),r)}).add([66,18,64,18],(i,r)=>{s(i,t.chRedir(1,r,!0),r)}).add([66,18,64,19],(i,r)=>{s(i,t.chRedir(2,r,!0),r)}).add([66,18,64,20],(i,r)=>{s(i,t.chRedir(3,r,!0),r)}).add([66,18,64,21],(i,r)=>{s(i,t.chRedir(4,r,!0),r)}).add([66,18,64,22],(i,r)=>{s(i,t.chRedir(5,r,!0),r)}).add([66,18,64,23],(i,r)=>{s(i,t.chRedir(6,r,!0),r)}).add([66,18,64,24],(i,r)=>{s(i,t.chRedir(7,r,!0),r)}).add([66,18,64,25],(i,r)=>{s(i,t.chRedir(8,r,!0),r)}).add([66,18,64,26],(i,r)=>{s(i,t.chRedir(10,r,!0),r)}).add([66,18,64,27],(i,r)=>{s(i,t.chRedir(11,r,!0),r)}).add([66,18,64,28],(i,r)=>{s(i,t.chRedir(12,r,!0),r)}).add([66,18,64,29],(i,r)=>{s(i,t.chRedir(13,r,!0),r)}).add([66,18,64,30],(i,r)=>{s(i,t.chRedir(14,r,!0),r)}).add([66,18,64,31],(i,r)=>{s(i,t.chRedir(15,r,!0),r)}).add([66,18,64,64],(i,r)=>{a(i,t.chRedir(9,r,!0))}).add([66,18,64,65],(i,r)=>{a(i,t.chRedir(0,r,!0))}).add([66,18,64,66],(i,r)=>{a(i,t.chRedir(1,r,!0))}).add([66,18,64,67],(i,r)=>{a(i,t.chRedir(2,r,!0))}).add([66,18,64,68],(i,r)=>{a(i,t.chRedir(3,r,!0))}).add([66,18,64,69],(i,r)=>{a(i,t.chRedir(4,r,!0))}).add([66,18,64,70],(i,r)=>{a(i,t.chRedir(5,r,!0))}).add([66,18,64,71],(i,r)=>{a(i,t.chRedir(6,r,!0))}).add([66,18,64,72],(i,r)=>{a(i,t.chRedir(7,r,!0))}).add([66,18,64,73],(i,r)=>{a(i,t.chRedir(8,r,!0))}).add([66,18,64,74],(i,r)=>{a(i,t.chRedir(10,r,!0))}).add([66,18,64,75],(i,r)=>{a(i,t.chRedir(11,r,!0))}).add([66,18,64,76],(i,r)=>{a(i,t.chRedir(12,r,!0))}).add([66,18,64,77],(i,r)=>{a(i,t.chRedir(13,r,!0))}).add([66,18,64,78],(i,r)=>{a(i,t.chRedir(14,r,!0))}).add([66,18,64,79],(i,r)=>{a(i,t.chRedir(15,r,!0))}),this.#S.add([54,76,0],(i,r)=>{t.switchMode("x5d",!0);let n="",l=82,o=0,f=0,c="MSB	PRG	LSB	NME";v(i,function(h,u){if(u<16400){let g=u%164;switch(!0){case g<10:{h>31&&(n+=String.fromCharCode(h));break}case g==11:{c+=`
${l}	${o}	${f}	${n.trim().replace("Init Voice","")}`,o++,n="";break}}o>99&&(l=90,o=0)}}),t.dispatchEvent("mapupdate",{clearRange:{msb:82,prg:[0,99],lsb:0},voiceMap:c})}).add([54,77,0],(i,r)=>{t.switchMode("x5d",!0);let n="",l=90,o=0,f=0,c="MSB	PRG	LSB	NME";v(i,function(h,u){if(u<13600){let g=u%136;switch(!0){case g<10:{h>31&&(n+=String.fromCharCode(h));break}case g==11:{c+=`
${l}	${o}	${f}	${n.trim().replace("Init Combi","")}`,o++,n="";break}}}}),t.dispatchEvent("mapupdate",{clearRange:{msb:90,prg:[0,99],lsb:0},voiceMap:c})}).add([54,104],(i,r)=>{t.switchMode("x5d",!0),v(i,function(n,l){if(l<192){let o=t.chRedir(Math.floor(l/12),r,!0),f=o*p.cc;switch(l%12){case 0:{t.#n[o]=n,n>0&&(t.#o[o]=1);break}case 1:{t.#e[f+d[7]]=n;break}case 2:{t.#a[o*p.rpn+3]=n>127?256-n:64+n;break}case 3:{t.#a[o*p.rpn+1]=n>127?256-n:64+n;break}case 4:{n<31&&(t.#e[f+d[10]]=Math.round((n-15)*4.2+64));break}case 5:{let c=n>>4,h=n&15;t.#e[f+d[91]]=A(h),t.#e[f+d[93]]=A(c);break}case 10:{t.#e[f]=n&3?82:56;break}case 11:{let c=t.chRedir(n&15,r,!0),h=n>>4;t.#d[o]=n,(c!=o||h)&&(console.info(`X5D Part CH${o+1} receives from CH${c+1}.`),t.buildRchTree())}}}else{let o=t.chRedir(l-192,r,!0)}})}),this.#S.add([66,0],(i,r)=>{t.switchMode("ns5r",!0),t.#s=!1,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][i[0]]} mode.`)}).add([66,1],(i,r)=>{t.switchMode(["ns5r","05rw"][i[0]],!0),t.#s=!1}).add([66,18,0,0],(i,r)=>{let n=i[0];switch(n){case 124:case 126:case 127:{t.switchMode("ns5r",!0),t.#s=!1;break}case 125:break;default:if(n<10){let l=[0,0,0,0],o=(f,c)=>{l[c]=f};if(i.slice(1).forEach((f,c)=>{[o,o,o,o,()=>{t.#m=f*129/16383*100},()=>f-64,()=>f-64,()=>{},()=>{},()=>{}][n+c]()}),i[0]<4){let f=0;l.forEach(c=>{f=f<<4,f+=c}),f-=1024}}}}).add([66,18,0,1],(i,r)=>{}).add([66,18,0,2],(i,r)=>{}).add([66,18,1],(i,r)=>{let n=t.chRedir(i[0],r,!0),l=n*p.cc,o=i[1],f=`NS5R CH${n+1}`;i.slice(2).forEach((c,h)=>{let u=o+h;u<3?[()=>{t.#e[l+d[0]]=c},()=>{t.#e[l+d[32]]=c},()=>{t.#n[n]=c}][u]():u<8||(u<14?[()=>{let g=t.chRedir(c,r,!0);t.#d[n]=g,n!=g&&(t.buildRchTree(),console.info(`${f}receives from CH${g+1}`))},()=>{t.#g[n]=+!c},()=>{console.debug(`${f}type: ${T[c]}`)},()=>{t.#a[p.rpn*n+3]=c},()=>{},()=>{}][u-8]():u<16||(u<33?[()=>{t.#e[l+d[7]]=c},()=>{t.#e[l+d[11]]=c},()=>{},()=>{},()=>{t.#e[l+d[10]]=c||128},()=>{},()=>{},()=>{t.#e[l+d[93]]=c},()=>{t.#e[l+d[91]]=c},()=>{t.#e[l+d[76]]=c},()=>{t.#e[l+d[77]]=c},()=>{t.#e[l+d[78]]=c},()=>{t.#e[l+d[74]]=c},()=>{t.#e[l+d[71]]=c},()=>{t.#e[l+d[73]]=c},()=>{t.#e[l+d[75]]=c},()=>{t.#e[l+d[72]]=c}][u-16]():u<112||u<114&&[()=>{t.#e[l+d[5]]=c},()=>{t.#e[l+d[65]]=c}][u-112]()))})}).add([66,18,8,0],(i,r)=>{}).add([66,52],(i,r)=>{t.switchMode("ns5r",!0),t.#s=!1}).add([66,53],(i,r)=>{t.switchMode("ns5r",!0),t.#s=!1,v(i,function(n,l){switch(!0){case l<2944:{let o=t.chRedir(Math.floor(l/92),r,!0),f=o*p.cc;switch(l%92){case 0:{t.#e[f+d[0]]=n;break}case 1:{t.#e[f+d[32]]=n;break}case 2:{t.#n[o]=n,n>0&&(t.#o[o]=1);break}case 3:{let c=t.chRedir(n,r,!0);t.#d[o]=c,o!=c&&(console.info(`NS5R CH${o+1} receives from CH${c+1}.`),t.buildRchTree())}case 7:break;case 8:{t.#a[o*p.rpn+3]=n<40||n>88?n+(n>63?-192:64):n;break}case 9:case 10:{t.#e[f+d[7]]=n;break}case 11:{t.#e[f+d[11]]=n;break}case 14:{t.#e[f+d[10]]=n||128;break}case 19:{t.#e[f+d[93]]=n;break}case 20:{t.#e[f+d[91]]=n;break}case 84:{t.#e[f+d[65]]=n;break}case 85:{t.#e[f+d[5]]=n;break}}break}case l<3096:break;case l<3134:break;case l<8566:break}})}).add([66,54],(i,r)=>{t.switchMode("ns5r",!0);let n="",l=80,o=0,f=0,c="MSB	PRG	LSB	NME";v(i,function(h,u){let g=u%158;switch(!0){case g<10:{h>31&&(n+=String.fromCharCode(h));break}case g==11:{l=h;break}case g==12:{f=h;break}case g==13:{c+=`
${l}	${o}	${f}	${n.trim().replace("Init Voice","")}`,o++,n="";break}}}),t.dispatchEvent("mapupdate",{clearRange:{msb:80,lsb:0},voiceMap:c})}).add([66,55],(i,r)=>{t.switchMode("ns5r",!0);let n="",l=88,o=0,f=0,c="MSB	PRG	LSB	NME";v(i,function(h,u){let g=u%126;switch(!0){case g<10:{h>31&&(n+=String.fromCharCode(h));break}case g==11:break;case g==12:break;case g==13:{c+=`
${l}	${o}	${f}	${n.trim().replace("Init Combi","")}`,o++,n="";break}}}),t.dispatchEvent("mapupdate",{clearRange:{msb:88,lsb:0},voiceMap:c})}).add([66,125],i=>{t.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][i[0]]||"white")}).add([76],(i,r,n)=>{t.#S.run([66,...i],r,n)})}};var F=be(se(),1);var ae=class{#t=!1;constructor(t,s,a,i){this.#t=t,this.start=s,this.end=a,this.data=i}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},B=class extends ae{constructor(t,s,a){super(!0,t,s,a)}},ne=class extends ae{constructor(t,s){super(!1,t,t,s)}},D=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,s){return t.start==s.start?0:(+(t.start>s.start)<<1)-1}),this.forEach(function(t,s){t.index=s})}step(t,s=!1){let a=[];if(s)for(let i=0;i<this.length&&!(this[i].start>t);i++){if(this[i].end<t)continue;a.push(this[i])}else{let i=this.getRange(this.#t==-1?0:t-1,t),r=this;i.forEach(function(n){n.index>r.#t&&(a.push(n),r.#t=n.index)})}return a}getRange(t,s){t>s&&([t,s]=[s,t]);let a=[],i=-1,r=Math.ceil(Math.sqrt(this.length)),n=!0;for(let l=0;l<this.length;l+=r)this[l+r]?i<0&&this[l+r].start>=t&&(i=l):i=i<0?l:i;for(;n;)this[i]?.end<s?this[i].start>=t&&a.push(this[i]):n=!1,i++;return a}};var xe=0xffffffffffff,oe=function(t){let s=new D,a=this,i=t.timeDivision,r=120,n=new D,l=0,o=0;n.push(new B(0,xe,[120,0])),t.track.forEach(function(u){l=0,u.event.forEach(function(g){l+=g.deltaTime,g.type==255&&g?.metaType==81&&(r=6e7/g.data,n[n.length-1]&&n.push(new B(l,0xffffffffffff,[r,0])))})}),n.fresh(),n.forEach(function(u,g,b){g>0&&(b[g-1].end=u.start)});let f=120;n.forEach(function(u,g,b){g>0&&(u.end==u.start?b.splice(b.indexOf(u),1):f==u.data[0]&&(b[g-1].end=u.end,b.splice(b.indexOf(u),1)),f=u.data[0])});let c=0,h=120;return n.forEach(function(u){let g=u.start,b=g/h/i*60+c;h=u.data[0],c=b-g/h/i*60,u.data[1]=c}),console.debug("All tempo changes: ",n),r=120,l=0,o=0,t.track.forEach(function(u,g){l=0,o=0;let b=g+1;u.event.forEach(function(m,$){l+=m.deltaTime;let y=n.step(l,!0)[0];y&&(r=y.data[0],o=y.data[1]);let I={type:m.type,data:m.data,track:b,part:0};m.type>14?I.meta=m.metaType:I.part=m.channel,s.push(new ne(l/r/i*60+o,I))})}),s.fresh(),self.midiEvents=s,console.debug(`Parsed a type ${t.formatType} MIDI sequence.`),s};var Ee=["MSB","PRG","LSB"];var le=class{#t;get(t=0,s=0,a=0,i){let r,n=Array.from(arguments);switch(i){case"xg":t==82&&(n[0]=98);case"gs":{t==0&&a<5&&(n[2]=0);break}}n[0]==0&&n[2]>111&&n[2]<120&&(n[2]=0);let l=" ";for(;!(r?.length>=0);)r=this.#t[n[1]||0][(n[0]<<7)+n[2]],r||(n[2]=0,l="^",this.#t[n[1]||0][n[0]<<7]||(t==62?(n[1]--,l=" "):t<64?i=="xg"&&t==16?(r=`Voice${(a*128+s+1).toString().padStart(3,"0")}`,l=" "):(n[0]=0,l="*"):t==80?(r=`PrgU:${s.toString().padStart(3,"0")}`,l="!"):t==88?(r=`CmbU:${s.toString().padStart(3,"0")}`,l="!"):t==121?(r=`GM2Vox0${a}`,l="#"):t==122?(n[1]==32?n[1]==0:n[1]%=7,l=" "):n[1]==0?(r=`${t.toString().padStart(3,"0")} ${s.toString().padStart(3,"0")} ${a.toString().padStart(3,"0")}`,l="!"):(n[1]=0,l="!")));i=="gs"&&l=="^"&&(l=" "),l!=" "&&self.debugMode&&(r="");let o="??";switch(n[0]){case 0:{n[2]==0?o="GM":n[2]==5||n[2]==7?o="KG":n[2]<120?o="XG":n[2]==127&&(o="MT");break}case 56:{o="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{o="AI";break}case 62:case 82:case 90:{o="XD";break}case 63:o="KR";case 81:{o="RW";break}case 98:o="XG";case 64:case 126:{o="XG";break}case 120:{o="GS";break}case 121:{o="G2";break}case 122:{o="KG";break}case 127:{o=a==127?"MT":s==0?"GM":"XG";break}default:n[0]<48&&(n[0]==16&&i=="xg"?o="XG":o="GS")}return{name:r||(t||0).toString().padStart(3,"0")+" "+(s||0).toString().padStart(3,"0")+" "+(a||0).toString().padStart(3,"0"),ending:l,standard:o}}async load(t,s,a){let i=this,r=[],n=0,l=0;t.split(`
`).forEach(function(o,f){let c=o.split("	"),h=[];f==0?c.forEach(function(u,g){r[Ee.indexOf(u)]=g}):c.forEach(async function(u,g){g>2?(i.#t[h[r[1]]]=i.#t[h[r[1]]]||[],(!i.#t[h[r[1]]][(h[r[0]]<<7)+h[r[2]]]?.length||s)&&(i.#t[h[r[1]]][(h[r[0]]<<7)+h[r[2]]]=c[3],n++),l++):h.push(parseInt(c[g]))})}),console.debug(`Map "${a}": ${l} total, ${n} loaded.`)}clearRange(t){let s=t.prg!=null?t.prg.constructor==Array?t.prg:[t.prg,t.prg]:[0,127],a=t.msb!=null?t.msb.constructor==Array?t.msb:[t.msb,t.msb]:[0,127],i=t.lsb!=null?t.lsb.constructor==Array?t.lsb:[t.lsb,t.lsb]:[0,127];for(let r=a[0];r<=a[1];r++){let n=r<<7;for(let l=i[0];l<=i[1];l++){let o=n+l;for(let f=s[0];f<=s[1];f++)delete this.#t[f][o]}}}init(){this.#t=[];for(let t=0;t<128;t++)this.#t.push([""])}async loadFiles(...t){this.init();let s=this;t.forEach(async function(a,i){await fetch(`./data/bank/${a}.tsv`).then(function(r){return r.text()}).then(r=>{s.load(r,!1,a)})})}constructor(...t){this.loadFiles(...t)}};F.default.customInterpreter=function(t,s,a){let i=[],r=a==!1?s.readIntVLV():a;t==0||t==127;for(let n=0;n<r;n++){let l=s.readInt(1);if(i.push(l),l!=247){if(l!=240){if(l>127)return console.debug(`Early termination: ${i}`),i.pop(),s.backOne(),s.backOne(),i}}}return i};var rt=class extends S{#t=new re;#p;#f="";voices=new le("gm","gm2","xg","gs","ns5r","gmega","sg","plg-100sg","kross");#h=[];#u=new Uint8ClampedArray(64);#o=.5;#d=120;#e=4;#n=4;#r=0;#g=0;smoothing=0;reset(){this.dispatchEvent("reset"),this.#p?.resetIndex(),this.#t.init(),this.#f="",this.#o=.5,this.#d=120,this.#e=4,this.#n=4,this.#r=0,this.#g=0}async loadFile(t){this.#p=oe(F.default.parse(new Uint8Array(await t.arrayBuffer())))}switchMode(t,s=!1){this.#t.switchMode(t,s)}getMode(){return this.#t.mode}get noteProgress(){return this.#g/this.#o}get noteOverall(){return this.noteProgress-this.#r}get noteBar(){return Math.floor(this.noteOverall/this.#e)}get noteBeat(){let t=this.noteOverall%this.#e;return t<0&&(t+=this.#e),t}getTimeSig(){return[this.#e,this.#n]}getTempo(){return this.#d}sendCmd(t){this.#t.runJson(t)}render(t){t>this.#g&&(this.#g=t);let s=this.#p?.step(t)||[],a=0,i=new Set,r=this,n=[];r.#t.newStrength(),s.forEach(function(m){let $=m.data;$.type==9&&($.data[1]>0?i.add($.part*128+$.data[0]):i.has($.part*128+$.data[0])&&a++),m.data.type==8&&i.has($.part*128+$.data[0])&&a++;let y=r.#t.runJson($);switch(y?.reply){case"meta":{n.push(y);break}}y?.reply&&delete y.reply});let l=this.#t.getStrength();l.forEach(function(m,$){let y=m-r.#u[$];r.#u[$]+=Math.ceil(y-y*r.smoothing)}),n?.length>0&&this.dispatchEvent("meta",n);let o=this.#t.getActive(),f=[],c=r.#t.getPitch(),h=r.#t.getCcAll(),u=r.#t.getProgram(),g=0;return o.forEach(function(m,$){m&&(f[$]=r.#t.getVel($),g+=f[$].size)}),{extraPoly:a,curPoly:g,chInUse:o,chKeyPr:f,chPitch:c,chProgr:u,chContr:h,eventCount:s.length,title:this.#f,bitmap:this.#t.getBitmap(),letter:this.#t.getLetter(),names:this.#t.getCustomNames(),texts:this.#t.getTexts(),master:this.#t.getMaster(),mode:this.#t.getMode(),strength:this.#u.slice(),velo:l,rpn:this.#t.getRpn(),tSig:this.getTimeSig(),tempo:this.getTempo(),noteBar:this.noteBar,noteBeat:Math.floor(this.noteBeat)}}constructor(){super();let t=this;this.smoothing=.5,this.addEventListener("meta",function(s){s?.data?.forEach(function(a){(t.#h[a.meta]||console.debug).call(t,a.meta,a.data)})}),this.#t.addEventListener("mode",function(s){t.dispatchEvent("mode",s.data)}),this.#t.addEventListener("mapupdate",function(s){s.data.clearRange&&t.voices.clearRange(s.data.clearRange),t.voices.load(s.data.voiceMap,s.data.overwrite)}),this.#h[3]=function(s,a){t.#f?.length<1&&(t.#f=a)},this.#h[81]=function(s,a){let i=t.noteProgress,r=t.#o||.5;t.#d=6e7/a,t.#o=a/1e6,t.#r+=i*(r/t.#o)-i},this.#h[88]=function(s,a){let i=t.noteProgress,r=t.noteOverall,n=t.noteBar,l=t.noteBeat,o=t.#e,f=t.#n;t.#e=a[0],t.#n=1<<a[1];let c=24*(32/a[3])/a[2];o!=t.#e&&(l<1?o<t.#e?t.#r+=i-l-n*t.#e:(t.#r+=r*t.#e/o,console.warn("Fuck me! Any trick to make tSig shrinking WORK in any condition!")):t.#r+=i-t.#e*(n+1),console.info(`${t.#e}/${t.#n}`))}}};export{rt as RootDisplay,d as ccToPos};
