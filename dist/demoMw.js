"use strict";(()=>{var G=Object.create;var P=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,re=Object.prototype.hasOwnProperty;var ne=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ae=(e,t,i,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ee(t))!re.call(e,r)&&r!==i&&P(e,r,{get:()=>t[r],enumerable:!(a=Q(t,r))||a.enumerable});return e};var ie=(e,t,i)=>(i=e!=null?G(te(e)):{},ae(t||!e||!e.__esModule?P(i,"default",{value:e,enumerable:!0}):i,e));var H=ne((Te,b)=>{(function(){"use strict";let e={fatal:!0},t=[new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("utf-8")],i={debug:!1,parse:function(a,r){if(a instanceof Uint8Array)return i.Uint8(a);if(typeof a=="string")return i.Base64(a);if(a instanceof HTMLElement&&a.type==="file")return i.addListener(a,r);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(a,r){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(a===void 0||!(a instanceof HTMLElement)||a.tagName!=="INPUT"||a.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;r=r||function(){},a.addEventListener("change",function(n){if(!n.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let l=new FileReader;l.readAsArrayBuffer(n.target.files[0]),l.onload=function(c){r(i.Uint8(new Uint8Array(c.target.result)))}})},Base64:function(a){let r=function(c){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(c=c.replace(/^.*?base64,/,""),c=String(c).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(c))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");c+="==".slice(2-(3&c.length));let p,h="",s,o,d=0;for(;d<c.length;)p=f.indexOf(c.charAt(d++))<<18|f.indexOf(c.charAt(d++))<<12|(s=f.indexOf(c.charAt(d++)))<<6|(o=f.indexOf(c.charAt(d++))),h+=s===64?String.fromCharCode(p>>16&255):o===64?String.fromCharCode(p>>16&255,p>>8&255):String.fromCharCode(p>>16&255,p>>8&255,255&p);return h}(a=String(a));var n=r.length;let l=new Uint8Array(new ArrayBuffer(n));for(let c=0;c<n;c++)l[c]=r.charCodeAt(c);return i.Uint8(l)},Uint8:function(l){let r={data:null,pointer:0,movePointer:function(s){return this.pointer+=s,this.pointer},readInt:function(s){if((s=Math.min(s,this.data.byteLength-this.pointer))<1)return-1;let o=0;if(1<s)for(let d=1;d<=s-1;d++)o+=this.data.getUint8(this.pointer)*Math.pow(256,s-d),this.pointer++;return o+=this.data.getUint8(this.pointer),this.pointer++,o},readStr:function(s){let o=new Uint8Array(s),d=!1,u;o.forEach((m,v)=>{o[v]=this.readInt(1)});for(let m=0;m<t.length;m++)if(!d)try{u=t[m].decode(o),d=!0}catch{}return u||"Byte read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let s=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)s=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);var o=this.readInt(1);for(let u=1;u<=d.length;u++)s+=d[d.length-u]*Math.pow(128,u);s+=o}return s}};if(r.data=new DataView(l.buffer,l.byteOffset,l.byteLength),r.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;r.readInt(4);let n={};n.formatType=r.readInt(2),n.tracks=r.readInt(2),n.track=[];var l=r.readInt(1),c=r.readInt(1);128<=l?(n.timeDivision=[],n.timeDivision[0]=l-128,n.timeDivision[1]=c):n.timeDivision=256*l+c;for(let s=1;s<=n.tracks;s++){n.track[s-1]={event:[]};var f,p=r.readInt(4);if(p===-1)break;if(p!==1297379947)return!1;r.readInt(4);let o=0,d=!1,u,m;for(;!d&&(o++,n.track[s-1].event[o-1]={},n.track[s-1].event[o-1].deltaTime=r.readIntVLV(),(u=r.readInt(1))!==-1);)if(128<=u?m=u:(u=m,r.movePointer(-1)),u===255){n.track[s-1].event[o-1].type=255,n.track[s-1].event[o-1].metaType=r.readInt(1);var h=r.readIntVLV();switch(n.track[s-1].event[o-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:n.track[s-1].event[o-1].data=r.readStr(h);break;case 33:case 89:case 81:n.track[s-1].event[o-1].data=r.readInt(h);break;case 84:n.track[s-1].event[o-1].data=[],n.track[s-1].event[o-1].data[0]=r.readInt(1),n.track[s-1].event[o-1].data[1]=r.readInt(1),n.track[s-1].event[o-1].data[2]=r.readInt(1),n.track[s-1].event[o-1].data[3]=r.readInt(1),n.track[s-1].event[o-1].data[4]=r.readInt(1);break;case 88:n.track[s-1].event[o-1].data=[],n.track[s-1].event[o-1].data[0]=r.readInt(1),n.track[s-1].event[o-1].data[1]=r.readInt(1),n.track[s-1].event[o-1].data[2]=r.readInt(1),n.track[s-1].event[o-1].data[3]=r.readInt(1);break;default:this.customInterpreter!==null&&(n.track[s-1].event[o-1].data=this.customInterpreter(n.track[s-1].event[o-1].metaType,r,h)),this.customInterpreter!==null&&n.track[s-1].event[o-1].data!==!1||(r.readInt(h),n.track[s-1].event[o-1].data=r.readInt(h),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((u=u.toString(16).split(""))[1]||u.unshift("0"),n.track[s-1].event[o-1].type=parseInt(u[0],16),n.track[s-1].event[o-1].channel=parseInt(u[1],16),n.track[s-1].event[o-1].type){case 15:this.customInterpreter!==null&&(n.track[s-1].event[o-1].data=this.customInterpreter(n.track[s-1].event[o-1].type,r,!1)),this.customInterpreter!==null&&n.track[s-1].event[o-1].data!==!1||(f=r.readIntVLV(),n.track[s-1].event[o-1].data=r.readInt(f),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:n.track[s-1].event[o-1].data=[],n.track[s-1].event[o-1].data[0]=r.readInt(1),n.track[s-1].event[o-1].data[1]=r.readInt(1);break;case 12:case 13:n.track[s-1].event[o-1].data=r.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(n.track[s-1].event[o-1].data=this.customInterpreter(n.track[s-1].event[o-1].metaType,r,!1)),this.customInterpreter===null||n.track[s-1].event[o-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return n},customInterpreter:null};if(typeof b<"u")b.exports=i;else{let a=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;a.MidiParser=i}})()});DOMTokenList.prototype.on=function(e){!this.contains(e)&&this.toggle(e)};DOMTokenList.prototype.off=function(e){this.contains(e)&&this.toggle(e)};var L=function(e,t=document){return t?.querySelector(e)};var se=Object.defineProperty,y=(e,t)=>()=>(e&&(t=e(e=0)),t),g=(e,t)=>{for(var i in t)se(e,i,{get:t[i],enumerable:!0})},M={};g(M,{default:()=>U});var U,oe=y(()=>{U=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,i)=>{let a=document.createElement("input");a.type="file";let r=[...e.map(f=>f.mimeTypes||[]).join(),e.map(f=>f.extensions||[]).join()].join();a.multiple=e[0].multiple||!1,a.accept=r||"";let n=()=>c(i),l=f=>{typeof c=="function"&&c(),t(f)},c=e[0].legacySetup&&e[0].legacySetup(l,n,a);a.addEventListener("change",()=>{l(a.multiple?Array.from(a.files):a.files[0])}),a.click()}))}),D={};g(D,{default:()=>S});var O,S,le=y(()=>{O=async e=>{let t=await e.getFile();return t.handle=e,t},S=async(e=[{}])=>{Array.isArray(e)||(e=[e]);let t=[];e.forEach((r,n)=>{t[n]={description:r.description||"",accept:{}},r.mimeTypes?r.mimeTypes.map(l=>{t[n].accept[l]=r.extensions||[]}):t[n].accept["*/*"]=r.extensions||[]});let i=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),a=await Promise.all(i.map(O));return e[0].multiple?a:a[0]}}),F={};g(F,{default:()=>C});var C,ce=y(()=>{C=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,i)=>{let a=document.createElement("input");a.type="file",a.webkitdirectory=!0;let r=()=>l(i),n=c=>{typeof l=="function"&&l(),t(c)},l=e[0].legacySetup&&e[0].legacySetup(n,r,a);a.addEventListener("change",()=>{let c=Array.from(a.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(c=c.filter(f=>f.webkitRelativePath.split("/").every(p=>!e[0].skipDirectory({name:p,kind:"directory"})))):c=c.filter(f=>f.webkitRelativePath.split("/").length===2),n(c)}),a.click()}))}),R={};g(R,{default:()=>$});var k,$,de=y(()=>{k=async(e,t,i=e.name,a)=>{let r=[],n=[];for await(let l of e.values()){let c=`${i}/${l.name}`;l.kind==="file"?n.push(l.getFile().then(f=>(f.directoryHandle=e,f.handle=l,Object.defineProperty(f,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):l.kind==="directory"&&t&&(!a||!a(l))&&r.push(k(l,t,c,a))}return[...(await Promise.all(r)).flat(),...await Promise.all(n)]},$=async(e={})=>{e.recursive=e.recursive||!1;let t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn});return k(t,e.recursive,void 0,e.skipDirectory)}}),B={};g(B,{default:()=>N});async function fe(e,t){let i=e.getReader(),a=new ReadableStream({start(n){return l();async function l(){return i.read().then(({done:c,value:f})=>{if(c){n.close();return}return n.enqueue(f),l()})}}}),r=new Response(a);return i.releaseLock(),new Blob([await r.blob()],{type:t})}var N,ue=y(()=>{N=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);let i=document.createElement("a"),a=e;"body"in e&&(a=await fe(e.body,e.headers.get("content-type"))),i.download=t.fileName||"Untitled",i.href=URL.createObjectURL(a);let r=()=>l(reject),n=()=>{typeof l=="function"&&l()},l=t.legacySetup&&t.legacySetup(n,r,i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),30*1e3),n(null)}),i.click(),null}}),V={};g(V,{default:()=>j});var j,pe=y(()=>{j=async(e,t=[{}],i=null,a=!1)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";let r=[];if(t.forEach((c,f)=>{r[f]={description:c.description||"",accept:{}},c.mimeTypes?(f===0&&(e.type?c.mimeTypes.push(e.type):e.headers&&e.headers.get("content-type")&&c.mimeTypes.push(e.headers.get("content-type"))),c.mimeTypes.map(p=>{r[f].accept[p]=c.extensions||[]})):e.type&&(r[f].accept[e.type]=c.extensions||[])}),i)try{await i.getFile()}catch(c){if(i=null,a)throw c}let n=i||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:r,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),l=await n.createWritable();return"stream"in e?(await e.stream().pipeTo(l),n):"body"in e?(await e.body.pipeTo(l),n):(await l.write(blob),await l.close(),n)}}),he=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),I=he,me=I?Promise.resolve().then(()=>(le(),D)):Promise.resolve().then(()=>(oe(),M));async function q(...e){return(await me).default(...e)}var we=I?Promise.resolve().then(()=>(de(),R)):Promise.resolve().then(()=>(ce(),F));var ke=I?Promise.resolve().then(()=>(pe(),V)):Promise.resolve().then(()=>(ue(),B));var z=class{#e={};addEventListener(e,t){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(t)}removeEventListener(e,t){if(this.#e[e]){let i=this.#e[e].indexOf(t);i>-1&&this.#e[e].splice(i,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,t){let i=new Event(e),a=this;i.data=t,this.#e[e]?.length>0&&this.#e[e].forEach(function(r){r?.call(a,i)}),this[`on${e}`]&&this[`on${e}`](i)}};var x=ie(H(),1);var J=class{#e=!1;constructor(e,t,i,a){this.#e=e,this.start=t,this.end=i,this.data=a}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},E=class extends J{constructor(e,t,i){super(!0,e,t,i)}},Z=class extends J{constructor(e,t){super(!1,e,e,t)}},T=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let i=[];if(t)for(let a=0;a<this.length&&!(this[a].start>e);a++){if(this[a].end<e)continue;i.push(this[a])}else{let a=this.getRange(this.#e==-1?0:e-1,e),r=this;a.forEach(function(n){n.index>r.#e&&(i.push(n),r.#e=n.index)})}return i}getRange(e,t){e>t&&([e,t]=[t,e]);let i=[],a=-1,r=Math.ceil(Math.sqrt(this.length)),n=!0;for(let l=0;l<this.length;l+=r)this[l+r]?a<0&&this[l+r].start>=e&&(a=l):a=a<0?l:a;for(;n;)this[a]?.end<t?this[a].start>=e&&i.push(this[a]):n=!1,a++;return i}};var ve=0xffffffffffff,W=function(e){let t=new T,i=this,a=e.timeDivision,r=120,n=new T,l=0,c=0;n.push(new E(0,ve,[120,0])),e.track.forEach(function(s){l=0,s.event.forEach(function(o){l+=o.deltaTime,o.type==255&&o?.metaType==81&&(r=6e7/o.data,n[n.length-1]&&n.push(new E(l,0xffffffffffff,[r,0])))})}),n.fresh(),n.forEach(function(s,o,d){o>0&&(d[o-1].end=s.start)});let f=120;n.forEach(function(s,o,d){o>0&&(s.end==s.start?d.splice(d.indexOf(s),1):f==s.data[0]&&(d[o-1].end=s.end,d.splice(d.indexOf(s),1)),f=s.data[0])});let p=0,h=120;return n.forEach(function(s){let o=s.start,d=o/h/a*60+p;h=s.data[0],p=d-o/h/a*60,s.data[1]=p}),console.debug("All tempo changes: ",n),r=120,l=0,c=0,e.track.forEach(function(s,o){l=0,c=0;let d=o+1;s.event.forEach(function(u,m){l+=u.deltaTime;let v=n.step(l,!0)[0];v&&(r=v.data[0],c=v.data[1]);let w={type:u.type,data:u.data,track:d,part:0};u.type>14?w.meta=u.metaType:w.part=u.channel,t.push(new Z(l/r/a*60+c,w))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};var K=function(e,t,i){let a=[],r=i==!1?t.readIntVLV():i;e==0||e==127;for(let n=0;n<r;n++){let l=t.readInt(1);if(a.push(l),l!=247){if(l!=240){if(l>127)return console.debug(`Early termination: ${a}`),a.pop(),t.backOne(),t.backOne(),new Uint8Array(a)}}}return new Uint8Array(a)};x.default.customInterpreter=K;var X=function(e,t=0){let i=e[0]>>4,a=e[0]&15,r={track:(t&15)+240,type:i,data:e.slice(1)};if(i<15)return r.part=a,r;if(i==12)r.data=e[1];else{if(a==0)return r;console.warn(`Unknown special event channel ${a}.`)}},Y=function(e){let t=e.type,i=e.part;if(t==255)return;let a=3;t==12?a=2:t==15&&(a=e.data.length+1);let r=new Uint8Array(a);return t!=15?r[0]=e.type*16+e.part:r[0]=240,t==12?r[1]=e.data:e.data.forEach?e.data.forEach((n,l)=>{r[l+1]=n}):console.debug(`Type ${t} value ${e.data.constructor.name} cannot be iterated.`),r},A=function(){return new BroadcastChannel("cc.ltgc.octavia:MainInput")};var _=class extends z{#e;#a=!0;#r=0;#n=0;#t=-1;get currentTime(){return this.#r/1e3}get duration(){return this.#e?this.#e[this.#e.length-1].end+4:0}async load(e){e?this.#e=W(x.default.parse(new Uint8Array(await e.arrayBuffer()))):(this.pause(),this.#r=0)}pause(){if(this.#t>-1){clearInterval(this.#t);for(let e=0;e<16;e++)this.dispatchEvent("midi",{delay:0,data:{part:e,type:11,data:[123,0]}});this.dispatchEvent("pause"),this.#t=-1}}async play(){this.#t<0&&(this.#n=Date.now(),this.#t=setInterval(()=>{let e=Date.now(),t=this.#r,i=e-this.#n;this.#r+=i,this.#e.step(this.currentTime)?.forEach(r=>{this.dispatchEvent("midi",{delay:Math.round(r.start*1e3-t),data:r.data})}),this.#n=e},12.5),this.dispatchEvent("play"))}constructor(e){super(),e&&this.load(e)}};(async function(){self.midiAccess=await navigator.requestMIDIAccess({sysex:!0,software:!0}),self.fromJson=Y,self.toJson=X,self.MEE=_,self.inBridge=A(),midiAccess.addEventListener("statechange",t=>{console.info(t.port)}),midiAccess.inputs.forEach((t,i)=>{console.info(`Discovered input ${i}: ${t.name}.`)}),midiAccess.outputs.forEach((t,i)=>{console.info(`Discovered output ${i}: ${t.name}.`)}),self.midiLine=A();let e=JSON.parse('{"extensions":[".mid",".MID",".kar",".KAR",".syx",".SYX"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}');L("#openMidi").addEventListener("click",async function(){let t=await q(e),i=t.name.lastIndexOf("."),a="";i>-1&&(a=t.name.slice(i+1).toLowerCase()),a=="syx"||(self.midiBlob=t)})})();})();
