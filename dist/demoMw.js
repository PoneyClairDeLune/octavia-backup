"use strict";(()=>{var _=Object.create;var x=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var re=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ne=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Q(t))!te.call(e,a)&&a!==n&&x(e,a,{get:()=>t[a],enumerable:!(r=G(t,a))||r.enumerable});return e};var ae=(e,t,n)=>(n=e!=null?_(ee(e)):{},ne(t||!e||!e.__esModule?x(n,"default",{value:e,enumerable:!0}):n,e));var z=re((Te,I)=>{(function(){"use strict";let e={debug:!1,parse:function(t,n){if(t instanceof Uint8Array)return e.Uint8(t);if(typeof t=="string")return e.Base64(t);if(t instanceof HTMLElement&&t.type==="file")return e.addListener(t,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(t,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(t===void 0||!(t instanceof HTMLElement)||t.tagName!=="INPUT"||t.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},t.addEventListener("change",function(r){if(!r.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let a=new FileReader;a.readAsArrayBuffer(r.target.files[0]),a.onload=function(i){n(e.Uint8(new Uint8Array(i.target.result)))}})},Base64:function(t){let n=function(i){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(i=i.replace(/^.*?base64,/,""),i=String(i).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(i))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");i+="==".slice(2-(3&i.length));let c,f="",s,l,d=0;for(;d<i.length;)c=o.indexOf(i.charAt(d++))<<18|o.indexOf(i.charAt(d++))<<12|(s=o.indexOf(i.charAt(d++)))<<6|(l=o.indexOf(i.charAt(d++))),f+=s===64?String.fromCharCode(c>>16&255):l===64?String.fromCharCode(c>>16&255,c>>8&255):String.fromCharCode(c>>16&255,c>>8&255,255&c);return f}(t=String(t));var r=n.length;let a=new Uint8Array(new ArrayBuffer(r));for(let i=0;i<r;i++)a[i]=n.charCodeAt(i);return e.Uint8(a)},Uint8:function(a){let n={data:null,pointer:0,movePointer:function(s){return this.pointer+=s,this.pointer},readInt:function(s){if((s=Math.min(s,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<s)for(let d=1;d<=s-1;d++)l+=this.data.getUint8(this.pointer)*Math.pow(256,s-d),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(s){let l="";for(let d=1;d<=s;d++)l+=String.fromCharCode(this.readInt(1));return l},backOne:function(){this.pointer--},readIntVLV:function(){let s=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)s=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);var l=this.readInt(1);for(let u=1;u<=d.length;u++)s+=d[d.length-u]*Math.pow(128,u);s+=l}return s}};if(n.data=new DataView(a.buffer,a.byteOffset,a.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let r={};r.formatType=n.readInt(2),r.tracks=n.readInt(2),r.track=[];var a=n.readInt(1),i=n.readInt(1);128<=a?(r.timeDivision=[],r.timeDivision[0]=a-128,r.timeDivision[1]=i):r.timeDivision=256*a+i;for(let s=1;s<=r.tracks;s++){r.track[s-1]={event:[]};var o,c=n.readInt(4);if(c===-1)break;if(c!==1297379947)return!1;n.readInt(4);let l=0,d=!1,u,p;for(;!d&&(l++,r.track[s-1].event[l-1]={},r.track[s-1].event[l-1].deltaTime=n.readIntVLV(),(u=n.readInt(1))!==-1);)if(128<=u?p=u:(u=p,n.movePointer(-1)),u===255){r.track[s-1].event[l-1].type=255,r.track[s-1].event[l-1].metaType=n.readInt(1);var f=n.readIntVLV();switch(r.track[s-1].event[l-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:r.track[s-1].event[l-1].data=n.readStr(f);break;case 33:case 89:case 81:r.track[s-1].event[l-1].data=n.readInt(f);break;case 84:r.track[s-1].event[l-1].data=[],r.track[s-1].event[l-1].data[0]=n.readInt(1),r.track[s-1].event[l-1].data[1]=n.readInt(1),r.track[s-1].event[l-1].data[2]=n.readInt(1),r.track[s-1].event[l-1].data[3]=n.readInt(1),r.track[s-1].event[l-1].data[4]=n.readInt(1);break;case 88:r.track[s-1].event[l-1].data=[],r.track[s-1].event[l-1].data[0]=n.readInt(1),r.track[s-1].event[l-1].data[1]=n.readInt(1),r.track[s-1].event[l-1].data[2]=n.readInt(1),r.track[s-1].event[l-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(r.track[s-1].event[l-1].data=this.customInterpreter(r.track[s-1].event[l-1].metaType,n,f)),this.customInterpreter!==null&&r.track[s-1].event[l-1].data!==!1||(n.readInt(f),r.track[s-1].event[l-1].data=n.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((u=u.toString(16).split(""))[1]||u.unshift("0"),r.track[s-1].event[l-1].type=parseInt(u[0],16),r.track[s-1].event[l-1].channel=parseInt(u[1],16),r.track[s-1].event[l-1].type){case 15:this.customInterpreter!==null&&(r.track[s-1].event[l-1].data=this.customInterpreter(r.track[s-1].event[l-1].type,n,!1)),this.customInterpreter!==null&&r.track[s-1].event[l-1].data!==!1||(o=n.readIntVLV(),r.track[s-1].event[l-1].data=n.readInt(o),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:r.track[s-1].event[l-1].data=[],r.track[s-1].event[l-1].data[0]=n.readInt(1),r.track[s-1].event[l-1].data[1]=n.readInt(1);break;case 12:case 13:r.track[s-1].event[l-1].data=n.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(r.track[s-1].event[l-1].data=this.customInterpreter(r.track[s-1].event[l-1].metaType,n,!1)),this.customInterpreter===null||r.track[s-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return r},customInterpreter:null};if(typeof I<"u")I.exports=e;else{let t=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;t.MidiParser=e}})()});DOMTokenList.prototype.on=function(e){!this.contains(e)&&this.toggle(e)};DOMTokenList.prototype.off=function(e){this.contains(e)&&this.toggle(e)};var P=function(e,t=document){return t?.querySelector(e)};var ie=Object.defineProperty,m=(e,t)=>()=>(e&&(t=e(e=0)),t),v=(e,t)=>{for(var n in t)ie(e,n,{get:t[n],enumerable:!0})},O={};v(O,{default:()=>M});var M,se=m(()=>{M=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,n)=>{let r=document.createElement("input");r.type="file";let a=[...e.map(f=>f.mimeTypes||[]).join(),e.map(f=>f.extensions||[]).join()].join();r.multiple=e[0].multiple||!1,r.accept=a||"";let i=()=>c(n),o=f=>{typeof c=="function"&&c(),t(f)},c=e[0].legacySetup&&e[0].legacySetup(o,i,r);r.addEventListener("change",()=>{o(r.multiple?Array.from(r.files):r.files[0])}),r.click()}))}),U={};v(U,{default:()=>D});var L,D,oe=m(()=>{L=async e=>{let t=await e.getFile();return t.handle=e,t},D=async(e=[{}])=>{Array.isArray(e)||(e=[e]);let t=[];e.forEach((a,i)=>{t[i]={description:a.description||"",accept:{}},a.mimeTypes?a.mimeTypes.map(o=>{t[i].accept[o]=a.extensions||[]}):t[i].accept["*/*"]=a.extensions||[]});let n=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(n.map(L));return e[0].multiple?r:r[0]}}),S={};v(S,{default:()=>C});var C,le=m(()=>{C=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,n)=>{let r=document.createElement("input");r.type="file",r.webkitdirectory=!0;let a=()=>o(n),i=c=>{typeof o=="function"&&o(),t(c)},o=e[0].legacySetup&&e[0].legacySetup(i,a,r);r.addEventListener("change",()=>{let c=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(c=c.filter(f=>f.webkitRelativePath.split("/").every(s=>!e[0].skipDirectory({name:s,kind:"directory"})))):c=c.filter(f=>f.webkitRelativePath.split("/").length===2),i(c)}),r.click()}))}),F={};v(F,{default:()=>R});var w,R,ce=m(()=>{w=async(e,t,n=e.name,r)=>{let a=[],i=[];for await(let o of e.values()){let c=`${n}/${o.name}`;o.kind==="file"?i.push(o.getFile().then(f=>(f.directoryHandle=e,f.handle=o,Object.defineProperty(f,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):o.kind==="directory"&&t&&(!r||!r(o))&&a.push(w(o,t,c,r))}return[...(await Promise.all(a)).flat(),...await Promise.all(i)]},R=async(e={})=>{e.recursive=e.recursive||!1;let t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn});return w(t,e.recursive,void 0,e.skipDirectory)}}),$={};v($,{default:()=>B});async function de(e,t){let n=e.getReader(),r=new ReadableStream({start(i){return o();async function o(){return n.read().then(({done:c,value:f})=>{if(c){i.close();return}return i.enqueue(f),o()})}}}),a=new Response(r);return n.releaseLock(),new Blob([await a.blob()],{type:t})}var B,fe=m(()=>{B=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);let n=document.createElement("a"),r=e;"body"in e&&(r=await de(e.body,e.headers.get("content-type"))),n.download=t.fileName||"Untitled",n.href=URL.createObjectURL(r);let a=()=>o(reject),i=()=>{typeof o=="function"&&o()},o=t.legacySetup&&t.legacySetup(i,a,n);return n.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(n.href),30*1e3),i(null)}),n.click(),null}}),N={};v(N,{default:()=>V});var V,ue=m(()=>{V=async(e,t=[{}],n=null,r=!1)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";let a=[];if(t.forEach((c,f)=>{a[f]={description:c.description||"",accept:{}},c.mimeTypes?(f===0&&(e.type?c.mimeTypes.push(e.type):e.headers&&e.headers.get("content-type")&&c.mimeTypes.push(e.headers.get("content-type"))),c.mimeTypes.map(s=>{a[f].accept[s]=c.extensions||[]})):e.type&&(a[f].accept[e.type]=c.extensions||[])}),n)try{await n.getFile()}catch(c){if(n=null,r)throw c}let i=n||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:a,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),o=await i.createWritable();return"stream"in e?(await e.stream().pipeTo(o),i):"body"in e?(await e.body.pipeTo(o),i):(await o.write(blob),await o.close(),i)}}),pe=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),k=pe,he=k?Promise.resolve().then(()=>(oe(),U)):Promise.resolve().then(()=>(se(),O));async function j(...e){return(await he).default(...e)}var we=k?Promise.resolve().then(()=>(ce(),F)):Promise.resolve().then(()=>(le(),S));var ke=k?Promise.resolve().then(()=>(ue(),N)):Promise.resolve().then(()=>(fe(),$));var q=class{#e={};addEventListener(e,t){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(t)}removeEventListener(e,t){if(this.#e[e]){let n=this.#e[e].indexOf(t);n>-1&&this.#e[e].splice(n,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,t){let n=new Event(e),r=this;n.data=t,this.#e[e]?.length>0&&this.#e[e].forEach(function(a){a?.call(r,n)}),this[`on${e}`]&&this[`on${e}`](n)}};var T=ae(z(),1);var H=class{#e=!1;constructor(e,t,n,r){this.#e=e,this.start=t,this.end=n,this.data=r}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},b=class extends H{constructor(e,t,n){super(!0,e,t,n)}},J=class extends H{constructor(e,t){super(!1,e,e,t)}},E=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let n=[];if(t)for(let r=0;r<this.length&&!(this[r].start>e);r++){if(this[r].end<e)continue;n.push(this[r])}else{let r=this.getRange(this.#e==-1?0:e-1,e),a=this;r.forEach(function(i){i.index>a.#e&&(n.push(i),a.#e=i.index)})}return n}getRange(e,t){e>t&&([e,t]=[t,e]);let n=[],r=-1,a=Math.ceil(Math.sqrt(this.length)),i=!0;for(let o=0;o<this.length;o+=a)this[o+a]?r<0&&this[o+a].start>=e&&(r=o):r=r<0?o:r;for(;i;)this[r]?.end<t?this[r].start>=e&&n.push(this[r]):i=!1,r++;return n}};var me=0xffffffffffff,Z=function(e){let t=new E,n=this,r=e.timeDivision,a=120,i=new E,o=0,c=0;i.push(new b(0,me,[120,0])),e.track.forEach(function(d){o=0,d.event.forEach(function(u){o+=u.deltaTime,u.type==255&&u?.metaType==81&&(a=6e7/u.data,i[i.length-1]&&i.push(new b(o,0xffffffffffff,[a,0])))})}),i.fresh(),i.forEach(function(d,u,p){u>0&&(p[u-1].end=d.start)});let f=120;i.forEach(function(d,u,p){u>0&&(d.end==d.start?p.splice(p.indexOf(d),1):f==d.data[0]&&(p[u-1].end=d.end,p.splice(p.indexOf(d),1)),f=d.data[0])});let s=0,l=120;return i.forEach(function(d){let u=d.start,p=u/l/r*60+s;l=d.data[0],s=p-u/l/r*60,d.data[1]=s}),console.debug("All tempo changes: ",i),a=120,o=0,c=0,e.track.forEach(function(d,u){o=0,c=0;let p=u+1;d.event.forEach(function(h,ve){o+=h.deltaTime;let y=i.step(o,!0)[0];y&&(a=y.data[0],c=y.data[1]);let g={type:h.type,data:h.data,track:p,part:0};h.type>14?g.meta=h.metaType:g.part=h.channel,t.push(new J(o/a/r*60+c,g))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};var W=function(e,t,n){let r=[],a=n==!1?t.readIntVLV():n;e==0||e==127;for(let i=0;i<a;i++){let o=t.readInt(1);if(r.push(o),o!=247){if(o!=240){if(o>127)return console.debug(`Early termination: ${r}`),r.pop(),t.backOne(),t.backOne(),new Uint8Array(r)}}}return new Uint8Array(r)};T.default.customInterpreter=W;var K=function(e,t=0){let n=e[0]>>4,r=e[0]&15,a={track:(t&15)+240,type:n,data:e.slice(1)};if(n<15)return a.part=r,a;if(n==12)a.data=e[1];else{if(r==0)return a;console.warn(`Unknown special event channel ${r}.`)}},X=function(e){let t=e.type,n=e.part;if(t==255)return;let r=3;t==12?r=2:t==15&&(r=e.data.length+1);let a=new Uint8Array(r);return t!=15?a[0]=e.type*16+e.part:a[0]=240,t==12?a[1]=e.data:e.data.forEach?e.data.forEach((i,o)=>{a[o+1]=i}):console.debug(`Type ${t} value ${e.data.constructor.name} cannot be iterated.`),a},A=function(){return new BroadcastChannel("cc.ltgc.octavia:MainInput")};var Y=class extends q{#e;#a=!0;#r=0;#n=0;#t=-1;get currentTime(){return this.#r/1e3}get duration(){return this.#e?this.#e[this.#e.length-1].end+4:0}async load(e){e?this.#e=Z(T.default.parse(new Uint8Array(await e.arrayBuffer()))):(this.pause(),this.#r=0)}pause(){if(this.#t>-1){clearInterval(this.#t);for(let e=0;e<16;e++)this.dispatchEvent("midi",{delay:0,data:{part:e,type:11,data:[123,0]}});this.dispatchEvent("pause"),this.#t=-1}}async play(){this.#t<0&&(this.#n=Date.now(),this.#t=setInterval(()=>{let e=Date.now(),t=this.#r,n=e-this.#n;this.#r+=n,this.#e.step(this.currentTime)?.forEach(a=>{this.dispatchEvent("midi",{delay:Math.round(a.start*1e3-t),data:a.data})}),this.#n=e},12.5),this.dispatchEvent("play"))}constructor(e){super(),e&&this.load(e)}};(async function(){self.midiAccess=await navigator.requestMIDIAccess({sysex:!0,software:!0}),self.fromJson=X,self.toJson=K,self.MEE=Y,self.inBridge=A(),midiAccess.addEventListener("statechange",t=>{console.info(t.port)}),midiAccess.inputs.forEach((t,n)=>{console.info(`Discovered input ${n}: ${t.name}.`)}),midiAccess.outputs.forEach((t,n)=>{console.info(`Discovered output ${n}: ${t.name}.`)}),self.midiLine=A();let e=JSON.parse('{"extensions":[".mid",".MID",".kar",".KAR",".syx",".SYX"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}');P("#openMidi").addEventListener("click",async function(){let t=await j(e),n=t.name.lastIndexOf("."),r="";n>-1&&(r=t.name.slice(n+1).toLowerCase()),r=="syx"||(self.midiBlob=t)})})();})();
