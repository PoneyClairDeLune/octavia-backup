"use strict";(()=>{var Y=Object.create;var x=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var te=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var re=(e,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of G(t))!ee.call(e,n)&&n!==a&&x(e,n,{get:()=>t[n],enumerable:!(r=_(t,n))||r.enumerable});return e};var ae=(e,t,a)=>(a=e!=null?Y(Q(e)):{},re(t||!e||!e.__esModule?x(a,"default",{value:e,enumerable:!0}):a,e));var z=te((Ee,I)=>{(function(){"use strict";let e={debug:!1,parse:function(t,a){if(t instanceof Uint8Array)return e.Uint8(t);if(typeof t=="string")return e.Base64(t);if(t instanceof HTMLElement&&t.type==="file")return e.addListener(t,a);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(t,a){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(t===void 0||!(t instanceof HTMLElement)||t.tagName!=="INPUT"||t.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;a=a||function(){},t.addEventListener("change",function(r){if(!r.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let n=new FileReader;n.readAsArrayBuffer(r.target.files[0]),n.onload=function(i){a(e.Uint8(new Uint8Array(i.target.result)))}})},Base64:function(t){let a=function(i){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(i=i.replace(/^.*?base64,/,""),i=String(i).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(i))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");i+="==".slice(2-(3&i.length));let c,f="",s,l,d=0;for(;d<i.length;)c=o.indexOf(i.charAt(d++))<<18|o.indexOf(i.charAt(d++))<<12|(s=o.indexOf(i.charAt(d++)))<<6|(l=o.indexOf(i.charAt(d++))),f+=s===64?String.fromCharCode(c>>16&255):l===64?String.fromCharCode(c>>16&255,c>>8&255):String.fromCharCode(c>>16&255,c>>8&255,255&c);return f}(t=String(t));var r=a.length;let n=new Uint8Array(new ArrayBuffer(r));for(let i=0;i<r;i++)n[i]=a.charCodeAt(i);return e.Uint8(n)},Uint8:function(n){let a={data:null,pointer:0,movePointer:function(s){return this.pointer+=s,this.pointer},readInt:function(s){if((s=Math.min(s,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<s)for(let d=1;d<=s-1;d++)l+=this.data.getUint8(this.pointer)*Math.pow(256,s-d),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(s){let l="";for(let d=1;d<=s;d++)l+=String.fromCharCode(this.readInt(1));return l},backOne:function(){this.pointer--},readIntVLV:function(){let s=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)s=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);var l=this.readInt(1);for(let u=1;u<=d.length;u++)s+=d[d.length-u]*Math.pow(128,u);s+=l}return s}};if(a.data=new DataView(n.buffer,n.byteOffset,n.byteLength),a.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;a.readInt(4);let r={};r.formatType=a.readInt(2),r.tracks=a.readInt(2),r.track=[];var n=a.readInt(1),i=a.readInt(1);128<=n?(r.timeDivision=[],r.timeDivision[0]=n-128,r.timeDivision[1]=i):r.timeDivision=256*n+i;for(let s=1;s<=r.tracks;s++){r.track[s-1]={event:[]};var o,c=a.readInt(4);if(c===-1)break;if(c!==1297379947)return!1;a.readInt(4);let l=0,d=!1,u,p;for(;!d&&(l++,r.track[s-1].event[l-1]={},r.track[s-1].event[l-1].deltaTime=a.readIntVLV(),(u=a.readInt(1))!==-1);)if(128<=u?p=u:(u=p,a.movePointer(-1)),u===255){r.track[s-1].event[l-1].type=255,r.track[s-1].event[l-1].metaType=a.readInt(1);var f=a.readIntVLV();switch(r.track[s-1].event[l-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:r.track[s-1].event[l-1].data=a.readStr(f);break;case 33:case 89:case 81:r.track[s-1].event[l-1].data=a.readInt(f);break;case 84:r.track[s-1].event[l-1].data=[],r.track[s-1].event[l-1].data[0]=a.readInt(1),r.track[s-1].event[l-1].data[1]=a.readInt(1),r.track[s-1].event[l-1].data[2]=a.readInt(1),r.track[s-1].event[l-1].data[3]=a.readInt(1),r.track[s-1].event[l-1].data[4]=a.readInt(1);break;case 88:r.track[s-1].event[l-1].data=[],r.track[s-1].event[l-1].data[0]=a.readInt(1),r.track[s-1].event[l-1].data[1]=a.readInt(1),r.track[s-1].event[l-1].data[2]=a.readInt(1),r.track[s-1].event[l-1].data[3]=a.readInt(1);break;default:this.customInterpreter!==null&&(r.track[s-1].event[l-1].data=this.customInterpreter(r.track[s-1].event[l-1].metaType,a,f)),this.customInterpreter!==null&&r.track[s-1].event[l-1].data!==!1||(a.readInt(f),r.track[s-1].event[l-1].data=a.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((u=u.toString(16).split(""))[1]||u.unshift("0"),r.track[s-1].event[l-1].type=parseInt(u[0],16),r.track[s-1].event[l-1].channel=parseInt(u[1],16),r.track[s-1].event[l-1].type){case 15:this.customInterpreter!==null&&(r.track[s-1].event[l-1].data=this.customInterpreter(r.track[s-1].event[l-1].type,a,!1)),this.customInterpreter!==null&&r.track[s-1].event[l-1].data!==!1||(o=a.readIntVLV(),r.track[s-1].event[l-1].data=a.readInt(o),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:r.track[s-1].event[l-1].data=[],r.track[s-1].event[l-1].data[0]=a.readInt(1),r.track[s-1].event[l-1].data[1]=a.readInt(1);break;case 12:case 13:r.track[s-1].event[l-1].data=a.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(r.track[s-1].event[l-1].data=this.customInterpreter(r.track[s-1].event[l-1].metaType,a,!1)),this.customInterpreter===null||r.track[s-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return r},customInterpreter:null};if(typeof I<"u")I.exports=e;else{let t=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;t.MidiParser=e}})()});DOMTokenList.prototype.on=function(e){!this.contains(e)&&this.toggle(e)};DOMTokenList.prototype.off=function(e){this.contains(e)&&this.toggle(e)};var P=function(e,t=document){return t?.querySelector(e)};var ne=Object.defineProperty,m=(e,t)=>()=>(e&&(t=e(e=0)),t),v=(e,t)=>{for(var a in t)ne(e,a,{get:t[a],enumerable:!0})},L={};v(L,{default:()=>M});var M,ie=m(()=>{M=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,a)=>{let r=document.createElement("input");r.type="file";let n=[...e.map(f=>f.mimeTypes||[]).join(),e.map(f=>f.extensions||[]).join()].join();r.multiple=e[0].multiple||!1,r.accept=n||"";let i=()=>c(a),o=f=>{typeof c=="function"&&c(),t(f)},c=e[0].legacySetup&&e[0].legacySetup(o,i,r);r.addEventListener("change",()=>{o(r.multiple?Array.from(r.files):r.files[0])}),r.click()}))}),U={};v(U,{default:()=>S});var O,S,se=m(()=>{O=async e=>{let t=await e.getFile();return t.handle=e,t},S=async(e=[{}])=>{Array.isArray(e)||(e=[e]);let t=[];e.forEach((n,i)=>{t[i]={description:n.description||"",accept:{}},n.mimeTypes?n.mimeTypes.map(o=>{t[i].accept[o]=n.extensions||[]}):t[i].accept["*/*"]=n.extensions||[]});let a=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(a.map(O));return e[0].multiple?r:r[0]}}),D={};v(D,{default:()=>C});var C,oe=m(()=>{C=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,a)=>{let r=document.createElement("input");r.type="file",r.webkitdirectory=!0;let n=()=>o(a),i=c=>{typeof o=="function"&&o(),t(c)},o=e[0].legacySetup&&e[0].legacySetup(i,n,r);r.addEventListener("change",()=>{let c=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(c=c.filter(f=>f.webkitRelativePath.split("/").every(s=>!e[0].skipDirectory({name:s,kind:"directory"})))):c=c.filter(f=>f.webkitRelativePath.split("/").length===2),i(c)}),r.click()}))}),F={};v(F,{default:()=>R});var w,R,le=m(()=>{w=async(e,t,a=e.name,r)=>{let n=[],i=[];for await(let o of e.values()){let c=`${a}/${o.name}`;o.kind==="file"?i.push(o.getFile().then(f=>(f.directoryHandle=e,f.handle=o,Object.defineProperty(f,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):o.kind==="directory"&&t&&(!r||!r(o))&&n.push(w(o,t,c,r))}return[...(await Promise.all(n)).flat(),...await Promise.all(i)]},R=async(e={})=>{e.recursive=e.recursive||!1;let t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn});return w(t,e.recursive,void 0,e.skipDirectory)}}),$={};v($,{default:()=>B});async function ce(e,t){let a=e.getReader(),r=new ReadableStream({start(i){return o();async function o(){return a.read().then(({done:c,value:f})=>{if(c){i.close();return}return i.enqueue(f),o()})}}}),n=new Response(r);return a.releaseLock(),new Blob([await n.blob()],{type:t})}var B,de=m(()=>{B=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);let a=document.createElement("a"),r=e;"body"in e&&(r=await ce(e.body,e.headers.get("content-type"))),a.download=t.fileName||"Untitled",a.href=URL.createObjectURL(r);let n=()=>o(reject),i=()=>{typeof o=="function"&&o()},o=t.legacySetup&&t.legacySetup(i,n,a);return a.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(a.href),30*1e3),i(null)}),a.click(),null}}),N={};v(N,{default:()=>V});var V,fe=m(()=>{V=async(e,t=[{}],a=null,r=!1)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";let n=[];if(t.forEach((c,f)=>{n[f]={description:c.description||"",accept:{}},c.mimeTypes?(f===0&&(e.type?c.mimeTypes.push(e.type):e.headers&&e.headers.get("content-type")&&c.mimeTypes.push(e.headers.get("content-type"))),c.mimeTypes.map(s=>{n[f].accept[s]=c.extensions||[]})):e.type&&(n[f].accept[e.type]=c.extensions||[])}),a)try{await a.getFile()}catch(c){if(a=null,r)throw c}let i=a||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:n,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),o=await i.createWritable();return"stream"in e?(await e.stream().pipeTo(o),i):"body"in e?(await e.body.pipeTo(o),i):(await o.write(blob),await o.close(),i)}}),ue=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),k=ue,pe=k?Promise.resolve().then(()=>(se(),U)):Promise.resolve().then(()=>(ie(),L));async function j(...e){return(await pe).default(...e)}var ge=k?Promise.resolve().then(()=>(le(),F)):Promise.resolve().then(()=>(oe(),D));var we=k?Promise.resolve().then(()=>(fe(),N)):Promise.resolve().then(()=>(de(),$));var q=class{#e={};addEventListener(e,t){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(t)}removeEventListener(e,t){if(this.#e[e]){let a=this.#e[e].indexOf(t);a>-1&&this.#e[e].splice(a,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,t){let a=new Event(e),r=this;a.data=t,this.#e[e]?.length>0&&this.#e[e].forEach(function(n){n?.call(r,a)}),this[`on${e}`]&&this[`on${e}`](a)}};var T=ae(z(),1);var H=class{#e=!1;constructor(e,t,a,r){this.#e=e,this.start=t,this.end=a,this.data=r}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},b=class extends H{constructor(e,t,a){super(!0,e,t,a)}},J=class extends H{constructor(e,t){super(!1,e,e,t)}},E=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let a=[];if(t)for(let r=0;r<this.length&&!(this[r].start>e);r++){if(this[r].end<e)continue;a.push(this[r])}else{let r=this.getRange(this.#e==-1?0:e-1,e),n=this;r.forEach(function(i){i.index>n.#e&&(a.push(i),n.#e=i.index)})}return a}getRange(e,t){e>t&&([e,t]=[t,e]);let a=[],r=-1,n=Math.ceil(Math.sqrt(this.length)),i=!0;for(let o=0;o<this.length;o+=n)this[o+n]?r<0&&this[o+n].start>=e&&(r=o):r=r<0?o:r;for(;i;)this[r]?.end<t?this[r].start>=e&&a.push(this[r]):i=!1,r++;return a}};var he=0xffffffffffff,Z=function(e){let t=new E,a=this,r=e.timeDivision,n=120,i=new E,o=0,c=0;i.push(new b(0,he,[120,0])),e.track.forEach(function(d){o=0,d.event.forEach(function(u){o+=u.deltaTime,u.type==255&&u?.metaType==81&&(n=6e7/u.data,i[i.length-1]&&i.push(new b(o,0xffffffffffff,[n,0])))})}),i.fresh(),i.forEach(function(d,u,p){u>0&&(p[u-1].end=d.start)});let f=120;i.forEach(function(d,u,p){u>0&&(d.end==d.start?p.splice(p.indexOf(d),1):f==d.data[0]&&(p[u-1].end=d.end,p.splice(p.indexOf(d),1)),f=d.data[0])});let s=0,l=120;return i.forEach(function(d){let u=d.start,p=u/l/r*60+s;l=d.data[0],s=p-u/l/r*60,d.data[1]=s}),console.debug("All tempo changes: ",i),n=120,o=0,c=0,e.track.forEach(function(d,u){o=0,c=0;let p=u+1;d.event.forEach(function(h,me){o+=h.deltaTime;let y=i.step(o,!0)[0];y&&(n=y.data[0],c=y.data[1]);let g={type:h.type,data:h.data,track:p,part:0};h.type>14?g.meta=h.metaType:g.part=h.channel,t.push(new J(o/n/r*60+c,g))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};T.default.customInterpreter=function(e,t,a){let r=[],n=a==!1?t.readIntVLV():a;e==0||e==127;for(let i=0;i<n;i++){let o=t.readInt(1);if(r.push(o),o!=247){if(o!=240){if(o>127)return console.debug(`Early termination: ${r}`),r.pop(),t.backOne(),t.backOne(),r}}}return r};var W=function(e,t=0){let a=e[0]>>4,r=e[0]&15,n={track:(t&15)+240,type:a,data:e.slice(1)};if(a<15)return n.part=r,n;if(a==12)n.data=e[1];else{if(r==0)return n;console.warn(`Unknown special event channel ${r}.`)}},K=function(e){let t=e.type,a=e.part;if(t==255)return;let r=3;t==12?r=2:t==15&&(r=e.data.length+1);let n=new Uint8Array(r);return t!=15?n[0]=e.type*16+e.part:n[0]=240,t==12?n[1]=e.data:e.data.forEach?e.data.forEach((i,o)=>{n[o+1]=i}):console.debug(`Type ${t} value ${e.data.constructor.name} cannot be iterated.`),n},A=function(){return new BroadcastChannel("cc.ltgc.octavia:MainInput")};var X=class extends q{#e;#n=!0;#r=0;#a=0;#t=-1;get currentTime(){return this.#r/1e3}get duration(){return this.#e?this.#e[this.#e.length-1].end+4:0}async load(e){e?this.#e=Z(T.default.parse(new Uint8Array(await e.arrayBuffer()))):(this.pause(),this.#r=0)}pause(){if(this.#t>-1){clearInterval(this.#t);for(let e=0;e<16;e++)this.dispatchEvent("midi",{delay:0,data:{part:e,type:11,data:[123,0]}});this.dispatchEvent("pause"),this.#t=-1}}async play(){this.#t<0&&(this.#a=Date.now(),this.#t=setInterval(()=>{let e=Date.now(),t=this.#r,a=e-this.#a;this.#r+=a,this.#e.step(this.currentTime)?.forEach(n=>{this.dispatchEvent("midi",{delay:Math.round(n.start*1e3-t),data:n.data})}),this.#a=e},12.5),this.dispatchEvent("play"))}constructor(e){super(),e&&this.load(e)}};(async function(){self.midiAccess=await navigator.requestMIDIAccess({sysex:!0,software:!0}),self.fromJson=K,self.toJson=W,self.MEE=X,self.inBridge=A(),midiAccess.addEventListener("statechange",t=>{console.info(t.port)}),midiAccess.inputs.forEach((t,a)=>{console.info(`Discovered input ${a}: ${t.name}.`)}),midiAccess.outputs.forEach((t,a)=>{console.info(`Discovered output ${a}: ${t.name}.`)}),self.midiLine=A();let e=JSON.parse('{"extensions":[".mid",".MID",".kar",".KAR",".syx",".SYX"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}');P("#openMidi").addEventListener("click",async function(){let t=await j(e),a=t.name.lastIndexOf("."),r="";a>-1&&(r=t.name.slice(a+1).toLowerCase()),r=="syx"||(self.midiBlob=t)})})();})();
