var d=function(t,i){let e=Math.min(t.length,i.length),s=t.slice(0,e),n=i.slice(0,e),o=0,h=0;for(;h<e&&o==0;)o=Math.sign(s[h]-n[h]),h++;return o},l=function(){this.pool=[],this.point=function(t,i=!1){if(this.pool.length>0){let e=this.pool.length,s=1<<Math.floor(Math.log2(e)),n=s,o=64;for(;s>=1&&o>=0;){if(o<=0)throw new Error("TTL reached.");if(n==e)n-=s;else{let a=d(t,this.pool[n]);switch(a){case 0:{o=0;break}case 1:{n+s<=e&&(n+=s);break}case-1:{n!=0&&(n-=s);break}default:console.warn(`Unexpected result ${a}.`)}}s=s>>1,o--}let h=!0;if(n>=this.pool.length)h=!1;else{let a=this;this.pool[n].forEach(function(r,g,x){h&&r!=t[g]&&(h=!1)}),!h&&d(t,this.pool[n])>0&&n++}return h||i?n:-1}else return i?0:-1},this.add=function(t,i){return t.data=i,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let i=this.point(t);if(i>-1)return this.pool[i].data;this.default(t)},this.run=function(t,...i){let e=this.point(t);e>-1?this.pool[e].data(t.slice(this.pool[e].length),...i):this.default(t,...i)}};var p=class{#t={};addEventListener(t,i){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(i)}removeEventListener(t,i){if(this.#t[t]){let e=this.#t[t].indexOf(i);e>-1&&this.#t[t].splice(e,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,i){let e=new Event(t),s=this;e.data=i,this.#t[t]?.length>0&&this.#t[t].forEach(function(n){n?.call(s,e)}),this[`on${t}`]&&this[`on${t}`](e)}};var f=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw"],u={};f.forEach(function(t,i){u[t]=i});var m=[[0,0,0,0,0,0,0,56,82,81],[0,0,0,0,0,127,0,0,0,0]],M=[0,32,81,84,88,89],c=function(t,i,e){e[i]=0},E=function(t){let i=[[]];return t?.forEach(function(e){e==247||(e==240?i.push([]):i[i.length-1].push(e))}),i},w=function(t,i="",e="",s=2){return t?`${i}${t.toString().padStart(s,"0")}${e}`:""},I=class extends p{#t=0;#c=new Array(256);#l=0;#a=new Array(64);#s=new Uint8ClampedArray(8192);#p=new Uint8ClampedArray(64);#h=new Uint8ClampedArray(8192);#e=new Uint16Array(512);#E=new Int16Array(64);#f=new Array(64);#m=0;#w=0;#g=100;#u=0;#d="";#M=0;#n=[];#o=[];#x={8:function(t){let i=t.part*128+t.data[0],e=this.#e.indexOf(i);e>-1&&(this.#e[e]=0,this.#h[i]=0)},9:function(t){this.#a[t.part]=1;let i=t.part*128+t.data[0];if(t.data[1]>0){let e=0;for(;this.#e[e]>0;)e++;e<512?(this.#e[e]=i,this.#h[i]=t.data[1]):console.error("Polyphony exceeded.")}else{let e=this.#e.indexOf(i);e>-1&&(this.#e[e]=0,this.#h[i]=0)}},10:function(t){let i=t.part*128+t.data[0];this.#e.indexOf(i)>-1&&(this.#h[i]=data[1])},11:function(t){this.#a[t.part]=1,t.data[0]==0&&t.part%16==9&&this.#t==u.gs&&(t.data[1]=120),this.#s[t.part*128+t.data[0]]=t.data[1]},12:function(t){this.#a[t.part]=1,this.#p[t.part]=t.data,this.#f[t.part]=0},13:function(t){let i=this;this.#e.forEach(function(e){let s=e>>7;t.part==s&&(i.#h[e]=t.data)}),console.info(t)},14:function(t){this.#E[t.part]=t.data[1]*128+t.data[0]-8192},15:function(t){let i=this;E(t.data).forEach(function(e){i.#r.run(e)})},255:function(t){if((this.#o[t.meta]||console.debug).call(this,t.data),M.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#r;#b;#i;getActive(){let t=this.#a.slice();return this.#t==u.mt32&&(t[0]=0),t}getCc(t){let i=t*128,e=Array.from(this.#s).slice(i,i+128);return e[0]=e[0]||this.#m,e[32]=e[32]||this.#w,e}getPitch(){return Array.from(this.#E)}getProgram(){return Array.from(this.#p)}getTexts(){return this.#n.slice()}getVel(t){let i=new Map,e=this;return this.#e.forEach(function(s){let n=s>>7,o=s&127;t==n&&e.#h[s]>0&&i.set(o,e.#h[s])}),i}getBitmap(){return{bitmap:this.#c.slice(),expire:this.#l}}getCustomNames(){return this.#f.slice()}getLetter(){return{text:this.#d,expire:this.#M}}getMode(){return f[this.#t]}getMaster(){return{volume:this.#g}}init(){this.dispatchEvent("mode","?"),this.#t=0,this.#m=0,this.#w=0,this.#u=0,this.#a.forEach(c),this.#s.forEach(c),this.#p.forEach(c),this.#h.forEach(c),this.#e.forEach(c),this.#g=100,this.#n=[],this.#M=0,this.#d="",this.#l=0,this.#c.forEach(c),this.#f.forEach(c),this.#s[1152]=127;for(let t=0;t<64;t++)this.#s[t*128+7]=127,this.#s[t*128+11]=127,this.#s[t*128+74]=127,this.#s[t*128+10]=127}switchMode(t,i=!1){let e=f.indexOf(t);if(e>-1)(this.#t==0||i)&&(this.#t=e,this.#m=m[0][e],this.#w=m[1][e],this.dispatchEvent("mode",t));else throw new Error(`Unknown mode ${t}`)}runJson(t){return this.#x[t.type].call(this,t)}runRaw(t){}constructor(){super();let t=this;self.seeReg=function(i){return Array.from(t.#s).slice(i*128,i*128+128)},this.#r=new l,this.#b=new l,this.#i=new l,this.#r.default=console.debug,this.#o[1]=function(i){this.#n.unshift(i)},this.#o[2]=function(i){this.#n.unshift(`Copyrite: ${i}`)},this.#o[3]=function(i){this.#n.unshift(`Trk.Info: ${i}`)},this.#o[4]=function(i){this.#n.unshift(`${w(this.#u,""," ")}Instrmnt: ${i}`)},this.#o[5]=function(i){this.#n.unshift(`C.Lyrics: ${i}`)},this.#o[6]=function(i){this.#n.unshift(`${w(this.#u,""," ")}C.Marker: ${i}`)},this.#o[7]=function(i){this.#n.unshift(`CuePoint: ${i}`)},this.#o[32]=function(i){this.#u=i[0]+1},this.#r.add([126,127,9,1],function(){t.switchMode("gm",!0),console.info("MIDI reset: GM")}).add([126,127,9,3],function(){t.switchMode("g2",!0),console.info("MIDI reset: GM2")}).add([65,16,22,18,127,1],function(){t.switchMode("mt32",!0),console.info("MIDI reset: MT-32")}).add([65,16,66,18,64,0,127,0,65],function(){t.switchMode("gs",!0),console.info("MIDI reset: GS")}).add([66,48,66,52,0],function(i){t.switchMode("ns5r",!0),console.info("KORG reset:",i)}).add([67,16,76,0,0,126,0],function(i){t.switchMode("xg",!0),console.info("MIDI reset: XG")}),this.#r.add([127,127,4,1],function(i){t.switchMode("gm"),t.#g=(i[1]<<7+i[0])/163.83}),this.#r.add([67,16,76,6,0],function(i){let e=i[0];t.#d=" ".repeat(e),t.#M=Date.now()+3200,i.slice(1).forEach(function(s){t.#d+=String.fromCharCode(s)})}).add([67,16,76,7,0,0],function(i){for(t.#l=Date.now()+3200;iMsg.length<48;)i.unshift(0);i.forEach(function(e,s){let n=Math.floor(s/16),o=s%16,h=(o*3+n)*7,a=7,r=0;for(h-=o*5,n==2&&(a=2);r<a;)t.#c[h+r]=e>>6-r&1,r++})}),this.#r.add([65,1],function(i){t.switchMode("mt32"),t.#i.run(i,1)}).add([65,2],function(i){t.switchMode("mt32"),t.#i.run(i,2)}).add([65,3],function(i){t.switchMode("mt32"),t.#i.run(i,3)}).add([65,4],function(i){t.switchMode("mt32"),t.#i.run(i,4)}).add([65,5],function(i){t.switchMode("mt32"),t.#i.run(i,5)}).add([65,6],function(i){t.switchMode("mt32"),t.#i.run(i,6)}).add([65,7],function(i){t.switchMode("mt32"),t.#i.run(i,7)}).add([65,8],function(i){t.switchMode("mt32"),t.#i.run(i,8)}).add([65,9],function(i){t.switchMode("mt32"),t.#a[9]=1,t.#i.run(i,9)}),this.#i.add([22,18,2,0,0],function(i,e){let s="";i.slice(0,10).forEach(function(n){n>31&&(s+=String.fromCharCode(n))}),t.#f[e]=s,console.debug(`MT-32 tone properties on channel ${e+1} (${s}): ${i.slice(10)}`)}),this.#r.add([65,16,69,18,16,1,0],function(i){t.#l=Date.now()+3200,i.forEach(function(e,s){if(s<64){let n=Math.floor(s/16),o=s%16,h=(o*4+n)*5,a=5,r=0;for(h-=o*4,n==3&&(a=1);r<a;)t.#c[h+r]=e>>4-r&1,r++}})})}};export{I as OctaviaDevice};
