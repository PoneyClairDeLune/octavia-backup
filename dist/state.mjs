var d=function(t,i){let e=Math.min(t.length,i.length),s=t.slice(0,e),n=i.slice(0,e),h=0,o=0;for(;o<e&&h==0;)h=Math.sign(s[o]-n[o]),o++;return h},l=function(){this.pool=[],this.point=function(t,i=!1){if(this.pool.length>0){let e=this.pool.length,s=1<<Math.floor(Math.log2(e)),n=s,h=64;for(;s>=1&&h>=0;){if(h<=0)throw new Error("TTL reached.");if(n==e)n-=s;else{let a=d(t,this.pool[n]);switch(a){case 0:{h=0;break}case 1:{n+s<=e&&(n+=s);break}case-1:{n!=0&&(n-=s);break}default:console.warn(`Unexpected result ${a}.`)}}s=s>>1,h--}let o=!0;if(n>=this.pool.length)o=!1;else{let a=this;this.pool[n].forEach(function(r,g,x){o&&r!=t[g]&&(o=!1)}),!o&&d(t,this.pool[n])>0&&n++}return o||i?n:-1}else return i?0:-1},this.add=function(t,i){return t.data=i,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let i=this.point(t);if(i>-1)return this.pool[i].data;this.default(t)},this.run=function(t,...i){let e=this.point(t);e>-1?this.pool[e].data(t.slice(this.pool[e].length),...i):this.default(t,...i)}};var p=class{#t={};addEventListener(t,i){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(i)}removeEventListener(t,i){if(this.#t[t]){let e=this.#t[t].indexOf(i);e>-1&&this.#t[t].splice(e,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,i){let e=new Event(t),s=this;e.data=i,this.#t[t]?.length>0&&this.#t[t].forEach(function(n){n?.call(s,e)}),this[`on${t}`]&&this[`on${t}`](e)}};var f=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw"],u={};f.forEach(function(t,i){u[t]=i});var w=[[0,0,0,0,0,0,0,56,82,81],[0,0,0,0,0,127,0,0,0,0]],M=[0,3,32,81,84,88,89],c=function(t,i,e){e[i]=0},E=function(t){let i=[[]];return t?.forEach(function(e){e==247||(e==240?i.push([]):i[i.length-1].push(e))}),i},m=function(t,i="",e="",s=2){return t?`${i}${t.toString().padStart(s,"0")}${e}`:""},T=class extends p{#t=0;#f=new Array(256);#u=0;#c=new Array(64);#s=new Uint8ClampedArray(8192);#m=new Uint8ClampedArray(64);#n=new Uint8ClampedArray(8192);#i=new Uint16Array(256);#x=new Int16Array(64);#d=new Array(64);#a=new Uint8Array(64);#g=0;#M=0;#p=100;#l=0;#w="";#E=0;#h=[];#o=[];#b={8:function(t){let i=t.part*128+t.data[0],e=this.#i.indexOf(i);e>-1&&(this.#i[e]=0,this.#n[i]=0)},9:function(t){this.#c[t.part]=1;let i=t.part*128+t.data[0];if(t.data[1]>0){let e=0;for(;this.#i[e]>0;)e++;e<256?(this.#i[e]=i,this.#n[i]=t.data[1],this.#a[t.part]<t.data[1]&&(this.#a[t.part]=t.data[1])):console.error("Polyphony exceeded.")}else{let e=this.#i.indexOf(i);e>-1&&(this.#i[e]=0,this.#n[i]=0)}},10:function(t){let i=t.part*128+t.data[0];this.#i.indexOf(i)>-1&&(this.#n[i]=data[1])},11:function(t){this.#c[t.part]=1,t.data[0]==0&&t.part%16==9&&this.#t==u.gs&&(t.data[1]=120),this.#s[t.part*128+t.data[0]]=t.data[1]},12:function(t){this.#c[t.part]=1,this.#m[t.part]=t.data,this.#d[t.part]=0},13:function(t){let i=this;this.#i.forEach(function(e){let s=e>>7;t.part==s&&(i.#n[e]=t.data)}),console.info(t)},14:function(t){this.#x[t.part]=t.data[1]*128+t.data[0]-8192},15:function(t){let i=this;E(t.data).forEach(function(e){i.#r.run(e)})},255:function(t){if((this.#o[t.meta]||function(){}).call(this,t.data,t.track),M.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#r;#C;#e;getActive(){let t=this.#c.slice();return this.#t==u.mt32&&(t[0]=0),t}getCc(t){let i=t*128,e=this.#s.slice(i,i+128);return e[0]=e[0]||this.#g,e[32]=e[32]||this.#M,e}getPitch(){return this.#x.slice()}getProgram(){return this.#m.slice()}getTexts(){return this.#h.slice()}getVel(t){let i=new Map,e=this;return this.#i.forEach(function(s){let n=Math.floor(s/128),h=s%128;t==n&&e.#n[s]>0&&i.set(h,e.#n[s])}),i}getBitmap(){return{bitmap:this.#f.slice(),expire:this.#u}}getCustomNames(){return this.#d.slice()}getLetter(){return{text:this.#w,expire:this.#E}}getMode(){return f[this.#t]}getMaster(){return{volume:this.#p}}getRawStrength(){let t=this;return this.#i.forEach(function(i){let e=Math.floor(i/128);t.#n[i]>t.#a[e]&&(t.#a[e]=t.#n[i])}),this.#a.slice()}getStrength(){let t=[],i=this;return this.getRawStrength().forEach(function(e,s){t[s]=Math.floor(e*i.#s[s*128+7]*i.#s[s*128+11]*i.#p/803288)}),t}init(){this.dispatchEvent("mode","?"),this.#t=0,this.#g=0,this.#M=0,this.#l=0,this.#c.forEach(c),this.#s.forEach(c),this.#m.forEach(c),this.#n.forEach(c),this.#i.forEach(c),this.#a.forEach(c),this.#p=100,this.#h=[],this.#E=0,this.#w="",this.#u=0,this.#f.forEach(c),this.#d.forEach(c),this.#s[1152]=127;for(let t=0;t<64;t++)this.#s[t*128+7]=127,this.#s[t*128+11]=127,this.#s[t*128+74]=127,this.#s[t*128+10]=127}switchMode(t,i=!1){let e=f.indexOf(t);if(e>-1)(this.#t==0||i)&&(this.#t=e,this.#g=w[0][e],this.#M=w[1][e],this.dispatchEvent("mode",t));else throw new Error(`Unknown mode ${t}`)}runJson(t){return this.#a.forEach(c),this.#b[t.type].call(this,t)}runRaw(t){}constructor(){super();let t=this;this.#r=new l,this.#C=new l,this.#e=new l,this.#r.default=console.debug,this.#o[1]=function(i){this.#h.unshift(i)},this.#o[2]=function(i){this.#h.unshift(`Copyrite: ${i}`)},this.#o[3]=function(i,e){e<1&&this.#l<1&&this.#h.unshift(`TrkTitle: ${i}`)},this.#o[4]=function(i,e){e<1&&this.#l<1&&this.#h.unshift(`${m(this.#l,""," ")}Instrmnt: ${i}`)},this.#o[5]=function(i){this.#h.unshift(`C.Lyrics: ${i}`)},this.#o[6]=function(i){this.#h.unshift(`${m(this.#l,""," ")}C.Marker: ${i}`)},this.#o[7]=function(i){this.#h.unshift(`CuePoint: ${i}`)},this.#o[32]=function(i){this.#l=i[0]+1},this.#r.add([126,127,9,1],function(){t.switchMode("gm",!0),console.info("MIDI reset: GM")}).add([126,127,9,3],function(){t.switchMode("g2",!0),console.info("MIDI reset: GM2")}).add([65,16,22,18,127,1],function(){t.switchMode("mt32",!0),console.info("MIDI reset: MT-32")}).add([65,16,66,18,64,0,127,0,65],function(){t.switchMode("gs",!0),console.info("MIDI reset: GS")}).add([66,48,66,52,0],function(i){t.switchMode("ns5r",!0),console.info("KORG reset:",i)}).add([67,16,76,0,0,126,0],function(i){t.switchMode("xg",!0),console.info("MIDI reset: XG")}),this.#r.add([127,127,4,1],function(i){t.switchMode("gm"),t.#p=(i[1]<<7+i[0])/163.83}),this.#r.add([67,16,76,6,0],function(i){let e=i[0];t.#w=" ".repeat(e),t.#E=Date.now()+3200,i.slice(1).forEach(function(s){t.#w+=String.fromCharCode(s)})}).add([67,16,76,7,0,0],function(i){for(t.#u=Date.now()+3200;i.length<48;)i.unshift(0);i.forEach(function(e,s){let n=Math.floor(s/16),h=s%16,o=(h*3+n)*7,a=7,r=0;for(o-=h*5,n==2&&(a=2);r<a;)t.#f[o+r]=e>>6-r&1,r++})}),this.#r.add([65,1],function(i){t.switchMode("mt32"),t.#e.run(i,1)}).add([65,2],function(i){t.switchMode("mt32"),t.#e.run(i,2)}).add([65,3],function(i){t.switchMode("mt32"),t.#e.run(i,3)}).add([65,4],function(i){t.switchMode("mt32"),t.#e.run(i,4)}).add([65,5],function(i){t.switchMode("mt32"),t.#e.run(i,5)}).add([65,6],function(i){t.switchMode("mt32"),t.#e.run(i,6)}).add([65,7],function(i){t.switchMode("mt32"),t.#e.run(i,7)}).add([65,8],function(i){t.switchMode("mt32"),t.#e.run(i,8)}).add([65,9],function(i){t.switchMode("mt32"),t.#c[9]=1,t.#e.run(i,9)}),this.#e.add([22,18,2,0,0],function(i,e){let s="";i.slice(0,10).forEach(function(n){n>31&&(s+=String.fromCharCode(n))}),t.#d[e]=s,console.debug(`MT-32 tone properties on channel ${e+1} (${s}): ${i.slice(10)}`)}),this.#r.add([65,16,69,18,16,1,0],function(i){t.#u=Date.now()+3200,i.forEach(function(e,s){if(s<64){let n=Math.floor(s/16),h=s%16,o=(h*4+n)*5,a=5,r=0;for(o-=h*4,n==3&&(a=1);r<a;)t.#f[o+r]=e>>4-r&1,r++}})})}};export{T as OctaviaDevice};
