var y=function(t,e){let i=Math.min(t.length,e.length),s=t.slice(0,i),h=e.slice(0,i),a=0,o=0;for(;o<i&&a==0;)a=Math.sign(s[o]-h[o]),o++;return a},f=function(){this.pool=[],this.point=function(t,e=!1){if(this.pool.length>0){let i=this.pool.length,s=1<<Math.floor(Math.log2(i)),h=s,a=64;for(;s>=1&&a>=0;){if(a<=0)throw new Error("TTL reached.");if(h==i)h-=s;else{let u=y(t,this.pool[h]);switch(u){case 0:{a=0;break}case 1:{h+s<=i&&(h+=s);break}case-1:{h!=0&&(h-=s);break}default:console.warn(`Unexpected result ${u}.`)}}s=s>>1,a--}let o=!0;if(h>=this.pool.length)o=!1;else{let u=this;this.pool[h].forEach(function(p,g,d){o&&p!=t[g]&&(o=!1)}),!o&&y(t,this.pool[h])>0&&h++}return o||e?h:-1}else return e?0:-1},this.add=function(t,e){return t.data=e,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let e=this.point(t);if(e>-1)return this.pool[e].data;this.default(t)},this.run=function(t,...e){let i=this.point(t);i>-1?this.pool[i].data(t.slice(this.pool[i].length),...e):this.default(t,...e)}};var k=class{#e={};addEventListener(t,e){this.#e[t]||(this.#e[t]=[]),this.#e[t].unshift(e)}removeEventListener(t,e){if(this.#e[t]){let i=this.#e[t].indexOf(e);i>-1&&this.#e[t].splice(i,1),this.#e[t].length<1&&delete this.#e[t]}}dispatchEvent(t,e){let i=new Event(t),s=this;i.data=e,this.#e[t]?.length>0&&this.#e[t].forEach(function(h){h?.call(s,i)}),this[`on${t}`]&&this[`on${t}`](i)}};var c=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"];c[16]="white room";c[17]="tunnel";c[19]="basement";c[20]="karaoke";c[64]="pass through";c[65]="chorus";c[66]="celeste";c[67]="flanger";c[68]="symphonic";c[69]="rotary speaker";c[70]="tremelo";c[71]="auto pan";c[72]="phaser";c[73]="distortion";c[74]="overdrive";c[75]="amplifier";c[76]="3-band EQ";c[77]="2-band EQ";c[78]="auto wah";var $=function(t){let e=0;return t.forEach(i=>{e+=i,e>127&&(e%=128)}),128-e};var M=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw","krs","k11","sg"],C=[[0,0,0,0,121,0,0,56,82,81,63,0,0],[0,0,1,0,0,127,0,0,0,0,0,0,0]],w=[120,127,120,127,120,127,61,62,62,62,120,122,127],R=[0,3,81,84,88],v={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},E={0:0,1:1,2:3,5:4},T=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],A=[36,37];var x=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,12,13,16,17,18,19],S=[33,99,100,32,102,8,9,10],m={};M.forEach((t,e)=>{m[t]=e});var n={length:x.length};x.forEach((t,e)=>{n[t]=e});var l=function(t,e,i){i[e]=0},O=function(t){let e=[[]];return t?.forEach(function(i){i==247||(i==240?e.push([]):e[e.length-1].push(i))}),e},I=function(t,e="",i="",s=2){return t?`${e}${t.toString().padStart(s,"0")}${i}`:""},r={ch:128,cc:x.length,nn:128,pl:512,tr:256,rpn:6},it=class extends k{#e=0;#d=0;#p=0;#g=new Array(10);get#f(){return this.#g[this.#d]}set#f(t){this.#g[this.#d]=t}#m=new Uint8Array(r.ch);#N=new Uint8Array(r.ch);#t=new Uint8ClampedArray(r.ch*r.cc);#T=new Uint8ClampedArray(r.ch);#n=new Uint8ClampedArray(r.ch*r.nn);#U=new Uint8Array(r.ch);#s=new Uint16Array(r.pl);#M=new Int16Array(r.ch);#A=new Array(r.ch);#c=new Uint8Array(r.ch);#x=0;#a=new Uint8Array(r.ch*r.rpn);#I=new Int8Array(r.ch*A.length);#y=0;#k=0;#$=100;#l=0;#o="";#C=0;#h=!1;#L;#i=[];#w=new Uint8Array(r.ch);#b=new Uint8Array(r.tr);chRedir(t,e,i){if(this.#b[e])return(this.#b[e]-1)*16+t;if([m.gs,m.ns5r].indexOf(this.#e)>-1){if(i==1)return t;let s=0,h=!0;for(;h;)this.#w[t+s]==0?(this.#w[t+s]=e,console.debug(`Assign track ${e} to channel ${t+s+1}.`),h=!1):this.#w[t+s]==e?h=!1:(s+=16,s>=128&&(s=0,h=!1));return t+s}else return t}#r=[];#R;#u={ano:t=>{this.#s.forEach((e,i,s)=>{let h=e>>7;e==0&&this.#n[0]==0||h==t&&(this.#n[e]=0,s[i]=0)})}};#P={8:function(t){let i=t.channel*128+t.data[0],s=this.#s.indexOf(i);s>-1&&(this.#s[s]=0,this.#n[i]=0)},9:function(t){let e=t.channel;this.#m[e]=1;let i=e*128+t.data[0];if(t.data[1]>0){let s=0;for(;this.#s[s]>0;)s++;s<this.#s.length?(this.#s[s]=i,this.#n[i]=t.data[1],this.#c[e]<t.data[1]&&(this.#c[e]=t.data[1])):console.error("Polyphony exceeded.")}else{let s=this.#s.indexOf(i);s>-1&&(this.#s[s]=0,this.#n[i]=0)}},10:function(t){let i=t.channel*128+t.data[0];this.#s.indexOf(i)>-1&&(this.#n[i]=data[1])},11:function(t){let e=t.channel;this.#m[e]=1;let i=e*r.cc;switch(t.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#u.ano(e),this.#M[e]=0;let s=e*r.cc;this.#t[s+n[1]]=0,this.#t[s+n[5]]=0,this.#t[s+n[64]]=0,this.#t[s+n[65]]=0,this.#t[s+n[66]]=0,this.#t[s+n[67]]=0,this.#t[s+n[11]]=127,this.#t[s+n[101]]=127,this.#t[s+n[100]]=127,this.#t[s+n[99]]=127,this.#t[s+n[98]]=127;return}case 123:{this.#u.ano(e);return}case 124:{this.#u.ano(e);return}case 125:{this.#u.ano(e);return}case 126:{this.#U[e]=1,this.#u.ano(e);return}case 127:{this.#U[e]=0,this.#u.ano(e);return}}if(n[t.data[0]]==null)console.warn(`cc${t.data[0]} is not accepted.`);else{switch(t.data[0]){case 0:{if(this.#e==0)t.data[1]<48?(this.#t[i]>119&&(t.data[1]=this.#t[i],t.data[1]=120,console.debug(`Forced channel ${e+1} to stay drums.`)),t.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${t.data[1]}`),this.switchMode("gs"))):t.data[1]==62?this.switchMode("x5d"):t.data[1]==63&&this.switchMode("krs");else if(this.#e==m.gs)t.data[1]<56&&this.#t[i]>119&&(t.data[1]=this.#t[i],t.data[1]=120,console.debug(`Forced channel ${e+1} to stay drums.`));else if(this.#e==m.gm)t.data[1]<48&&this.#t[i]>119&&(t.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${e+1} to stay drums.`));else if(this.#e==m.x5d){if(t.data[1]>0&&t.data[1]<8)this.switchMode("05rw",!0);else if(t.data[1]==56){let s=0;for(let h=0;h<16;h++){let a=this.#t[r.cc*h];(a==56||a==62)&&s++}s>14&&this.switchMode("ag10",!0)}}break}case 6:{if(this.#x){let s=this.#t[i+n[99]],h=this.#t[i+n[98]];if(s==1){let a=S.indexOf(h);if(a>-1)this.#t[i+n[71+a]]=t.data[1],console.debug(`Redirected NRPN 1 ${h} to cc${71+a}.`);else{let o=A.indexOf(h);o>-1&&(this.#I[e*10+o]=t.data[1]-64),console.debug(`CH${e+1} voice NRPN ${h} commit`)}}}else{let s=E[this.#t[i+n[100]]];this.#t[i+n[101]]==0&&s!=null&&(console.debug(`CH${e+1} RPN 0 ${this.#t[i+n[100]]} commit: ${t.data[1]}`),t.data[1]=Math.min(Math.max(t.data[1],T[s][0]),T[s][1]),this.#a[e*r.rpn+s]=t.data[1])}break}case 38:{this.#x||this.#t[i+101]==0&&E[this.#t[i+100]]!=null&&(this.#a[e*r.rpn+E[this.#t[i+100]]+1]=t.data[1]);break}case 98:case 99:{this.#x=1;break}case 100:case 101:{this.#x=0;break}}this.#t[i+n[t.data[0]]]=t.data[1]}},12:function(t){let e=t.channel;this.#m[e]=1,this.#T[e]=t.data,this.#A[e]=0},13:function(t){let e=this,i=t.channel;this.#s.forEach(function(s){let h=s>>7;i==h&&(e.#n[s]=t.data)})},14:function(t){let e=t.channel;this.#M[e]=t.data[1]*128+t.data[0]-8192},15:function(t){O(t.data).forEach(e=>{let i=e[0],s=e[1];(this.#X[i]||function(){console.debug(`Unknown manufacturer ${i}.`)})(s,e.slice(2),t.track)})},255:function(t){if((this.#r[t.meta]||function(i,s,h){}).call(this,t.data,t.track,t.meta),t.meta!=32&&(this.#l=0),R.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#X={64:(t,e,i)=>{this.#D.run(e,i,t)},65:(t,e,i)=>{if(e[0]<64)this.#E.run(e,i,t);else{let s=e.pop(),h=$(e.slice(2));s==h?this.#E.run(e,i,t):console.warn(`Bad GS checksum ${s}. Should be ${h}.`)}},66:(t,e,i)=>{this.#K.run(e,i,t)},67:(t,e,i)=>{this.#v.run(e,i,t)},68:(t,e,i)=>{this.#G.run(e,i,t)},71:(t,e,i)=>{this.#F.run(e,i,t)},126:(t,e,i)=>{this.#S.run(e,i,t)},127:(t,e,i)=>{this.switchMode("gm"),this.#O.run(e,i,t)}};#S;#O;#v;#E;#K;#D;#F;#G;buildRchTree(){let t=[];this.#N.forEach((e,i)=>{t[e]?.constructor||(t[e]=[]),t[e].push(i)}),this.#L=t}getActive(){let t=this.#m.slice();return this.#e==m.mt32,t}getCc(t){let e=t*r.cc,i=this.#t.slice(e,e+r.cc);return i[n[0]]=i[n[0]]||this.#y,i[n[32]]=i[n[32]]||this.#k,i}getCcAll(){let t=this.#t.slice();for(let e=0;e<64;e++){let i=e*r.cc;t[i+n[0]]=t[i+n[0]]||this.#y,t[i+n[32]]=t[i+n[32]]||this.#k}return t}getPitch(){return this.#M}getProgram(){return this.#T}getTexts(){return this.#i.slice()}getVel(t){let e=new Map,i=this;return this.#s.forEach(function(s){let h=Math.floor(s/128),a=s%128;t==h&&i.#n[s]>0&&e.set(a,i.#n[s])}),e}getBitmap(){return{bitmap:this.#f,expire:this.#p}}getCustomNames(){return this.#A.slice()}getLetter(){return{text:this.#o,expire:this.#C}}getMode(){return M[this.#e]}getMaster(){return{volume:this.#$}}getRawStrength(){let t=this;return this.#s.forEach(function(e){let i=Math.floor(e/128);t.#n[e]>t.#c[i]&&(t.#c[i]=t.#n[e])}),this.#c}getStrength(){let t=[],e=this;return this.getRawStrength().forEach(function(i,s){t[s]=Math.floor(i*e.#t[s*r.cc+n[7]]*e.#t[s*r.cc+n[11]]*e.#$/803288)}),t}getRpn(){return this.#a}getNrpn(){return this.#I}init(t=0){this.dispatchEvent("mode","?"),this.#e=0,this.#y=0,this.#k=0,this.#l=0,this.#m.forEach(l),this.#t.forEach(l),this.#T.forEach(l),this.#n.forEach(l),this.#s.forEach(l),this.#c.forEach(l),this.#M.forEach(l),this.#I.forEach(l),this.#$=100,this.#i=[],this.#C=0,this.#o="",this.#p=0,this.#d=0,this.#f.forEach(l),this.#A.forEach(l),this.#h=!1,this.#N.forEach(function(e,i,s){s[i]=i}),this.buildRchTree(),this.#w.forEach(l),this.#b.forEach(l),this.#t[r.cc*9]=w[0],this.#t[r.cc*25]=w[0],this.#t[r.cc*41]=w[0],this.#t[r.cc*57]=w[0];for(let e=0;e<64;e++){let i=e*r.cc;this.#t[i+n[7]]=100,this.#t[i+n[11]]=127,this.#t[i+n[10]]=64,this.#t[i+n[71]]=64,this.#t[i+n[72]]=64,this.#t[i+n[73]]=64,this.#t[i+n[74]]=64,this.#t[i+n[75]]=64,this.#t[i+n[76]]=64,this.#t[i+n[77]]=64,this.#t[i+n[78]]=64,this.#t[i+n[91]]=40,this.#t[i+n[101]]=127,this.#t[i+n[100]]=127,this.#t[i+n[99]]=127,this.#t[i+n[98]]=127;let s=e*r.rpn;this.#a[s]=2,this.#a[s+1]=64,this.#a[s+2]=0,this.#a[s+3]=64,this.#a[s+4]=0,this.#a[s+5]=0}}switchMode(t,e=!1){let i=M.indexOf(t);if(i>-1){if(this.#e==0||e){this.#e=i,this.#d=0,this.#y=C[0][i],this.#k=C[1][i];for(let s=0;s<64;s++)w.indexOf(this.#t[s*r.cc])>-1&&(this.#t[s*r.cc]=w[i]);this.dispatchEvent("mode",t)}}else throw new Error(`Unknown mode ${t}`)}newStrength(){this.#c.forEach(l)}runJson(t){if(t.type>14)return this.#P[t.type].call(this,t);{let e=this.chRedir(t.part,t.track),i=!1;this.#L[e]?.forEach(s=>{t.channel=s,i=!0,this.#P[t.type].call(this,t)}),i||console.warn(`${v[t.type]?v[t.type]:t.type}${[11,12].includes(t.type)?(t.data[0]!=null?t.data[0]:t.data).toString():""} event sent to CH${e+1} without any recipient.`)}}runRaw(t){}constructor(){super();let t=this;this.#f=new Uint8Array(256),this.#R=new f,this.#r[1]=function(e){switch(e.slice(0,2)){case"@I":{this.#h=!0,this.#i.unshift(`Kar.Info: ${e.slice(2)}`);break}case"@K":{this.#h=!0,this.#i.unshift("Karaoke mode active."),console.debug(`Karaoke mode active: ${e.slice(2)}`);break}case"@L":{this.#h=!0,this.#i.unshift(`Language: ${e.slice(2)}`);break}case"@T":{this.#h=!0,this.#i.unshift(`Ka.Title: ${e.slice(2)}`);break}case"@V":{this.#h=!0,this.#i.unshift(`Kara.Ver: ${e.slice(2)}`);break}default:this.#h?e[0]=="\\"?this.#i.unshift(`@ ${e.slice(1)}`):e[0]=="/"?this.#i.unshift(e.slice(1)):this.#i[0]+=e:(this.#i[0]=e,this.#i.unshift(""))}},this.#r[2]=function(e){this.#i.unshift(`Copyrite: ${e}`)},this.#r[3]=function(e,i){i<1&&this.#l<1&&this.#i.unshift(`TrkTitle: ${e}`)},this.#r[4]=function(e,i){i<1&&this.#l<1&&this.#i.unshift(`${I(this.#l,""," ")}Instrmnt: ${e}`)},this.#r[5]=function(e){e.trim()==""?this.#i.unshift(""):this.#i[0]+=`${e}`},this.#r[6]=function(e){this.#i.unshift(`${I(this.#l,""," ")}C.Marker: ${e}`)},this.#r[7]=function(e){this.#i.unshift(`CuePoint: ${e}`)},this.#r[32]=function(e){this.#l=e[0]+1},this.#r[33]=function(e,i){console.debug(`Track ${i} requests to get assigned to output ${e}.`),t.#b[i]=e+1},this.#r[127]=function(e,i){t.#R.run(e,i)},this.#R.add([67,0,1],function(e,i){t.#b[i]=e[0]+1}),this.#S=new f,this.#O=new f,this.#v=new f,this.#E=new f,this.#K=new f,this.#D=new f,this.#F=new f,this.#G=new f,this.#S.add([9],e=>{t.switchMode(["gm","?","g2"][e[0]-1],!0),t.#h=t.#h||!1,console.info(`MIDI reset: ${["GM","Init","GM2"][e[0]]}`),e[0]==2&&t.init()}),this.#v.add([76,0,0,126],e=>{t.switchMode("xg",!0),t.#h=!1,console.info("MIDI reset: XG")}),this.#E.add([22,18,127,0,0,1],()=>{t.switchMode("mt32",!0),t.#h=!1,console.info("MIDI reset: MT-32")}).add([66,18,64,0,127,0,65],()=>{t.switchMode("gs",!0),t.#t[r.cc*9]=120,t.#t[r.cc*25]=120,t.#t[r.cc*41]=120,t.#t[r.cc*57]=120,t.#h=!1,t.#w.forEach(l),console.info("MIDI reset: GS")}),this.#D.add([16,0,8,0,0,0,0],()=>{t.switchMode("k11",!0),t.#h=!1,console.info("MIDI reset: KAWAI GMega/K11")}),this.#O.add([4,1],e=>{t.#$=((e[1]<<7)+e[0])/16383*100}).add([4,3],e=>((e[1]<<7)+e[0]-8192)/8192).add([4,4],e=>e[1]-64),this.#v.add([76,6,0],e=>{let i=e[0];t.#o=" ".repeat(i),t.#C=Date.now()+3200,e.slice(1).forEach(function(s){t.#o+=String.fromCharCode(s)}),t.#o=t.#o.padEnd(32," ")}).add([76,7,0],e=>{let i=e[0];t.#p=Date.now()+3200,t.#f.fill(0);let s=e.slice(1);for(let h=0;h<i;h++)s.unshift(0);s.forEach(function(h,a){let o=Math.floor(a/16),u=a%16,p=(u*3+o)*7,g=7,d=0;for(p-=u*5,o==2&&(g=2);d<g;)t.#f[p+d]=h>>6-d&1,d++})}),this.#E.add([69,18,16],e=>{switch(e[0]){case 0:{t.#C=Date.now()+3200;let i=e[1];t.#o=" ".repeat(i),e.slice(2).forEach(function(s){s<128&&(t.#o+=String.fromCharCode(s))});break}case 32:{t.#p=Date.now()+3200,e[1]==0&&(t.#d=Math.max(Math.min(e[2]-1,9),0));break}default:if(e[0]<11){t.#p=Date.now()+3200,t.#g[e[0]-1]?.length||(t.#g[e[0]-1]=new Uint8Array(256));let i=t.#g[e[0]-1],s=e[1];i.fill(0);let h=e.slice(2);for(let a=0;a<s;a++)h.unshift(0);h.forEach(function(a,o){let u=Math.floor(o/16),p=o%16,g=(p*4+u)*5,d=5,b=0;for(g-=p*4,u==3&&(d=1);b<d;)i[g+b]=a>>4-b&1,b++})}else console.warn(`Unknown GS display section: ${e[0]}`)}})}};export{it as OctaviaDevice,r as allocated,n as ccToPos};
