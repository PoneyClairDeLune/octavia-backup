var E=function(t,e){let i=Math.min(t.length,e.length),s=t.slice(0,i),r=e.slice(0,i),c=0,l=0;for(;l<i&&c==0;)c=Math.sign(s[l]-r[l]),l++;return c},f=function(){this.pool=[],this.point=function(t,e=!1){if(this.pool.length>0){let i=this.pool.length,s=1<<Math.floor(Math.log2(i)),r=s,c=64;for(;s>=1&&c>=0;){if(c<=0)throw new Error("TTL reached.");if(r==i)r-=s;else{let p=E(t,this.pool[r]);switch(p){case 0:{c=0;break}case 1:{r+s<=i&&(r+=s);break}case-1:{r!=0&&(r-=s);break}default:console.warn(`Unexpected result ${p}.`)}}s=s>>1,c--}let l=!0;if(r>=this.pool.length)l=!1;else{let p=this;this.pool[r].forEach(function(v,T,A){l&&v!=t[T]&&(l=!1)}),!l&&E(t,this.pool[r])>0&&r++}return l||e?r:-1}else return e?0:-1},this.add=function(t,e){return t.data=e,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let e=this.point(t);if(e>-1)return this.pool[e].data;this.default(t)},this.run=function(t,...e){let i=this.point(t);i>-1?this.pool[i].data(t.slice(this.pool[i].length),...e):this.default(t,...e)}};var b=class{#e={};addEventListener(t,e){this.#e[t]||(this.#e[t]=[]),this.#e[t].unshift(e)}removeEventListener(t,e){if(this.#e[t]){let i=this.#e[t].indexOf(e);i>-1&&this.#e[t].splice(i,1),this.#e[t].length<1&&delete this.#e[t]}}dispatchEvent(t,e){let i=new Event(t),s=this;i.data=e,this.#e[t]?.length>0&&this.#e[t].forEach(function(r){r?.call(s,i)}),this[`on${t}`]&&this[`on${t}`](i)}};var a=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"];a[16]="white room";a[17]="tunnel";a[19]="basement";a[20]="karaoke";a[64]="pass through";a[65]="chorus";a[66]="celeste";a[67]="flanger";a[68]="symphonic";a[69]="rotary speaker";a[70]="tremelo";a[71]="auto pan";a[72]="phaser";a[73]="distortion";a[74]="overdrive";a[75]="amplifier";a[76]="3-band EQ";a[77]="2-band EQ";a[78]="auto wah";var m=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw","krs","k11","sg"],M=[[0,0,0,0,121,0,0,56,82,81,63,0,0],[0,0,1,0,0,127,0,0,0,0,0,0,0]],d=[120,127,120,127,120,127,61,62,62,62,120,122,127],C=[0,3,81,84,88],x={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},g={0:0,1:1,2:3,5:4},y=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],$=[36,37];var w=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,12,13,16,17,18,19],I=[33,99,100,32,102,8,9,10],u={};m.forEach((t,e)=>{u[t]=e});var h={length:w.length};w.forEach((t,e)=>{h[t]=e});var o=function(t,e,i){i[e]=0},R=function(t){let e=[[]];return t?.forEach(function(i){i==247||(i==240?e.push([]):e[e.length-1].push(i))}),e},k=function(t,e="",i="",s=2){return t?`${e}${t.toString().padStart(s,"0")}${i}`:""},n={ch:128,cc:w.length,nn:128,pl:512,tr:256,rpn:6},tt=class extends b{#e=0;#T=new Uint8Array(256);#C=0;#f=new Uint8Array(n.ch);#I=new Uint8Array(n.ch);#t=new Uint8ClampedArray(n.ch*n.cc);#E=new Uint8ClampedArray(n.ch);#n=new Uint8ClampedArray(n.ch*n.nn);#R=new Uint8Array(n.ch);#h=new Uint16Array(n.pl);#d=new Int16Array(n.ch);#b=new Array(n.ch);#c=new Uint8Array(n.ch);#p=0;#a=new Uint8Array(n.ch*n.rpn);#M=new Int8Array(n.ch*$.length);#g=0;#m=0;#x=100;#o=0;#A="";#O=0;#s=!1;#N;#i=[];#u=new Uint8Array(n.ch);#w=new Uint8Array(n.tr);chRedir(t,e,i){if(this.#w[e])return(this.#w[e]-1)*16+t;if([u.gs,u.ns5r].indexOf(this.#e)>-1){if(i==1)return t;let s=0,r=!0;for(;r;)this.#u[t+s]==0?(this.#u[t+s]=e,console.debug(`Assign track ${e} to channel ${t+s+1}.`),r=!1):this.#u[t+s]==e?r=!1:(s+=16,s>=128&&(s=0,r=!1));return t+s}else return t}#r=[];#P;#l={ano:t=>{this.#h.forEach((e,i,s)=>{let r=e>>7;e==0&&this.#n[0]==0||r==t&&(this.#n[e]=0,s[i]=0)})}};#D={8:function(t){let i=t.channel*128+t.data[0],s=this.#h.indexOf(i);s>-1&&(this.#h[s]=0,this.#n[i]=0)},9:function(t){let e=t.channel;this.#f[e]=1;let i=e*128+t.data[0];if(t.data[1]>0){let s=0;for(;this.#h[s]>0;)s++;s<this.#h.length?(this.#h[s]=i,this.#n[i]=t.data[1],this.#c[e]<t.data[1]&&(this.#c[e]=t.data[1])):console.error("Polyphony exceeded.")}else{let s=this.#h.indexOf(i);s>-1&&(this.#h[s]=0,this.#n[i]=0)}},10:function(t){let i=t.channel*128+t.data[0];this.#h.indexOf(i)>-1&&(this.#n[i]=data[1])},11:function(t){let e=t.channel;this.#f[e]=1;let i=e*n.cc;switch(t.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#l.ano(e),this.#d[e]=0;let s=e*n.cc;this.#t[s+h[1]]=0,this.#t[s+h[5]]=0,this.#t[s+h[64]]=0,this.#t[s+h[65]]=0,this.#t[s+h[66]]=0,this.#t[s+h[67]]=0,this.#t[s+h[11]]=127,this.#t[s+h[101]]=127,this.#t[s+h[100]]=127,this.#t[s+h[99]]=127,this.#t[s+h[98]]=127;return}case 123:{this.#l.ano(e);return}case 124:{this.#l.ano(e);return}case 125:{this.#l.ano(e);return}case 126:{this.#R[e]=1,this.#l.ano(e);return}case 127:{this.#R[e]=0,this.#l.ano(e);return}}if(h[t.data[0]]==null)console.warn(`cc${t.data[0]} is not accepted.`);else{switch(t.data[0]){case 0:{if(this.#e==0)t.data[1]<48?(this.#t[i]>119&&(t.data[1]=this.#t[i],t.data[1]=120,console.debug(`Forced channel ${e+1} to stay drums.`)),t.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${t.data[1]}`),this.switchMode("gs"))):t.data[1]==62?this.switchMode("x5d"):t.data[1]==63&&this.switchMode("krs");else if(this.#e==u.gs)t.data[1]<64&&this.#t[i]>119&&(t.data[1]=this.#t[i],t.data[1]=120,console.debug(`Forced channel ${e+1} to stay drums.`));else if(this.#e==u.gm)t.data[1]<48&&this.#t[i]>119&&(t.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${e+1} to stay drums.`));else if(this.#e==u.x5d){if(t.data[1]>0&&t.data[1]<8)this.switchMode("05rw",!0);else if(t.data[1]==56){let s=0;for(let r=0;r<16;r++){let c=this.#t[n.cc*r];(c==56||c==62)&&s++}s>14&&this.switchMode("ag10",!0)}}break}case 6:{if(this.#p){let s=this.#t[i+h[99]],r=this.#t[i+h[98]];if(s==1){let c=I.indexOf(r);if(c>-1)this.#t[i+h[71+c]]=t.data[1],console.debug(`Redirected NRPN 1 ${r} to cc${71+c}.`);else{let l=$.indexOf(r);l>-1&&(this.#M[e*10+l]=t.data[1]-64),console.debug(`CH${e+1} voice NRPN ${r} commit`)}}}else{let s=g[this.#t[i+h[100]]];this.#t[i+h[101]]==0&&s!=null&&(console.debug(`CH${e+1} RPN 0 ${this.#t[i+h[100]]} commit: ${t.data[1]}`),t.data[1]=Math.min(Math.max(t.data[1],y[s][0]),y[s][1]),this.#a[e*n.rpn+s]=t.data[1])}break}case 38:{this.#p||this.#t[i+101]==0&&g[this.#t[i+100]]!=null&&(this.#a[e*n.rpn+g[this.#t[i+100]]+1]=t.data[1]);break}case 98:case 99:{this.#p=1;break}case 100:case 101:{this.#p=0;break}}this.#t[i+h[t.data[0]]]=t.data[1]}},12:function(t){let e=t.channel;this.#f[e]=1,this.#E[e]=t.data,this.#b[e]=0},13:function(t){let e=this,i=t.channel;this.#h.forEach(function(s){let r=s>>7;i==r&&(e.#n[s]=t.data)})},14:function(t){let e=t.channel;this.#d[e]=t.data[1]*128+t.data[0]-8192},15:function(t){R(t.data).forEach(e=>{let i=e[0],s=e[1]&15;(this.#K[i]||function(){console.debug(`Unknown manufacturer ${i}.`)})(s,e.slice(2))})},255:function(t){if((this.#r[t.meta]||function(i,s,r){}).call(this,t.data,t.track,t.meta),t.meta!=32&&(this.#o=0),C.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#K={64:(t,e)=>{this.#v.run(e)},65:(t,e)=>{this.#k.run(e)},66:(t,e)=>{this.#S.run(e)},67:(t,e)=>{this.#$.run(e)},68:(t,e)=>{this.#L.run(e)},71:(t,e)=>{this.#U.run(e)},126:(t,e)=>{this.#y.run(e)},127:(t,e)=>{}};#y;#F;#$;#k;#S;#v;#U;#L;buildRchTree(){let t=[];this.#I.forEach((e,i)=>{t[e]?.constructor||(t[e]=[]),t[e].push(i)}),this.#N=t}getActive(){let t=this.#f.slice();return this.#e==u.mt32,t}getCc(t){let e=t*n.cc,i=this.#t.slice(e,e+n.cc);return i[h[0]]=i[h[0]]||this.#g,i[h[32]]=i[h[32]]||this.#m,i}getCcAll(){let t=this.#t.slice();for(let e=0;e<64;e++){let i=e*n.cc;t[i+h[0]]=t[i+h[0]]||this.#g,t[i+h[32]]=t[i+h[32]]||this.#m}return t}getPitch(){return this.#d}getProgram(){return this.#E}getTexts(){return this.#i.slice()}getVel(t){let e=new Map,i=this;return this.#h.forEach(function(s){let r=Math.floor(s/128),c=s%128;t==r&&i.#n[s]>0&&e.set(c,i.#n[s])}),e}getBitmap(){return{bitmap:this.#T,expire:this.#C}}getCustomNames(){return this.#b.slice()}getLetter(){return{text:this.#A,expire:this.#O}}getMode(){return m[this.#e]}getMaster(){return{volume:this.#x}}getRawStrength(){let t=this;return this.#h.forEach(function(e){let i=Math.floor(e/128);t.#n[e]>t.#c[i]&&(t.#c[i]=t.#n[e])}),this.#c}getStrength(){let t=[],e=this;return this.getRawStrength().forEach(function(i,s){t[s]=Math.floor(i*e.#t[s*n.cc+h[7]]*e.#t[s*n.cc+h[11]]*e.#x/803288)}),t}getRpn(){return this.#a}getNrpn(){return this.#M}init(t=0){this.dispatchEvent("mode","?"),this.#e=0,this.#g=0,this.#m=0,this.#o=0,this.#f.forEach(o),this.#t.forEach(o),this.#E.forEach(o),this.#n.forEach(o),this.#h.forEach(o),this.#c.forEach(o),this.#d.forEach(o),this.#M.forEach(o),this.#x=100,this.#i=[],this.#O=0,this.#A="",this.#C=0,this.#T.forEach(o),this.#b.forEach(o),this.#s=!1,this.#I.forEach(function(e,i,s){s[i]=i}),this.buildRchTree(),this.#u.forEach(o),this.#w.forEach(o),this.#t[n.cc*9]=d[0],this.#t[n.cc*25]=d[0],this.#t[n.cc*41]=d[0],this.#t[n.cc*57]=d[0];for(let e=0;e<64;e++){let i=e*n.cc;this.#t[i+h[7]]=100,this.#t[i+h[11]]=127,this.#t[i+h[10]]=64,this.#t[i+h[71]]=64,this.#t[i+h[72]]=64,this.#t[i+h[73]]=64,this.#t[i+h[74]]=64,this.#t[i+h[75]]=64,this.#t[i+h[76]]=64,this.#t[i+h[77]]=64,this.#t[i+h[78]]=64,this.#t[i+h[91]]=40,this.#t[i+h[101]]=127,this.#t[i+h[100]]=127,this.#t[i+h[99]]=127,this.#t[i+h[98]]=127;let s=e*n.rpn;this.#a[s]=2,this.#a[s+1]=64,this.#a[s+2]=0,this.#a[s+3]=64,this.#a[s+4]=0,this.#a[s+5]=0}}switchMode(t,e=!1){let i=m.indexOf(t);if(i>-1){if(this.#e==0||e){this.#e=i,this.#g=M[0][i],this.#m=M[1][i];for(let s=0;s<64;s++)d.indexOf(this.#t[s*n.cc])>-1&&(this.#t[s*n.cc]=d[i]);this.dispatchEvent("mode",t)}}else throw new Error(`Unknown mode ${t}`)}newStrength(){this.#c.forEach(o)}runJson(t){if(t.type>14)return this.#D[t.type].call(this,t);{let e=this.chRedir(t.part,t.track),i=!1;this.#N[e]?.forEach(s=>{t.channel=s,i=!0,this.#D[t.type].call(this,t)}),i||console.warn(`${x[t.type]?x[t.type]:t.type}${[11,12].includes(t.type)?(t.data[0]!=null?t.data[0]:t.data).toString():""} event sent to CH${e+1} without any recipient.`)}}runRaw(t){}constructor(){super();let t=this;this.#r[1]=function(e){switch(e.slice(0,2)){case"@I":{this.#s=!0,this.#i.unshift(`Kar.Info: ${e.slice(2)}`);break}case"@K":{this.#s=!0,this.#i.unshift("Karaoke mode active."),console.debug(`Karaoke mode active: ${e.slice(2)}`);break}case"@L":{this.#s=!0,this.#i.unshift(`Language: ${e.slice(2)}`);break}case"@T":{this.#s=!0,this.#i.unshift(`Ka.Title: ${e.slice(2)}`);break}case"@V":{this.#s=!0,this.#i.unshift(`Kara.Ver: ${e.slice(2)}`);break}default:this.#s?e[0]=="\\"?this.#i.unshift(`@ ${e.slice(1)}`):e[0]=="/"?this.#i.unshift(e.slice(1)):this.#i[0]+=e:(this.#i[0]=e,this.#i.unshift(""))}},this.#r[2]=function(e){this.#i.unshift(`Copyrite: ${e}`)},this.#r[3]=function(e,i){i<1&&this.#o<1&&this.#i.unshift(`TrkTitle: ${e}`)},this.#r[4]=function(e,i){i<1&&this.#o<1&&this.#i.unshift(`${k(this.#o,""," ")}Instrmnt: ${e}`)},this.#r[5]=function(e){e.trim()==""?this.#i.unshift(""):this.#i[0]+=`${e}`},this.#r[6]=function(e){this.#i.unshift(`${k(this.#o,""," ")}C.Marker: ${e}`)},this.#r[7]=function(e){this.#i.unshift(`CuePoint: ${e}`)},this.#r[32]=function(e){this.#o=e[0]+1},this.#r[33]=function(e,i){console.debug(`Track ${i} requests to get assigned to output ${e}.`),t.#w[i]=e+1},this.#r[127]=function(e,i){t.#P.run(e,i)},this.#y=new f,this.#F=new f,this.#$=new f,this.#k=new f,this.#S=new f,this.#v=new f,this.#U=new f,this.#L=new f,this.#y.add([9,1],()=>{t.switchMode("gm",!0),t.#s=t.#s||!1,console.info("MIDI reset: GM")}).add([9,2],()=>{t.switchMode("?",!0),t.init(),console.info("MIDI reset: Init")}).add([9,3],()=>{t.switchMode("g2",!0),t.#s=t.#s||!1,console.info("MIDI reset: GM2")}),this.#$.add([76,0,0,126,0],()=>{t.switchMode("xg",!0),t.#s=!1,console.info("MIDI reset: XG")}),this.#k.add([22,18,127,0,0,1],()=>{t.switchMode("mt32",!0),t.#s=!1,console.info("MIDI reset: MT-32")}).add([66,18,64,0,127,0,65],()=>{t.switchMode("gs",!0),t.#t[n.cc*9]=120,t.#t[n.cc*25]=120,t.#t[n.cc*41]=120,t.#t[n.cc*57]=120,t.#s=!1,t.#u.forEach(o),console.info("MIDI reset: GS")}),this.#v.add([16,0,8,0,0,0,0],()=>{t.switchMode("k11",!0),t.#s=!1,console.info("MIDI reset: KAWAI GMega/K11")})}};export{tt as OctaviaDevice,n as allocated,h as ccToPos};
