var w=function(t,e){let i=Math.min(t.length,e.length),s=t.slice(0,i),h=e.slice(0,i),o=0,l=0;for(;l<i&&o==0;)o=Math.sign(s[l]-h[l]),l++;return o},c=function(){this.pool=[],this.point=function(t,e=!1){if(this.pool.length>0){let i=this.pool.length,s=1<<Math.floor(Math.log2(i)),h=s,o=64;for(;s>=1&&o>=0;){if(o<=0)throw new Error("TTL reached.");if(h==i)h-=s;else{let g=w(t,this.pool[h]);switch(g){case 0:{o=0;break}case 1:{h+s<=i&&(h+=s);break}case-1:{h!=0&&(h-=s);break}default:console.warn(`Unexpected result ${g}.`)}}s=s>>1,o--}let l=!0;if(h>=this.pool.length)l=!1;else{let g=this;this.pool[h].forEach(function(v,k,R){l&&v!=t[k]&&(l=!1)}),!l&&w(t,this.pool[h])>0&&h++}return l||e?h:-1}else return e?0:-1},this.add=function(t,e){return t.data=e,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let e=this.point(t);if(e>-1)return this.pool[e].data;this.default(t)},this.run=function(t,...e){let i=this.point(t);i>-1?this.pool[i].data(t.slice(this.pool[i].length),...e):this.default(t,...e)}};var E=class{#e={};addEventListener(t,e){this.#e[t]||(this.#e[t]=[]),this.#e[t].unshift(e)}removeEventListener(t,e){if(this.#e[t]){let i=this.#e[t].indexOf(e);i>-1&&this.#e[t].splice(i,1),this.#e[t].length<1&&delete this.#e[t]}}dispatchEvent(t,e){let i=new Event(t),s=this;i.data=e,this.#e[t]?.length>0&&this.#e[t].forEach(function(h){h?.call(s,i)}),this[`on${t}`]&&this[`on${t}`](i)}};var n=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"];n[16]="white room";n[17]="tunnel";n[19]="basement";n[20]="karaoke";n[64]="pass through";n[65]="chorus";n[66]="celeste";n[67]="flanger";n[68]="symphonic";n[69]="rotary speaker";n[70]="tremelo";n[71]="auto pan";n[72]="phaser";n[73]="distortion";n[74]="overdrive";n[75]="amplifier";n[76]="3-band EQ";n[77]="2-band EQ";n[78]="auto wah";var p=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw","krs","k11","sg"],b=[[0,0,0,0,121,0,0,56,82,81,63,0,0],[0,0,1,0,0,127,0,0,0,0,0,0,0]],u=[120,127,120,127,120,127,61,62,62,62,120,122,127],T=[0,3,81,84,88],M={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},d={0:0,1:1,2:3,5:4},y=[8,9,10,32,33,36,37,99,100,101];var m=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,12,13],C=[33,99,100,32,102,8,9,10],f={};p.forEach((t,e)=>{f[t]=e});var $={length:m.length};m.forEach((t,e)=>{$[t]=e});var a=function(t,e,i){i[e]=0},I=function(t){let e=[[]];return t?.forEach(function(i){i==247||(i==240?e.push([]):e[e.length-1].push(i))}),e},x=function(t,e="",i="",s=2){return t?`${e}${t.toString().padStart(s,"0")}${i}`:""},r={ch:64,cc:m.length,nn:128,pl:512,tr:256,rpn:6},j=class extends E{#e=0;#T=new Uint8Array(256);#C=0;#u=new Uint8Array(r.ch);#I=new Uint8Array(r.ch);#t=new Uint8ClampedArray(8192);#E=new Uint8ClampedArray(r.ch);#n=new Uint8ClampedArray(r.ch*r.nn);#R=new Uint8Array(r.ch);#h=new Uint16Array(r.pl);#d=new Int16Array(r.ch);#b=new Array(r.ch);#l=new Uint8Array(r.ch);#g=0;#o=new Uint8Array(r.ch*r.rpn);#M=new Int8Array(r.ch*y.length);#p=0;#m=0;#y=100;#c=0;#A="";#O=0;#s=!1;#N;#i=[];#a=new Uint8Array(r.ch);#w=new Uint8Array(r.tr);chRedir(t,e,i){if([f.gs,f.ns5r].indexOf(this.#e)>-1){if(this.#w[e])return(this.#w[e]-1)*16+t;if(i==1)return t;let s=0;return this.#a[t]==0?(this.#a[t]=e,console.debug(`Assign track ${e} to channel ${t+1}.`)):this.#a[t]!=e&&(s=16,this.#a[t+s]==0?(this.#a[t+s]=e,console.debug(`Assign track ${e} to channel ${t+s+1}.`)):this.#a[t+s]!=e&&(s=0)),t+s}else return t}#r=[];#P;#f={ano:t=>{this.#h.forEach((e,i,s)=>{let h=e>>7;e==0&&this.#n[0]==0||h==t&&(this.#n[e]=0,s[i]=0)})}};#D={8:function(t){let i=t.channel*128+t.data[0],s=this.#h.indexOf(i);s>-1&&(this.#h[s]=0,this.#n[i]=0)},9:function(t){let e=t.channel;this.#u[e]=1;let i=e*128+t.data[0];if(t.data[1]>0){let s=0;for(;this.#h[s]>0;)s++;s<this.#h.length?(this.#h[s]=i,this.#n[i]=t.data[1],this.#l[e]<t.data[1]&&(this.#l[e]=t.data[1])):console.error("Polyphony exceeded.")}else{let s=this.#h.indexOf(i);s>-1&&(this.#h[s]=0,this.#n[i]=0)}},10:function(t){let i=t.channel*128+t.data[0];this.#h.indexOf(i)>-1&&(this.#n[i]=data[1])},11:function(t){let e=t.channel;this.#u[e]=1;let i=e*128;switch($[t.data[0]]==null&&console.warn(`cc${t.data[0]} is not accepted.`),t.data[0]){case 0:{if(this.#e==f.gs||this.#e==0)t.data[1]<48?(this.#t[i]>119&&(t.data[1]=this.#t[i],this.#e||(t.data[1]=120,console.debug(`Forced channel ${e+1} to stay drums.`))),t.data[1]>0&&!this.#e&&(console.debug(`Roland GS detected with MSB: ${t.data[1]}`),this.switchMode("gs"))):t.data[1]==62?this.switchMode("x5d"):t.data[1]==63&&this.switchMode("krs");else if(this.#e==f.gm)t.data[1]<48&&this.#t[i]>119&&(t.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${e+1} to stay drums.`));else if(this.#e==f.x5d){if(t.data[1]>0&&t.data[1]<8)this.switchMode("05rw",!0);else if(t.data[1]==56){let s=0;for(let h=0;h<16;h++){let o=this.#t[128*h];(o==56||o==62)&&s++}s>14&&this.switchMode("ag10",!0)}}break}case 6:{if(this.#g){let s=this.#t[i+99],h=this.#t[i+98];if(s==1){let o=C.indexOf(h);o>-1&&(this.#t[i+71+o]=t.data[1],console.debug(`Redirected NRPN 1 ${h} to cc${71+o}.`));let l=y.indexOf(h);l>-1&&(this.#M[e*10+l]=t.data[1]-64),console.debug(`CH${e+1} voice NRPN ${s} ${h} commit`)}else console.debug(`CH${e+1} drum NRPN ${s} ${h} commit`)}else this.#t[i+101]==0&&d[this.#t[i+100]]!=null&&(this.#o[e*r.rpn+d[this.#t[i+100]]]=t.data[1],console.debug(`CH${e+1} RPN 0 ${this.#t[i+100]} commit: ${t.data[1]}`));break}case 38:{this.#g||this.#t[i+101]==0&&d[this.#t[i+100]]!=null&&(this.#o[e*r.rpn+d[this.#t[i+100]]+1]=t.data[1]);break}case 98:case 99:{this.#g=1;break}case 100:case 101:{this.#g=0;break}case 120:break;case 121:{this.#f.ano(e),this.#d[e]=0;let s=e*128;this.#t[s+1]=0,this.#t[s+5]=0,this.#t[s+64]=0,this.#t[s+65]=0,this.#t[s+66]=0,this.#t[s+67]=0,this.#t[s+11]=127,this.#t[s+101]=127,this.#t[s+100]=127,this.#t[s+99]=127,this.#t[s+98]=127;break}case 123:{this.#f.ano(e);break}case 124:{this.#f.ano(e);break}case 125:{this.#f.ano(e);break}case 126:{this.#R[e]=1,this.#f.ano(e);break}case 127:{this.#R[e]=0,this.#f.ano(e);break}}this.#t[i+t.data[0]]=t.data[1]},12:function(t){let e=t.channel;this.#u[e]=1,this.#E[e]=t.data,this.#b[e]=0},13:function(t){let e=this,i=t.channel;this.#h.forEach(function(s){let h=s>>7;i==h&&(e.#n[s]=t.data)})},14:function(t){let e=t.channel;this.#d[e]=t.data[1]*128+t.data[0]-8192},15:function(t){I(t.data).forEach(e=>{let i=e[0],s=e[1]&15;(this.#K[i]||function(){console.debug(`Unknown manufacturer ${i}.`)})(s,e.slice(2))})},255:function(t){if((this.#r[t.meta]||function(i,s,h){}).call(this,t.data,t.track,t.meta),t.meta!=32&&(this.#c=0),T.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#K={64:(t,e)=>{this.#k.run(e)},65:(t,e)=>{this.#v.run(e)},66:(t,e)=>{this.#S.run(e)},67:(t,e)=>{this.#$.run(e)},68:(t,e)=>{this.#L.run(e)},71:(t,e)=>{this.#U.run(e)},126:(t,e)=>{this.#x.run(e)},127:(t,e)=>{}};#x;#F;#$;#v;#S;#k;#U;#L;buildRchTree(){let t=[];this.#I.forEach((e,i)=>{t[e]?.constructor||(t[e]=[]),t[e].push(i)}),this.#N=t}getActive(){let t=this.#u.slice();return this.#e==f.mt32,t}getCc(t){let e=t*128,i=this.#t.slice(e,e+128);return i[0]=i[0]||this.#p,i[32]=i[32]||this.#m,i}getCcAll(){let t=this.#t.slice();for(let e=0;e<64;e++){let i=e*128;t[i]=t[i]||this.#p,t[i+32]=t[i+32]||this.#m}return t}getPitch(){return this.#d}getProgram(){return this.#E}getTexts(){return this.#i.slice()}getVel(t){let e=new Map,i=this;return this.#h.forEach(function(s){let h=Math.floor(s/128),o=s%128;t==h&&i.#n[s]>0&&e.set(o,i.#n[s])}),e}getBitmap(){return{bitmap:this.#T,expire:this.#C}}getCustomNames(){return this.#b.slice()}getLetter(){return{text:this.#A,expire:this.#O}}getMode(){return p[this.#e]}getMaster(){return{volume:this.#y}}getRawStrength(){let t=this;return this.#h.forEach(function(e){let i=Math.floor(e/128);t.#n[e]>t.#l[i]&&(t.#l[i]=t.#n[e])}),this.#l}getStrength(){let t=[],e=this;return this.getRawStrength().forEach(function(i,s){t[s]=Math.floor(i*e.#t[s*128+7]*e.#t[s*128+11]*e.#y/803288)}),t}getRpn(){return this.#o}getNrpn(){return this.#M}init(t=0){this.dispatchEvent("mode","?"),this.#e=0,this.#p=0,this.#m=0,this.#c=0,this.#u.forEach(a),this.#t.forEach(a),this.#E.forEach(a),this.#n.forEach(a),this.#h.forEach(a),this.#l.forEach(a),this.#d.forEach(a),this.#M.forEach(a),this.#y=100,this.#i=[],this.#O=0,this.#A="",this.#C=0,this.#T.forEach(a),this.#b.forEach(a),this.#s=!1,this.#I.forEach(function(e,i,s){s[i]=i}),this.buildRchTree(),this.#a.forEach(a),this.#w.forEach(a),this.#t[1152]=u[0],this.#t[3200]=u[0],this.#t[5248]=u[0],this.#t[7296]=u[0];for(let e=0;e<64;e++){let i=e*128;this.#t[i+7]=127,this.#t[i+11]=127,this.#t[i+10]=64,this.#t[i+71]=64,this.#t[i+72]=64,this.#t[i+73]=64,this.#t[i+74]=64,this.#t[i+75]=64,this.#t[i+76]=64,this.#t[i+77]=64,this.#t[i+78]=64,this.#t[i+101]=127,this.#t[i+100]=127,this.#t[i+99]=127,this.#t[i+98]=127;let s=e*r.rpn;this.#o[s]=2,this.#o[s+1]=64,this.#o[s+2]=0,this.#o[s+3]=64,this.#o[s+4]=0,this.#o[s+5]=0}}switchMode(t,e=!1){let i=p.indexOf(t);if(i>-1){if(this.#e==0||e){this.#e=i,this.#p=b[0][i],this.#m=b[1][i];for(let s=0;s<64;s++)u.indexOf(this.#t[s*128])>-1&&(this.#t[s*128]=u[i]);this.dispatchEvent("mode",t)}}else throw new Error(`Unknown mode ${t}`)}newStrength(){this.#l.forEach(a)}runJson(t){if(t.type>14)return this.#D[t.type].call(this,t);{let e=this.chRedir(t.part,t.track),i=!1;this.#N[e]?.forEach(s=>{t.channel=s,i=!0,this.#D[t.type].call(this,t)}),i||console.warn(`${M[t.type]?M[t.type]:t.type}${[11,12].includes(t.type)?(t.data[0]!=null?t.data[0]:t.data).toString():""} event sent to CH${e+1} without any recipient.`)}}runRaw(t){}constructor(){super();let t=this;this.#r[1]=function(e){switch(e.slice(0,2)){case"@I":{this.#s=!0,this.#i.unshift(`Kar.Info: ${e.slice(2)}`);break}case"@K":{this.#s=!0,this.#i.unshift("Karaoke mode active."),console.debug(`Karaoke mode active: ${e.slice(2)}`);break}case"@L":{this.#s=!0,this.#i.unshift(`Language: ${e.slice(2)}`);break}case"@T":{this.#s=!0,this.#i.unshift(`Ka.Title: ${e.slice(2)}`);break}case"@V":{this.#s=!0,this.#i.unshift(`Kara.Ver: ${e.slice(2)}`);break}default:this.#s?e[0]=="\\"?this.#i.unshift(`@ ${e.slice(1)}`):e[0]=="/"?this.#i.unshift(e.slice(1)):this.#i[0]+=e:(this.#i[0]=e,this.#i.unshift(""))}},this.#r[2]=function(e){this.#i.unshift(`Copyrite: ${e}`)},this.#r[3]=function(e,i){i<1&&this.#c<1&&this.#i.unshift(`TrkTitle: ${e}`)},this.#r[4]=function(e,i){i<1&&this.#c<1&&this.#i.unshift(`${x(this.#c,""," ")}Instrmnt: ${e}`)},this.#r[5]=function(e){e.trim()==""?this.#i.unshift(""):this.#i[0]+=`${e}`},this.#r[6]=function(e){this.#i.unshift(`${x(this.#c,""," ")}C.Marker: ${e}`)},this.#r[7]=function(e){this.#i.unshift(`CuePoint: ${e}`)},this.#r[32]=function(e){this.#c=e[0]+1},this.#r[33]=function(e,i){console.debug(`Track ${i} requests to get assigned to output ${e}.`),t.#w[i]=e+1},this.#r[127]=function(e,i){t.#P.run(e,i)},this.#x=new c,this.#F=new c,this.#$=new c,this.#v=new c,this.#S=new c,this.#k=new c,this.#U=new c,this.#L=new c,this.#x.add([9,1],()=>{t.switchMode("gm",!0),t.#s=t.#s||!1,console.info("MIDI reset: GM")}).add([9,2],()=>{t.switchMode("?",!0),t.init(),console.info("MIDI reset: Init")}).add([9,3],()=>{t.switchMode("g2",!0),t.#s=t.#s||!1,console.info("MIDI reset: GM2")}),this.#$.add([76,0,0,126,0],()=>{t.switchMode("xg",!0),t.#s=!1,console.info("MIDI reset: XG")}),this.#v.add([22,18,127,0,0,1],()=>{t.switchMode("mt32",!0),t.#s=!1,console.info("MIDI reset: MT-32")}).add([66,18,64,0,127,0,65],()=>{t.switchMode("gs",!0),t.#t[1152]=120,t.#t[3200]=120,t.#t[5248]=120,t.#t[7296]=120,t.#s=!1,t.#a.forEach(a),console.info("MIDI reset: GS")}),this.#k.add([16,0,8,0,0,0,0],()=>{t.switchMode("k11",!0),t.#s=!1,console.info("MIDI reset: KAWAI GMega/K11")})}};export{j as OctaviaDevice,$ as ccToPos};
