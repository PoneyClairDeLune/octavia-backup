var Fe=Object.create;var de=Object.defineProperty;var Ge=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var Ye=Object.getPrototypeOf,Ve=Object.prototype.hasOwnProperty;var He=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var Ke=(i,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Ne(t))!Ve.call(i,n)&&n!==r&&de(i,n,{get:()=>t[n],enumerable:!(s=Ge(t,n))||s.enumerable});return i};var We=(i,t,r)=>(r=i!=null?Fe(Ye(i)):{},Ke(t||!i||!i.__esModule?de(r,"default",{value:i,enumerable:!0}):r,i));var Ae=He((At,te)=>{(function(){"use strict";let i={debug:!1,parse:function(t,r){if(t instanceof Uint8Array)return i.Uint8(t);if(typeof t=="string")return i.Base64(t);if(t instanceof HTMLElement&&t.type==="file")return i.addListener(t,r);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(t,r){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(t===void 0||!(t instanceof HTMLElement)||t.tagName!=="INPUT"||t.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;r=r||function(){},t.addEventListener("change",function(s){if(!s.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let n=new FileReader;n.readAsArrayBuffer(s.target.files[0]),n.onload=function(a){r(i.Uint8(new Uint8Array(a.target.result)))}})},Base64:function(t){let r=function(a){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(a=a.replace(/^.*?base64,/,""),a=String(a).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(a))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");a+="==".slice(2-(3&a.length));let d,p="",c,l,u=0;for(;u<a.length;)d=o.indexOf(a.charAt(u++))<<18|o.indexOf(a.charAt(u++))<<12|(c=o.indexOf(a.charAt(u++)))<<6|(l=o.indexOf(a.charAt(u++))),p+=c===64?String.fromCharCode(d>>16&255):l===64?String.fromCharCode(d>>16&255,d>>8&255):String.fromCharCode(d>>16&255,d>>8&255,255&d);return p}(t=String(t));var s=r.length;let n=new Uint8Array(new ArrayBuffer(s));for(let a=0;a<s;a++)n[a]=r.charCodeAt(a);return i.Uint8(n)},Uint8:function(n){let r={data:null,pointer:0,movePointer:function(c){return this.pointer+=c,this.pointer},readInt:function(c){if((c=Math.min(c,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<c)for(let u=1;u<=c-1;u++)l+=this.data.getUint8(this.pointer)*Math.pow(256,c-u),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(c){let l="";for(let u=1;u<=c;u++)l+=String.fromCharCode(this.readInt(1));return l},backOne:function(){this.pointer--},readIntVLV:function(){let c=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)c=this.readInt(1);else{let u=[];for(;128<=this.data.getUint8(this.pointer);)u.push(this.readInt(1)-128);var l=this.readInt(1);for(let f=1;f<=u.length;f++)c+=u[u.length-f]*Math.pow(128,f);c+=l}return c}};if(r.data=new DataView(n.buffer,n.byteOffset,n.byteLength),r.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;r.readInt(4);let s={};s.formatType=r.readInt(2),s.tracks=r.readInt(2),s.track=[];var n=r.readInt(1),a=r.readInt(1);128<=n?(s.timeDivision=[],s.timeDivision[0]=n-128,s.timeDivision[1]=a):s.timeDivision=256*n+a;for(let c=1;c<=s.tracks;c++){s.track[c-1]={event:[]};var o,d=r.readInt(4);if(d===-1)break;if(d!==1297379947)return!1;r.readInt(4);let l=0,u=!1,f,M;for(;!u&&(l++,s.track[c-1].event[l-1]={},s.track[c-1].event[l-1].deltaTime=r.readIntVLV(),(f=r.readInt(1))!==-1);)if(128<=f?M=f:(f=M,r.movePointer(-1)),f===255){s.track[c-1].event[l-1].type=255,s.track[c-1].event[l-1].metaType=r.readInt(1);var p=r.readIntVLV();switch(s.track[c-1].event[l-1].metaType){case 47:case-1:u=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:s.track[c-1].event[l-1].data=r.readStr(p);break;case 33:case 89:case 81:s.track[c-1].event[l-1].data=r.readInt(p);break;case 84:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=r.readInt(1),s.track[c-1].event[l-1].data[1]=r.readInt(1),s.track[c-1].event[l-1].data[2]=r.readInt(1),s.track[c-1].event[l-1].data[3]=r.readInt(1),s.track[c-1].event[l-1].data[4]=r.readInt(1);break;case 88:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=r.readInt(1),s.track[c-1].event[l-1].data[1]=r.readInt(1),s.track[c-1].event[l-1].data[2]=r.readInt(1),s.track[c-1].event[l-1].data[3]=r.readInt(1);break;default:this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].metaType,r,p)),this.customInterpreter!==null&&s.track[c-1].event[l-1].data!==!1||(r.readInt(p),s.track[c-1].event[l-1].data=r.readInt(p),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((f=f.toString(16).split(""))[1]||f.unshift("0"),s.track[c-1].event[l-1].type=parseInt(f[0],16),s.track[c-1].event[l-1].channel=parseInt(f[1],16),s.track[c-1].event[l-1].type){case 15:this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].type,r,!1)),this.customInterpreter!==null&&s.track[c-1].event[l-1].data!==!1||(o=r.readIntVLV(),s.track[c-1].event[l-1].data=r.readInt(o),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=r.readInt(1),s.track[c-1].event[l-1].data[1]=r.readInt(1);break;case 12:case 13:s.track[c-1].event[l-1].data=r.readInt(1);break;case-1:u=!0;break;default:if(this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].metaType,r,!1)),this.customInterpreter===null||s.track[c-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return s},customInterpreter:null};if(typeof te<"u")te.exports=i;else{let t=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;t.MidiParser=i}})()});var ue=function(i){let t=Array.from("----");if(i>0)for(let r=0;i>0;r++)t[r]=i<1024?"=":">",i-=2048;else if(i<0)for(let r=3;i<0;r--)t[r]=i>=-1024?"=":"<",i+=2048;return t.join("")},ge=function(i){if(i==128)return"<<>>";let t=Array.from("----");if(i>64)for(let r=0;i>64;r++)t[r]=i<72?"=":">",i-=16;else if(i<64)for(let r=3;i<64;r--)t[r]=i>=56?"=":"<",i+=16;return t.join("")};var W=class{#t={};addEventListener(i,t){this.#t[i]||(this.#t[i]=[]),this.#t[i].unshift(t)}removeEventListener(i,t){if(this.#t[i]){let r=this.#t[i].indexOf(t);r>-1&&this.#t[i].splice(r,1),this.#t[i].length<1&&delete this.#t[i]}}dispatchEvent(i,t){let r=new Event(i),s=this;r.data=t,this.#t[i]?.length>0&&this.#t[i].forEach(function(n){n?.call(s,r)}),this[`on${i}`]&&this[`on${i}`](r)}};var pe=function(i,t){let r=Math.min(i.length,t.length),s=i.slice(0,r),n=t.slice(0,r),a=0,o=0;for(;o<r&&a==0;)a=Math.sign(s[o]-n[o]),o++;return a},U=function(){this.pool=[],this.point=function(i,t=!1){if(this.pool.length>0){let r=this.pool.length,s=1<<Math.floor(Math.log2(r)),n=s,a=64;for(;s>=1&&a>=0;){if(a<=0)throw new Error("TTL reached.");if(n==r)n-=s;else{let d=pe(i,this.pool[n]);switch(d){case 0:{a=0;break}case 1:{n+s<=r&&(n+=s);break}case-1:{n!=0&&(n-=s);break}default:console.warn(`Unexpected result ${d}.`)}}s=s>>1,a--}let o=!0;if(n>=this.pool.length)o=!1;else{let d=this;this.pool[n].forEach(function(p,c,l){o&&p!=i[c]&&(o=!1)}),!o&&pe(i,this.pool[n])>0&&n++}return o||t?n:-1}else return t?0:-1},this.add=function(i,t){return i.data=t,this.pool.splice(this.point(i,!0),0,i),this},this.default=function(i){console.warn(`No match for "${i}". Default action not defined.`)},this.get=function(i){let t=this.point(i);if(t>-1)return this.pool[t].data;this.default(i)},this.run=function(i,...t){let r=this.point(i);r>-1?this.pool[r].data(i.slice(this.pool[r].length),...t):this.default(i,...t)}};var q=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),me=["melodic","drum","drum set 1","drum set 2","drum set 3","drum set 4"],qe=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],Y=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],be=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],$e=function(i){let t=.1,r=-.3;return i>66?(t=5,r=315):i>56?(t=1,r=47):i>46&&(t=.5,r=18.5),t*i-r},ye=function(i){return i>105?qe[i-106]:i>100?i*1.1-100:i/10};var we=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],Ee=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],Se=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var B=function(i=64){return Math.round(2e3*Math.log10(i/64))/100},ke=function(i){let t=0;return i.forEach(r=>{t+=r,t>127&&(t%=128)}),128-t};var j=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw","krs","k11","sg"],Me=[[0,0,0,0,121,0,0,56,82,81,63,0,0],[0,0,1,0,0,127,0,0,0,0,0,0,0]],G=[120,127,120,127,120,127,61,62,62,62,120,122,127],ze=[0,3,81,84,88],ve={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},J={0:0,1:1,2:3,5:4},Ce=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],Te=[36,37];var ee=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,12,13,16,17,18,19],Qe=[33,99,100,32,102,8,9,10],O={};j.forEach((i,t)=>{O[i]=t});var h={length:ee.length};ee.forEach((i,t)=>{h[i]=t});var A=function(i,t,r){r[t]=0},Ze=function(i){let t=[[]];return i?.forEach(function(r){r==247||(r==240?t.push([]):t[t.length-1].push(r))}),t},Pe=function(i,t="",r="",s=2){return i?`${t}${i.toString().padStart(s,"0")}${r}`:""},C={ch:128,cc:ee.length,nn:128,pl:512,tr:256,rpn:6},Ie=class extends W{#t=0;#r=0;#n=0;#a=new Array(10);get#s(){return this.#a[this.#r]}set#s(i){this.#a[this.#r]=i}#i=new Uint8Array(C.ch);#l=new Uint8Array(C.ch);#e=new Uint8ClampedArray(C.ch*C.cc);#d=new Uint8ClampedArray(C.ch);#o=new Uint8ClampedArray(C.ch*C.nn);#p=new Uint8Array(C.ch);#c=new Uint16Array(C.pl);#v=new Int16Array(C.ch);#A=new Array(C.ch);#b=new Uint8Array(C.ch);#C=0;#g=new Uint8Array(C.ch*C.rpn);#x=new Int8Array(C.ch*Te.length);#T=0;#S=0;#y=100;#$=0;#m="";#P=0;#f=!1;#X;#h=[];#w=new Uint8Array(C.ch);#k=new Uint8Array(C.tr);chRedir(i,t,r){if(this.#k[t])return(this.#k[t]-1)*16+i;if([O.gs,O.ns5r].indexOf(this.#t)>-1){if(r==1)return i;let s=0,n=!0;for(;n;)this.#w[i+s]==0?(this.#w[i+s]=t,console.debug(`Assign track ${t} to channel ${i+s+1}.`),n=!1):this.#w[i+s]==t?n=!1:(s+=16,s>=128&&(s=0,n=!1));return i+s}else return i}#u=[];#R;#E={ano:i=>{this.#c.forEach((t,r,s)=>{let n=t>>7;t==0&&this.#o[0]==0||n==i&&(this.#o[t]=0,s[r]=0)})}};#O={8:function(i){let r=i.channel*128+i.data[0],s=this.#c.indexOf(r);s>-1&&(this.#c[s]=0,this.#o[r]=0)},9:function(i){let t=i.channel;this.#i[t]=1;let r=t*128+i.data[0];if(i.data[1]>0){let s=0;for(;this.#c[s]>0;)s++;s<this.#c.length?(this.#c[s]=r,this.#o[r]=i.data[1],this.#b[t]<i.data[1]&&(this.#b[t]=i.data[1])):console.error("Polyphony exceeded.")}else{let s=this.#c.indexOf(r);s>-1&&(this.#c[s]=0,this.#o[r]=0)}},10:function(i){let r=i.channel*128+i.data[0];this.#c.indexOf(r)>-1&&(this.#o[r]=data[1])},11:function(i){let t=i.channel;this.#i[t]=1;let r=t*C.cc;switch(i.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#E.ano(t),this.#v[t]=0;let s=t*C.cc;this.#e[s+h[1]]=0,this.#e[s+h[5]]=0,this.#e[s+h[64]]=0,this.#e[s+h[65]]=0,this.#e[s+h[66]]=0,this.#e[s+h[67]]=0,this.#e[s+h[11]]=127,this.#e[s+h[101]]=127,this.#e[s+h[100]]=127,this.#e[s+h[99]]=127,this.#e[s+h[98]]=127;return}case 123:{this.#E.ano(t);return}case 124:{this.#E.ano(t);return}case 125:{this.#E.ano(t);return}case 126:{this.#p[t]=1,this.#E.ano(t);return}case 127:{this.#p[t]=0,this.#E.ano(t);return}}if(h[i.data[0]]==null)console.warn(`cc${i.data[0]} is not accepted.`);else{switch(i.data[0]){case 0:{if(this.#t==0)i.data[1]<48?(this.#e[r]>119&&(i.data[1]=this.#e[r],i.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`)),i.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${i.data[1]}`),this.switchMode("gs"))):i.data[1]==62?this.switchMode("x5d"):i.data[1]==63&&this.switchMode("krs");else if(this.#t==O.gs)i.data[1]<56&&this.#e[r]>119&&(i.data[1]=this.#e[r],i.data[1]=120,console.debug(`Forced channel ${t+1} to stay drums.`));else if(this.#t==O.gm)i.data[1]<48&&this.#e[r]>119&&(i.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${t+1} to stay drums.`));else if(this.#t==O.x5d){if(i.data[1]>0&&i.data[1]<8)this.switchMode("05rw",!0);else if(i.data[1]==56){let s=0;for(let n=0;n<16;n++){let a=this.#e[C.cc*n];(a==56||a==62)&&s++}s>14&&this.switchMode("ag10",!0)}}break}case 6:{if(this.#C){let s=this.#e[r+h[99]],n=this.#e[r+h[98]];if(s==1){let a=Qe.indexOf(n);if(a>-1)this.#e[r+h[71+a]]=i.data[1];else{let o=Te.indexOf(n);o>-1&&(this.#x[t*10+o]=i.data[1]-64),console.debug(`CH${t+1} voice NRPN ${n} commit`)}}}else{let s=J[this.#e[r+h[100]]];this.#e[r+h[101]]==0&&s!=null&&(console.debug(`CH${t+1} RPN 0 ${this.#e[r+h[100]]} commit: ${i.data[1]}`),i.data[1]=Math.min(Math.max(i.data[1],Ce[s][0]),Ce[s][1]),this.#g[t*C.rpn+s]=i.data[1])}break}case 38:{this.#C||this.#e[r+101]==0&&J[this.#e[r+100]]!=null&&(this.#g[t*C.rpn+J[this.#e[r+100]]+1]=i.data[1]);break}case 98:case 99:{this.#C=1;break}case 100:case 101:{this.#C=0;break}}this.#e[r+h[i.data[0]]]=i.data[1]}},12:function(i){let t=i.channel;this.#i[t]=1,this.#d[t]=i.data,this.#A[t]=0},13:function(i){let t=this,r=i.channel;this.#c.forEach(function(s){let n=s>>7;r==n&&(t.#o[s]=i.data)})},14:function(i){let t=i.channel;this.#v[t]=i.data[1]*128+i.data[0]-8192},15:function(i){Ze(i.data).forEach(t=>{let r=t[0],s=t[1];(this.#N[r]||function(){console.debug(`Unknown manufacturer ${r}.`)})(s,t.slice(2),i.track)})},255:function(i){if((this.#u[i.meta]||function(r,s,n){}).call(this,i.data,i.track,i.meta),i.meta!=32&&(this.#$=0),ze.indexOf(i.meta)>-1)return i.reply="meta",i;self.debugMode&&console.debug(i)}};#N={64:(i,t,r)=>{this.#D.run(t,r,i)},65:(i,t,r)=>{if(t[0]<64)this.#M.run(t,r,i);else{let s=t.pop(),n=ke(t.slice(2));s==n?this.#M.run(t,r,i):console.warn(`Bad GS checksum ${s}. Should be ${n}.`)}},66:(i,t,r)=>{this.#L.run(t,r,i)},67:(i,t,r)=>{this.#I.run(t,r,i)},68:(i,t,r)=>{this.#G.run(t,r,i)},71:(i,t,r)=>{this.#F.run(t,r,i)},126:(i,t,r)=>{this.#B.run(t,r,i)},127:(i,t,r)=>{this.switchMode("gm"),this.#U.run(t,r,i)}};#B;#U;#I;#M;#L;#D;#F;#G;buildRchTree(){let i=[];this.#l.forEach((t,r)=>{i[t]?.constructor||(i[t]=[]),i[t].push(r)}),this.#X=i}getActive(){let i=this.#i.slice();return this.#t==O.mt32,i}getCc(i){let t=i*C.cc,r=this.#e.slice(t,t+C.cc);return r[h[0]]=r[h[0]]||this.#T,r[h[32]]=r[h[32]]||this.#S,r}getCcAll(){let i=this.#e.slice();for(let t=0;t<64;t++){let r=t*C.cc;i[r+h[0]]=i[r+h[0]]||this.#T,i[r+h[32]]=i[r+h[32]]||this.#S}return i}getPitch(){return this.#v}getProgram(){return this.#d}getTexts(){return this.#h.slice()}getVel(i){let t=new Map,r=this;return this.#c.forEach(function(s){let n=Math.floor(s/128),a=s%128;i==n&&r.#o[s]>0&&t.set(a,r.#o[s])}),t}getBitmap(){return{bitmap:this.#s,expire:this.#n}}getCustomNames(){return this.#A.slice()}getLetter(){return{text:this.#m,expire:this.#P}}getMode(){return j[this.#t]}getMaster(){return{volume:this.#y}}getRawStrength(){let i=this;return this.#c.forEach(function(t){let r=Math.floor(t/128);i.#o[t]>i.#b[r]&&(i.#b[r]=i.#o[t])}),this.#b}getStrength(){let i=[],t=this;return this.getRawStrength().forEach(function(r,s){i[s]=Math.floor(r*t.#e[s*C.cc+h[7]]*t.#e[s*C.cc+h[11]]*t.#y/803288)}),i}getRpn(){return this.#g}getNrpn(){return this.#x}init(i=0){this.dispatchEvent("mode","?"),this.#t=0,this.#T=0,this.#S=0,this.#$=0,this.#i.forEach(A),this.#e.forEach(A),this.#d.forEach(A),this.#o.forEach(A),this.#c.forEach(A),this.#b.forEach(A),this.#v.forEach(A),this.#x.forEach(A),this.#y=100,this.#h=[],this.#P=0,this.#m="",this.#n=0,this.#r=0,this.#s.forEach(A),this.#A.forEach(A),this.#f=!1,this.#l.forEach(function(t,r,s){s[r]=r}),this.buildRchTree(),this.#w.forEach(A),this.#k.forEach(A),this.#e[C.cc*9]=G[0],this.#e[C.cc*25]=G[0],this.#e[C.cc*41]=G[0],this.#e[C.cc*57]=G[0];for(let t=0;t<64;t++){let r=t*C.cc;this.#e[r+h[7]]=100,this.#e[r+h[11]]=127,this.#e[r+h[10]]=64,this.#e[r+h[71]]=64,this.#e[r+h[72]]=64,this.#e[r+h[73]]=64,this.#e[r+h[74]]=64,this.#e[r+h[75]]=64,this.#e[r+h[76]]=64,this.#e[r+h[77]]=64,this.#e[r+h[78]]=64,this.#e[r+h[91]]=40,this.#e[r+h[101]]=127,this.#e[r+h[100]]=127,this.#e[r+h[99]]=127,this.#e[r+h[98]]=127;let s=t*C.rpn;this.#g[s]=2,this.#g[s+1]=64,this.#g[s+2]=0,this.#g[s+3]=64,this.#g[s+4]=0,this.#g[s+5]=0}}switchMode(i,t=!1){let r=j.indexOf(i);if(r>-1){if(this.#t==0||t){this.#t=r,this.#r=0,this.#T=Me[0][r],this.#S=Me[1][r];for(let s=0;s<64;s++)G.indexOf(this.#e[s*C.cc])>-1&&(this.#e[s*C.cc]=G[r]);this.dispatchEvent("mode",i)}}else throw new Error(`Unknown mode ${i}`)}newStrength(){this.#b.forEach(A)}runJson(i){if(i.type>14)return this.#O[i.type].call(this,i);{let t=this.chRedir(i.part,i.track),r=!1;this.#X[t]?.forEach(s=>{i.channel=s,r=!0,this.#O[i.type].call(this,i)}),r||console.warn(`${ve[i.type]?ve[i.type]:i.type}${[11,12].includes(i.type)?(i.data[0]!=null?i.data[0]:i.data).toString():""} event sent to CH${t+1} without any recipient.`)}}runRaw(i){}constructor(){super();let i=this;this.#s=new Uint8Array(256),this.#R=new U,this.#u[1]=function(t){switch(t.slice(0,2)){case"@I":{this.#f=!0,this.#h.unshift(`Kar.Info: ${t.slice(2)}`);break}case"@K":{this.#f=!0,this.#h.unshift("Karaoke mode active."),console.debug(`Karaoke mode active: ${t.slice(2)}`);break}case"@L":{this.#f=!0,this.#h.unshift(`Language: ${t.slice(2)}`);break}case"@T":{this.#f=!0,this.#h.unshift(`Ka.Title: ${t.slice(2)}`);break}case"@V":{this.#f=!0,this.#h.unshift(`Kara.Ver: ${t.slice(2)}`);break}default:this.#f?t[0]=="\\"?this.#h.unshift(`@ ${t.slice(1)}`):t[0]=="/"?this.#h.unshift(t.slice(1)):this.#h[0]+=t:(this.#h[0]=t,this.#h.unshift(""))}},this.#u[2]=function(t){this.#h.unshift(`Copyrite: ${t}`)},this.#u[3]=function(t,r){r<1&&this.#$<1&&this.#h.unshift(`TrkTitle: ${t}`)},this.#u[4]=function(t,r){r<1&&this.#$<1&&this.#h.unshift(`${Pe(this.#$,""," ")}Instrmnt: ${t}`)},this.#u[5]=function(t){t.trim()==""?this.#h.unshift(""):this.#h[0]+=`${t}`},this.#u[6]=function(t){this.#h.unshift(`${Pe(this.#$,""," ")}C.Marker: ${t}`)},this.#u[7]=function(t){this.#h.unshift(`CuePoint: ${t}`)},this.#u[32]=function(t){this.#$=t[0]+1},this.#u[33]=function(t,r){console.debug(`Track ${r} requests to get assigned to output ${t}.`),i.#k[r]=t+1},this.#u[127]=function(t,r){i.#R.run(t,r)},this.#R.add([67,0,1],function(t,r){i.#k[r]=t[0]+1}),this.#B=new U,this.#U=new U,this.#I=new U,this.#M=new U,this.#L=new U,this.#D=new U,this.#F=new U,this.#G=new U,this.#B.add([9],t=>{i.switchMode(["gm","?","g2"][t[0]-1],!0),i.#f=i.#f||!1,console.info(`MIDI reset: ${["GM","Init","GM2"][t[0]-1]}`),t[0]==2&&i.init()}),this.#M.add([22,18,127,0,0,1],()=>{i.switchMode("mt32",!0),i.#f=!1,console.info("MIDI reset: MT-32")}),this.#D.add([16,0,8,0,0,0,0],()=>{i.switchMode("k11",!0),i.#f=!1,console.info("MIDI reset: KAWAI GMega/K11")}),this.#U.add([4,1],t=>{i.#y=((t[1]<<7)+t[0])/16383*100}).add([4,3],t=>((t[1]<<7)+t[0]-8192)/8192).add([4,4],t=>t[1]-64),this.#I.add([76,0,0],t=>{switch(t[0]){case 126:{i.switchMode("xg",!0),i.#f=!1,console.info("MIDI reset: XG");break}default:{let r=[0,0,0,0],s=(n,a)=>{r[a]=n};if(t.slice(1).forEach((n,a)=>{let o=a+t[0];[s,s,s,s,d=>{this.#y=d*129/16383*100},d=>{},d=>{}][o](n,a)}),t[0]<4){let n=0;r.forEach(a=>{n=n<<4,n+=a}),n-=1024}}}}).add([76,2,1],t=>{let r="XG ";t[0]<32?(r+="reverb ",t.slice(1).forEach((s,n)=>{([a=>{console.debug(`${r}main type: ${q[a]}`)},a=>{console.debug(`${r}sub type: ${a+1}`)},a=>{console.debug(`${r}time: ${$e(a)}s`)},a=>{console.debug(`${r}diffusion: ${a}`)},a=>{console.debug(`${r}initial delay: ${a}`)},a=>{console.debug(`${r}HPF cutoff: ${Y[a]}Hz`)},a=>{console.debug(`${r}LPF cutoff: ${Y[a]}Hz`)},a=>{console.debug(`${r}width: ${a}`)},a=>{console.debug(`${r}height: ${a}`)},a=>{console.debug(`${r}depth: ${a}`)},a=>{console.debug(`${r}wall type: ${a}`)},a=>{console.debug(`${r}dry/wet: ${a}`)},a=>{console.debug(`${r}send: ${B(a)}dB`)},a=>{console.debug(`${r}pan: ${a-64}`)},!1,!1,a=>{console.debug(`${r}delay: ${a}`)},a=>{console.debug(`${r}density: ${a}`)},a=>{console.debug(`${r}balance: ${a}`)},a=>{},a=>{console.debug(`${r}feedback: ${a}`)},a=>{}][t[0]+n]||function(){console.warn(`Unknown XG reverb address: ${t[0]}.`)})(s)})):t[0]<64?(r+="chorus ",t.slice(1).forEach((s,n)=>{([a=>{console.debug(`${r}main type: ${q[a]}`)},a=>{console.debug(`${r}sub type: ${a+1}`)},a=>{console.debug(`${r}LFO: ${be[a]}Hz`)},a=>{},a=>{console.debug(`${r}feedback: ${a}`)},a=>{console.debug(`${r}delay offset: ${ye(a)}ms`)},a=>{},a=>{console.debug(`${r}low: ${Y[a]}Hz`)},a=>{console.debug(`${r}low: ${a-64}dB`)},a=>{console.debug(`${r}high: ${Y[a]}Hz`)},a=>{console.debug(`${r}high: ${a-64}dB`)},a=>{console.debug(`${r}dry/wet: ${a}`)},a=>{console.debug(`${r}send: ${B(a)}dB`)},a=>{console.debug(`${r}pan: ${a-64}`)},a=>{console.debug(`${r}to reverb: ${B(a)}dB`)},!1,a=>{},a=>{},a=>{},a=>{console.debug(`${r}LFO phase diff: ${(a-64)*3}deg`)},a=>{console.debug(`${r}input mode: ${a?"stereo":"mono"}`)},a=>{}][t[0]-32+n]||function(){console.warn(`Unknown XG chorus address: ${t[0]}.`)})(s)})):t[0]<86?(r+="variation ",t[0]==64&&console.debug(`${r}type: ${q[t[1]]}${t[2]>0?" "+(t[2]+1):""}`)):t[0]<97?(r+="variation ",t.slice(1).forEach((s,n)=>{[a=>{console.debug(`${r}send: ${B(a)}dB`)},a=>{console.debug(`${r}pan: ${a-64}`)},a=>{console.debug(`${r}to reverb: ${B(a)}dB`)},a=>{console.debug(`${r}to chorus: ${B(a)}dB`)},a=>{console.debug(`${r}connection: ${a?"system":"insertion"}`)},a=>{console.debug(`${r}channel: CH${a+1}`)},a=>{console.debug(`${r}mod wheel: ${a-64}`)},a=>{console.debug(`${r}bend wheel: ${a-64}`)},a=>{console.debug(`${r}channel after touch: ${a-64}`)},a=>{console.debug(`${r}AC1: ${a-64}`)},a=>{console.debug(`${r}AC2: ${a-64}`)}][t[0]-86+n](s)})):t[0]>111&&t[0]<118?r+="variation ":console.warn(`Unknown XG variation address: ${t[0]}`)}).add([76,2,64],t=>{t.slice(1).forEach((r,s)=>{let n=s+t[0];if(n==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][r]}`);else{let a=n-1>>2,o=n-1&3,d=`XG EQ ${a} ${["gain","freq","Q","shape"][o]}: `;[()=>{console.debug(`${d}${r-64}dB`)},()=>{console.debug(`${d}${r} (raw)`)},()=>{console.debug(`${d}${r/10}`)},()=>{console.debug(`${d}${["shelf","peak"][+!!r]}`)}][o]()}})}).add([76,3],t=>{}).add([76,6,0],t=>{let r=t[0];i.#m=" ".repeat(r),i.#P=Date.now()+3200,t.slice(1).forEach(function(s){i.#m+=String.fromCharCode(s)}),i.#m=i.#m.padEnd(32," ")}).add([76,7,0],t=>{let r=t[0];i.#n=Date.now()+3200,i.#s.fill(0);let s=t.slice(1);for(let n=0;n<r;n++)s.unshift(0);s.forEach(function(n,a){let o=Math.floor(a/16),d=a%16,p=(d*3+o)*7,c=7,l=0;for(p-=d*5,o==2&&(c=2);l<c;)i.#s[p+l]=n>>6-l&1,l++})}).add([76,8],(t,r)=>{let s=i.chRedir(t[0],r,!0),n=t[1],a=C.cc*s,o=`XG CH${s+1} `,d=`Unknown XG part address ${n}.`;n<1?console.debug(d):n<41?t.slice(2).forEach((p,c)=>{([()=>{i.#e[a+h[0]]=p},()=>{i.#e[a+h[32]]=p},()=>{i.#d[s]=p},()=>{i.#l[s]=p,s!=p&&(i.buildRchTree(),console.info(`${o}receives from CH${p+1}`))},()=>{i.#p[s]=+!p},()=>{},()=>{i.#e[a+h[0]]=p>1?127:0,console.debug(`${o}set to type ${me[p]}`)},()=>{},!1,!1,()=>{i.#e[a+h[7]]=p},!1,!1,()=>{i.#e[a+h[10]]=p||128},!1,!1,()=>{i.#e[a+h[11]]=p},()=>{i.#e[a+h[93]]=p},()=>{i.#e[a+h[91]]=p},()=>{i.#e[a+h[94]]=p},()=>{i.#e[a+h[76]]=p},()=>{i.#e[a+h[77]]=p},()=>{i.#e[a+h[78]]=p},()=>{i.#e[a+h[74]]=p},()=>{i.#e[a+h[71]]=p},()=>{i.#e[a+h[73]]=p},()=>{i.#e[a+h[75]]=p},()=>{i.#e[a+h[72]]=p}][n+c-1]||function(){})()}):n<48?console.debug(d):n<111?n>102&&n<105&&(i.#e[a+h[[5,65][n&1]]]=e):n<114?console.debug(d):n<116?console.debug(`${o}EQ ${["bass","treble"][n&1]} gain: ${e-64}dB`):n<118?console.debug(d):n<120?console.debug(`${o}EQ ${["bass","treble"][n&1]} freq: ${e}`):console.debug(d)}).add([76,10],t=>{}).add([76,16],t=>{}).add([76,17,0,0],t=>{}).add([112],t=>{console.debug(`XG plugin PLG100-${["VL","SG","DX"][t[0]]} enabled for channel ${t[2]+1}.`)}),this.#I.add([76,48],t=>{}).add([76,49],t=>{}).add([76,50],t=>{}).add([76,51],t=>{}),this.#M.add([66,18,0,0,127],t=>{i.switchMode("gs",!0),i.#e[C.cc*9]=120,i.#e[C.cc*25]=120,i.#e[C.cc*41]=120,i.#e[C.cc*57]=120,i.#S=3,i.#f=!1,i.#w.forEach(A),console.info(`GS system to ${["single","dual"][t[0]]} mode.`)}).add([66,18,64,0],t=>{switch(t[0]){case 127:{i.switchMode("gs",!0),i.#e[C.cc*9]=120,i.#e[C.cc*25]=120,i.#e[C.cc*41]=120,i.#e[C.cc*57]=120,i.#f=!1,i.#w.forEach(A),console.info("MIDI reset: GS");break}default:{let r=[0,0,0,0],s=(n,a)=>{r[a]=n};if(t.slice(1).forEach((n,a)=>{let o=a+t[0];[s,s,s,s,d=>{this.#y=d*129/16383*100},d=>{},d=>{}][o](n,a)}),t[0]<4){let n=0;r.forEach(a=>{n=n<<4,n+=a}),n-=1024}}}}).add([66,18,64,1],t=>{let r=t[0];if(r<16){let s="".padStart(r," ");t.slice(1).forEach((n,a)=>{s+=String.fromCharCode(Math.max(32,n))}),s=s.padEnd(16," "),console.debug(`GS patch name: ${s}`)}else r<48||(r<65?t.slice(1).forEach((s,n)=>{let a=`GS ${["reverb","chorus"][+(r+n>37)]} `;([()=>{console.debug(`${a}type: ${we[s]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${a}predelay: ${s}ms`)},()=>{console.debug(`${a}type: ${Ee[s]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${a}to reverb: ${B(s)}`)},()=>{console.debug(`${a}to delay: ${B(s)}`)}][r+n-48]||function(){})()}):r<80?console.debug(`Unknown GS patch address: ${r}`):r<91?t.slice(1).forEach((s,n)=>{let a="GS delay ";([()=>{console.debug(`${a}type: ${Se[s]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${a}to reverb: ${B(s)}`)}][r+n-80]||function(){})()}):console.debug(`Unknown GS patch address: ${r}`))}).add([66,18,64,2],t=>{let r="GS EQ ";t.slice(1).forEach((s,n)=>{([()=>{console.debug(`${r}low freq: ${[200,400][s]}Hz`)},()=>{console.debug(`${r}low gain: ${s-64}dB`)},()=>{console.debug(`${r}high freq: ${[3e3,6e3][s]}Hz`)},()=>{console.debug(`${r}high gain: ${s-64}dB`)}][t[0]+n]||function(){console.warn(`Unknown GS EQ address: ${t[0]+n}`)})()})}).add([66,18,64,3],t=>{let r="GS EFX ";t.slice(1).forEach((s,n)=>{([()=>{console.debug(`${r}type MSB: ${s}`)},()=>{console.debug(`${r}type LSB: ${s}`)},!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,()=>{console.debug(`${r}to reverb: ${B(s)}dB`)},()=>{console.debug(`${r}to chorus: ${B(s)}dB`)},()=>{console.debug(`${r}to delay: ${B(s)}dB`)},!1,()=>{console.debug(`${r}1 source: ${s}`)},()=>{console.debug(`${r}1 depth: ${s-64}`)},()=>{console.debug(`${r}2 source: ${s}`)},()=>{console.debug(`${r}2 depth: ${s-64}`)},()=>{console.debug(`${r}to EQ: ${s?"ON":"OFF"}`)}][t[0]+n]||function(){})()})}).add([66,18,65],t=>{}).add([69,18,16],t=>{switch(t[0]){case 0:{i.#P=Date.now()+3200;let r=t[1];i.#m=" ".repeat(r),t.slice(2).forEach(function(s){s<128&&(i.#m+=String.fromCharCode(s))});break}case 32:{i.#n=Date.now()+3200,t[1]==0&&(i.#r=Math.max(Math.min(t[2]-1,9),0));break}default:if(t[0]<11){i.#n=Date.now()+3200,i.#a[t[0]-1]?.length||(i.#a[t[0]-1]=new Uint8Array(256));let r=i.#a[t[0]-1],s=t[1];r.fill(0);let n=t.slice(2);for(let a=0;a<s;a++)n.unshift(0);n.forEach(function(a,o){let d=Math.floor(o/16),p=o%16,c=(p*4+d)*5,l=5,u=0;for(c-=p*4,d==3&&(l=1);u<l;)r[c+u]=a>>4-u&1,u++})}else console.warn(`Unknown GS display section: ${t[0]}`)}})}};var se=We(Ae(),1);var xe=class{#t=!1;constructor(i,t,r,s){this.#t=i,this.start=t,this.end=r,this.data=s}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},ie=class extends xe{constructor(i,t,r){super(!0,i,t,r)}},Re=class extends xe{constructor(i,t){super(!1,i,i,t)}},re=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(i){this.#t=-1}fresh(){this.sort(function(i,t){return i.start==t.start?0:(+(i.start>t.start)<<1)-1}),this.forEach(function(i,t){i.index=t})}step(i,t=!1){let r=[];if(t)for(let s=0;s<this.length&&!(this[s].start>i);s++){if(this[s].end<i)continue;r.push(this[s])}else{let s=this.getRange(this.#t==-1?0:i-1,i),n=this;s.forEach(function(a){a.index>n.#t&&(r.push(a),n.#t=a.index)})}return r}getRange(i,t){i>t&&([i,t]=[t,i]);let r=[],s=-1,n=Math.ceil(Math.sqrt(this.length)),a=!0;for(let o=0;o<this.length;o+=n)this[o+n]?s<0&&this[o+n].start>=i&&(s=o):s=s<0?o:s;for(;a;)this[s]?.end<t?this[s].start>=i&&r.push(this[s]):a=!1,s++;return r}};var _e=0xffffffffffff,Be=function(i){let t=new re,r=this,s=i.timeDivision,n=120,a=new re,o=0,d=0;a.push(new ie(0,_e,[120,0])),i.track.forEach(function(u){o=0,u.event.forEach(function(f){o+=f.deltaTime,f.type==255&&f?.metaType==81&&(n=6e7/f.data,a[a.length-1]&&a.push(new ie(o,0xffffffffffff,[n,0])))})}),a.fresh(),a.forEach(function(u,f,M){f>0&&(M[f-1].end=u.start)});let p=120;a.forEach(function(u,f,M){f>0&&(u.end==u.start?M.splice(M.indexOf(u),1):p==u.data[0]&&(M[f-1].end=u.end,M.splice(M.indexOf(u),1)),p=u.data[0])});let c=0,l=120;return a.forEach(function(u){let f=u.start,M=f/l/s*60+c;l=u.data[0],c=M-f/l/s*60,u.data[1]=c}),console.debug("All tempo changes: ",a),n=120,o=0,d=0,i.track.forEach(function(u,f){o=0,d=0;let M=f+1;u.event.forEach(function(k,$){o+=k.deltaTime;let w=a.step(o,!0)[0];w&&(n=w.data[0],d=w.data[1]);let g={type:k.type,data:k.data,track:M,part:0};k.type>14?g.meta=k.metaType:g.part=k.channel,t.push(new Re(o/n/s*60+d,g))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${i.formatType} MIDI sequence.`),t};var Je=["MSB","PRG","LSB"];var Ue=class{#t;get(i=0,t=0,r=0,s){let n,a=Array.from(arguments);s=="gs"&&i==0&&r<5&&(a[2]=0),a[0]==0&&a[2]>111&&a[2]<120&&(a[2]=0);let o=" ";for(;!(n?.length>=0);)n=this.#t[a[1]||0][(a[0]<<7)+a[2]],n||(a[2]=0,o="^",this.#t[a[1]||0][a[0]<<7]||(i==62?(a[1]--,o=" "):i<64?s=="xg"&&i==16?(n=`Voice${(r*128+t+1).toString().padStart(3,"0")}`,o=" "):(a[0]=0,o="*"):i==80?(n=`PrgU:${t.toString().padStart(3,"0")}`,o="!"):i==88?(n=`CmbU:${t.toString().padStart(3,"0")}`,o="!"):i==121?(n=`GM2Vox0${r}`,o="#"):i==122?(a[1]==32?a[1]==0:a[1]%=7,o=" "):a[1]==0?(n=`${i.toString().padStart(3,"0")} ${t.toString().padStart(3,"0")} ${r.toString().padStart(3,"0")}`,o="!"):(a[1]=0,o="!")));s=="gs"&&o=="^"&&(o=" "),o!=" "&&self.debugMode&&(n="");let d="??";switch(a[0]){case 0:{a[2]==0?d="GM":a[2]==5||a[2]==7?d="KG":a[2]<120?d="XG":a[2]==127&&(d="MT");break}case 56:{d="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{d="AI";break}case 62:case 82:case 90:{d="XD";break}case 63:d="KR";case 81:{d="RW";break}case 64:case 126:{d="XG";break}case 120:{d="GS";break}case 121:{d="G2";break}case 122:{d="KG";break}case 127:{d=r==127?"MT":t==0?"GM":"XG";break}default:a[0]<48&&(a[0]==16&&s=="xg"?d="XG":d="GS")}return{name:n||(i||0).toString().padStart(3,"0")+" "+(t||0).toString().padStart(3,"0")+" "+(r||0).toString().padStart(3,"0"),ending:o,standard:d}}async load(i,t,r){let s=this,n=[],a=0,o=0;i.split(`
`).forEach(function(d,p){let c=d.split("	"),l=[];p==0?c.forEach(function(u,f){n[Je.indexOf(u)]=f}):c.forEach(async function(u,f){f>2?(s.#t[l[n[1]]]=s.#t[l[n[1]]]||[],(!s.#t[l[n[1]]][(l[n[0]]<<7)+l[n[2]]]?.length||t)&&(s.#t[l[n[1]]][(l[n[0]]<<7)+l[n[2]]]=c[3],a++),o++):l.push(parseInt(c[f]))})}),console.debug(`Map "${r}" contains ${o} entries in total, loaded ${a} entries.`)}clearRange(i){let t=i.prg!=null?i.prg.constructor==Array?i.prg:[i.prg,i.prg]:[0,127],r=i.msb!=null?i.msb.constructor==Array?i.msb:[i.msb,i.msb]:[0,127],s=i.lsb!=null?i.lsb.constructor==Array?i.lsb:[i.lsb,i.lsb]:[0,127];for(let n=r[0];n<=r[1];n++){let a=n<<7;for(let o=s[0];o<=s[1];o++){let d=a+o;for(let p=t[0];p<=t[1];p++)delete this.#t[p][d]}}}init(){this.#t=[];for(let i=0;i<128;i++)this.#t.push([""])}async loadFiles(...i){this.init();let t=this;i.forEach(async function(r,s){await fetch(`./data/bank/${r}.tsv`).then(function(n){return n.text()}).then(n=>{t.load(n,!1,r)})})}constructor(...i){this.loadFiles(...i)}};se.default.customInterpreter=function(i,t,r){let s=[],n=r==!1?t.readIntVLV():r;i==0||i==127;for(let a=0;a<n;a++){let o=t.readInt(1);if(s.push(o),o!=247){if(o!=240){if(o>127)return console.debug(`Early termination: ${s}`),s.pop(),t.backOne(),t.backOne(),s}}}return s};var V=class extends W{#t=new Ie;#r;#n="";voices=new Ue("gm","gm2","xg","gs","ns5r","gmega","sg","kross");#a=[];#s=new Uint8ClampedArray(64);#i=.5;#l=120;#e=4;#d=4;#o=0;#p=0;smoothing=0;reset(){this.dispatchEvent("reset"),this.#r?.resetIndex(),this.#t.init(),this.#n="",this.#i=.5,this.#l=120,this.#e=4,this.#d=4,this.#o=0,this.#p=0}async loadFile(i){this.#r=Be(se.default.parse(new Uint8Array(await i.arrayBuffer())))}switchMode(i,t=!1){this.#t.switchMode(i,t)}getMode(){return this.#t.mode}get noteProgress(){return this.#p/this.#i}get noteOverall(){return this.noteProgress-this.#o}get noteBar(){return Math.floor(this.noteOverall/this.#e)}get noteBeat(){let i=this.noteOverall%this.#e;return i<0&&(i+=this.#e),i}getTimeSig(){return[this.#e,this.#d]}getTempo(){return this.#l}sendCmd(i){this.#t.runJson(i)}render(i){i>this.#p&&(this.#p=i);let t=this.#r?.step(i)||[],r=0,s=new Set,n=this,a=[];n.#t.newStrength(),t.forEach(function(k){let $=k.data;$.type==9&&($.data[1]>0?s.add($.part*128+$.data[0]):s.has($.part*128+$.data[0])&&r++),k.data.type==8&&s.has($.part*128+$.data[0])&&r++;let w=n.#t.runJson($);switch(w?.reply){case"meta":{a.push(w);break}}w?.reply&&delete w.reply});let o=this.#t.getStrength();o.forEach(function(k,$){let w=k-n.#s[$];n.#s[$]+=Math.ceil(w-w*n.smoothing)}),a?.length>0&&this.dispatchEvent("meta",a);let d=this.#t.getActive(),p=[],c=n.#t.getPitch(),l=n.#t.getCcAll(),u=n.#t.getProgram(),f=0;return d.forEach(function(k,$){k&&(p[$]=n.#t.getVel($),f+=p[$].size)}),{extraPoly:r,curPoly:f,chInUse:d,chKeyPr:p,chPitch:c,chProgr:u,chContr:l,eventCount:t.length,title:this.#n,bitmap:this.#t.getBitmap(),letter:this.#t.getLetter(),names:this.#t.getCustomNames(),texts:this.#t.getTexts(),master:this.#t.getMaster(),mode:this.#t.getMode(),strength:this.#s.slice(),velo:o,rpn:this.#t.getRpn(),tSig:this.getTimeSig(),tempo:this.getTempo(),noteBar:this.noteBar,noteBeat:Math.floor(this.noteBeat)}}constructor(){super();let i=this;this.smoothing=.5,this.addEventListener("meta",function(t){t?.data?.forEach(function(r){(i.#a[r.meta]||console.debug).call(i,r.meta,r.data)})}),this.#t.addEventListener("mode",function(t){i.dispatchEvent("mode",t.data)}),this.#t.addEventListener("mapupdate",function(t){t.data.clearRange&&i.voices.clearRange(t.data.clearRange),i.voices.load(t.data.voiceMap,t.data.overwrite)}),this.#a[3]=function(t,r){i.#n?.length<1&&(i.#n=r)},this.#a[81]=function(t,r){let s=i.noteProgress,n=i.#i||.5;i.#l=6e7/r,i.#i=r/1e6,i.#o+=s*(n/i.#i)-s},this.#a[88]=function(t,r){let s=i.noteProgress,n=i.noteOverall,a=i.noteBar,o=i.noteBeat,d=i.#e,p=i.#d;i.#e=r[0],i.#d=1<<r[1];let c=24*(32/r[3])/r[2];d!=i.#e&&(o<1?d<i.#e?i.#o+=s-o-a*i.#e:(i.#o+=n*i.#e/d,console.warn("Fuck me! Any trick to make tSig shrinking WORK in any condition!")):i.#o+=s-i.#e*(a+1),console.info(`${i.#e}/${i.#d}`))}}};var ae=new Uint8Array(40),H=0,ne,zt=setInterval(()=>{ne&&(ae[H]=!ae[H],H++,H>34&&(H=0))},1e3/50),z=class{#t=[];async loadFile(i){let t=this;console.debug(`Requested font file from "${i}".`),(await(await fetch(i)).text()).split(`
`).forEach(async function(r,s){if(s>0&&r?.length>0){let n=r.split("	"),a=new Uint8Array(40);Array.from(n[1]).forEach(function(o,d){let p=d%2?4:0,c=Math.floor(d/2),l=parseInt(o,16),u=3;for(;l>0||u>=0;){let f=(p+u)*5+c;a[f]=l&1,l=l>>1,u--}}),t.#t[parseInt(n[0],16)]=a}}),ne=!1}constructor(i){ne=!0,this.loadFile(i)}getCP(i){return this.#t[i]}getStr(i){let t=[],r=this;return Array.from(i).forEach(function(s){t.push(r.#t[s.charCodeAt(0)]||r.#t[32]||ae)}),t}},le=class{#t={};async loadFile(i){let t=this;console.debug(`Requested fixed 256 bitmap file from "${i}".`),(await(await fetch(i)).text()).split(`
`).forEach(function(r,s){if(s>0&&r?.length>0){let n=r.split("	");if(n[1][0]!="@"){let a=new Uint8Array(256);Array.from(n[1]).forEach(function(o,d){let p=d*4,c=parseInt(o,16),l=3;for(;c>0||l>=0;){let u=p+l;a[u]=c&1,c=c>>1,l--}}),t.#t[n[0]]=a}else t.#t[n[0]]=t.#t[n[1].slice(1)]}})}constructor(i){this.loadFile(i)}getBm(i){return this.#t[i]?.slice()}};var je=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],et="!0123456789";var L="0123456789_aAbBcCdDeEfFgGhHiIjJ-kKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ",tt=["-","~","+","|"],it={"?":"UnkwnStd",gm:"GnrlMIDI",g2:"GrlMIDI2",xg:"YamahaXG",gs:"RolandGS",mt32:"RlndMT32",ag10:"KorgAG10",x5d:"Korg X5D","05rw":"Korg05RW",ns5r:"KorgNS5R",krs:"KorgKros",k11:"KawaiK11",sg:"AkaiPrSG"},fe="#ffaa2264",F="#aaff2264",De="#b3d8de64",Xe="#ff798664";var ti=class extends V{#t=0;constructor(){super(),this.addEventListener("reset",()=>{this.#t=0})}render(i,t){let r=new Array(24),s=super.render(i),n=this,a=Date.now(),o=Math.round(s.tempo*100)/100,d=s.curPoly+s.extraPoly;this.#t<d&&(this.#t=d),r[0]=`${s.eventCount.toString().padStart(3,"0")} ${d.toString().padStart(3,"0")}:${this.#t.toString().padStart(3,"0")}/512 TSig:${s.tSig[0]}/${s.tSig[1]} Bar:${(s.noteBar+1).toString().padStart(3,"0")}/${s.noteBeat+1} Tempo:${Math.floor(o)}.${Math.floor(o%1*100).toString().padStart(2,"0")} Vol:${Math.floor(s.master.volume)}.${Math.round(s.master.volume%1*100).toString().padStart(2,"0")}%`,r[1]=`Mode:${it[s.mode]} Title:${s.title||"N/A"}`,r[2]="Ch:VoiceNme#St VEM RCDB PP PiBd Pan : Note";let p=3,c=0;if(s.chInUse.forEach(function(l,u){if(l){c=u;let f=u*h.length;if(p<r.length-5&&u>=(self.minCh||0)){let M=n.voices.get(s.chContr[f+h[0]],s.chProgr[u],s.chContr[f+h[32]],s.mode);s.names[u]&&(M.name=s.names[u],M.ending="~"),r[p]=`${(u+1).toString().padStart(2,"0")}:${M.name.slice(0,8).padEnd(8," ")}${M.ending}${M.standard} ${L[s.chContr[f+h[7]]>>1]}${L[s.chContr[f+h[11]]>>1]}${tt[s.chContr[f+h[1]]>>5]} ${L[s.chContr[f+h[91]]>>1]}${L[s.chContr[f+h[93]]>>1]}${L[s.chContr[f+h[94]]>>1]}${L[s.chContr[f+h[74]]>>1]} ${s.chContr[f+h[65]]>63?"O":"X"}${L[s.chContr[f+h[5]]>>1]} ${ue(s.chPitch[u])} ${ge(s.chContr[f+h[10]])}:`,s.chKeyPr[u].forEach(function(k,$){k>0&&(r[p]+=` <span style="opacity:${Math.round(k/1.27)/100}">${je[$%12]}${et[Math.floor($/12)]}</span>`)}),p++}}}),s.texts.length>0){let l=0,u=r.length-1;for(;u>=p;)s.texts[l]?.length&&(r[u]=(s.texts[l]||"").padEnd(100," ")),(s.texts[l]?.length>0||s.texts[l]?.length==null)&&u--,l++}if(a<=s.letter.expire){let l=s.letter.text.padEnd(32," "),u=r.length-2;for(let f=0;f<2;f++)r[f+u]=`${(r[f+u]||"").slice(0,82).padEnd(81," ")} <span class="letter"> ${l.slice(f*16,f*16+16).padEnd(" ",16)} </span>`}if(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="#202020";let l;a<=s.bitmap.expire?l=s.bitmap.bitmap:(l=new Array(256),c<16?s.strength.forEach(function(u,f){if(f<16){let M=u>>4;for(let k=0;k<=M;k++)l[f+(15-k)*16]=1}}):s.strength.forEach(function(u,f){if(f<32){let M=u>>5;for(let k=0;k<=M;k++)l[f+((f>15?6:15)-k)*16]=1}})),l.forEach(function(u,f){u&&t.fillRect((f&15)*12,(f>>4)*6,11,5)})}return r.join("<br/>")}},R="#0000000b",x="#00000068",X=8,K=7,Z=4,rt=3,oe=function(i,t,r){let s=X*4-1,n=Z*1.5-1,a=i>>4;for(let o=0;o<8;o++){a>=0?r.fillStyle=x:r.fillStyle=R,a--;let d=7-o;r.fillRect(t,181+d*X,s,n)}},st=Math.PI*255/180,at=Math.PI*285/180,he=function(i,t,r){let s=X*4-1,n=Z*1.5-1,a=i>>4;for(let o=0;o<8;o++){a>=0?r.strokeStyle=x:r.strokeStyle=R,a--;let d=7-o;r.beginPath(),r.arc(t,256,(9-d)*X,st,at),r.lineWidth=n,r.stroke()}};CanvasRenderingContext2D.prototype.radial=function(i,t,r,s,n){let a=r-1.5707963267948966,o=Math.sin(a),d=Math.cos(a);this.beginPath(),this.moveTo(i+o*s,t+d*s),this.lineTo(i+o*n,t+d*n),this.stroke()};var ii=class extends V{#t=new Uint8Array(1360);#r=new Uint8Array(200);#n=new Uint8Array(256);#a=0;#s=0;#i=0;#l=new Uint8Array(7);xgFont=new z("./data/bitmaps/xg/font.tsv");sysBm=new le("./data/bitmaps/xg/system.tsv");voxBm=new le("./data/bitmaps/xg/voices.tsv");constructor(){super();let i=this;this.addEventListener("mode",function(t){(i.sysBm.getBm(`st_${{gm:"gm1",g2:"gm2","?":"gm1",ns5r:"korg",ag10:"korg",x5d:"korg","05rw":"korg",krs:"korg",sg:"gm1",k11:"gm1"}[t.data]||t.data}`)||[]).forEach(function(r,s){i.#n[s]=r}),i.#a=2,i.#s=Date.now()+1600})}setCh(i){this.#i=i}getCh(){return this.#i}render(i,t){let r=super.render(i),s=this,n=Date.now();t.fillStyle=F,t.fillRect(0,0,t.canvas.width,t.canvas.height),this.#t.forEach(($,w,g)=>{g[w]=0}),this.#r.forEach(($,w,g)=>{g[w]=0});let a=!1,o=0,d=0;r.chInUse.forEach(function($,w){$&&(a||(a=!0,o=w),d=w)}),o=o>>4<<4,d=(d>>4<<4)+15,this.#i>d&&(this.#i=o),this.#i<o&&(this.#i=d);let c=this.#i*h.length,l=Math.ceil(Math.log2(d-o+1)-4),u=0;if(n<=r.letter.expire&&r.letter.text.length>0)s.xgFont.getStr(r.letter.text.padEnd(32," ")).forEach(function($,w){let g=w%16*5+5,b=Math.floor(w/16)*8;$.forEach(function(E,S){let m=S%5,y=Math.floor(S/5);s.#t[(b+y)*85+g+m]=E})});else{s.#t[1275]=1,s.#t[1276]=1,s.#t[1278]=1,s.#t[1279]=1;for(let $=o;$<=d;$++){let w=r.strength[$];if(l?w=w>>5:w=w>>4,l==0||l==1)for(let g=0;g<=w;g++){let b=5+u*3+(15-g)*85-Math.floor(u/2);s.#t[b]=1,s.#t[b+1]=1}else for(let g=0;g<=w;g++){let b=5+u*3+(15-g)*85-Math.floor(u/2);u>31&&(b-=760),s.#t[b]=1,s.#t[b+1]=1}u++}if(l<2){let $=(r.names[this.#i]||s.voices.get(r.chContr[c+h[0]],r.chProgr[this.#i],r.chContr[c+h[32]],r.mode).name).slice(0,8).padEnd(8," "),w=`\x80${(r.chContr[c+h[0]]==64?"SFX":r.chContr[c+h[0]]||r.chContr[c+h[32]]||0).toString().padStart(3,"0")}\x81${((r.chProgr[this.#i]||0)+1).toString().padStart(3,"0")}`;s.xgFont.getStr(w+$).forEach(function(b,E){let S=0,m=0;l==1?S=E*5:l||(S=E%8*5+45,m=8-Math.floor(E/8)*8),b.forEach(function(y,v){let T=v%5,P=Math.floor(v/5);l==1&&E>7&&(T=T+5),s.#t[(m+P)*85+S+T]=y})})}}for(let $=0;$<1360;$++){let w=$%85,g=Math.floor($/85);t.fillStyle=R,s.#t[$]&&(t.fillStyle=x),t.fillRect(16+(w+Math.floor(w/5))*X,12+g*X,K,K)}t.textAlign="center",t.font='12px "Arial Web"';{let $=71.5;for(let w=-2;w<32;w++){t.fillStyle=x,w==this.#i&&(t.fillStyle=R);let g="";w>=0?g=(w+1).toString().padStart(2,"0"):g=`A${w+3}`,t.fillText(g,$+24*w,150)}}let f=!r.chContr[c+h[0]];t.fillStyle=f?R:x,t.fillText("MSB",515,164),t.fillStyle=f?x:R,t.fillText("LSB",564,164),t.fillStyle=x,t.fillText("BANK",467.5,164),t.fillText("PRG#",660,164),t.fillText("CHANNEL     SEC     PART",118,254),t.fillText("VOL",420,254),t.fillText("EXP",468,254),t.fillText("BRT",516,254),t.fillText("REV",648,254),t.fillText("CHO",696.5,254),t.fillText("VAR",745,254),t.fillText("KEY",801,254),t.fillText("PAN",583,254),s.xgFont.getStr(`${(this.#i+1).toString().padStart(2,"0")}${"ABCD"[this.#i>>4]}${(this.#i%16+1).toString().padStart(2,"0")}`).forEach(function($,w){let g=w*5;$.forEach(function(b,E){let S=E%5,m=Math.floor(E/5);s.#r[m*25+g+S]=b})});for(let $=0;$<200;$++){let w=$%25,g=Math.floor($/25);t.fillStyle=R,s.#r[$]&&(t.fillStyle=x),t.fillRect(16+(w+Math.floor(w/5))*X,180+g*X,K,K)}let M;n<=r.bitmap.expire?M=r.bitmap.bitmap:(M=this.#n.slice(),n>=this.#s?(this.#a=0,M=this.voxBm.getBm(s.voices.get(r.chContr[c+h[0]],r.chProgr[this.#i],r.chContr[c+h[32]],r.mode).name)||this.voxBm.getBm(s.voices.get(r.chContr[c]+h[0],r.chProgr[this.#i],0,r.mode).name),!M&&(r.chContr[c+h[0]]<48||r.chContr[c+h[0]]==56)&&(M=this.voxBm.getBm(s.voices.get(0,r.chProgr[this.#i],0,r.mode).name)),M||(M=this.sysBm.getBm("no_abm"))):this.#a==2&&M.forEach(($,w,g)=>{let b=Math.floor((this.#s-n)/400);g[w]=b%2==$}));for(let $=0;$<256;$++){let w=$%16,g=Math.floor($/16);t.fillStyle=R,M[$]&&(t.fillStyle=x),t.fillRect(260+w*X,180+g*Z,K,rt)}oe(r.chContr[c+h[7]],404,t),oe(r.chContr[c+h[11]],452,t),oe(r.chContr[c+h[74]],500,t),he(r.chContr[c+h[91]],648,t),he(r.chContr[c+h[93]],696,t),he(r.chContr[c+h[94]],744,t),t.beginPath(),t.arc(582,216,34,2.356194490192345,7.068583470577034),t.lineWidth=2,t.strokeStyle="#000f",t.stroke();let k=r.chContr[c+h[10]];this.#l.forEach(($,w,g)=>{g[w]=0}),k==0?this.#l[0]=1:k==64?this.#l[3]=1:k==128?(this.#l[1]=1,this.#l[5]=1):k<64?this.#l[Math.floor(k/21)]=1:this.#l[4+Math.floor((k-65)/21)]=1,t.lineWidth=Z;for(let $=0;$<7;$++)t.strokeStyle=R,this.#l[$]&&(t.strokeStyle=x),t.radial(582,216,[7.068583470577034,6.283185307179586,5.497787143782138,4.71238898038469,3.9269908169872414,3.141592653589793,2.356194490192345][$],8,26)}},N=7,Q=6,Oe=31,nt=12,lt=29,ot=10,ht=N*(17+2),ft=N*(7+3)+1,ri=class extends V{#t=new Uint8Array(665);#r=new Uint8Array(735);#n=new Uint8Array(256);#a=new Uint8Array(64);#s=new Uint8Array(64);#i=0;xgFont=new z("./data/bitmaps/xg/font.tsv");constructor(){super()}setCh(i){this.#i=i}getCh(){return this.#i}render(i,t){let r=super.render(i),s=this,n=Date.now();t.fillStyle=fe,t.fillRect(0,0,t.canvas.width,t.canvas.height);let a=22,o=24,d=!1,p=0,c=0;r.chInUse.forEach(function(m,y){m&&(d||(d=!0,p=y),c=y)}),p=p>>4<<4,c=(c>>4<<4)+15,this.#i>c&&(this.#i=p),this.#i<p&&(this.#i=c);let u=this.#i*h.length;this.#t.forEach((m,y,v)=>{v[y]=0});let f,M=r.letter.text.trim();for(;M.indexOf("  ")>-1;)M=M.replaceAll("  "," ");if(n<=r.letter.expire){f=M;let m=r.letter.text,y=m.length-m.trimLeft().length,v=m.length-m.trimRight().length;if(m.length>f.length&&f.length<16&&y>0){for(;f.length<15;)f=` ${f} `;f.length<16&&(y<v?f=` ${f}`:f=`${f} `)}let T=0;if(f.length>16){T=Math.floor((r.letter.expire-n)/33)-96;let P=(f.length-16)*-6;T<P?T=P:T>0&&(T=0)}this.xgFont.getStr(f).forEach(function(P,I){P.forEach(function(D,ce){let _=I*6+ce%5+T,Le=Math.floor(ce/5);_>=0&&_<95&&(s.#t[Le*95+_]=D)})})}else f=`${r.chProgr[this.#i]+1}`.padStart(3,"0"),f+=" ",f+=(r.names[this.#i]||s.voices.get(r.chContr[u+h[0]],r.chProgr[this.#i],r.chContr[u+h[32]],r.mode).name).slice(0,12).padEnd(12," "),this.xgFont.getStr(f).forEach(function(m,y){m.forEach(function(v,T){let P=y*6+T%5,I=Math.floor(T/5);s.#t[I*95+P]=v})});this.#t.forEach(function(m,y){t.fillStyle=R,m&&(t.fillStyle=x);let v=y%95,T=Math.floor(y/95);t.fillRect(a+133+v*N,o+T*N,Q,Q)}),this.#r.forEach((m,y,v)=>{v[y]=0});let k="";k+=`${"ABCD"[this.#i>>4]}${(this.#i%16+1).toString().padStart(2,"0")}`,k+=r.chContr[u+h[7]].toString().padStart(3," "),k+=r.chContr[u+h[91]].toString().padStart(3," ");let $=r.chPitch[this.#i]/8192*r.rpn[this.#i*6]+(r.rpn[this.#i*6+3]-64);$<0?k+="-":k+="+",k+=Math.round($<0?Math.abs($):$).toString().padStart(2,"0");let w=r.chContr[u+h[10]];w==64?k+="C  ":w==128?k+="RND":(w>64?k+="R":k+="L",k+=Math.abs(w-64).toString().padStart(2," ")),k+=r.chContr[u+h[93]].toString().padStart(3," "),k+=(r.chContr[u+h[0]]||r.chContr[u+h[32]]).toString().padStart(3,"0"),this.xgFont.getStr(k).forEach(function(m,y){m.forEach(function(v,T){let P=Math.floor(y/3)*90+y*5+T%5,I=Math.floor(T/5);I<7&&(s.#r[I*15+P]=v)})}),this.#r.forEach(function(m,y){t.fillStyle=R,m&&(t.fillStyle=x);let v=y>419?1:0,T=0,P=y%15+Math.floor(y%15/5),I=Math.floor(y%105/15);v?T=Math.floor((y-315)/105):T=Math.floor(y/105),t.fillRect(a+ht*v+P*N,o+ft*T+I*N,Q,Q)}),this.#n.forEach((m,y,v)=>{v[y]=0});let g=Math.ceil(Math.log2(c-p+1)-4),b=0;r.velo.forEach(function(m,y){if(m>=s.#a[y])s.#a[y]=m;else{let v=s.#a[y]-m;s.#a[y]-=v/8}if(m>=s.#s[y])s.#s[y]=m;else{let v=s.#s[y]-2;v<0&&(v=0),s.#s[y]=v}});let E=this.#n;if(n<=r.bitmap.expire)E=r.bitmap.bitmap;else{let m=0;for(let y=p;y<=c;y++){let v=m>>4,T=this.#a[y]>>4+g,P=this.#s[y]>>4+g;if(g==2){let I=4*(3-v);for(let D=3-T;D<4;D++)this.#n[m%16+(D+I)*16]=1}else if(g==1){let I=8*(1-v);for(let D=7-T;D<8;D++)this.#n[m%16+(D+I)*16]=1;this.#n[m%16+(7-P+I)*16]=1}else{for(let I=15-T;I<16;I++)this.#n[m%16+I*16]=1;this.#n[m+(15-P)*16]=1}m++}}E.forEach(function(m,y){t.fillStyle=R,m&&(t.fillStyle=x);let v=y%16,T=Math.floor(y/16);t.fillRect(a+302+v*Oe,o+71+T*nt,lt,ot)}),t.fillStyle="#000c",t.textAlign="left",t.font='16px "Arial Web"',t.fillText("PART",21,20),t.fillText("INSTRUMENT",154,20),t.fillText("LEVEL",21,91),t.fillText("PAN",154,91),t.fillText("REVERB",21,162),t.fillText("CHORUS",154,162),t.fillText("KEY SHIFT",21,233),t.fillText("BANK",154,233),t.textAlign="right",t.fillText("SB",274,233),t.textAlign="center";for(let m=1;m<=16;m++)t.fillText(`${m}`.padStart(2,"0"),308+Oe*m,300);t.lineWidth=1,t.strokeStyle="#000c";let S=2*Math.PI;for(let m=0;m<16;m++){let y=m%8;t.beginPath(),y?y==4?(t.ellipse(316,(15-m)*12+100,3,3,0,0,S),t.fill()):(t.ellipse(316,(15-m)*12+100,2,2,0,0,S),t.stroke()):(t.ellipse(316,(15-m)*12+100,4,4,0,0,S),t.fill())}r.chContr[u+h[0]]?t.fillStyle=x:t.fillStyle=R,t.fillText("M",236,233),r.chContr[u+h[0]]?t.fillStyle=R:t.fillStyle=x,t.fillText("L",248,233)}},si=class extends V{#t=new Uint8Array(5760);#r=new Uint8Array(5760);#n="?";#a=new Uint8Array(64);#s=0;#i;#l=!0;xgFont=new z("./data/bitmaps/xg/font.tsv");constructor(){super(),this.#i=De,this.addEventListener("mode",i=>{this.#i={gs:fe,mt32:fe,xg:F,ns5r:F,x5d:F,ag10:Xe,"05rw":F,k11:F,gmlx:F,sg01:Xe}[i.data]||De,this.#n=i.data,this.#l=!0})}setCh(i){this.#s=i}getCh(){return this.#s}#e(i,t){for(let s=0;s<180;s++){let n=s%12,a=Math.floor(s/12);a==0&&n<11||a==14&&n>0||a==13?this.#r[a*144+n+i]=1:a>0&&a<13&&(n==0||n>9||n==5&&a>1&&a<12)&&(this.#r[a*144+n+i]=1)}let r=t>>4;for(let s=0;s<21;s++){let n=s%7,a=Math.floor(s/7),o=a+(9-r);a!=1||n==0||n==6?this.#r[o*144+n+i+2]=1:this.#r[o*144+n+i+2]=0}}#d(i,t,r){let s=7,n=40;for(let a=0;a<n;a++){let o=Math.PI*a*2/n,d=s*Math.sin(o),p=Math.sign(d)*Math.round(Math.abs(d)),c=s*Math.cos(o),l=Math.sign(c)*Math.round(Math.abs(c));this.#r[(l+t)*144+p+i]=1}if(r<128){let a=Math.floor(r/9.85)*22.5,o=5,d=Math.PI*(315-a)/180,p=Math.sin(d),c=Math.cos(d);for(let l=0;l<=o;l++){let u=Math.round(l*p),f=Math.round(l*c);this.#r[(f+t)*144+u+i]=1}}else this.#r[t*144+i]=1}render(i,t,r){let s=super.render(i),n=this,a=Date.now(),o=!1,d=0,p=0;s.chInUse.forEach(function(g,b){g&&(o||(o=!0,d=b),p=b)}),d=d>>4<<4,p=(p>>4<<4)+15,this.#s>p&&(this.#s=d),this.#s<d&&(this.#s=p);let l=this.#s*h.length;this.#r.forEach((g,b,E)=>{E[b]=0}),this.xgFont.getStr(`${"ABCD"[this.#s>>4]}${((this.#s&15)+1).toString().padStart(2,"0")}`).forEach((g,b)=>{let E=b*6+1;g.forEach((S,m)=>{let y=m%5,v=Math.floor(m/5);this.#r[v*144+E+y]=S})});let u=s.chPitch[this.#s]/8192*s.rpn[this.#s*6]+(s.rpn[this.#s*6+3]-64);this.xgFont.getStr(`${"+-"[+(u<0)]}${Math.round(Math.abs(u)).toString().padStart(2,"0")}`).forEach((g,b)=>{let E=b*6+1;g.forEach((S,m)=>{let y=m%5,v=Math.floor(m/5)+8;this.#r[v*144+E+y]=S})});for(let g=0;g<225;g++){let b=g%25,E=Math.floor(g/25)+15;this.#r[E*144+b]=1}let f="",M=0;switch(s.chContr[l+h[0]]){case 0:{let g=s.chContr[l+h[32]];g==127?f="MT-a":g==126?f="MT-b":g==7?f="SP-k":g==5?f="SG-v":g==4?f="SP-l":g==0||this.#n=="gs"&&g<5?f="GM-a":(f="y",M=32);break}case 48:{f="yM",M=32;break}case 56:{f="GM-b";break}case 61:case 120:{f="rDrm";break}case 62:{f="kDrm";break}case 63:{let g=s.chContr[l+h[32]];f=g<10?"kP:":"kC:",f+=g%10;break}case 64:{f="ySFX";break}case 80:case 81:case 82:case 83:{f=`Prg${"UABC"[s.chContr[l+h[0]]-80]}`;break}case 88:case 89:case 90:case 91:{f=`Cmb${"UABC"[s.chContr[l+h[0]]-88]}`;break}case 121:{f="g",M=32;break}case 122:{f="lDrm";break}case 126:{f="yDrS";break}case 127:{s.chContr[l+h[32]]==127?f="rDrm":f="yDrm";break}default:s.chContr[l+h[0]]<48?f="r:":f="M"}f.length<4&&(f+=`${s.chContr[l+h[M]]}`.padStart(4-f.length,"0")),this.xgFont.getStr(f).forEach((g,b)=>{let E=b*6+1;g.forEach((S,m)=>{let y=m%5,v=Math.floor(m/5)+16;S&&(this.#r[v*144+E+y]=0)})});let k=(s.names[this.#s]||n.voices.get(s.chContr[l+h[0]],s.chProgr[this.#s],s.chContr[l+h[32]],s.mode).name).slice(0,10).padEnd(10," ");this.xgFont.getStr(`:${(s.chProgr[this.#s]+1).toString().padStart(3,"0")} ${k}`).forEach((g,b)=>{let E=b*6+25;g.forEach((S,m)=>{let y=m%5,v=Math.floor(m/5)+16;this.#r[v*144+E+y]=S})}),this.xgFont.getStr(`${this.#s+1}`.padStart(2,"0")).forEach((g,b)=>{let E=b*6;g.forEach((S,m)=>{let y=m%5,v=Math.floor(m/5)+32;this.#r[v*144+E+y]=S})}),s.velo.forEach((g,b)=>{if(g>=this.#a[b]){let E=g-this.#a[b];this.#a[b]+=Math.ceil(E*.8)}else{let E=this.#a[b]-g;this.#a[b]-=Math.ceil(E/10)}});let $=22;if(p>31&&($=43),this.#a.forEach((g,b)=>{if(!(p<32&&b>31))for(let E=Math.floor(g/$);E>=0;E--){let S=b%32*4+12,m=(b>31?32:39)-E;this.#r[m*144+S]=1,this.#r[m*144+S+1]=1,this.#r[m*144+S+2]=1}}),this.xgFont.getStr(r?"Fx A:001Rev/Cho":"FxA:001Rev/Cho").forEach((g,b)=>{let E=r?8:7,S=b%E*6+(r?95:102),m=Math.floor(b/E)*8;g.forEach((y,v)=>{let T=v%5,P=Math.floor(v/5)+m;this.#r[P*144+S+T]=y})}),a<s.letter.expire){let g=19+ +r*3;for(let b=0;b<2e3;b++){let E=b%100,S=Math.floor(b/100);(S==0&&E<99||S==18||S==19&&E>0)&&(this.#r[S*144+E+g]=1),S>0&&S<18&&(this.#r[S*144+E+g]=+(E<1||E>97))}this.xgFont.getStr(s.letter.text).forEach((b,E)=>{let S=E%16*6+g+2,m=Math.floor(E/16)*8+2;b.forEach((y,v)=>{let T=v%5,P=Math.floor(v/5)+m;this.#r[P*144+S+T]=y})})}else{let g=r?2:0;this.#e(20+g,s.chContr[l+h[7]]),this.#e(33+g,s.chContr[l+h[11]]),this.#d(53+ +r+g,7,s.chContr[l+h[10]]),this.#e(62+2*+r+g,s.chContr[l+h[91]]),this.#e(75+2*+r+g,s.chContr[l+h[93]]),r||this.#e(88,s.chContr[l+h[74]])}if(a<s.bitmap.expire){for(let b=0;b<777;b++){let E=b%37,S=Math.floor(b/37),m=E+77+ +r,y=S+19;(S==0&&E<36||S==19||S==20&&E>0)&&(this.#r[y*144+m]=1),S>0&&S<19&&(this.#r[y*144+m]=+(E<1||E>34))}let g=s.bitmap.bitmap.length==512?1:2;for(let b=0;b<512;b+=g){let E=b&31,S=b>>5,m=E+79+ +r,y=S+21;this.#r[y*144+m]=s.bitmap.bitmap[b/g],g==2&&(this.#r[y*144+m+1]=s.bitmap.bitmap[b/g])}}let w=!1;if(this.#l){t.fillStyle=this.#i.replace("64",""),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.textAlign="center",t.font='11px "Arial Web"',t.fillStyle="#000e",t.fillText("MIDI. CH",58,10),t.fillText("VOL",153.5,10),t.fillText("EXP",231.5,10),t.fillText("PAN",322.5,10),t.fillText("REV",405,10),t.fillText("CHO",484,10),t.fillText("BRT",561.5,10),t.fillText("EFFECT TYPE",738,10),t.fillText("PART",34,262);let g=2*Math.PI;for(let b=1;b<33;b++)b==1||b==32||b%5==0?t.fillText(`${b}`,24*b+58,262):(t.beginPath(),t.ellipse(24*b+58,258,2,2,0,0,g),t.fill());w=!0,this.#l=!1}this.#r.forEach((g,b)=>{let E=b%144,S=Math.floor(b/144),m=this.#t[b]!=g;!w&&m&&(t.fillStyle=this.#i.slice(0,7),t.fillRect(6*E+1,12+6*S,6,6)),(w||m)&&(t.fillStyle=["#0000001a","#0000009f"][g],w&&(t.fillStyle=t.fillStyle.slice(0,7)),t.fillRect(6*E+1,12+6*S,5.5,5.5))}),this.#r.forEach((g,b)=>{this.#t[b]!=g&&(this.#t[b]=g)})}};export{ii as MuDisplay,si as Ns5rDisplay,ri as ScDisplay,ti as TuiDisplay};
