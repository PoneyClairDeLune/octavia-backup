var G=Object.create;var T=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var K=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var z=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of F(e))!j.call(t,i)&&i!==n&&T(t,i,{get:()=>e[i],enumerable:!(r=V(e,i))||r.enumerable});return t};var Z=(t,e,n)=>(n=t!=null?G(X(t)):{},z(e||!t||!t.__esModule?T(n,"default",{value:t,enumerable:!0}):n,t));var D=K((ht,k)=>{(function(){"use strict";let t={debug:!1,parse:function(e,n){if(e instanceof Uint8Array)return t.Uint8(e);if(typeof e=="string")return t.Base64(e);if(e instanceof HTMLElement&&e.type==="file")return t.addListener(e,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(e===void 0||!(e instanceof HTMLElement)||e.tagName!=="INPUT"||e.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},e.addEventListener("change",function(r){if(!r.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let i=new FileReader;i.readAsArrayBuffer(r.target.files[0]),i.onload=function(s){n(t.Uint8(new Uint8Array(s.target.result)))}})},Base64:function(e){let n=function(s){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(s=s.replace(/^.*?base64,/,""),s=String(s).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(s))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");s+="==".slice(2-(3&s.length));let f,c="",a,l,h=0;for(;h<s.length;)f=o.indexOf(s.charAt(h++))<<18|o.indexOf(s.charAt(h++))<<12|(a=o.indexOf(s.charAt(h++)))<<6|(l=o.indexOf(s.charAt(h++))),c+=a===64?String.fromCharCode(f>>16&255):l===64?String.fromCharCode(f>>16&255,f>>8&255):String.fromCharCode(f>>16&255,f>>8&255,255&f);return c}(e=String(e));var r=n.length;let i=new Uint8Array(new ArrayBuffer(r));for(let s=0;s<r;s++)i[s]=n.charCodeAt(s);return t.Uint8(i)},Uint8:function(i){let n={data:null,pointer:0,movePointer:function(a){return this.pointer+=a,this.pointer},readInt:function(a){if((a=Math.min(a,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<a)for(let h=1;h<=a-1;h++)l+=this.data.getUint8(this.pointer)*Math.pow(256,a-h),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(a){let l="";for(let h=1;h<=a;h++)l+=String.fromCharCode(this.readInt(1));return l},backOne:function(){this.pointer--},readIntVLV:function(){let a=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)a=this.readInt(1);else{let h=[];for(;128<=this.data.getUint8(this.pointer);)h.push(this.readInt(1)-128);var l=this.readInt(1);for(let d=1;d<=h.length;d++)a+=h[h.length-d]*Math.pow(128,d);a+=l}return a}};if(n.data=new DataView(i.buffer,i.byteOffset,i.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let r={};r.formatType=n.readInt(2),r.tracks=n.readInt(2),r.track=[];var i=n.readInt(1),s=n.readInt(1);128<=i?(r.timeDivision=[],r.timeDivision[0]=i-128,r.timeDivision[1]=s):r.timeDivision=256*i+s;for(let a=1;a<=r.tracks;a++){r.track[a-1]={event:[]};var o,f=n.readInt(4);if(f===-1)break;if(f!==1297379947)return!1;n.readInt(4);let l=0,h=!1,d,u;for(;!h&&(l++,r.track[a-1].event[l-1]={},r.track[a-1].event[l-1].deltaTime=n.readIntVLV(),(d=n.readInt(1))!==-1);)if(128<=d?u=d:(d=u,n.movePointer(-1)),d===255){r.track[a-1].event[l-1].type=255,r.track[a-1].event[l-1].metaType=n.readInt(1);var c=n.readIntVLV();switch(r.track[a-1].event[l-1].metaType){case 47:case-1:h=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:r.track[a-1].event[l-1].data=n.readStr(c);break;case 33:case 89:case 81:r.track[a-1].event[l-1].data=n.readInt(c);break;case 84:r.track[a-1].event[l-1].data=[],r.track[a-1].event[l-1].data[0]=n.readInt(1),r.track[a-1].event[l-1].data[1]=n.readInt(1),r.track[a-1].event[l-1].data[2]=n.readInt(1),r.track[a-1].event[l-1].data[3]=n.readInt(1),r.track[a-1].event[l-1].data[4]=n.readInt(1);break;case 88:r.track[a-1].event[l-1].data=[],r.track[a-1].event[l-1].data[0]=n.readInt(1),r.track[a-1].event[l-1].data[1]=n.readInt(1),r.track[a-1].event[l-1].data[2]=n.readInt(1),r.track[a-1].event[l-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(r.track[a-1].event[l-1].data=this.customInterpreter(r.track[a-1].event[l-1].metaType,n,c)),this.customInterpreter!==null&&r.track[a-1].event[l-1].data!==!1||(n.readInt(c),r.track[a-1].event[l-1].data=n.readInt(c),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((d=d.toString(16).split(""))[1]||d.unshift("0"),r.track[a-1].event[l-1].type=parseInt(d[0],16),r.track[a-1].event[l-1].channel=parseInt(d[1],16),r.track[a-1].event[l-1].type){case 15:this.customInterpreter!==null&&(r.track[a-1].event[l-1].data=this.customInterpreter(r.track[a-1].event[l-1].type,n,!1)),this.customInterpreter!==null&&r.track[a-1].event[l-1].data!==!1||(o=n.readIntVLV(),r.track[a-1].event[l-1].data=n.readInt(o),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:r.track[a-1].event[l-1].data=[],r.track[a-1].event[l-1].data[0]=n.readInt(1),r.track[a-1].event[l-1].data[1]=n.readInt(1);break;case 12:case 13:r.track[a-1].event[l-1].data=n.readInt(1);break;case-1:h=!0;break;default:if(this.customInterpreter!==null&&(r.track[a-1].event[l-1].data=this.customInterpreter(r.track[a-1].event[l-1].metaType,n,!1)),this.customInterpreter===null||r.track[a-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return r},customInterpreter:null};if(typeof k<"u")k.exports=t;else{let e=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;e.MidiParser=t}})()});var w=class{#t={};addEventListener(t,e){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(e)}removeEventListener(t,e){if(this.#t[t]){let n=this.#t[t].indexOf(e);n>-1&&this.#t[t].splice(n,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,e){let n=new Event(t),r=this;n.data=e,this.#t[t]?.length>0&&this.#t[t].forEach(function(i){i?.call(r,n)}),this[`on${t}`]&&this[`on${t}`](n)}};var A=function(t,e){let n=Math.min(t.length,e.length),r=t.slice(0,n),i=e.slice(0,n),s=0,o=0;for(;o<n&&s==0;)s=Math.sign(r[o]-i[o]),o++;return s},v=function(){this.pool=[],this.point=function(t,e=!1){if(this.pool.length>0){let n=this.pool.length,r=1<<Math.floor(Math.log2(n)),i=r,s=64;for(;r>=1&&s>=0;){if(s<=0)throw new Error("TTL reached.");if(i==n)i-=r;else{let f=A(t,this.pool[i]);switch(f){case 0:{s=0;break}case 1:{i+r<=n&&(i+=r);break}case-1:{i!=0&&(i-=r);break}default:console.warn(`Unexpected result ${f}.`)}}r=r>>1,s--}let o=!0;if(i>=this.pool.length)o=!1;else{let f=this;this.pool[i].forEach(function(c,a,l){o&&c!=t[a]&&(o=!1)}),!o&&A(t,this.pool[i])>0&&i++}return o||e?i:-1}else return e?0:-1},this.add=function(t,e){return t.data=e,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let e=this.point(t);if(e>-1)return this.pool[e].data;this.default(t)},this.run=function(t,...e){let n=this.point(t);n>-1?this.pool[n].data(t.slice(this.pool[n].length),...e):this.default(t,...e)}};var M=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw"],y={};M.forEach(function(t,e){y[t]=e});var P=[[0,0,0,0,0,0,0,56,82,81],[0,0,0,0,0,127,0,0,0,0]],H=[0,32,81,84,88,89],p=function(t,e,n){n[e]=0},W=function(t){let e=[[]];return t?.forEach(function(n){n==247||(n==240?e.push([]):e[e.length-1].push(n))}),e},$=function(t,e="",n="",r=2){return t?`${e}${t.toString().padStart(r,"0")}${n}`:""},S=class extends w{#t=0;#c=new Array(256);#r=0;#i=new Array(64);#a=new Uint8ClampedArray(8192);#p=new Uint8ClampedArray(64);#l=new Uint8ClampedArray(8192);#n=new Uint16Array(512);#I=new Int16Array(64);#f=new Array(64);#g=0;#m=0;#w=100;#d=0;#u="";#v=0;#s=[];#o=[];#E={8:function(t){let e=t.part*128+t.data[0],n=this.#n.indexOf(e);n>-1&&(this.#n[n]=0,this.#l[e]=0)},9:function(t){this.#i[t.part]=1;let e=t.part*128+t.data[0];if(t.data[1]>0){let n=0;for(;this.#n[n]>0;)n++;n<512?(this.#n[n]=e,this.#l[e]=t.data[1]):console.error("Polyphony exceeded.")}else{let n=this.#n.indexOf(e);n>-1&&(this.#n[n]=0,this.#l[e]=0)}},10:function(t){let e=t.part*128+t.data[0];this.#n.indexOf(e)>-1&&(this.#l[e]=data[1])},11:function(t){this.#i[t.part]=1,t.data[0]==0&&t.part%16==9&&this.#t==y.gs&&(t.data[1]=120),this.#a[t.part*128+t.data[0]]=t.data[1]},12:function(t){this.#i[t.part]=1,this.#p[t.part]=t.data,this.#f[t.part]=0},13:function(t){let e=this;this.#n.forEach(function(n){let r=n>>7;t.part==r&&(e.#l[n]=t.data)}),console.info(t)},14:function(t){this.#I[t.part]=t.data[1]*128+t.data[0]-8192},15:function(t){let e=this;W(t.data).forEach(function(n){e.#h.run(n)})},255:function(t){if((this.#o[t.meta]||console.debug).call(this,t.data),H.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#h;#M;#e;getActive(){let t=this.#i.slice();return this.#t==y.mt32&&(t[0]=0),t}getCc(t){let e=t*128,n=Array.from(this.#a).slice(e,e+128);return n[0]=n[0]||this.#g,n[32]=n[32]||this.#m,n}getPitch(){return Array.from(this.#I)}getProgram(){return Array.from(this.#p)}getTexts(){return this.#s.slice()}getVel(t){let e=new Map,n=this;return this.#n.forEach(function(r){let i=r>>7,s=r&127;t==i&&n.#l[r]>0&&e.set(s,n.#l[r])}),e}getBitmap(){return{bitmap:this.#c.slice(),expire:this.#r}}getCustomNames(){return this.#f.slice()}getLetter(){return{text:this.#u,expire:this.#v}}getMode(){return M[this.#t]}getMaster(){return{volume:this.#w}}init(){this.dispatchEvent("mode","?"),this.#t=0,this.#g=0,this.#m=0,this.#d=0,this.#i.forEach(p),this.#a.forEach(p),this.#p.forEach(p),this.#l.forEach(p),this.#n.forEach(p),this.#w=100,this.#s=[],this.#v=0,this.#u="",this.#r=0,this.#c.forEach(p),this.#f.forEach(p),this.#a[1152]=127;for(let t=0;t<64;t++)this.#a[t*128+7]=127,this.#a[t*128+11]=127,this.#a[t*128+74]=127,this.#a[t*128+10]=127}switchMode(t,e=!1){let n=M.indexOf(t);if(n>-1)(this.#t==0||e)&&(this.#t=n,this.#g=P[0][n],this.#m=P[1][n],this.dispatchEvent("mode",t));else throw new Error(`Unknown mode ${t}`)}runJson(t){return this.#E[t.type].call(this,t)}runRaw(t){}constructor(){super();let t=this;self.seeReg=function(e){return Array.from(t.#a).slice(e*128,e*128+128)},this.#h=new v,this.#M=new v,this.#e=new v,this.#h.default=console.debug,this.#o[1]=function(e){this.#s.unshift(e)},this.#o[2]=function(e){this.#s.unshift(`Copyrite: ${e}`)},this.#o[3]=function(e){this.#s.unshift(`Trk.Info: ${e}`)},this.#o[4]=function(e){this.#s.unshift(`${$(this.#d,""," ")}Instrmnt: ${e}`)},this.#o[5]=function(e){this.#s.unshift(`C.Lyrics: ${e}`)},this.#o[6]=function(e){this.#s.unshift(`${$(this.#d,""," ")}C.Marker: ${e}`)},this.#o[7]=function(e){this.#s.unshift(`CuePoint: ${e}`)},this.#o[32]=function(e){this.#d=e[0]+1},this.#h.add([126,127,9,1],function(){t.switchMode("gm",!0),console.info("MIDI reset: GM")}).add([126,127,9,3],function(){t.switchMode("g2",!0),console.info("MIDI reset: GM2")}).add([65,16,22,18,127,1],function(){t.switchMode("mt32",!0),console.info("MIDI reset: MT-32")}).add([65,16,66,18,64,0,127,0,65],function(){t.switchMode("gs",!0),console.info("MIDI reset: GS")}).add([66,48,66,52,0],function(e){t.switchMode("ns5r",!0),console.info("KORG reset:",e)}).add([67,16,76,0,0,126,0],function(e){t.switchMode("xg",!0),console.info("MIDI reset: XG")}),this.#h.add([127,127,4,1],function(e){t.switchMode("gm"),t.#w=(e[1]<<7+e[0])/163.83}),this.#h.add([67,16,76,6,0],function(e){let n=e[0];t.#u=" ".repeat(n),t.#v=Date.now()+3200,e.slice(1).forEach(function(r){t.#u+=String.fromCharCode(r)})}).add([67,16,76,7,0,0],function(e){for(t.#r=Date.now()+3200;iMsg.length<48;)e.unshift(0);e.forEach(function(n,r){let i=Math.floor(r/16),s=r%16,o=(s*3+i)*7,f=7,c=0;for(o-=s*5,i==2&&(f=2);c<f;)t.#c[o+c]=n>>6-c&1,c++})}),this.#h.add([65,1],function(e){t.switchMode("mt32"),t.#e.run(e,1)}).add([65,2],function(e){t.switchMode("mt32"),t.#e.run(e,2)}).add([65,3],function(e){t.switchMode("mt32"),t.#e.run(e,3)}).add([65,4],function(e){t.switchMode("mt32"),t.#e.run(e,4)}).add([65,5],function(e){t.switchMode("mt32"),t.#e.run(e,5)}).add([65,6],function(e){t.switchMode("mt32"),t.#e.run(e,6)}).add([65,7],function(e){t.switchMode("mt32"),t.#e.run(e,7)}).add([65,8],function(e){t.switchMode("mt32"),t.#e.run(e,8)}).add([65,9],function(e){t.switchMode("mt32"),t.#i[9]=1,t.#e.run(e,9)}),this.#e.add([22,18,2,0,0],function(e,n){let r="";e.slice(0,10).forEach(function(i){i>31&&(r+=String.fromCharCode(i))}),t.#f[n]=r,console.debug(`MT-32 tone properties on channel ${n+1} (${r}): ${e.slice(10)}`)}),this.#h.add([65,16,69,18,16,1,0],function(e){t.#r=Date.now()+3200,e.forEach(function(n,r){if(r<64){let i=Math.floor(r/16),s=r%16,o=(s*4+i)*5,f=5,c=0;for(o-=s*4,i==3&&(f=1);c<f;)t.#c[o+c]=n>>4-c&1,c++}})})}};var C=Z(D(),1);var L=class{#t=!1;constructor(t,e,n,r){this.#t=t,this.start=e,this.end=n,this.data=r}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},x=class extends L{constructor(t,e,n){super(!0,t,e,n)}},U=class extends L{constructor(t,e){super(!1,t,t,e)}},b=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,e){return t.start==e.start?0:(+(t.start>e.start)<<1)-1}),this.forEach(function(t,e){t.index=e})}step(t,e=!1){let n=[];if(e)for(let r=0;r<this.length&&!(this[r].start>t);r++){if(this[r].end<t)continue;n.push(this[r])}else{let r=this.getRange(t-1,t),i=this;r.forEach(function(s){s.index>i.#t&&(n.push(s),i.#t=s.index)})}return n}getRange(t,e){t>e&&([t,e]=[e,t]);let n=[],r=-1,i=Math.ceil(Math.sqrt(this.length)),s=!0;for(let o=0;o<this.length;o+=i)this[o+i]?r<0&&this[o+i].start>=t&&(r=o):r=r<0?o:r;for(;s;)this[r]?.end<e?this[r].start>=t&&n.push(this[r]):s=!1,r++;return n}};var q=0xffffffffffff,R=function(t){let e=new b,n=this,r=t.timeDivision,i=120,s=new b,o=0,f=0;s.push(new x(0,q,[120,0])),t.track.forEach(function(h){o=0,h.event.forEach(function(d){o+=d.deltaTime,d.type==255&&d?.metaType==81&&(i=6e7/d.data,s[s.length-1]&&s.push(new x(o,0xffffffffffff,[i,0])))})}),s.fresh(),s.forEach(function(h,d,u){d>0&&(u[d-1].end=h.start)});let c=120;s.forEach(function(h,d,u){d>0&&(h.end==h.start?u.splice(u.indexOf(h),1):c==h.data[0]&&(u[d-1].end=h.end,u.splice(u.indexOf(h),1)),c=h.data[0])});let a=0,l=120;return s.forEach(function(h){let d=h.start,u=d/l/r*60+a;l=h.data[0],a=u-d/l/r*60,h.data[1]=a}),console.debug("All tempo changes: ",s),i=120,o=0,f=0,t.track.forEach(function(h,d){o=0,f=0,h.event.forEach(function(u,m){o+=u.deltaTime;let I=s.step(o,!0)[0];I&&(i=I.data[0],f=I.data[1]);let E={type:u.type,data:u.data,track:d,part:0};u.type>14?E.meta=u.metaType:E.part=u.channel,e.push(new U(o/i/r*60+f,E))})}),e.fresh(),e};var Y=["MSB","PRG","LSB"];var N=class{#t=[];get(t=0,e=0,n=0){let r,i=Array.from(arguments);i[0]==127&&i[2]==0&&i[1]>111&&(i[1]=0),i[0]==0&&i[2]>111&&i[2]<120&&(i[2]=0);let s=" ";for(;!(r?.length>0);)r=this.#t[i[1]||0][(i[0]<<7)+i[2]],r||(i[2]=0,s="^",this.#t[i[1]||0][i[0]<<7]||(i[0]=0,s="*"));s!=" "&&self.debugMode&&(r="");let o="??";switch(i[0]){case 0:{i[2]==0?o="GM":i[2]<120?o="XG":i[2]==127&&(o="MT");break}case 56:{o="AG";break}case 61:case 83:{o="AI";break}case 62:case 82:{o="XD";break}case 81:{o="RW";break}case 64:case 121:case 126:{o="XG";break}case 127:{o=n==127?"MT":"XG";break}case 120:o="GS";default:i[0]<40&&(o="GS")}return{name:r||(t||0).toString().padStart(3,"0")+" "+(e||0).toString().padStart(3,"0")+" "+(n||0).toString().padStart(3,"0"),ending:s,standard:o}}load(t){let e=this,n=[];t.split(`
`).forEach(function(r,i){let s=r.split("	"),o=[];i==0?(s.forEach(function(f,c){n[Y.indexOf(f)]=c}),console.info(`Bank map significance: ${n}`)):s.forEach(function(f,c){c>2?(e.#t[o[n[1]]]=e.#t[o[n[1]]]||[],e.#t[o[n[1]]][(o[n[0]]<<7)+o[n[2]]]=s[3]):o.push(parseInt(s[c]))})})}async loadFiles(...t){this.#t=[];let e=this;for(let n=0;n<t.length;n++)await fetch(`./data/bank/${t[n]}.tsv`).then(function(r){return console.info(`Parsing voice map: ${t[n]}`),r.text()}).then(function(r){e.load.call(e,r)})}constructor(...t){this.loadFiles(...t)}};var O=function(t){let e=Array.from("----");if(t>0)for(let n=0;t>0;n++)e[n]=t<1024?"=":">",t-=2048;else if(t<0)for(let n=3;t<0;n--)e[n]=t>=-1024?"=":"<",t+=2048;return e.join("")},B=function(t){let e=Array.from("----");if(t>64)for(let n=0;t>64;n++)e[n]=t<72?"=":">",t-=16;else if(t<64)for(let n=3;t<64;n--)e[n]=t>=56?"=":"<",t+=16;return e.join("")};var J=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],Q="!0123456789";var g="0123456789_aAbBcCdDeEfFgGhHiIjJ-kKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ",_=["-","~","+","|"],tt={"?":"UnkwnStd",gm:"GnrlMIDI",g2:"GrlMIDI2",xg:"YamahaXG",gs:"RolandGS",mt32:"RlndMT32",ag10:"KorgAG10",x5d:"Korg X5D","05rw":"Korg05RW",ns5r:"KorgNS5R"};C.default.customInterpreter=function(t,e,n){let r=[],i=n==!1?e.readIntVLV():n;t==127&&(i=1);for(let s=0;s<i;s++){let o=e.readInt(1);if(r.push(o),o!=247){if(o!=240){if(o>127)return console.debug(`Early termination: ${r}`),e.backOne(),e.backOne(),r}}}return r};var et=class extends w{#t=new S;#c;#r="";voices=new N("xg","gs","ns5r");#i=[];reset(){this.dispatchEvent("reset"),this.#c?.resetIndex(),this.#t.init(),this.#r=""}async loadFile(t){this.#c=R(C.default.parse(new Uint8Array(await t.arrayBuffer())))}switchMode(t,e=!1){this.#t.switchMode(t,e)}getMode(){return this.#t.mode}render(t){let e=this.#c.step(t),n=0,r=new Set,i=this,s=[];e.forEach(function(d){let u=d.data;u.type==9&&(u.data[1]>0?r.add(u.part*128+u.data[0]):r.has(u.part*128+u.data[0])&&n++),d.data.type==8&&r.has(u.part*128+u.data[0])&&n++;let m=i.#t.runJson(u);switch(m?.reply){case"meta":{s.push(m);break}}m?.reply&&delete m.reply}),s?.length>0&&this.dispatchEvent("meta",s);let o=this.#t.getActive(),f=[],c=i.#t.getPitch(),a=[],l=i.#t.getProgram(),h=0;return o.forEach(function(d,u){d&&(f[u]=i.#t.getVel(u),a[u]=i.#t.getCc(u),h+=f[u].size)}),{extraPoly:n,curPoly:h,chInUse:o,chKeyPr:f,chPitch:c,chProgr:l,chContr:a,eventCount:e.length,title:this.#r,bitmap:this.#t.getBitmap(),letter:this.#t.getLetter(),names:this.#t.getCustomNames(),texts:this.#t.getTexts(),master:this.#t.getMaster(),mode:this.#t.getMode()}}constructor(){super();let t=this;this.addEventListener("meta",function(e){e?.data?.forEach(function(n){(t.#i[n.meta]||console.debug).call(t,n.meta,n.data)})}),this.#t.addEventListener("mode",function(e){t.dispatchEvent("mode",e.data)}),this.#i[3]=function(e,n){t.#r?.length<1&&(t.#r=n)}}},Ct=class extends et{#t=new Array(64);constructor(){super();for(let t=0;t<this.#t.length;t++)this.#t[t]=0,console.info("a")}render(t,e){let n=new Array(24),r=super.render(t),i=this,s=Date.now();n[0]=`${r.eventCount.toString().padStart(3,"0")} Poly:${(r.curPoly+r.extraPoly).toString().padStart(3,"0")}/512 Vol:${Math.floor(r.master.volume)}.${Math.round(r.master.volume%1*100).toString().padStart(2,"0")}%`,n[1]=`Mode:${tt[r.mode]} Title:${r.title||"N/A"}`,n[2]="Ch:VoiceNme#St VEM RCDB PP PiBd Pan : Note";let o=3;if(this.#t.forEach(function(f,c,a){a[c]=f>>1}),r.chInUse.forEach(function(f,c){if(f){let a=i.voices.get(r.chContr[c][0],r.chProgr[c],r.chContr[c][32]);r.names[c]&&(a.name=r.names[c],a.ending="~"),n[o]=`${(c+1).toString().padStart(2,"0")}:${a.name.slice(0,8).padEnd(8," ")}${a.ending}${a.standard} ${g[r.chContr[c][7]>>1]}${g[r.chContr[c][11]>>1]}${_[r.chContr[c][1]>>5]} ${g[r.chContr[c][91]>>1]}${g[r.chContr[c][93]>>1]}${g[r.chContr[c][94]>>1]}${g[r.chContr[c][74]>>1]} ${r.chContr[c][65]>63?"O":"X"}${g[r.chContr[c][5]>>1]} ${O(r.chPitch[c])} ${B(r.chContr[c][10])}:`,r.chKeyPr[c].forEach(function(l,h){if(l>0){let d=Math.max(i.#t[c],l);i.#t[c]=d-i.#t[c]>32?i.#t[c]+48:d,n[o]+=` <span style="opacity:${Math.round(l/1.27)/100}">${J[h%12]}${Q[Math.floor(h/12)]}</span>`}}),o++}}),r.texts.length>0){let f=0;for(let c=n.length-1;c>=o;c--)n[c]=(r.texts[f]||"").padEnd(100," "),f++}if(s<=r.letter.expire){let f=r.letter.text.padEnd(32," "),c=n.length-2;for(let a=0;a<2;a++)n[a+c]=`${(n[a+c]||"").slice(0,82).padEnd(81)} <span class="letter"> ${f.slice(a*16,a*16+16).padEnd(" ",16)} </span>`}if(e.clearRect(0,0,e.canvas.width,e.canvas.height),e){e.fillStyle="#202020";let f;s<=r.bitmap.expire?f=r.bitmap.bitmap:(f=new Array(256),i.#t.forEach(function(c,a){if(a<16&&r.chContr[a]?.length>0){let l=Math.floor(c*r.chContr[a][7]*r.chContr[a][11]/129032);for(let h=0;h<=l;h++)f[a+(15-h)*16]=1}})),f.forEach(function(c,a){c&&e.fillRect(a%16*12,Math.floor(a/16)*6,11,5)})}return n.join("<br/>")}};export{Ct as TuiDisplay};
