var S=Object.create;var b=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var V=(t,n)=>()=>(n||t((n={exports:{}}).exports,n),n.exports);var $=(t,n,e,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let a of L(n))!D.call(t,a)&&a!==e&&b(t,a,{get:()=>n[a],enumerable:!(r=U(n,a))||r.enumerable});return t};var B=(t,n,e)=>(e=t!=null?S(O(t)):{},$(n||!t||!t.__esModule?b(e,"default",{value:t,enumerable:!0}):e,t));var T=V((_,k)=>{(function(){"use strict";let t={debug:!1,parse:function(n,e){if(n instanceof Uint8Array)return t.Uint8(n);if(typeof n=="string")return t.Base64(n);if(n instanceof HTMLElement&&n.type==="file")return t.addListener(n,e);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(n,e){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(n===void 0||!(n instanceof HTMLElement)||n.tagName!=="INPUT"||n.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;e=e||function(){},n.addEventListener("change",function(r){if(!r.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let a=new FileReader;a.readAsArrayBuffer(r.target.files[0]),a.onload=function(s){e(t.Uint8(new Uint8Array(s.target.result)))}})},Base64:function(n){let e=function(s){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(s=s.replace(/^.*?base64,/,""),s=String(s).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(s))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");s+="==".slice(2-(3&s.length));let d,f="",i,l,h=0;for(;h<s.length;)d=o.indexOf(s.charAt(h++))<<18|o.indexOf(s.charAt(h++))<<12|(i=o.indexOf(s.charAt(h++)))<<6|(l=o.indexOf(s.charAt(h++))),f+=i===64?String.fromCharCode(d>>16&255):l===64?String.fromCharCode(d>>16&255,d>>8&255):String.fromCharCode(d>>16&255,d>>8&255,255&d);return f}(n=String(n));var r=e.length;let a=new Uint8Array(new ArrayBuffer(r));for(let s=0;s<r;s++)a[s]=e.charCodeAt(s);return t.Uint8(a)},Uint8:function(a){let e={data:null,pointer:0,movePointer:function(i){return this.pointer+=i,this.pointer},readInt:function(i){if((i=Math.min(i,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<i)for(let h=1;h<=i-1;h++)l+=this.data.getUint8(this.pointer)*Math.pow(256,i-h),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(i){let l="";for(let h=1;h<=i;h++)l+=String.fromCharCode(this.readInt(1));return l},backOne:function(){this.pointer--},readIntVLV:function(){let i=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)i=this.readInt(1);else{let h=[];for(;128<=this.data.getUint8(this.pointer);)h.push(this.readInt(1)-128);var l=this.readInt(1);for(let c=1;c<=h.length;c++)i+=h[h.length-c]*Math.pow(128,c);i+=l}return i}};if(e.data=new DataView(a.buffer,a.byteOffset,a.byteLength),e.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;e.readInt(4);let r={};r.formatType=e.readInt(2),r.tracks=e.readInt(2),r.track=[];var a=e.readInt(1),s=e.readInt(1);128<=a?(r.timeDivision=[],r.timeDivision[0]=a-128,r.timeDivision[1]=s):r.timeDivision=256*a+s;for(let i=1;i<=r.tracks;i++){r.track[i-1]={event:[]};var o,d=e.readInt(4);if(d===-1)break;if(d!==1297379947)return!1;e.readInt(4);let l=0,h=!1,c,u;for(;!h&&(l++,r.track[i-1].event[l-1]={},r.track[i-1].event[l-1].deltaTime=e.readIntVLV(),(c=e.readInt(1))!==-1);)if(128<=c?u=c:(c=u,e.movePointer(-1)),c===255){r.track[i-1].event[l-1].type=255,r.track[i-1].event[l-1].metaType=e.readInt(1);var f=e.readIntVLV();switch(r.track[i-1].event[l-1].metaType){case 47:case-1:h=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:r.track[i-1].event[l-1].data=e.readStr(f);break;case 33:case 89:case 81:r.track[i-1].event[l-1].data=e.readInt(f);break;case 84:r.track[i-1].event[l-1].data=[],r.track[i-1].event[l-1].data[0]=e.readInt(1),r.track[i-1].event[l-1].data[1]=e.readInt(1),r.track[i-1].event[l-1].data[2]=e.readInt(1),r.track[i-1].event[l-1].data[3]=e.readInt(1),r.track[i-1].event[l-1].data[4]=e.readInt(1);break;case 88:r.track[i-1].event[l-1].data=[],r.track[i-1].event[l-1].data[0]=e.readInt(1),r.track[i-1].event[l-1].data[1]=e.readInt(1),r.track[i-1].event[l-1].data[2]=e.readInt(1),r.track[i-1].event[l-1].data[3]=e.readInt(1);break;default:this.customInterpreter!==null&&(r.track[i-1].event[l-1].data=this.customInterpreter(r.track[i-1].event[l-1].metaType,e,f)),this.customInterpreter!==null&&r.track[i-1].event[l-1].data!==!1||(e.readInt(f),r.track[i-1].event[l-1].data=e.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((c=c.toString(16).split(""))[1]||c.unshift("0"),r.track[i-1].event[l-1].type=parseInt(c[0],16),r.track[i-1].event[l-1].channel=parseInt(c[1],16),r.track[i-1].event[l-1].type){case 15:this.customInterpreter!==null&&(r.track[i-1].event[l-1].data=this.customInterpreter(r.track[i-1].event[l-1].type,e,!1)),this.customInterpreter!==null&&r.track[i-1].event[l-1].data!==!1||(o=e.readIntVLV(),r.track[i-1].event[l-1].data=e.readInt(o),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:r.track[i-1].event[l-1].data=[],r.track[i-1].event[l-1].data[0]=e.readInt(1),r.track[i-1].event[l-1].data[1]=e.readInt(1);break;case 12:case 13:r.track[i-1].event[l-1].data=e.readInt(1);break;case-1:h=!0;break;default:if(this.customInterpreter!==null&&(r.track[i-1].event[l-1].data=this.customInterpreter(r.track[i-1].event[l-1].metaType,e,!1)),this.customInterpreter===null||r.track[i-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return r},customInterpreter:null};if(typeof k<"u")k.exports=t;else{let n=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;n.MidiParser=t}})()});var E=class{#t={};addEventListener(t,n){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(n)}removeEventListener(t,n){if(this.#t[t]){let e=this.#t[t].indexOf(n);e>-1&&this.#t[t].splice(e,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t){let n=new Event(t),e=this;this.#t[t]?.length>0&&this.#t[t].forEach(function(r){r?.call(e,n)}),this[`on${t}`]&&this[`on${t}`](n)}};var v=["?","gm","gs","xg","mt32","ns5r","ag10","x5d","05rw"],F={};v.forEach(function(t,n){F[t]=n});var p=function(t,n,e){e[n]=0},x=class{#t=0;#r=new Array(64);#a=new Uint8ClampedArray(8192);#i=new Uint8ClampedArray(64);#n=new Uint8ClampedArray(8192);#e=new Uint16Array(512);#s=new Int16Array(64);#o=0;#l=0;#c={8:function(t){let n=t.part*128+t.data[0],e=this.#e.indexOf(n);e>-1&&(this.#e[e]=0,this.#n[n]=0)},9:function(t){this.#r[t.part]=!0;let n=t.part*128+t.data[0];if(t.data[1]>0){let e=0;for(;this.#e[e]>0;)e++;e<512?(this.#e[e]=n,this.#n[n]=t.data[1]):console.error("Polyphony exceeded.")}else{let e=this.#e.indexOf(n);e>-1&&(this.#e[e]=0,this.#n[n]=0)}},10:function(t){let n=t.part*128+t.data[0];this.#e.indexOf(n)>-1&&(this.#n[n]=data[1])},11:function(t){this.#r[t.part]=!0,this.#a[t.part*128+t.data[0]]=t.data[1]},12:function(t){this.#r[t.part]=!0,this.#i[t.part]=t.data},13:function(t){let n=this;this.#e.forEach(function(e){let r=e>>7;t.part==r&&(this.#n[e]=t.data)}),console.info(t)},14:function(t){this.#s[t.part]=t.data[1]*128+t.data[0]},15:function(t){console.warn(t)},255:function(t){console.warn(t)}};getActive(){return this.#r.slice()}getCc(t){let n=t*128;return Array.from(this.#a).slice(n,n+128)}getPitch(){return Array.from(this.#s)}getProgram(){return Array.from(this.#i)}getVel(t){let n=new Map,e=this;return this.#e.forEach(function(r){let a=r>>7,s=r&127;t==a&&e.#n[r]>0&&n.set(s,e.#n[r])}),n}getMode(){return v[this.#t]}init(){this.#t=0,this.#o=0,this.#l=0,this.#r.forEach(p),this.#a.forEach(p),this.#i.forEach(p),this.#n.forEach(p),this.#e.forEach(p)}switchMode(t,n=!1){let e=v.indexOf(t);if(e>-1)(this.#t==0||n)&&(this.#t=e);else throw new Error(`Unknown mode ${t}`)}runJson(t){this.#c[t.type].call(this,t)}runRaw(t){}};var y=B(T(),1);var A=class{#t=!1;constructor(t,n,e,r){this.#t=t,this.start=n,this.end=e,this.data=r}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},w=class extends A{constructor(t,n,e){super(!0,t,n,e)}},M=class extends A{constructor(t,n){super(!1,t,t,n)}},I=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,n){return t.start==n.start?0:(+(t.start>n.start)<<1)-1}),this.forEach(function(t,n){t.index=n})}step(t,n=!1){let e=[];if(n)for(let r=0;r<this.length&&!(this[r].start>t);r++){if(this[r].end<t)continue;e.push(this[r])}else{let r=this.getRange(t-1,t),a=this;r.forEach(function(s){s.index>a.#t&&(e.push(s),a.#t=s.index)})}return e}getRange(t,n){t>n&&([t,n]=[n,t]);let e=[],r=-1,a=Math.ceil(Math.sqrt(this.length)),s=!0;for(let o=0;o<this.length;o+=a)this[o+a]?r<0&&this[o+a].start>=t&&(r=o):r=r<0?o:r;for(;s;)this[r]?.end<n?this[r].start>=t&&e.push(this[r]):s=!1,r++;return e}};var N=0xffffffffffff,P=function(t){let n=new I,e=this,r=t.timeDivision,a=120,s=new I,o=0,d=0;s.push(new w(0,N,[120,0])),t.track.forEach(function(h){o=0,h.event.forEach(function(c){o+=c.deltaTime,c.type==255&&c?.metaType==81&&(a=6e7/c.data,s[s.length-1]&&s.push(new w(o,0xffffffffffff,[a,0])))})}),s.fresh(),s.forEach(function(h,c,u){c>0&&(u[c-1].end=h.start)});let f=120;s.forEach(function(h,c,u){h.end==h.start?u.splice(u.indexOf(h),1):f==h.data[0]&&(u[c-1].end=h.end,u.splice(u.indexOf(h),1)),f=h.data[0]});let i=0,l=120;return s.forEach(function(h){let c=h.start,u=c/l/r*60+i;l=h.data[0],i=u-c/l/r*60,h.data[1]=i}),console.debug("All tempo changes: ",s),a=120,o=0,d=0,t.track.forEach(function(h,c){o=0,d=0,h.event.forEach(function(u,z){o+=u.deltaTime;let g=s.step(o,!0)[0];g&&(a=g.data[0],d=g.data[1]);let m={type:u.type,data:u.data,track:c,part:0};u.type>14?m.meta=u.metaType:m.part=u.channel,n.push(new M(o/a/r*60+d,m))})}),n.fresh(),n};var R=["MSB","PRG","LSB"];var C=class{#t=[];get(t=0,n=0,e=0){let r,a=Array.from(arguments);a[0]==127&&a[2]==0&&a[1]>111&&(a[1]=0),a[0]==0&&a[2]>111&&a[2]<120&&(a[2]=0);let s=" ";for(;!(r?.length>0);)r=this.#t[a[1]||0][(a[0]<<7)+a[2]],r||(a[2]=0,s="^",this.#t[a[1]||0][a[0]<<7]||(a[0]=0,s="*"));s!=" "&&self.debugMode&&(r="");let o="??";switch(a[0]){case 0:{a[2]==0?o="GM":a[2]<120?o="XG":a[2]==127&&(o="MT");break}case 56:{o="AG";break}case 61:case 83:{o="AI";break}case 62:case 82:{o="XD";break}case 81:{o="RW";break}case 64:case 121:case 126:case 127:{o="XG";break}case 120:o="GS";default:a[0]<40&&(o="GS")}return{name:r||(t||0).toString().padStart(3,"0")+" "+(n||0).toString().padStart(3,"0")+" "+(e||0).toString().padStart(3,"0"),ending:s,standard:o}}load(t){let n=this,e=[];t.split(`
`).forEach(function(r,a){let s=r.split("	"),o=[];a==0?(s.forEach(function(d,f){e[R.indexOf(d)]=f}),console.info(`Bank map significance: ${e}`)):s.forEach(function(d,f){f>2?(n.#t[o[e[1]]]=n.#t[o[e[1]]]||[],n.#t[o[e[1]]][(o[e[0]]<<7)+o[e[2]]]=s[3]):o.push(parseInt(s[f]))})})}async loadFiles(...t){this.#t=[];let n=this;for(let e=0;e<t.length;e++)await fetch(`./data/bank/${t[e]}.tsv`).then(function(r){return console.info(`Parsing voice map: ${t[e]}`),r.text()}).then(function(r){n.load.call(n,r)})}constructor(...t){this.loadFiles(...t)}};var G=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],j="!0123456789";y.default.customInterpreter=function(t,n,e){let r=[],a=e==!1?n.readIntVLV():e;t==127&&(a=1);for(let s=0;s<a;s++){let o=n.readInt(1);if(r.push(o),o==247)return r;if(o>127)return console.debug(`Early termination: ${r}`),n.backOne(),n.backOne(),r}return r};var X=class extends E{#t=new x;#r;voices=new C("xg","gs","ns5r");reset(){this.dispatchEvent("reset"),this.#r?.resetIndex(),this.#t.init()}async loadFile(t){this.#r=P(y.default.parse(new Uint8Array(await t.arrayBuffer())))}switchMode(t,n=!1){this.#t.switchMode(t,n)}getMode(){return this.#t.mode}render(t){let n=this.#r.step(t),e=0,r=new Set,a=this;n.forEach(function(h){let c=h.data;c.type==9&&(c.data[1]>0?r.add(c.part*128+c.data[0]):r.has(c.part*128+c.data[0])&&e++),h.data.type==8&&r.has(c.part*128+c.data[0])&&e++,a.#t.runJson(c)});let s=this.#t.getActive(),o=[],d=a.#t.getPitch(),f=[],i=a.#t.getProgram(),l=0;return s.forEach(function(h,c){h&&(o[c]=a.#t.getVel(c),f[c]=a.#t.getCc(c),l+=o[c].size)}),{extraPoly:e,curPoly:l,chInUse:s,chKeyPr:o,chPitch:d,chProgr:i,chContr:f,mode:this.getMode()}}},ut=class extends X{constructor(){super()}render(t){let n=new Array(30),e=super.render(t),r=this;n[0]=`Poly:${(e.curPoly+e.extraPoly).toString().padStart(3,"0")}/512`,n[2]="Ch:VoiceNme#St Note";let a=3;return e.chInUse.forEach(function(s,o){if(s){let d=r.voices.get(e.chContr[o][0],e.chProgr[o],e.chContr[o][32]);n[a]=`${(o+1).toString().padStart(2,"0")}:${d.name.padEnd(8," ")}${d.ending}${d.standard}`,e.chKeyPr[o].forEach(function(f,i){f>0&&(n[a]+=` <span style="opacity:${Math.round(f/1.27)/100}">${G[i%12]}${j[Math.floor(i/12)]}</span>`)}),a++}}),n.join("<br/>")}};export{ut as TuiDisplay};
