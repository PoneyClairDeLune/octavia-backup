var U=Object.create;var y=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var P=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var C=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var D=(t,a,r,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let s of M(a))!O.call(t,s)&&s!==r&&y(t,s,{get:()=>a[s],enumerable:!(e=A(a,s))||e.enumerable});return t};var S=(t,a,r)=>(r=t!=null?U(P(t)):{},D(a||!t||!t.__esModule?y(r,"default",{value:t,enumerable:!0}):r,t));var b=C(($,m)=>{(function(){"use strict";let t={debug:!1,parse:function(a,r){if(a instanceof Uint8Array)return t.Uint8(a);if(typeof a=="string")return t.Base64(a);if(a instanceof HTMLElement&&a.type==="file")return t.addListener(a,r);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(a,r){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(a===void 0||!(a instanceof HTMLElement)||a.tagName!=="INPUT"||a.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;r=r||function(){},a.addEventListener("change",function(e){if(!e.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let s=new FileReader;s.readAsArrayBuffer(e.target.files[0]),s.onload=function(o){r(t.Uint8(new Uint8Array(o.target.result)))}})},Base64:function(a){let r=function(o){var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(o=o.replace(/^.*?base64,/,""),o=String(o).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(o))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");o+="==".slice(2-(3&o.length));let f,u="",n,i,d=0;for(;d<o.length;)f=l.indexOf(o.charAt(d++))<<18|l.indexOf(o.charAt(d++))<<12|(n=l.indexOf(o.charAt(d++)))<<6|(i=l.indexOf(o.charAt(d++))),u+=n===64?String.fromCharCode(f>>16&255):i===64?String.fromCharCode(f>>16&255,f>>8&255):String.fromCharCode(f>>16&255,f>>8&255,255&f);return u}(a=String(a));var e=r.length;let s=new Uint8Array(new ArrayBuffer(e));for(let o=0;o<e;o++)s[o]=r.charCodeAt(o);return t.Uint8(s)},Uint8:function(s){let r={data:null,pointer:0,movePointer:function(n){return this.pointer+=n,this.pointer},readInt:function(n){if((n=Math.min(n,this.data.byteLength-this.pointer))<1)return-1;let i=0;if(1<n)for(let d=1;d<=n-1;d++)i+=this.data.getUint8(this.pointer)*Math.pow(256,n-d),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(n){let i="";for(let d=1;d<=n;d++)i+=String.fromCharCode(this.readInt(1));return i},backOne:function(){this.pointer--},readIntVLV:function(){let n=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)n=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);var i=this.readInt(1);for(let c=1;c<=d.length;c++)n+=d[d.length-c]*Math.pow(128,c);n+=i}return n}};if(r.data=new DataView(s.buffer,s.byteOffset,s.byteLength),r.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;r.readInt(4);let e={};e.formatType=r.readInt(2),e.tracks=r.readInt(2),e.track=[];var s=r.readInt(1),o=r.readInt(1);128<=s?(e.timeDivision=[],e.timeDivision[0]=s-128,e.timeDivision[1]=o):e.timeDivision=256*s+o;for(let n=1;n<=e.tracks;n++){e.track[n-1]={event:[]};var l,f=r.readInt(4);if(f===-1)break;if(f!==1297379947)return!1;r.readInt(4);let i=0,d=!1,c,h;for(;!d&&(i++,e.track[n-1].event[i-1]={},e.track[n-1].event[i-1].deltaTime=r.readIntVLV(),(c=r.readInt(1))!==-1);)if(128<=c?h=c:(c=h,r.movePointer(-1)),c===255){e.track[n-1].event[i-1].type=255,e.track[n-1].event[i-1].metaType=r.readInt(1);var u=r.readIntVLV();switch(e.track[n-1].event[i-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:e.track[n-1].event[i-1].data=r.readStr(u);break;case 33:case 89:case 81:e.track[n-1].event[i-1].data=r.readInt(u);break;case 84:e.track[n-1].event[i-1].data=[],e.track[n-1].event[i-1].data[0]=r.readInt(1),e.track[n-1].event[i-1].data[1]=r.readInt(1),e.track[n-1].event[i-1].data[2]=r.readInt(1),e.track[n-1].event[i-1].data[3]=r.readInt(1),e.track[n-1].event[i-1].data[4]=r.readInt(1);break;case 88:e.track[n-1].event[i-1].data=[],e.track[n-1].event[i-1].data[0]=r.readInt(1),e.track[n-1].event[i-1].data[1]=r.readInt(1),e.track[n-1].event[i-1].data[2]=r.readInt(1),e.track[n-1].event[i-1].data[3]=r.readInt(1);break;default:this.customInterpreter!==null&&(e.track[n-1].event[i-1].data=this.customInterpreter(e.track[n-1].event[i-1].metaType,r,u)),this.customInterpreter!==null&&e.track[n-1].event[i-1].data!==!1||(r.readInt(u),e.track[n-1].event[i-1].data=r.readInt(u),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((c=c.toString(16).split(""))[1]||c.unshift("0"),e.track[n-1].event[i-1].type=parseInt(c[0],16),e.track[n-1].event[i-1].channel=parseInt(c[1],16),e.track[n-1].event[i-1].type){case 15:this.customInterpreter!==null&&(e.track[n-1].event[i-1].data=this.customInterpreter(e.track[n-1].event[i-1].type,r,!1)),this.customInterpreter!==null&&e.track[n-1].event[i-1].data!==!1||(l=r.readIntVLV(),e.track[n-1].event[i-1].data=r.readInt(l),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:e.track[n-1].event[i-1].data=[],e.track[n-1].event[i-1].data[0]=r.readInt(1),e.track[n-1].event[i-1].data[1]=r.readInt(1);break;case 12:case 13:e.track[n-1].event[i-1].data=r.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(e.track[n-1].event[i-1].data=this.customInterpreter(e.track[n-1].event[i-1].metaType,r,!1)),this.customInterpreter===null||e.track[n-1].event[i-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return e},customInterpreter:null};if(typeof m<"u")m.exports=t;else{let a=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;a.MidiParser=t}})()});var E=class{#t={};addEventListener(t,a){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(a)}removeEventListener(t,a){if(this.#t[t]){let r=this.#t[t].indexOf(a);r>-1&&this.#t[t].splice(r,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,a){let r=new Event(t),e=this;r.data=a,this.#t[t]?.length>0&&this.#t[t].forEach(function(s){s?.call(e,r)}),this[`on${t}`]&&this[`on${t}`](r)}};var w=S(b(),1);var T=class{#t=!1;constructor(t,a,r,e){this.#t=t,this.start=a,this.end=r,this.data=e}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},I=class extends T{constructor(t,a,r){super(!0,t,a,r)}},x=class extends T{constructor(t,a){super(!1,t,t,a)}},k=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,a){return t.start==a.start?0:(+(t.start>a.start)<<1)-1}),this.forEach(function(t,a){t.index=a})}step(t,a=!1){let r=[];if(a)for(let e=0;e<this.length&&!(this[e].start>t);e++){if(this[e].end<t)continue;r.push(this[e])}else{let e=this.getRange(this.#t==-1?0:t-1,t),s=this;e.forEach(function(o){o.index>s.#t&&(r.push(o),s.#t=o.index)})}return r}getRange(t,a){t>a&&([t,a]=[a,t]);let r=[],e=-1,s=Math.ceil(Math.sqrt(this.length)),o=!0;for(let l=0;l<this.length;l+=s)this[l+s]?e<0&&this[l+s].start>=t&&(e=l):e=e<0?l:e;for(;o;)this[e]?.end<a?this[e].start>=t&&r.push(this[e]):o=!1,e++;return r}};var V=0xffffffffffff,L=function(t){let a=new k,r=this,e=t.timeDivision,s=120,o=new k,l=0,f=0;o.push(new I(0,V,[120,0])),t.track.forEach(function(d){l=0,d.event.forEach(function(c){l+=c.deltaTime,c.type==255&&c?.metaType==81&&(s=6e7/c.data,o[o.length-1]&&o.push(new I(l,0xffffffffffff,[s,0])))})}),o.fresh(),o.forEach(function(d,c,h){c>0&&(h[c-1].end=d.start)});let u=120;o.forEach(function(d,c,h){c>0&&(d.end==d.start?h.splice(h.indexOf(d),1):u==d.data[0]&&(h[c-1].end=d.end,h.splice(h.indexOf(d),1)),u=d.data[0])});let n=0,i=120;return o.forEach(function(d){let c=d.start,h=c/i/e*60+n;i=d.data[0],n=h-c/i/e*60,d.data[1]=n}),console.debug("All tempo changes: ",o),s=120,l=0,f=0,t.track.forEach(function(d,c){l=0,f=0;let h=c+1;d.event.forEach(function(p,B){l+=p.deltaTime;let v=o.step(l,!0)[0];v&&(s=v.data[0],f=v.data[1]);let g={type:p.type,data:p.data,track:h,part:0};p.type>14?g.meta=p.metaType:g.part=p.channel,a.push(new x(l/s/e*60+f,g))})}),a.fresh(),self.midiEvents=a,console.debug(`Parsed a type ${t.formatType} MIDI sequence.`),a};w.default.customInterpreter=function(t,a,r){let e=[],s=r==!1?a.readIntVLV():r;t==0||t==127;for(let o=0;o<s;o++){let l=a.readInt(1);if(e.push(l),l!=247){if(l!=240){if(l>127)return console.debug(`Early termination: ${e}`),e.pop(),a.backOne(),a.backOne(),e}}}return e};var Y=function(t,a=0){let r=t[0]>>4,e=t[0]&15,s={track:(a&15)+240,type:r,data:t.slice(1)};if(r<15)return s.part=e,s;if(r==12)s.data=t[1];else{if(e==0)return s;console.warn(`Unknown special event channel ${e}.`)}},_=function(t){let a=t.type,r=t.part;if(a==255)return;let e=3;a==12?e=2:a==15&&(e=t.data.length+1);let s=new Uint8Array(e);return a!=15?s[0]=t.type*16+t.part:s[0]=240,a==12?s[1]=t.data:t.data.forEach?t.data.forEach((o,l)=>{s[l+1]=o}):console.debug(`Type ${a} value ${t.data.constructor.name} cannot be iterated.`),s},J=function(){return new BroadcastChannel("cc.ltgc.octavia:MainInput")},j=function(){return new BroadcastChannel("cc.ltgc.octavia:MainOutput")},tt=class extends E{#t;#n=!0;#r=0;#a=0;#e=-1;get currentTime(){return this.#r/1e3}get duration(){return this.#t?this.#t[this.#t.length-1].end+4:0}async load(t){t?this.#t=L(w.default.parse(new Uint8Array(await t.arrayBuffer()))):(this.pause(),this.#r=0)}pause(){if(this.#e>-1){clearInterval(this.#e);for(let t=0;t<16;t++)this.dispatchEvent("midi",{delay:0,data:{part:t,type:11,data:[123,0]}});this.dispatchEvent("pause"),this.#e=-1}}async play(){this.#e<0&&(this.#a=Date.now(),this.#e=setInterval(()=>{let t=Date.now(),a=this.#r,r=t-this.#a;this.#r+=r,this.#t.step(this.currentTime)?.forEach(s=>{this.dispatchEvent("midi",{delay:Math.round(s.start*1e3-a),data:s.data})}),this.#a=t},12.5),this.dispatchEvent("play"))}constructor(t){super(),t&&this.load(t)}};export{tt as SimpleMidiEventEmitter,_ as fromJson,J as getBridge,j as getBridgeOut,Y as toJson};
