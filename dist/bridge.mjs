var M=Object.create;var E=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var C=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var B=(e,s)=>()=>(s||e((s={exports:{}}).exports,s),s.exports);var S=(e,s,o,a)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of P(s))!O.call(e,t)&&t!==o&&E(e,t,{get:()=>s[t],enumerable:!(a=D(s,t))||a.enumerable});return e};var F=(e,s,o)=>(o=e!=null?M(C(e)):{},S(s||!e||!e.__esModule?E(o,"default",{value:e,enumerable:!0}):o,e));var T=B((q,I)=>{(function(){"use strict";let e={fatal:!0},s=[new TextDecoder("iso-8859-15",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("utf-8",e),new TextDecoder("utf-16",e),new TextDecoder("ascii")],o={debug:!1,parse:function(a,t){if(a instanceof Uint8Array)return o.Uint8(a);if(typeof a=="string")return o.Base64(a);if(a instanceof HTMLElement&&a.type==="file")return o.addListener(a,t);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(a,t){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(a===void 0||!(a instanceof HTMLElement)||a.tagName!=="INPUT"||a.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;t=t||function(){},a.addEventListener("change",function(r){if(!r.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let c=new FileReader;c.readAsArrayBuffer(r.target.files[0]),c.onload=function(l){t(o.Uint8(new Uint8Array(l.target.result)))}})},Base64:function(a){let t=function(l){var v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(l=l.replace(/^.*?base64,/,""),l=String(l).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(l))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");l+="==".slice(2-(3&l.length));let h,u="",n,i,d=0;for(;d<l.length;)h=v.indexOf(l.charAt(d++))<<18|v.indexOf(l.charAt(d++))<<12|(n=v.indexOf(l.charAt(d++)))<<6|(i=v.indexOf(l.charAt(d++))),u+=n===64?String.fromCharCode(h>>16&255):i===64?String.fromCharCode(h>>16&255,h>>8&255):String.fromCharCode(h>>16&255,h>>8&255,255&h);return u}(a=String(a));var r=t.length;let c=new Uint8Array(new ArrayBuffer(r));for(let l=0;l<r;l++)c[l]=t.charCodeAt(l);return o.Uint8(c)},Uint8:function(c){let t={data:null,pointer:0,movePointer:function(n){return this.pointer+=n,this.pointer},readInt:function(n){if((n=Math.min(n,this.data.byteLength-this.pointer))<1)return-1;let i=0;if(1<n)for(let d=1;d<=n-1;d++)i+=this.data.getUint8(this.pointer)*Math.pow(256,n-d),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(n){let i=new Uint8Array(n),d=!1,f;i.forEach((g,p)=>{i[p]=this.readInt(1)});for(let g=0;g<s.length;g++)if(!d)try{if(f=s[g].decode(i),g==0)for(let p=0;p<f.length;p++){let m=f.charCodeAt(p);if(m>191||m>127&&m<160)throw new RangeError(`Invalid code point: ${m}`)}d=!0,console.debug(`String byte sequence in ${s[g].encoding}`)}catch(p){console.debug(`SMF string ${p}`)}return f||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let n=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)n=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);var i=this.readInt(1);for(let f=1;f<=d.length;f++)n+=d[d.length-f]*Math.pow(128,f);n+=i}return n}};if(t.data=new DataView(c.buffer,c.byteOffset,c.byteLength),t.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;t.readInt(4);let r={};r.formatType=t.readInt(2),r.tracks=t.readInt(2),r.track=[];var c=t.readInt(1),l=t.readInt(1);128<=c?(r.timeDivision=[],r.timeDivision[0]=c-128,r.timeDivision[1]=l):r.timeDivision=256*c+l;for(let n=1;n<=r.tracks;n++){r.track[n-1]={event:[]};var v,h=t.readInt(4);if(h===-1)break;if(h!==1297379947)return!1;t.readInt(4);let i=0,d=!1,f,g;for(;!d&&(i++,r.track[n-1].event[i-1]={},r.track[n-1].event[i-1].deltaTime=t.readIntVLV(),(f=t.readInt(1))!==-1);)if(128<=f?g=f:(f=g,t.movePointer(-1)),f===255){r.track[n-1].event[i-1].type=255,r.track[n-1].event[i-1].metaType=t.readInt(1);var u=t.readIntVLV();switch(r.track[n-1].event[i-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:r.track[n-1].event[i-1].data=t.readStr(u);break;case 33:case 89:case 81:r.track[n-1].event[i-1].data=t.readInt(u);break;case 84:r.track[n-1].event[i-1].data=[],r.track[n-1].event[i-1].data[0]=t.readInt(1),r.track[n-1].event[i-1].data[1]=t.readInt(1),r.track[n-1].event[i-1].data[2]=t.readInt(1),r.track[n-1].event[i-1].data[3]=t.readInt(1),r.track[n-1].event[i-1].data[4]=t.readInt(1);break;case 88:r.track[n-1].event[i-1].data=[],r.track[n-1].event[i-1].data[0]=t.readInt(1),r.track[n-1].event[i-1].data[1]=t.readInt(1),r.track[n-1].event[i-1].data[2]=t.readInt(1),r.track[n-1].event[i-1].data[3]=t.readInt(1);break;default:this.customInterpreter!==null&&(r.track[n-1].event[i-1].data=this.customInterpreter(r.track[n-1].event[i-1].metaType,t,u)),this.customInterpreter!==null&&r.track[n-1].event[i-1].data!==!1||(t.readInt(u),r.track[n-1].event[i-1].data=t.readInt(u),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((f=f.toString(16).split(""))[1]||f.unshift("0"),r.track[n-1].event[i-1].type=parseInt(f[0],16),r.track[n-1].event[i-1].channel=parseInt(f[1],16),r.track[n-1].event[i-1].type){case 15:this.customInterpreter!==null&&(r.track[n-1].event[i-1].data=this.customInterpreter(r.track[n-1].event[i-1].type,t,!1)),this.customInterpreter!==null&&r.track[n-1].event[i-1].data!==!1||(v=t.readIntVLV(),r.track[n-1].event[i-1].data=t.readInt(v),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:r.track[n-1].event[i-1].data=[],r.track[n-1].event[i-1].data[0]=t.readInt(1),r.track[n-1].event[i-1].data[1]=t.readInt(1);break;case 12:case 13:r.track[n-1].event[i-1].data=t.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(r.track[n-1].event[i-1].data=this.customInterpreter(r.track[n-1].event[i-1].metaType,t,!1)),this.customInterpreter===null||r.track[n-1].event[i-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return r},customInterpreter:null};if(typeof I<"u")I.exports=o;else{let a=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;a.MidiParser=o}})()});var b=class{#e={};addEventListener(e,s){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(s)}removeEventListener(e,s){if(this.#e[e]){let o=this.#e[e].indexOf(s);o>-1&&this.#e[e].splice(o,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,s){let o=new Event(e),a=this;o.data=s,this.#e[e]?.length>0&&this.#e[e].forEach(function(t){try{t?.call(a,o)}catch(r){console.error(r)}}),this[`on${e}`]&&this[`on${e}`](o)}};var y=F(T(),1);var x=class{#e=!1;constructor(e,s,o,a){this.#e=e,this.start=s,this.end=o,this.data=a}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},k=class extends x{constructor(e,s,o){super(!0,e,s,o)}},L=class extends x{constructor(e,s){super(!1,e,e,s)}},w=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,s){return e.start==s.start?0:(+(e.start>s.start)<<1)-1}),this.forEach(function(e,s){e.index=s})}step(e,s=!1){let o=[];if(s)for(let a=0;a<this.length&&!(this[a].start>e);a++){if(this[a].end<e)continue;o.push(this[a])}else{let a=this.getRange(this.#e==-1?0:e-1,e),t=this;a.forEach(function(r){r.index>t.#e&&(o.push(r),t.#e=r.index)})}return o}getRange(e,s){e>s&&([e,s]=[s,e]);let o=[],a=-1,t=Math.ceil(Math.sqrt(this.length)),r=!0;for(let c=0;c<this.length;c+=t)this[c+t]?a<0&&this[c+t].start>=e&&(a=c):a=a<0?c:a;for(;r;)this[a]?.end<s?this[a].start>=e&&o.push(this[a]):r=!1,a++;return o}};var V=0xffffffffffff;{let e=function(s,o){let a=new FileReader;return new Promise((t,r)=>{switch(a.addEventListener("abort",()=>{r(new Error("Blob read aborted"))}),a.addEventListener("error",c=>{r(a.error||c.data||new Error("Blob read error"))}),a.addEventListener("load",()=>{t(a.result)}),o.toLowerCase()){case"arraybuffer":case"buffer":{a.readAsArrayBuffer(s);break}case"string":case"text":{a.readAsText(s);break}default:r(new Error(`Unknown target ${o}`))}})};Blob.prototype.arrayBuffer=function(){return e(this,"arrayBuffer")}}var U=function(e){let s=new w,o=this,a=e.timeDivision,t=120,r=new w,c=0,l=0;r.push(new k(0,V,[120,0])),e.track.forEach(function(n){c=0,n.event.forEach(function(i){c+=i.deltaTime,i.type==255&&i?.metaType==81&&(t=6e7/i.data,r[r.length-1]&&r.push(new k(c,0xffffffffffff,[t,0])))})}),r.fresh(),r.forEach(function(n,i,d){i>0&&(d[i-1].end=n.start)});let v=120;r.forEach(function(n,i,d){i>0&&(n.end==n.start?d.splice(d.indexOf(n),1):v==n.data[0]&&(d[i-1].end=n.end,d.splice(d.indexOf(n),1)),v=n.data[0])});let h=0,u=120;return r.forEach(function(n){let i=n.start,d=i/u/a*60+h;u=n.data[0],h=d-i/u/a*60,n.data[1]=h}),console.debug("All tempo changes: ",r),t=120,c=0,l=0,e.track.forEach(function(n,i){c=0,l=0;let d=i+1;n.event.forEach(function(f,g){c+=f.deltaTime;let p=r.step(c,!0)[0];p&&(t=p.data[0],l=p.data[1]);let m={type:f.type,data:f.data,track:d,part:0};f.type>14?m.meta=f.metaType:m.part=f.channel,s.push(new L(c/t/a*60+l,m))})}),s.fresh(),self.midiEvents=s,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),s};var A=function(e,s,o){let a=[],t=o==!1?s.readIntVLV():o;e==0||e==127;for(let r=0;r<t;r++){let c=s.readInt(1);if(a.push(c),c!=247){if(c!=240){if(c>127)return console.debug(`Early termination: ${a}`),a.pop(),s.backOne(),s.backOne(),new Uint8Array(a)}}}return new Uint8Array(a)};y.default.customInterpreter=A;var J=function(e,s=0){let o=e[0]>>4,a=e[0]&15,t={track:(s&15)+240,type:o,data:e.slice(1)};if(o<15)return t.part=a,t;if(o==12)t.data=e[1];else{if(a==0)return t;console.warn(`Unknown special event channel ${a}.`)}},ee=function(e){let s=e.type,o=e.part;if(s==255)return;let a=3;s==12?a=2:s==15&&(a=e.data.length+1);let t=new Uint8Array(a);return s!=15?t[0]=e.type*16+e.part:t[0]=240,s==12?t[1]=e.data:e.data.forEach?e.data.forEach((r,c)=>{t[c+1]=r}):console.debug(`Type ${s} value ${e.data.constructor.name} cannot be iterated.`),t},te=function(){return new BroadcastChannel("cc.ltgc.octavia:MainInput")},re=function(){return new BroadcastChannel("cc.ltgc.octavia:MainOutput")},ne=class extends b{#e;#a=!0;#r=0;#n=0;#t=-1;get currentTime(){return this.#r/1e3}get duration(){return this.#e?this.#e[this.#e.length-1].end+4:0}async load(e){e?this.#e=U(y.default.parse(new Uint8Array(await e.arrayBuffer()))):(this.pause(),this.#r=0)}pause(){if(this.#t>-1){clearInterval(this.#t);for(let e=0;e<16;e++)this.dispatchEvent("midi",{delay:0,data:{part:e,type:11,data:[123,0]}});this.dispatchEvent("pause"),this.#t=-1}}async play(){this.#t<0&&(this.#n=Date.now(),this.#t=setInterval(()=>{let e=Date.now(),s=this.#r,o=e-this.#n;this.#r+=o,this.#e.step(this.currentTime)?.forEach(t=>{this.dispatchEvent("midi",{delay:Math.round(t.start*1e3-s),data:t.data})}),this.#n=e},12.5),this.dispatchEvent("play"))}constructor(e){super(),e&&this.load(e)}};export{ne as SimpleMidiEventEmitter,ee as fromJson,te as getBridge,re as getBridgeOut,J as toJson};
