var M=Object.create;var y=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var C=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var D=(t,n)=>()=>(n||t((n={exports:{}}).exports,n),n.exports);var S=(t,n,r,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of P(n))!O.call(t,s)&&s!==r&&y(t,s,{get:()=>n[s],enumerable:!(e=A(n,s))||e.enumerable});return t};var F=(t,n,r)=>(r=t!=null?M(C(t)):{},S(n||!t||!t.__esModule?y(r,"default",{value:t,enumerable:!0}):r,t));var b=D((z,m)=>{(function(){"use strict";let t={debug:!1,parse:function(n,r){if(n instanceof Uint8Array)return t.Uint8(n);if(typeof n=="string")return t.Base64(n);if(n instanceof HTMLElement&&n.type==="file")return t.addListener(n,r);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(n,r){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(n===void 0||!(n instanceof HTMLElement)||n.tagName!=="INPUT"||n.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;r=r||function(){},n.addEventListener("change",function(e){if(!e.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let s=new FileReader;s.readAsArrayBuffer(e.target.files[0]),s.onload=function(o){r(t.Uint8(new Uint8Array(o.target.result)))}})},Base64:function(n){let r=function(o){var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(o=o.replace(/^.*?base64,/,""),o=String(o).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(o))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");o+="==".slice(2-(3&o.length));let f,u="",a,i,c=0;for(;c<o.length;)f=d.indexOf(o.charAt(c++))<<18|d.indexOf(o.charAt(c++))<<12|(a=d.indexOf(o.charAt(c++)))<<6|(i=d.indexOf(o.charAt(c++))),u+=a===64?String.fromCharCode(f>>16&255):i===64?String.fromCharCode(f>>16&255,f>>8&255):String.fromCharCode(f>>16&255,f>>8&255,255&f);return u}(n=String(n));var e=r.length;let s=new Uint8Array(new ArrayBuffer(e));for(let o=0;o<e;o++)s[o]=r.charCodeAt(o);return t.Uint8(s)},Uint8:function(s){let r={data:null,pointer:0,movePointer:function(a){return this.pointer+=a,this.pointer},readInt:function(a){if((a=Math.min(a,this.data.byteLength-this.pointer))<1)return-1;let i=0;if(1<a)for(let c=1;c<=a-1;c++)i+=this.data.getUint8(this.pointer)*Math.pow(256,a-c),this.pointer++;return i+=this.data.getUint8(this.pointer),this.pointer++,i},readStr:function(a){let i="";for(let c=1;c<=a;c++)i+=String.fromCharCode(this.readInt(1));return i},backOne:function(){this.pointer--},readIntVLV:function(){let a=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)a=this.readInt(1);else{let c=[];for(;128<=this.data.getUint8(this.pointer);)c.push(this.readInt(1)-128);var i=this.readInt(1);for(let l=1;l<=c.length;l++)a+=c[c.length-l]*Math.pow(128,l);a+=i}return a}};if(r.data=new DataView(s.buffer,s.byteOffset,s.byteLength),r.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;r.readInt(4);let e={};e.formatType=r.readInt(2),e.tracks=r.readInt(2),e.track=[];var s=r.readInt(1),o=r.readInt(1);128<=s?(e.timeDivision=[],e.timeDivision[0]=s-128,e.timeDivision[1]=o):e.timeDivision=256*s+o;for(let a=1;a<=e.tracks;a++){e.track[a-1]={event:[]};var d,f=r.readInt(4);if(f===-1)break;if(f!==1297379947)return!1;r.readInt(4);let i=0,c=!1,l,h;for(;!c&&(i++,e.track[a-1].event[i-1]={},e.track[a-1].event[i-1].deltaTime=r.readIntVLV(),(l=r.readInt(1))!==-1);)if(128<=l?h=l:(l=h,r.movePointer(-1)),l===255){e.track[a-1].event[i-1].type=255,e.track[a-1].event[i-1].metaType=r.readInt(1);var u=r.readIntVLV();switch(e.track[a-1].event[i-1].metaType){case 47:case-1:c=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:e.track[a-1].event[i-1].data=r.readStr(u);break;case 33:case 89:case 81:e.track[a-1].event[i-1].data=r.readInt(u);break;case 84:e.track[a-1].event[i-1].data=[],e.track[a-1].event[i-1].data[0]=r.readInt(1),e.track[a-1].event[i-1].data[1]=r.readInt(1),e.track[a-1].event[i-1].data[2]=r.readInt(1),e.track[a-1].event[i-1].data[3]=r.readInt(1),e.track[a-1].event[i-1].data[4]=r.readInt(1);break;case 88:e.track[a-1].event[i-1].data=[],e.track[a-1].event[i-1].data[0]=r.readInt(1),e.track[a-1].event[i-1].data[1]=r.readInt(1),e.track[a-1].event[i-1].data[2]=r.readInt(1),e.track[a-1].event[i-1].data[3]=r.readInt(1);break;default:this.customInterpreter!==null&&(e.track[a-1].event[i-1].data=this.customInterpreter(e.track[a-1].event[i-1].metaType,r,u)),this.customInterpreter!==null&&e.track[a-1].event[i-1].data!==!1||(r.readInt(u),e.track[a-1].event[i-1].data=r.readInt(u),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((l=l.toString(16).split(""))[1]||l.unshift("0"),e.track[a-1].event[i-1].type=parseInt(l[0],16),e.track[a-1].event[i-1].channel=parseInt(l[1],16),e.track[a-1].event[i-1].type){case 15:this.customInterpreter!==null&&(e.track[a-1].event[i-1].data=this.customInterpreter(e.track[a-1].event[i-1].type,r,!1)),this.customInterpreter!==null&&e.track[a-1].event[i-1].data!==!1||(d=r.readIntVLV(),e.track[a-1].event[i-1].data=r.readInt(d),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:e.track[a-1].event[i-1].data=[],e.track[a-1].event[i-1].data[0]=r.readInt(1),e.track[a-1].event[i-1].data[1]=r.readInt(1);break;case 12:case 13:e.track[a-1].event[i-1].data=r.readInt(1);break;case-1:c=!0;break;default:if(this.customInterpreter!==null&&(e.track[a-1].event[i-1].data=this.customInterpreter(e.track[a-1].event[i-1].metaType,r,!1)),this.customInterpreter===null||e.track[a-1].event[i-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return e},customInterpreter:null};if(typeof m<"u")m.exports=t;else{let n=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;n.MidiParser=t}})()});var E=class{#t={};addEventListener(t,n){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(n)}removeEventListener(t,n){if(this.#t[t]){let r=this.#t[t].indexOf(n);r>-1&&this.#t[t].splice(r,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,n){let r=new Event(t),e=this;r.data=n,this.#t[t]?.length>0&&this.#t[t].forEach(function(s){s?.call(e,r)}),this[`on${t}`]&&this[`on${t}`](r)}};var w=F(b(),1);var T=class{#t=!1;constructor(t,n,r,e){this.#t=t,this.start=n,this.end=r,this.data=e}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},I=class extends T{constructor(t,n,r){super(!0,t,n,r)}},x=class extends T{constructor(t,n){super(!1,t,t,n)}},k=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,n){return t.start==n.start?0:(+(t.start>n.start)<<1)-1}),this.forEach(function(t,n){t.index=n})}step(t,n=!1){let r=[];if(n)for(let e=0;e<this.length&&!(this[e].start>t);e++){if(this[e].end<t)continue;r.push(this[e])}else{let e=this.getRange(this.#t==-1?0:t-1,t),s=this;e.forEach(function(o){o.index>s.#t&&(r.push(o),s.#t=o.index)})}return r}getRange(t,n){t>n&&([t,n]=[n,t]);let r=[],e=-1,s=Math.ceil(Math.sqrt(this.length)),o=!0;for(let d=0;d<this.length;d+=s)this[d+s]?e<0&&this[d+s].start>=t&&(e=d):e=e<0?d:e;for(;o;)this[e]?.end<n?this[e].start>=t&&r.push(this[e]):o=!1,e++;return r}};var V=0xffffffffffff,L=function(t){let n=new k,r=this,e=t.timeDivision,s=120,o=new k,d=0,f=0;o.push(new I(0,V,[120,0])),t.track.forEach(function(c){d=0,c.event.forEach(function(l){d+=l.deltaTime,l.type==255&&l?.metaType==81&&(s=6e7/l.data,o[o.length-1]&&o.push(new I(d,0xffffffffffff,[s,0])))})}),o.fresh(),o.forEach(function(c,l,h){l>0&&(h[l-1].end=c.start)});let u=120;o.forEach(function(c,l,h){l>0&&(c.end==c.start?h.splice(h.indexOf(c),1):u==c.data[0]&&(h[l-1].end=c.end,h.splice(h.indexOf(c),1)),u=c.data[0])});let a=0,i=120;return o.forEach(function(c){let l=c.start,h=l/i/e*60+a;i=c.data[0],a=h-l/i/e*60,c.data[1]=a}),console.debug("All tempo changes: ",o),s=120,d=0,f=0,t.track.forEach(function(c,l){d=0,f=0;let h=l+1;c.event.forEach(function(p,B){d+=p.deltaTime;let v=o.step(d,!0)[0];v&&(s=v.data[0],f=v.data[1]);let g={type:p.type,data:p.data,track:h,part:0};p.type>14?g.meta=p.metaType:g.part=p.channel,n.push(new x(d/s/e*60+f,g))})}),n.fresh(),self.midiEvents=n,console.debug(`Parsed a type ${t.formatType} MIDI sequence.`),n};var U=function(t,n,r){let e=[],s=r==!1?n.readIntVLV():r;t==0||t==127;for(let o=0;o<s;o++){let d=n.readInt(1);if(e.push(d),d!=247){if(d!=240){if(d>127)return console.debug(`Early termination: ${e}`),e.pop(),n.backOne(),n.backOne(),new Uint8Array(e)}}}return new Uint8Array(e)};w.default.customInterpreter=U;var j=function(t,n=0){let r=t[0]>>4,e=t[0]&15,s={track:(n&15)+240,type:r,data:t.slice(1)};if(r<15)return s.part=e,s;if(r==12)s.data=t[1];else{if(e==0)return s;console.warn(`Unknown special event channel ${e}.`)}},tt=function(t){let n=t.type,r=t.part;if(n==255)return;let e=3;n==12?e=2:n==15&&(e=t.data.length+1);let s=new Uint8Array(e);return n!=15?s[0]=t.type*16+t.part:s[0]=240,n==12?s[1]=t.data:t.data.forEach?t.data.forEach((o,d)=>{s[d+1]=o}):console.debug(`Type ${n} value ${t.data.constructor.name} cannot be iterated.`),s},et=function(){return new BroadcastChannel("cc.ltgc.octavia:MainInput")},rt=function(){return new BroadcastChannel("cc.ltgc.octavia:MainOutput")},nt=class extends E{#t;#a=!0;#r=0;#n=0;#e=-1;get currentTime(){return this.#r/1e3}get duration(){return this.#t?this.#t[this.#t.length-1].end+4:0}async load(t){t?this.#t=L(w.default.parse(new Uint8Array(await t.arrayBuffer()))):(this.pause(),this.#r=0)}pause(){if(this.#e>-1){clearInterval(this.#e);for(let t=0;t<16;t++)this.dispatchEvent("midi",{delay:0,data:{part:t,type:11,data:[123,0]}});this.dispatchEvent("pause"),this.#e=-1}}async play(){this.#e<0&&(this.#n=Date.now(),this.#e=setInterval(()=>{let t=Date.now(),n=this.#r,r=t-this.#n;this.#r+=r,this.#t.step(this.currentTime)?.forEach(s=>{this.dispatchEvent("midi",{delay:Math.round(s.start*1e3-n),data:s.data})}),this.#n=t},12.5),this.dispatchEvent("play"))}constructor(t){super(),t&&this.load(t)}};export{nt as SimpleMidiEventEmitter,tt as fromJson,et as getBridge,rt as getBridgeOut,j as toJson};
