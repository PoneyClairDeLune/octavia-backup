"use strict";(()=>{var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty;var __commonJS=(cb,mod)=>function(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target,mod));var require_main_min=__commonJS({"libs/midi-parser@colxi/main.min.js"(exports,module){(function(){"use strict";let n={debug:!1,parse:function(e,t){if(e instanceof Uint8Array)return n.Uint8(e);if(typeof e=="string")return n.Base64(e);if(e instanceof HTMLElement&&e.type==="file")return n.addListener(e,t);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,r){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(e===void 0||!(e instanceof HTMLElement)||e.tagName!=="INPUT"||e.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;r=r||function(){},e.addEventListener("change",function(e2){if(!e2.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let t=new FileReader;t.readAsArrayBuffer(e2.target.files[0]),t.onload=function(e3){r(n.Uint8(new Uint8Array(e3.target.result)))}})},Base64:function(e){let t=function(e2){var t2="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(e2=e2.replace(/^.*?base64,/,""),e2=String(e2).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(e2))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");e2+="==".slice(2-(3&e2.length));let r2,a2="",n2,i,d2=0;for(;d2<e2.length;)r2=t2.indexOf(e2.charAt(d2++))<<18|t2.indexOf(e2.charAt(d2++))<<12|(n2=t2.indexOf(e2.charAt(d2++)))<<6|(i=t2.indexOf(e2.charAt(d2++))),a2+=n2===64?String.fromCharCode(r2>>16&255):i===64?String.fromCharCode(r2>>16&255,r2>>8&255):String.fromCharCode(r2>>16&255,r2>>8&255,255&r2);return a2}(e=String(e));var r=t.length;let a=new Uint8Array(new ArrayBuffer(r));for(let e2=0;e2<r;e2++)a[e2]=t.charCodeAt(e2);return n.Uint8(a)},Uint8:function(e){let i={data:null,pointer:0,movePointer:function(e2){return this.pointer+=e2,this.pointer},readInt:function(t2){if((t2=Math.min(t2,this.data.byteLength-this.pointer))<1)return-1;let r=0;if(1<t2)for(let e2=1;e2<=t2-1;e2++)r+=this.data.getUint8(this.pointer)*Math.pow(256,t2-e2),this.pointer++;return r+=this.data.getUint8(this.pointer),this.pointer++,r},readStr:function(t2){let r="";for(let e2=1;e2<=t2;e2++)r+=String.fromCharCode(this.readInt(1));return r},backOne:function(){this.pointer--},readIntVLV:function(){let r=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)r=this.readInt(1);else{let t2=[];for(;128<=this.data.getUint8(this.pointer);)t2.push(this.readInt(1)-128);var e2=this.readInt(1);for(let e3=1;e3<=t2.length;e3++)r+=t2[t2.length-e3]*Math.pow(128,e3);r+=e2}return r}};if(i.data=new DataView(e.buffer,e.byteOffset,e.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let d2={};d2.formatType=i.readInt(2),d2.tracks=i.readInt(2),d2.track=[];var e=i.readInt(1),t=i.readInt(1);128<=e?(d2.timeDivision=[],d2.timeDivision[0]=e-128,d2.timeDivision[1]=t):d2.timeDivision=256*e+t;for(let n2=1;n2<=d2.tracks;n2++){d2.track[n2-1]={event:[]};var s,o2=i.readInt(4);if(o2===-1)break;if(o2!==1297379947)return!1;i.readInt(4);let e2=0,t2=!1,r,a;for(;!t2&&(e2++,d2.track[n2-1].event[e2-1]={},d2.track[n2-1].event[e2-1].deltaTime=i.readIntVLV(),(r=i.readInt(1))!==-1);)if(128<=r?a=r:(r=a,i.movePointer(-1)),r===255){d2.track[n2-1].event[e2-1].type=255,d2.track[n2-1].event[e2-1].metaType=i.readInt(1);var c=i.readIntVLV();switch(d2.track[n2-1].event[e2-1].metaType){case 47:case-1:t2=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:d2.track[n2-1].event[e2-1].data=i.readStr(c);break;case 33:case 89:case 81:d2.track[n2-1].event[e2-1].data=i.readInt(c);break;case 84:d2.track[n2-1].event[e2-1].data=[],d2.track[n2-1].event[e2-1].data[0]=i.readInt(1),d2.track[n2-1].event[e2-1].data[1]=i.readInt(1),d2.track[n2-1].event[e2-1].data[2]=i.readInt(1),d2.track[n2-1].event[e2-1].data[3]=i.readInt(1),d2.track[n2-1].event[e2-1].data[4]=i.readInt(1);break;case 88:d2.track[n2-1].event[e2-1].data=[],d2.track[n2-1].event[e2-1].data[0]=i.readInt(1),d2.track[n2-1].event[e2-1].data[1]=i.readInt(1),d2.track[n2-1].event[e2-1].data[2]=i.readInt(1),d2.track[n2-1].event[e2-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(d2.track[n2-1].event[e2-1].data=this.customInterpreter(d2.track[n2-1].event[e2-1].metaType,i,c)),this.customInterpreter!==null&&d2.track[n2-1].event[e2-1].data!==!1||(i.readInt(c),d2.track[n2-1].event[e2-1].data=i.readInt(c),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((r=r.toString(16).split(""))[1]||r.unshift("0"),d2.track[n2-1].event[e2-1].type=parseInt(r[0],16),d2.track[n2-1].event[e2-1].channel=parseInt(r[1],16),d2.track[n2-1].event[e2-1].type){case 15:this.customInterpreter!==null&&(d2.track[n2-1].event[e2-1].data=this.customInterpreter(d2.track[n2-1].event[e2-1].type,i,!1)),this.customInterpreter!==null&&d2.track[n2-1].event[e2-1].data!==!1||(s=i.readIntVLV(),d2.track[n2-1].event[e2-1].data=i.readInt(s),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:d2.track[n2-1].event[e2-1].data=[],d2.track[n2-1].event[e2-1].data[0]=i.readInt(1),d2.track[n2-1].event[e2-1].data[1]=i.readInt(1);break;case 12:case 13:d2.track[n2-1].event[e2-1].data=i.readInt(1);break;case-1:t2=!0;break;default:if(this.customInterpreter!==null&&(d2.track[n2-1].event[e2-1].data=this.customInterpreter(d2.track[n2-1].event[e2-1].metaType,i,!1)),this.customInterpreter===null||d2.track[n2-1].event[e2-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return d2},customInterpreter:null};if(typeof module<"u")module.exports=n;else{let e=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;e.MidiParser=n}})()}});DOMTokenList.prototype.on=function(classNme){!this.contains(classNme)&&this.toggle(classNme)};DOMTokenList.prototype.off=function(classNme){this.contains(classNme)&&this.toggle(classNme)};var $e=function(selector,source=document){return source?.querySelector(selector)},$a=function(selector,source=document){return Array.from(source?.querySelectorAll(selector))};var textedPitchBend=function(number){let result=Array.from("----");if(number>0)for(let c=0;number>0;c++)result[c]=number<1024?"=":">",number-=2048;else if(number<0)for(let c=3;number<0;c--)result[c]=number>=-1024?"=":"<",number+=2048;return result.join("")},textedPanning=function(number){let result=Array.from("----");if(number>64)for(let c=0;number>64;c++)result[c]=number<72?"=":">",number-=16;else if(number<64)for(let c=3;number<64;c--)result[c]=number>=56?"=":"<",number+=16;return result.join("")};var CustomEventSource=class{#eventListeners={};addEventListener(type,callback){this.#eventListeners[type]||(this.#eventListeners[type]=[]),this.#eventListeners[type].unshift(callback)}removeEventListener(type,callback){if(this.#eventListeners[type]){let index=this.#eventListeners[type].indexOf(callback);index>-1&&this.#eventListeners[type].splice(index,1),this.#eventListeners[type].length<1&&delete this.#eventListeners[type]}}dispatchEvent(type,data2){let eventObj=new Event(type),upThis=this;eventObj.data=data2,this.#eventListeners[type]?.length>0&&this.#eventListeners[type].forEach(function(e){e?.call(upThis,eventObj)}),this[`on${type}`]&&this[`on${type}`](eventObj)}};var compArr=function(a,b){let minL=Math.min(a.length,b.length),c=a.slice(0,minL),d2=b.slice(0,minL),result=0,pointer=0;for(;pointer<minL&&result==0;)result=Math.sign(c[pointer]-d2[pointer]),pointer++;return result},BinaryMatch=function(){this.pool=[],this.point=function(prefix,insert=!1){if(this.pool.length>0){let bound=this.pool.length,bs=1<<Math.floor(Math.log2(bound)),pp=bs,ttl=64;for(;bs>=1&&ttl>=0;){if(ttl<=0)throw new Error("TTL reached.");if(pp==bound)pp-=bs;else{let result=compArr(prefix,this.pool[pp]);switch(result){case 0:{ttl=0;break}case 1:{pp+bs<=bound&&(pp+=bs);break}case-1:{pp!=0&&(pp-=bs);break}default:console.warn(`Unexpected result ${result}.`)}}bs=bs>>1,ttl--}let match=!0;if(pp>=this.pool.length)match=!1;else{let upThis=this;this.pool[pp].forEach(function(e,i,a){match&&e!=prefix[i]&&(match=!1)}),!match&&compArr(prefix,this.pool[pp])>0&&pp++}return match||insert?pp:-1}else return insert?0:-1},this.add=function(prefix,data2){return prefix.data=data2,this.pool.splice(this.point(prefix,!0),0,prefix),this},this.default=function(info){console.warn(`No match for "${info}". Default action not defined.`)},this.get=function(prefix){let idx=this.point(prefix);if(idx>-1)return this.pool[idx].data;this.default(prefix)},this.run=function(prefix,...additional){let idx=this.point(prefix);idx>-1?this.pool[idx].data(prefix.slice(this.pool[idx].length),...additional):this.default(prefix,...additional)}};var modeIdx=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw"],modeMap={};modeIdx.forEach(function(e,i){modeMap[e]=i});var substList=[[0,0,0,0,0,0,0,56,82,81],[0,0,0,0,0,127,0,0,0,0]],passedMeta=[0,3,32,81,84,88,89],toZero=function(e,i,a){a[i]=0},sysExSplitter=function(seq){let seqArr=[[]];return seq?.forEach(function(e){e==247||(e==240?seqArr.push([]):seqArr[seqArr.length-1].push(e))}),seqArr},showTrue=function(data2,prefix="",suffix="",length=2){return data2?`${prefix}${data2.toString().padStart(length,"0")}${suffix}`:""},OctaviaDevice=class extends CustomEventSource{#mode=0;#bitmap=new Array(256);#bitmapExpire=0;#chActive=new Array(64);#cc=new Uint8ClampedArray(8192);#prg=new Uint8ClampedArray(64);#velo=new Uint8ClampedArray(8192);#poly=new Uint16Array(256);#pitch=new Int16Array(64);#customName=new Array(64);#rawStrength=new Uint8Array(64);#subMsb=0;#subLsb=0;#masterVol=100;#metaChannel=0;#letterDisp="";#letterExpire=0;#metaTexts=[];#metaRun=[];#runChEvent={8:function(det){let rawNote=det.part*128+det.data[0],polyIdx=this.#poly.indexOf(rawNote);polyIdx>-1&&(this.#poly[polyIdx]=0,this.#velo[rawNote]=0)},9:function(det){this.#chActive[det.part]=1;let rawNote=det.part*128+det.data[0];if(det.data[1]>0){let place=0;for(;this.#poly[place]>0;)place++;place<256?(this.#poly[place]=rawNote,this.#velo[rawNote]=det.data[1],this.#rawStrength[det.part]<det.data[1]&&(this.#rawStrength[det.part]=det.data[1])):console.error("Polyphony exceeded.")}else{let polyIdx=this.#poly.indexOf(rawNote);polyIdx>-1&&(this.#poly[polyIdx]=0,this.#velo[rawNote]=0)}},10:function(det){let rawNote=det.part*128+det.data[0];this.#poly.indexOf(rawNote)>-1&&(this.#velo[rawNote]=data[1])},11:function(det){this.#chActive[det.part]=1,det.data[0]==0&&det.part%16==9&&this.#mode==modeMap.gs&&(det.data[1]=120),this.#cc[det.part*128+det.data[0]]=det.data[1]},12:function(det){this.#chActive[det.part]=1,this.#prg[det.part]=det.data,this.#customName[det.part]=0},13:function(det){let upThis=this;this.#poly.forEach(function(e){let realCh=e>>7;det.part==realCh&&(upThis.#velo[e]=det.data)}),console.info(det)},14:function(det){this.#pitch[det.part]=det.data[1]*128+det.data[0]-8192},15:function(det){let upThis=this;sysExSplitter(det.data).forEach(function(seq){upThis.#seMain.run(seq)})},255:function(det){if((this.#metaRun[det.meta]||console.debug).call(this,det.data,det.track),passedMeta.indexOf(det.meta)>-1)return det.reply="meta",det;self.debugMode&&console.debug(det)}};#seMain;#seXgPart;#seMtSysEx;getActive(){let result=this.#chActive.slice();return this.#mode==modeMap.mt32&&(result[0]=0),result}getCc(channel){let start=channel*128,arr=this.#cc.slice(start,start+128);return arr[0]=arr[0]||this.#subMsb,arr[32]=arr[32]||this.#subLsb,arr}getPitch(){return this.#pitch.slice()}getProgram(){return this.#prg.slice()}getTexts(){return this.#metaTexts.slice()}getVel(channel){let notes=new Map,upThis=this;return this.#poly.forEach(function(e){let realCh=Math.floor(e/128),realNote=e%128;channel==realCh&&upThis.#velo[e]>0&&notes.set(realNote,upThis.#velo[e])}),notes}getBitmap(){return{bitmap:this.#bitmap.slice(),expire:this.#bitmapExpire}}getCustomNames(){return this.#customName.slice()}getLetter(){return{text:this.#letterDisp,expire:this.#letterExpire}}getMode(){return modeIdx[this.#mode]}getMaster(){return{volume:this.#masterVol}}getRawStrength(){let upThis=this;return this.#poly.forEach(function(e){let channel=Math.floor(e/128);upThis.#velo[e]>upThis.#rawStrength[channel]&&(upThis.#rawStrength[channel]=upThis.#velo[e])}),this.#rawStrength.slice()}getStrength(){let str=[],upThis=this;return this.getRawStrength().forEach(function(e,i){str[i]=Math.floor(e*upThis.#cc[i*128+7]*upThis.#cc[i*128+11]*upThis.#masterVol/803288)}),str}init(){this.dispatchEvent("mode","?"),this.#mode=0,this.#subMsb=0,this.#subLsb=0,this.#metaChannel=0,this.#chActive.forEach(toZero),this.#cc.forEach(toZero),this.#prg.forEach(toZero),this.#velo.forEach(toZero),this.#poly.forEach(toZero),this.#rawStrength.forEach(toZero),this.#masterVol=100,this.#metaTexts=[],this.#letterExpire=0,this.#letterDisp="",this.#bitmapExpire=0,this.#bitmap.forEach(toZero),this.#customName.forEach(toZero),this.#cc[1152]=127;for(let ch=0;ch<64;ch++)this.#cc[ch*128+7]=127,this.#cc[ch*128+11]=127,this.#cc[ch*128+74]=127,this.#cc[ch*128+10]=127}switchMode(mode,forced=!1){let idx=modeIdx.indexOf(mode);if(idx>-1)(this.#mode==0||forced)&&(this.#mode=idx,this.#subMsb=substList[0][idx],this.#subLsb=substList[1][idx],this.dispatchEvent("mode",mode));else throw new Error(`Unknown mode ${mode}`)}runJson(json){return this.#rawStrength.forEach(toZero),this.#runChEvent[json.type].call(this,json)}runRaw(midiArr){}constructor(){super();let upThis=this;this.#seMain=new BinaryMatch,this.#seXgPart=new BinaryMatch,this.#seMtSysEx=new BinaryMatch,this.#seMain.default=console.debug,this.#metaRun[1]=function(data2){this.#metaTexts.unshift(data2)},this.#metaRun[2]=function(data2){this.#metaTexts.unshift(`Copyrite: ${data2}`)},this.#metaRun[3]=function(data2,track){track<1&&this.#metaChannel<1&&this.#metaTexts.unshift(`TrkTitle: ${data2}`)},this.#metaRun[4]=function(data2,track){track<1&&this.#metaChannel<1&&this.#metaTexts.unshift(`${showTrue(this.#metaChannel,""," ")}Instrmnt: ${data2}`)},this.#metaRun[5]=function(data2){this.#metaTexts.unshift(`C.Lyrics: ${data2}`)},this.#metaRun[6]=function(data2){this.#metaTexts.unshift(`${showTrue(this.#metaChannel,""," ")}C.Marker: ${data2}`)},this.#metaRun[7]=function(data2){this.#metaTexts.unshift(`CuePoint: ${data2}`)},this.#metaRun[32]=function(data2){this.#metaChannel=data2[0]+1},this.#seMain.add([126,127,9,1],function(){upThis.switchMode("gm",!0),console.info("MIDI reset: GM")}).add([126,127,9,3],function(){upThis.switchMode("g2",!0),console.info("MIDI reset: GM2")}).add([65,16,22,18,127,1],function(){upThis.switchMode("mt32",!0),console.info("MIDI reset: MT-32")}).add([65,16,66,18,64,0,127,0,65],function(){upThis.switchMode("gs",!0),console.info("MIDI reset: GS")}).add([66,48,66,52,0],function(msg){upThis.switchMode("ns5r",!0),console.info("KORG reset:",msg)}).add([67,16,76,0,0,126,0],function(msg){upThis.switchMode("xg",!0),console.info("MIDI reset: XG")}),this.#seMain.add([127,127,4,1],function(msg){upThis.switchMode("gm"),upThis.#masterVol=(msg[1]<<7+msg[0])/163.83}),this.#seMain.add([67,16,76,6,0],function(msg){let offset=msg[0];upThis.#letterDisp=" ".repeat(offset),upThis.#letterExpire=Date.now()+3200,msg.slice(1).forEach(function(e){upThis.#letterDisp+=String.fromCharCode(e)})}).add([67,16,76,7,0,0],function(msg){for(upThis.#bitmapExpire=Date.now()+3200;msg.length<48;)msg.unshift(0);msg.forEach(function(e,i){let ln=Math.floor(i/16),co=i%16,pt=(co*3+ln)*7,threshold=7,bi=0;for(pt-=co*5,ln==2&&(threshold=2);bi<threshold;)upThis.#bitmap[pt+bi]=e>>6-bi&1,bi++})}),this.#seMain.add([65,1],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,1)}).add([65,2],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,2)}).add([65,3],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,3)}).add([65,4],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,4)}).add([65,5],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,5)}).add([65,6],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,6)}).add([65,7],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,7)}).add([65,8],function(msg){upThis.switchMode("mt32"),upThis.#seMtSysEx.run(msg,8)}).add([65,9],function(msg){upThis.switchMode("mt32"),upThis.#chActive[9]=1,upThis.#seMtSysEx.run(msg,9)}),this.#seMtSysEx.add([22,18,2,0,0],function(msg,channel){let setName="";msg.slice(0,10).forEach(function(e){e>31&&(setName+=String.fromCharCode(e))}),upThis.#customName[channel]=setName,console.debug(`MT-32 tone properties on channel ${channel+1} (${setName}): ${msg.slice(10)}`)}),this.#seMain.add([65,16,69,18,16,1,0],function(msg){upThis.#bitmapExpire=Date.now()+3200,msg.forEach(function(e,i){if(i<64){let ln=Math.floor(i/16),co=i%16,pt=(co*4+ln)*5,threshold=5,bi=0;for(pt-=co*4,ln==3&&(threshold=1);bi<threshold;)upThis.#bitmap[pt+bi]=e>>4-bi&1,bi++}})})}};var import_main_min=__toESM(require_main_min(),1);var TimedEvent=class{#ranged=!1;constructor(ranged,start,end,data2){this.#ranged=ranged,this.start=start,this.end=end,this.data=data2}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#ranged}},RangeEvent=class extends TimedEvent{constructor(start,end,data2){super(!0,start,end,data2)}},PointEvent=class extends TimedEvent{constructor(start,data2){super(!1,start,start,data2)}},TimedEvents=class extends Array{#index=-1;constructor(){super(...arguments)}resetIndex(pointer){this.#index=-1}fresh(){this.sort(function(a,b){return a.start==b.start?0:(+(a.start>b.start)<<1)-1}),this.forEach(function(e,i){e.index=i})}step(time,allowRepeat=!1){let array=[];if(allowRepeat)for(let index=0;index<this.length&&!(this[index].start>time);index++){if(this[index].end<time)continue;array.push(this[index])}else{let rawArray=this.getRange(time-1,time),upThis=this;rawArray.forEach(function(e){e.index>upThis.#index&&(array.push(e),upThis.#index=e.index)})}return array}getRange(start,end){start>end&&([start,end]=[end,start]);let array=[],index=-1,chunk=Math.ceil(Math.sqrt(this.length)),working=!0;for(let c=0;c<this.length;c+=chunk)this[c+chunk]?index<0&&this[c+chunk].start>=start&&(index=c):index=index<0?c:index;for(;working;)this[index]?.end<end?this[index].start>=start&&array.push(this[index]):working=!1,index++;return array}};var veryBig=0xffffffffffff,rawToPool=function(midiJson){let list=new TimedEvents,upThis=this,timeDiv=midiJson.timeDivision,tempo=120,tempoChanges=new TimedEvents,pointer=0,pointerOffset=0;tempoChanges.push(new RangeEvent(0,veryBig,[120,0])),midiJson.track.forEach(function(e0){pointer=0,e0.event.forEach(function(e1){pointer+=e1.deltaTime,e1.type==255&&e1?.metaType==81&&(tempo=6e7/e1.data,tempoChanges[tempoChanges.length-1]&&tempoChanges.push(new RangeEvent(pointer,0xffffffffffff,[tempo,0])))})}),tempoChanges.fresh(),tempoChanges.forEach(function(e,i,a){i>0&&(a[i-1].end=e.start)});let tTempo=120;tempoChanges.forEach(function(e,i,a){i>0&&(e.end==e.start?a.splice(a.indexOf(e),1):tTempo==e.data[0]&&(a[i-1].end=e.end,a.splice(a.indexOf(e),1)),tTempo=e.data[0])});let cOffset=0,cTempo=120;return tempoChanges.forEach(function(e){let cPointer=e.start,curTime=cPointer/cTempo/timeDiv*60+cOffset;cTempo=e.data[0],cOffset=curTime-cPointer/cTempo/timeDiv*60,e.data[1]=cOffset}),console.debug("All tempo changes: ",tempoChanges),tempo=120,pointer=0,pointerOffset=0,midiJson.track.forEach(function(e0,i0){pointer=0,pointerOffset=0,e0.event.forEach(function(e1,i1){pointer+=e1.deltaTime;let changeData=tempoChanges.step(pointer,!0)[0];changeData&&(tempo=changeData.data[0],pointerOffset=changeData.data[1]);let appendObj={type:e1.type,data:e1.data,track:i0,part:0};e1.type>14?appendObj.meta=e1.metaType:appendObj.part=e1.channel,list.push(new PointEvent(pointer/tempo/timeDiv*60+pointerOffset,appendObj))})}),list.fresh(),list};var sgCrit=["MSB","PRG","LSB"];var VoiceBank=class{#bankInfo=[];get(msb=0,prg=0,lsb=0){let bankName,args=Array.from(arguments);args[0]==127&&args[2]==0&&args[1]>111&&(args[1]=0),args[0]==0&&args[2]>111&&args[2]<120&&(args[2]=0);let ending=" ";for(;!(bankName?.length>0);)bankName=this.#bankInfo[args[1]||0][(args[0]<<7)+args[2]],bankName||(args[2]=0,ending="^",this.#bankInfo[args[1]||0][args[0]<<7]||(args[0]=0,ending="*"));ending!=" "&&self.debugMode&&(bankName="");let standard="??";switch(args[0]){case 0:{args[2]==0?standard="GM":args[2]<120?standard="XG":args[2]==127&&(standard="MT");break}case 56:{standard="AG";break}case 61:case 83:{standard="AI";break}case 62:case 82:{standard="XD";break}case 81:{standard="RW";break}case 64:case 121:case 126:{standard="XG";break}case 127:{standard=lsb==127?"MT":prg==0?"GM":"XG";break}case 120:standard="GS";default:args[0]<40&&(standard="GS")}return{name:bankName||(msb||0).toString().padStart(3,"0")+" "+(prg||0).toString().padStart(3,"0")+" "+(lsb||0).toString().padStart(3,"0"),ending,standard}}load(text){let upThis=this,sig=[];text.split(`
`).forEach(function(e,i){let assign=e.split("	"),to=[];i==0?(assign.forEach(function(e0,i0){sig[sgCrit.indexOf(e0)]=i0}),console.info(`Bank map significance: ${sig}`)):assign.forEach(function(e1,i1){i1>2?(upThis.#bankInfo[to[sig[1]]]=upThis.#bankInfo[to[sig[1]]]||[],upThis.#bankInfo[to[sig[1]]][(to[sig[0]]<<7)+to[sig[2]]]=assign[3]):to.push(parseInt(assign[i1]))})})}async loadFiles(...type){this.#bankInfo=[];let upThis=this;for(let c=0;c<type.length;c++)await fetch(`./data/bank/${type[c]}.tsv`).then(function(response){return console.info(`Parsing voice map: ${type[c]}`),response.text()}).then(function(text){upThis.load.call(upThis,text)})}constructor(...args){this.loadFiles(...args)}};import_main_min.default.customInterpreter=function(type,file,rawMtLen){let u8Data=[],metaLength=rawMtLen==!1?file.readIntVLV():rawMtLen;type==127&&(metaLength=1);for(let c=0;c<metaLength;c++){let byte=file.readInt(1);if(u8Data.push(byte),byte!=247){if(byte!=240){if(byte>127)return console.debug(`Early termination: ${u8Data}`),file.backOne(),file.backOne(),u8Data}}}return u8Data};var RootDisplay=class extends CustomEventSource{#midiState=new OctaviaDevice;#midiPool;#titleName="";voices=new VoiceBank("xg","gs","ns5r");#metaRun=[];#mimicStrength=new Uint8ClampedArray(64);reset(){this.dispatchEvent("reset"),this.#midiPool?.resetIndex(),this.#midiState.init(),this.#titleName=""}async loadFile(blob2){this.#midiPool=rawToPool(import_main_min.default.parse(new Uint8Array(await blob2.arrayBuffer())))}switchMode(modeName,forced=!1){this.#midiState.switchMode(modeName,forced)}getMode(){return this.#midiState.mode}render(time){let events=this.#midiPool.step(time),extraPoly=0,notes=new Set,upThis=this,metaReplies=[];events.forEach(function(e){let raw=e.data;raw.type==9&&(raw.data[1]>0?notes.add(raw.part*128+raw.data[0]):notes.has(raw.part*128+raw.data[0])&&extraPoly++),e.data.type==8&&notes.has(raw.part*128+raw.data[0])&&extraPoly++;let reply=upThis.#midiState.runJson(raw);switch(reply?.reply){case"meta":{metaReplies.push(reply);break}}reply?.reply&&delete reply.reply}),metaReplies?.length>0&&this.dispatchEvent("meta",metaReplies),this.#midiState.getStrength().forEach(function(e,i){let diff=e-upThis.#mimicStrength[i];upThis.#mimicStrength[i]+=Math.ceil(diff-diff/2)});let chInUse=this.#midiState.getActive(),chKeyPr=[],chPitch=upThis.#midiState.getPitch(),chContr=[],chProgr=upThis.#midiState.getProgram(),curPoly=0;return chInUse.forEach(function(e,i){e&&(chKeyPr[i]=upThis.#midiState.getVel(i),chContr[i]=upThis.#midiState.getCc(i),curPoly+=chKeyPr[i].size)}),{extraPoly,curPoly,chInUse,chKeyPr,chPitch,chProgr,chContr,eventCount:events.length,title:this.#titleName,bitmap:this.#midiState.getBitmap(),letter:this.#midiState.getLetter(),names:this.#midiState.getCustomNames(),texts:this.#midiState.getTexts(),master:this.#midiState.getMaster(),mode:this.#midiState.getMode(),strength:upThis.#mimicStrength.slice()}}constructor(){super();let upThis=this;this.addEventListener("meta",function(raw){raw?.data?.forEach(function(e){(upThis.#metaRun[e.meta]||console.debug).call(upThis,e.meta,e.data)})}),this.#midiState.addEventListener("mode",function(ev){upThis.dispatchEvent("mode",ev.data)}),this.#metaRun[3]=function(type,data2){upThis.#titleName?.length<1&&(upThis.#titleName=data2)}}};var noteNames=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],noteRegion="!0123456789";var map="0123456789_aAbBcCdDeEfFgGhHiIjJ-kKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ",waveMap=["-","~","+","|"],modeNames={"?":"UnkwnStd",gm:"GnrlMIDI",g2:"GrlMIDI2",xg:"YamahaXG",gs:"RolandGS",mt32:"RlndMT32",ag10:"KorgAG10",x5d:"Korg X5D","05rw":"Korg05RW",ns5r:"KorgNS5R"};var TuiDisplay=class extends RootDisplay{constructor(){super()}render(time,ctx){let fields=new Array(24),sum=super.render(time),upThis=this,timeNow=Date.now();fields[0]=`${sum.eventCount.toString().padStart(3,"0")} Poly:${(sum.curPoly+sum.extraPoly).toString().padStart(3,"0")}/256 Vol:${Math.floor(sum.master.volume)}.${Math.round(sum.master.volume%1*100).toString().padStart(2,"0")}%`,fields[1]=`Mode:${modeNames[sum.mode]} Title:${sum.title||"N/A"}`,fields[2]="Ch:VoiceNme#St VEM RCDB PP PiBd Pan : Note";let line=3;if(sum.chInUse.forEach(function(e,i){if(e){let voiceName=upThis.voices.get(sum.chContr[i][0],sum.chProgr[i],sum.chContr[i][32]);sum.names[i]&&(voiceName.name=sum.names[i],voiceName.ending="~"),fields[line]=`${(i+1).toString().padStart(2,"0")}:${voiceName.name.slice(0,8).padEnd(8," ")}${voiceName.ending}${voiceName.standard} ${map[sum.chContr[i][7]>>1]}${map[sum.chContr[i][11]>>1]}${waveMap[sum.chContr[i][1]>>5]} ${map[sum.chContr[i][91]>>1]}${map[sum.chContr[i][93]>>1]}${map[sum.chContr[i][94]>>1]}${map[sum.chContr[i][74]>>1]} ${sum.chContr[i][65]>63?"O":"X"}${map[sum.chContr[i][5]>>1]} ${textedPitchBend(sum.chPitch[i])} ${textedPanning(sum.chContr[i][10])}:`,sum.chKeyPr[i].forEach(function(e1,i1){e1>0&&(fields[line]+=` <span style="opacity:${Math.round(e1/1.27)/100}">${noteNames[i1%12]}${noteRegion[Math.floor(i1/12)]}</span>`)}),line++}}),sum.texts.length>0){let metaLine=0;for(let st=fields.length-1;st>=line;st--)fields[st]=(sum.texts[metaLine]||"").padEnd(100," "),metaLine++}if(timeNow<=sum.letter.expire){let letterDisp=sum.letter.text.padEnd(32," "),startLn=fields.length-2;for(let st=0;st<2;st++)fields[st+startLn]=`${(fields[st+startLn]||"").slice(0,82).padEnd(81)} <span class="letter"> ${letterDisp.slice(st*16,st*16+16).padEnd(" ",16)} </span>`}if(ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx){ctx.fillStyle="#202020";let renderer;timeNow<=sum.bitmap.expire?renderer=sum.bitmap.bitmap:(renderer=new Array(256),sum.strength.forEach(function(e,i){if(i<16&&sum.chContr[i]?.length>0){let strength=e>>4;for(let dot=0;dot<=strength;dot++)renderer[i+(15-dot)*16]=1}})),renderer.forEach(function(e,i){e&&ctx.fillRect((i&15)*12,(i>>4)*6,11,5)})}return fields.join("<br/>")}};var T=Object.defineProperty,f=(e,t)=>()=>(e&&(t=e(e=0)),t),d=(e,t)=>{for(var i in t)T(e,i,{get:t[i],enumerable:!0})},y={};d(y,{default:()=>E});var E,p=f(()=>{E=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,i)=>{let r=document.createElement("input");r.type="file";let l=[...e.map(s=>s.mimeTypes||[]).join(),e.map(s=>s.extensions||[]).join()].join();r.multiple=e[0].multiple||!1,r.accept=l||"";let n=()=>c(i),a=s=>{typeof c=="function"&&c(),t(s)},c=e[0].legacySetup&&e[0].legacySetup(a,n,r);r.addEventListener("change",()=>{a(r.multiple?Array.from(r.files):r.files[0])}),r.click()}))}),w={};d(w,{default:()=>I});var N,I,h=f(()=>{N=async e=>{let t=await e.getFile();return t.handle=e,t},I=async(e=[{}])=>{Array.isArray(e)||(e=[e]);let t=[];e.forEach((l,n)=>{t[n]={description:l.description||"",accept:{}},l.mimeTypes?l.mimeTypes.map(a=>{t[n].accept[a]=l.extensions||[]}):t[n].accept["*/*"]=l.extensions||[]});let i=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(i.map(N));return e[0].multiple?r:r[0]}}),o={};d(o,{default:()=>M});var M,A=f(()=>{M=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,i)=>{let r=document.createElement("input");r.type="file",r.webkitdirectory=!0;let l=()=>a(i),n=c=>{typeof a=="function"&&a(),t(c)},a=e[0].legacySetup&&e[0].legacySetup(n,l,r);r.addEventListener("change",()=>{let c=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(c=c.filter(s=>s.webkitRelativePath.split("/").every(S=>!e[0].skipDirectory({name:S,kind:"directory"})))):c=c.filter(s=>s.webkitRelativePath.split("/").length===2),n(c)}),r.click()}))}),x={};d(x,{default:()=>B});var v,B,g=f(()=>{v=async(e,t,i=e.name,r)=>{let l=[],n=[];for await(let a of e.values()){let c=`${i}/${a.name}`;a.kind==="file"?n.push(a.getFile().then(s=>(s.directoryHandle=e,s.handle=a,Object.defineProperty(s,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):a.kind==="directory"&&t&&(!r||!r(a))&&l.push(v(a,t,c,r))}return[...(await Promise.all(l)).flat(),...await Promise.all(n)]},B=async(e={})=>{e.recursive=e.recursive||!1;let t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn});return v(t,e.recursive,void 0,e.skipDirectory)}}),k={};d(k,{default:()=>W});async function $(e,t){let i=e.getReader(),r=new ReadableStream({start(n){return a();async function a(){return i.read().then(({done:c,value:s})=>{if(c){n.close();return}return n.enqueue(s),a()})}}}),l=new Response(r);return i.releaseLock(),new Blob([await l.blob()],{type:t})}var W,P=f(()=>{W=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);let i=document.createElement("a"),r=e;"body"in e&&(r=await $(e.body,e.headers.get("content-type"))),i.download=t.fileName||"Untitled",i.href=URL.createObjectURL(r);let l=()=>a(reject),n=()=>{typeof a=="function"&&a()},a=t.legacySetup&&t.legacySetup(n,l,i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),30*1e3),n(null)}),i.click(),null}}),j={};d(j,{default:()=>q});var q,L=f(()=>{q=async(e,t=[{}],i=null,r=!1)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";let l=[];if(t.forEach((c,s)=>{l[s]={description:c.description||"",accept:{}},c.mimeTypes?(s===0&&(e.type?c.mimeTypes.push(e.type):e.headers&&e.headers.get("content-type")&&c.mimeTypes.push(e.headers.get("content-type"))),c.mimeTypes.map(m=>{l[s].accept[m]=c.extensions||[]})):e.type&&(l[s].accept[e.type]=c.extensions||[])}),i)try{await i.getFile()}catch(c){if(i=null,r)throw c}let n=i||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:l,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),a=await n.createWritable();return"stream"in e?(await e.stream().pipeTo(a),n):"body"in e?(await e.body.pipeTo(a),n):(await a.write(blob),await a.close(),n)}}),F=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),u=F,U=u?Promise.resolve().then(()=>(h(),w)):Promise.resolve().then(()=>(p(),y));async function _(...e){return(await U).default(...e)}var D=u?Promise.resolve().then(()=>(g(),x)):Promise.resolve().then(()=>(A(),o));var z=u?Promise.resolve().then(()=>(L(),j)):Promise.resolve().then(()=>(P(),k));var demoBlobs={},demoModes=[];demoModes[2]="x5d";demoModes[9]="gm";var stSwitch=$a("b.mode"),stSwitchMode=[];stSwitch.to=function(i){stSwitch.forEach(function(e){e.classList.off("active")}),i>-1&&stSwitch[i].classList.on("active")};stSwitch.forEach(function(e,i,a){stSwitchMode[i]=e.title,e.addEventListener("click",function(){tuiVis.switchMode(e.title,!0),stSwitch.to(i)})});var stDemo=$a("b.demo");stDemo.to=function(i){stDemo.forEach(function(e){e.classList.off("active")}),i>-1&&stDemo[i].classList.on("active")};stDemo.forEach(function(e,i,a){e.addEventListener("click",async function(){audioPlayer.pause(),demoBlobs[e.title]?.midi||(demoBlobs[e.title]={},textDisplay.innerHTML=`Loading demo ${e.innerText.toUpperCase()}.${"<br/>".repeat(23)}`,demoBlobs[e.title].midi=await(await fetch(`./demo/${e.title}.mid`)).blob(),demoBlobs[e.title].wave=await(await fetch(`./demo/${e.title}.opus`)).blob()),textDisplay.innerHTML=`Demo ${e.innerText.toUpperCase()} ready.${"<br/>".repeat(23)}`,audioPlayer.currentTime=0,tuiVis.reset(),tuiVis.loadFile(demoBlobs[e.title].midi),audioBlob&&URL.revokeObjectURL(audioBlob),audioBlob=demoBlobs[e.title].wave,audioPlayer.src=URL.createObjectURL(audioBlob),demoModes[i]?.length>0&&tuiVis.switchMode(demoModes[i]),stDemo.to(i)})});self.tuiVis=new TuiDisplay;tuiVis.addEventListener("reset",function(e){});tuiVis.addEventListener("mode",function(ev){stSwitch.to(stSwitchMode.indexOf(ev.data))});var audioBlob,propsMid=JSON.parse('{"extensions":[".mid",".MID"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}'),propsAud=JSON.parse('{"mimeTypes":["audio/*"],"startIn":"music","id":"audioOpener","description":"Open an audio file"}');$e("#openMidi").addEventListener("click",async function(){stDemo.to(-1),tuiVis.reset(),tuiVis.loadFile(await _(propsMid))});$e("#openAudio").addEventListener("click",async function(){audioBlob&&URL.revokeObjectURL(audioBlob),audioBlob=await _(propsAud),audioPlayer.src=URL.createObjectURL(audioBlob)});var dispCanvas=$e("#bmDisp"),dispCtx=dispCanvas.getContext("2d"),audioPlayer=$e("#audioPlayer"),textDisplay=$e("#display");dispCanvas.style.left=`${textDisplay.offsetLeft+textDisplay.offsetWidth-dispCanvas.offsetWidth}px`;dispCanvas.style.top=`${textDisplay.offsetTop}px`;audioPlayer.onended=function(){tuiVis.reset()};(async function(){tuiVis.reset();let midiBlob=await(await fetch("./demo/KANDI8.mid")).blob();demoBlobs.KANDI8={},demoBlobs.KANDI8.midi=midiBlob,tuiVis.loadFile(midiBlob),audioBlob&&URL.revokeObjectURL(audioBlob),audioBlob=await(await fetch("./demo/KANDI8.opus")).blob(),demoBlobs.KANDI8.wave=audioBlob,audioPlayer.src=URL.createObjectURL(audioBlob),textDisplay.innerHTML=`${"<br/>".repeat(23)}`})();var renderThread=setInterval(function(){audioPlayer.paused||(textDisplay.innerHTML=tuiVis.render(audioPlayer.currentTime-(self.audioDelay||0),dispCtx))},20);addEventListener("resize",function(){dispCanvas.style.left=`${textDisplay.offsetLeft+textDisplay.offsetWidth-dispCanvas.offsetWidth}px`,dispCanvas.style.top=`${textDisplay.offsetTop}px`});})();
//# sourceMappingURL=demoTui.js.map
