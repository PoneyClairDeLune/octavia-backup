"use strict";(()=>{var gt=Object.create;var j=Object.defineProperty;var vt=Object.getOwnPropertyDescriptor;var wt=Object.getOwnPropertyNames;var yt=Object.getPrototypeOf,kt=Object.prototype.hasOwnProperty;var Et=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var bt=(t,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of wt(e))!kt.call(t,r)&&r!==i&&j(t,r,{get:()=>e[r],enumerable:!(n=vt(e,r))||n.enumerable});return t};var It=(t,e,i)=>(i=t!=null?gt(yt(t)):{},bt(e||!t||!t.__esModule?j(i,"default",{value:t,enumerable:!0}):i,t));var Z=Et((ee,U)=>{(function(){"use strict";let t={debug:!1,parse:function(e,i){if(e instanceof Uint8Array)return t.Uint8(e);if(typeof e=="string")return t.Base64(e);if(e instanceof HTMLElement&&e.type==="file")return t.addListener(e,i);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,i){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(e===void 0||!(e instanceof HTMLElement)||e.tagName!=="INPUT"||e.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;i=i||function(){},e.addEventListener("change",function(n){if(!n.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let r=new FileReader;r.readAsArrayBuffer(n.target.files[0]),r.onload=function(s){i(t.Uint8(new Uint8Array(s.target.result)))}})},Base64:function(e){let i=function(s){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(s=s.replace(/^.*?base64,/,""),s=String(s).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(s))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");s+="==".slice(2-(3&s.length));let c,h="",o,l,f=0;for(;f<s.length;)c=a.indexOf(s.charAt(f++))<<18|a.indexOf(s.charAt(f++))<<12|(o=a.indexOf(s.charAt(f++)))<<6|(l=a.indexOf(s.charAt(f++))),h+=o===64?String.fromCharCode(c>>16&255):l===64?String.fromCharCode(c>>16&255,c>>8&255):String.fromCharCode(c>>16&255,c>>8&255,255&c);return h}(e=String(e));var n=i.length;let r=new Uint8Array(new ArrayBuffer(n));for(let s=0;s<n;s++)r[s]=i.charCodeAt(s);return t.Uint8(r)},Uint8:function(r){let i={data:null,pointer:0,movePointer:function(o){return this.pointer+=o,this.pointer},readInt:function(o){if((o=Math.min(o,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<o)for(let f=1;f<=o-1;f++)l+=this.data.getUint8(this.pointer)*Math.pow(256,o-f),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(o){let l="";for(let f=1;f<=o;f++)l+=String.fromCharCode(this.readInt(1));return l},backOne:function(){this.pointer--},readIntVLV:function(){let o=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)o=this.readInt(1);else{let f=[];for(;128<=this.data.getUint8(this.pointer);)f.push(this.readInt(1)-128);var l=this.readInt(1);for(let d=1;d<=f.length;d++)o+=f[f.length-d]*Math.pow(128,d);o+=l}return o}};if(i.data=new DataView(r.buffer,r.byteOffset,r.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let n={};n.formatType=i.readInt(2),n.tracks=i.readInt(2),n.track=[];var r=i.readInt(1),s=i.readInt(1);128<=r?(n.timeDivision=[],n.timeDivision[0]=r-128,n.timeDivision[1]=s):n.timeDivision=256*r+s;for(let o=1;o<=n.tracks;o++){n.track[o-1]={event:[]};var a,c=i.readInt(4);if(c===-1)break;if(c!==1297379947)return!1;i.readInt(4);let l=0,f=!1,d,u;for(;!f&&(l++,n.track[o-1].event[l-1]={},n.track[o-1].event[l-1].deltaTime=i.readIntVLV(),(d=i.readInt(1))!==-1);)if(128<=d?u=d:(d=u,i.movePointer(-1)),d===255){n.track[o-1].event[l-1].type=255,n.track[o-1].event[l-1].metaType=i.readInt(1);var h=i.readIntVLV();switch(n.track[o-1].event[l-1].metaType){case 47:case-1:f=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:n.track[o-1].event[l-1].data=i.readStr(h);break;case 33:case 89:case 81:n.track[o-1].event[l-1].data=i.readInt(h);break;case 84:n.track[o-1].event[l-1].data=[],n.track[o-1].event[l-1].data[0]=i.readInt(1),n.track[o-1].event[l-1].data[1]=i.readInt(1),n.track[o-1].event[l-1].data[2]=i.readInt(1),n.track[o-1].event[l-1].data[3]=i.readInt(1),n.track[o-1].event[l-1].data[4]=i.readInt(1);break;case 88:n.track[o-1].event[l-1].data=[],n.track[o-1].event[l-1].data[0]=i.readInt(1),n.track[o-1].event[l-1].data[1]=i.readInt(1),n.track[o-1].event[l-1].data[2]=i.readInt(1),n.track[o-1].event[l-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(n.track[o-1].event[l-1].data=this.customInterpreter(n.track[o-1].event[l-1].metaType,i,h)),this.customInterpreter!==null&&n.track[o-1].event[l-1].data!==!1||(i.readInt(h),n.track[o-1].event[l-1].data=i.readInt(h),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((d=d.toString(16).split(""))[1]||d.unshift("0"),n.track[o-1].event[l-1].type=parseInt(d[0],16),n.track[o-1].event[l-1].channel=parseInt(d[1],16),n.track[o-1].event[l-1].type){case 15:this.customInterpreter!==null&&(n.track[o-1].event[l-1].data=this.customInterpreter(n.track[o-1].event[l-1].type,i,!1)),this.customInterpreter!==null&&n.track[o-1].event[l-1].data!==!1||(a=i.readIntVLV(),n.track[o-1].event[l-1].data=i.readInt(a),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:n.track[o-1].event[l-1].data=[],n.track[o-1].event[l-1].data[0]=i.readInt(1),n.track[o-1].event[l-1].data[1]=i.readInt(1);break;case 12:case 13:n.track[o-1].event[l-1].data=i.readInt(1);break;case-1:f=!0;break;default:if(this.customInterpreter!==null&&(n.track[o-1].event[l-1].data=this.customInterpreter(n.track[o-1].event[l-1].metaType,i,!1)),this.customInterpreter===null||n.track[o-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return n},customInterpreter:null};if(typeof U<"u")U.exports=t;else{let e=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;e.MidiParser=t}})()});DOMTokenList.prototype.on=function(t){!this.contains(t)&&this.toggle(t)};DOMTokenList.prototype.off=function(t){this.contains(t)&&this.toggle(t)};var b=function(t,e=document){return e?.querySelector(t)},C=function(t,e=document){return Array.from(e?.querySelectorAll(t))};var K=function(t){let e=Array.from("----");if(t>0)for(let i=0;t>0;i++)e[i]=t<1024?"=":">",t-=2048;else if(t<0)for(let i=3;t<0;i--)e[i]=t>=-1024?"=":"<",t+=2048;return e.join("")},X=function(t){let e=Array.from("----");if(t>64)for(let i=0;t>64;i++)e[i]=t<72?"=":">",t-=16;else if(t<64)for(let i=3;t<64;i--)e[i]=t>=56?"=":"<",t+=16;return e.join("")};var A=class{#t={};addEventListener(t,e){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(e)}removeEventListener(t,e){if(this.#t[t]){let i=this.#t[t].indexOf(e);i>-1&&this.#t[t].splice(i,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,e){let i=new Event(t),n=this;i.data=e,this.#t[t]?.length>0&&this.#t[t].forEach(function(r){r?.call(n,i)}),this[`on${t}`]&&this[`on${t}`](i)}};var W=function(t,e){let i=Math.min(t.length,e.length),n=t.slice(0,i),r=e.slice(0,i),s=0,a=0;for(;a<i&&s==0;)s=Math.sign(n[a]-r[a]),a++;return s},P=function(){this.pool=[],this.point=function(t,e=!1){if(this.pool.length>0){let i=this.pool.length,n=1<<Math.floor(Math.log2(i)),r=n,s=64;for(;n>=1&&s>=0;){if(s<=0)throw new Error("TTL reached.");if(r==i)r-=n;else{let c=W(t,this.pool[r]);switch(c){case 0:{s=0;break}case 1:{r+n<=i&&(r+=n);break}case-1:{r!=0&&(r-=n);break}default:console.warn(`Unexpected result ${c}.`)}}n=n>>1,s--}let a=!0;if(r>=this.pool.length)a=!1;else{let c=this;this.pool[r].forEach(function(h,o,l){a&&h!=t[o]&&(a=!1)}),!a&&W(t,this.pool[r])>0&&r++}return a||e?r:-1}else return e?0:-1},this.add=function(t,e){return t.data=e,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let e=this.point(t);if(e>-1)return this.pool[e].data;this.default(t)},this.run=function(t,...e){let i=this.point(t);i>-1?this.pool[i].data(t.slice(this.pool[i].length),...e):this.default(t,...e)}};var O=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw"],D={};O.forEach(function(t,e){D[t]=e});var H=[[0,0,0,0,0,0,0,56,82,81],[0,0,0,0,0,127,0,0,0,0]],Mt=[0,3,32,81,84,88,89],g=function(t,e,i){i[e]=0},xt=function(t){let e=[[]];return t?.forEach(function(i){i==247||(i==240?e.push([]):e[e.length-1].push(i))}),e},q=function(t,e="",i="",n=2){return t?`${e}${t.toString().padStart(n,"0")}${i}`:""},z=class extends A{#t=0;#d=new Array(256);#l=0;#a=new Array(64);#i=new Uint8ClampedArray(8192);#c=new Uint8ClampedArray(64);#n=new Uint8ClampedArray(8192);#e=new Uint16Array(256);#u=new Int16Array(64);#o=new Array(64);#r=new Uint8Array(64);#w=0;#y=0;#g=100;#m=0;#v="";#k=0;#h=[];#f=[];#E={8:function(t){let e=t.part*128+t.data[0],i=this.#e.indexOf(e);i>-1&&(this.#e[i]=0,this.#n[e]=0)},9:function(t){this.#a[t.part]=1;let e=t.part*128+t.data[0];if(t.data[1]>0){let i=0;for(;this.#e[i]>0;)i++;i<256?(this.#e[i]=e,this.#n[e]=t.data[1],this.#r[t.part]<t.data[1]&&(this.#r[t.part]=t.data[1])):console.error("Polyphony exceeded.")}else{let i=this.#e.indexOf(e);i>-1&&(this.#e[i]=0,this.#n[e]=0)}},10:function(t){let e=t.part*128+t.data[0];this.#e.indexOf(e)>-1&&(this.#n[e]=data[1])},11:function(t){this.#a[t.part]=1,t.data[0]==0&&t.part%16==9&&this.#t==D.gs&&(t.data[1]=120),this.#i[t.part*128+t.data[0]]=t.data[1]},12:function(t){this.#a[t.part]=1,this.#c[t.part]=t.data,this.#o[t.part]=0},13:function(t){let e=this;this.#e.forEach(function(i){let n=i>>7;t.part==n&&(e.#n[i]=t.data)}),console.info(t)},14:function(t){this.#u[t.part]=t.data[1]*128+t.data[0]-8192},15:function(t){let e=this;xt(t.data).forEach(function(i){e.#p.run(i)})},255:function(t){if((this.#f[t.meta]||function(){}).call(this,t.data,t.track),Mt.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#p;#b;#s;getActive(){let t=this.#a.slice();return this.#t==D.mt32&&(t[0]=0),t}getCc(t){let e=t*128,i=this.#i.slice(e,e+128);return i[0]=i[0]||this.#w,i[32]=i[32]||this.#y,i}getPitch(){return this.#u.slice()}getProgram(){return this.#c.slice()}getTexts(){return this.#h.slice()}getVel(t){let e=new Map,i=this;return this.#e.forEach(function(n){let r=Math.floor(n/128),s=n%128;t==r&&i.#n[n]>0&&e.set(s,i.#n[n])}),e}getBitmap(){return{bitmap:this.#d.slice(),expire:this.#l}}getCustomNames(){return this.#o.slice()}getLetter(){return{text:this.#v,expire:this.#k}}getMode(){return O[this.#t]}getMaster(){return{volume:this.#g}}getRawStrength(){let t=this;return this.#e.forEach(function(e){let i=Math.floor(e/128);t.#n[e]>t.#r[i]&&(t.#r[i]=t.#n[e])}),this.#r.slice()}getStrength(){let t=[],e=this;return this.getRawStrength().forEach(function(i,n){t[n]=Math.floor(i*e.#i[n*128+7]*e.#i[n*128+11]*e.#g/803288)}),t}init(){this.dispatchEvent("mode","?"),this.#t=0,this.#w=0,this.#y=0,this.#m=0,this.#a.forEach(g),this.#i.forEach(g),this.#c.forEach(g),this.#n.forEach(g),this.#e.forEach(g),this.#r.forEach(g),this.#g=100,this.#h=[],this.#k=0,this.#v="",this.#l=0,this.#d.forEach(g),this.#o.forEach(g),this.#i[1152]=127;for(let t=0;t<64;t++)this.#i[t*128+7]=127,this.#i[t*128+11]=127,this.#i[t*128+74]=127,this.#i[t*128+10]=127}switchMode(t,e=!1){let i=O.indexOf(t);if(i>-1)(this.#t==0||e)&&(this.#t=i,this.#w=H[0][i],this.#y=H[1][i],this.dispatchEvent("mode",t));else throw new Error(`Unknown mode ${t}`)}runJson(t){return this.#r.forEach(g),this.#E[t.type].call(this,t)}runRaw(t){}constructor(){super();let t=this;this.#p=new P,this.#b=new P,this.#s=new P,this.#p.default=console.debug,this.#f[1]=function(e){this.#h.unshift(e)},this.#f[2]=function(e){this.#h.unshift(`Copyrite: ${e}`)},this.#f[3]=function(e,i){i<1&&this.#m<1&&this.#h.unshift(`TrkTitle: ${e}`)},this.#f[4]=function(e,i){i<1&&this.#m<1&&this.#h.unshift(`${q(this.#m,""," ")}Instrmnt: ${e}`)},this.#f[5]=function(e){this.#h.unshift(`C.Lyrics: ${e}`)},this.#f[6]=function(e){this.#h.unshift(`${q(this.#m,""," ")}C.Marker: ${e}`)},this.#f[7]=function(e){this.#h.unshift(`CuePoint: ${e}`)},this.#f[32]=function(e){this.#m=e[0]+1},this.#p.add([126,127,9,1],function(){t.switchMode("gm",!0),console.info("MIDI reset: GM")}).add([126,127,9,3],function(){t.switchMode("g2",!0),console.info("MIDI reset: GM2")}).add([65,16,22,18,127,1],function(){t.switchMode("mt32",!0),console.info("MIDI reset: MT-32")}).add([65,16,66,18,64,0,127,0,65],function(){t.switchMode("gs",!0),console.info("MIDI reset: GS")}).add([66,48,66,52,0],function(e){t.switchMode("ns5r",!0),console.info("KORG reset:",e)}).add([67,16,76,0,0,126,0],function(e){t.switchMode("xg",!0),console.info("MIDI reset: XG")}),this.#p.add([127,127,4,1],function(e){t.switchMode("gm"),t.#g=(e[1]<<7+e[0])/163.83}),this.#p.add([67,16,76,6,0],function(e){let i=e[0];t.#v=" ".repeat(i),t.#k=Date.now()+3200,e.slice(1).forEach(function(n){t.#v+=String.fromCharCode(n)})}).add([67,16,76,7,0,0],function(e){for(t.#l=Date.now()+3200;e.length<48;)e.unshift(0);e.forEach(function(i,n){let r=Math.floor(n/16),s=n%16,a=(s*3+r)*7,c=7,h=0;for(a-=s*5,r==2&&(c=2);h<c;)t.#d[a+h]=i>>6-h&1,h++})}),this.#p.add([65,1],function(e){t.switchMode("mt32"),t.#s.run(e,1)}).add([65,2],function(e){t.switchMode("mt32"),t.#s.run(e,2)}).add([65,3],function(e){t.switchMode("mt32"),t.#s.run(e,3)}).add([65,4],function(e){t.switchMode("mt32"),t.#s.run(e,4)}).add([65,5],function(e){t.switchMode("mt32"),t.#s.run(e,5)}).add([65,6],function(e){t.switchMode("mt32"),t.#s.run(e,6)}).add([65,7],function(e){t.switchMode("mt32"),t.#s.run(e,7)}).add([65,8],function(e){t.switchMode("mt32"),t.#s.run(e,8)}).add([65,9],function(e){t.switchMode("mt32"),t.#a[9]=1,t.#s.run(e,9)}),this.#s.add([22,18,2,0,0],function(e,i){let n="";e.slice(0,10).forEach(function(r){r>31&&(n+=String.fromCharCode(r))}),t.#o[i]=n,console.debug(`MT-32 tone properties on channel ${i+1} (${n}): ${e.slice(10)}`)}),this.#p.add([65,16,69,18,16,1,0],function(e){t.#l=Date.now()+3200,e.forEach(function(i,n){if(n<64){let r=Math.floor(n/16),s=n%16,a=(s*4+r)*5,c=5,h=0;for(a-=s*4,r==3&&(c=1);h<c;)t.#d[a+h]=i>>4-h&1,h++}})})}};var N=It(Z(),1);var J=class{#t=!1;constructor(t,e,i,n){this.#t=t,this.start=e,this.end=i,this.data=n}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},R=class extends J{constructor(t,e,i){super(!0,t,e,i)}},Y=class extends J{constructor(t,e){super(!1,t,t,e)}},B=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,e){return t.start==e.start?0:(+(t.start>e.start)<<1)-1}),this.forEach(function(t,e){t.index=e})}step(t,e=!1){let i=[];if(e)for(let n=0;n<this.length&&!(this[n].start>t);n++){if(this[n].end<t)continue;i.push(this[n])}else{let n=this.getRange(t-1,t),r=this;n.forEach(function(s){s.index>r.#t&&(i.push(s),r.#t=s.index)})}return i}getRange(t,e){t>e&&([t,e]=[e,t]);let i=[],n=-1,r=Math.ceil(Math.sqrt(this.length)),s=!0;for(let a=0;a<this.length;a+=r)this[a+r]?n<0&&this[a+r].start>=t&&(n=a):n=n<0?a:n;for(;s;)this[n]?.end<e?this[n].start>=t&&i.push(this[n]):s=!1,n++;return i}};var Tt=0xffffffffffff,_=function(t){let e=new B,i=this,n=t.timeDivision,r=120,s=new B,a=0,c=0;s.push(new R(0,Tt,[120,0])),t.track.forEach(function(f){a=0,f.event.forEach(function(d){a+=d.deltaTime,d.type==255&&d?.metaType==81&&(r=6e7/d.data,s[s.length-1]&&s.push(new R(a,0xffffffffffff,[r,0])))})}),s.fresh(),s.forEach(function(f,d,u){d>0&&(u[d-1].end=f.start)});let h=120;s.forEach(function(f,d,u){d>0&&(f.end==f.start?u.splice(u.indexOf(f),1):h==f.data[0]&&(u[d-1].end=f.end,u.splice(u.indexOf(f),1)),h=f.data[0])});let o=0,l=120;return s.forEach(function(f){let d=f.start,u=d/l/n*60+o;l=f.data[0],o=u-d/l/n*60,f.data[1]=o}),console.debug("All tempo changes: ",s),r=120,a=0,c=0,t.track.forEach(function(f,d){a=0,c=0,f.event.forEach(function(u,w){a+=u.deltaTime;let $=s.step(a,!0)[0];$&&(r=$.data[0],c=$.data[1]);let L={type:u.type,data:u.data,track:d,part:0};u.type>14?L.meta=u.metaType:L.part=u.channel,e.push(new Y(a/r/n*60+c,L))})}),e.fresh(),e};var At=["MSB","PRG","LSB"];var Q=class{#t=[];get(t=0,e=0,i=0){let n,r=Array.from(arguments);r[0]==127&&r[2]==0&&r[1]>111&&(r[1]=0),r[0]==0&&r[2]>111&&r[2]<120&&(r[2]=0);let s=" ";for(;!(n?.length>0);)n=this.#t[r[1]||0][(r[0]<<7)+r[2]],n||(r[2]=0,s="^",this.#t[r[1]||0][r[0]<<7]||(r[0]=0,s="*"));s!=" "&&self.debugMode&&(n="");let a="??";switch(r[0]){case 0:{r[2]==0?a="GM":r[2]<120?a="XG":r[2]==127&&(a="MT");break}case 56:{a="AG";break}case 61:case 83:{a="AI";break}case 62:case 82:{a="XD";break}case 81:{a="RW";break}case 64:case 121:case 126:{a="XG";break}case 127:{a=i==127?"MT":e==0?"GM":"XG";break}case 120:a="GS";default:r[0]<40&&(a="GS")}return{name:n||(t||0).toString().padStart(3,"0")+" "+(e||0).toString().padStart(3,"0")+" "+(i||0).toString().padStart(3,"0"),ending:s,standard:a}}load(t){let e=this,i=[];t.split(`
`).forEach(function(n,r){let s=n.split("	"),a=[];r==0?(s.forEach(function(c,h){i[At.indexOf(c)]=h}),console.info(`Bank map significance: ${i}`)):s.forEach(function(c,h){h>2?(e.#t[a[i[1]]]=e.#t[a[i[1]]]||[],e.#t[a[i[1]]][(a[i[0]]<<7)+a[i[2]]]=s[3]):a.push(parseInt(s[h]))})})}async loadFiles(...t){this.#t=[];let e=this;for(let i=0;i<t.length;i++)await fetch(`./data/bank/${t[i]}.tsv`).then(function(n){return console.info(`Parsing voice map: ${t[i]}`),n.text()}).then(function(n){e.load.call(e,n)})}constructor(...t){this.loadFiles(...t)}};N.default.customInterpreter=function(t,e,i){let n=[],r=i==!1?e.readIntVLV():i;t==127&&(r=1);for(let s=0;s<r;s++){let a=e.readInt(1);if(n.push(a),a!=247){if(a!=240){if(a>127)return console.debug(`Early termination: ${n}`),e.backOne(),e.backOne(),n}}}return n};var tt=class extends A{#t=new z;#d;#l="";voices=new Q("xg","gs","ns5r");#a=[];#i=new Uint8ClampedArray(64);#c=.5;#n=120;#e=4;#u=4;#o=0;#r=0;reset(){this.dispatchEvent("reset"),this.#d?.resetIndex(),this.#t.init(),this.#l="",this.#c=.5,this.#n=120,this.#e=4,this.#u=4,this.#o=0,this.#r=0}async loadFile(t){this.#d=_(N.default.parse(new Uint8Array(await t.arrayBuffer())))}switchMode(t,e=!1){this.#t.switchMode(t,e)}getMode(){return this.#t.mode}get noteProgress(){return this.#r/this.#c}get noteOverall(){return this.noteProgress-this.#o}get noteBar(){return Math.floor(this.noteOverall/this.#e)}get noteBeat(){return this.noteOverall%this.#e}getTimeSig(){return[this.#e,this.#u]}getTempo(){return this.#n}render(t){t>this.#r&&(this.#r=t);let e=this.#d.step(t),i=0,n=new Set,r=this,s=[];e.forEach(function(d){let u=d.data;u.type==9&&(u.data[1]>0?n.add(u.part*128+u.data[0]):n.has(u.part*128+u.data[0])&&i++),d.data.type==8&&n.has(u.part*128+u.data[0])&&i++;let w=r.#t.runJson(u);switch(w?.reply){case"meta":{s.push(w);break}}w?.reply&&delete w.reply}),s?.length>0&&this.dispatchEvent("meta",s),this.#t.getStrength().forEach(function(d,u){let w=d-r.#i[u];r.#i[u]+=Math.ceil(w-w/2)});let a=this.#t.getActive(),c=[],h=r.#t.getPitch(),o=[],l=r.#t.getProgram(),f=0;return a.forEach(function(d,u){d&&(c[u]=r.#t.getVel(u),o[u]=r.#t.getCc(u),f+=c[u].size)}),{extraPoly:i,curPoly:f,chInUse:a,chKeyPr:c,chPitch:h,chProgr:l,chContr:o,eventCount:e.length,title:this.#l,bitmap:this.#t.getBitmap(),letter:this.#t.getLetter(),names:this.#t.getCustomNames(),texts:this.#t.getTexts(),master:this.#t.getMaster(),mode:this.#t.getMode(),strength:this.#i.slice(),tSig:this.getTimeSig(),tempo:this.getTempo(),noteBar:this.noteBar,noteBeat:Math.floor(this.noteBeat)}}constructor(){super();let t=this;this.addEventListener("meta",function(e){e?.data?.forEach(function(i){(t.#a[i.meta]||console.debug).call(t,i.meta,i.data)})}),this.#t.addEventListener("mode",function(e){t.dispatchEvent("mode",e.data)}),this.#a[3]=function(e,i){t.#l?.length<1&&(t.#l=i)},this.#a[81]=function(e,i){let n=t.noteProgress,r=t.#c||.5;t.#n=6e7/i,t.#c=i/1e6,t.#o+=n*(r/t.#c)-n},this.#a[88]=function(e,i){let n=t.noteProgress,r=t.noteBar,s=t.noteBeat,a=t.#e,c=t.#u;t.#e=i[0],t.#u=1<<i[1];let h=24*(32/i[3])/i[2];a!=t.#e&&(s<1&&t.#e<a?(t.#o+=n-t.#e*r,console.info("Not new bar.")):(t.#o+=n-t.#e*(r+1),console.info("New bar.")),console.info(`${t.#e}/${t.#u}`))}}};var Pt=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],St="!0123456789";var k="0123456789_aAbBcCdDeEfFgGhHiIjJ-kKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ",$t=["-","~","+","|"],Lt={"?":"UnkwnStd",gm:"GnrlMIDI",g2:"GrlMIDI2",xg:"YamahaXG",gs:"RolandGS",mt32:"RlndMT32",ag10:"KorgAG10",x5d:"Korg X5D","05rw":"Korg05RW",ns5r:"KorgNS5R"};var et=class extends tt{constructor(){super()}render(t,e){let i=new Array(24),n=super.render(t),r=this,s=Date.now(),a=Math.round(n.tempo*100)/100;i[0]=`${n.eventCount.toString().padStart(3,"0")} Poly:${(n.curPoly+n.extraPoly).toString().padStart(3,"0")}/256 TSig:${n.tSig[0]}/${n.tSig[1]} Bar:${(n.noteBar+1).toString().padStart(3,"0")}/${n.noteBeat+1} Tempo:${Math.floor(a)}.${Math.floor(a%1*100).toString().padStart(2,"0")} Vol:${Math.floor(n.master.volume)}.${Math.round(n.master.volume%1*100).toString().padStart(2,"0")}%`,i[1]=`Mode:${Lt[n.mode]} Title:${n.title||"N/A"}`,i[2]="Ch:VoiceNme#St VEM RCDB PP PiBd Pan : Note";let c=3;if(n.chInUse.forEach(function(h,o){if(h){let l=r.voices.get(n.chContr[o][0],n.chProgr[o],n.chContr[o][32]);n.names[o]&&(l.name=n.names[o],l.ending="~"),i[c]=`${(o+1).toString().padStart(2,"0")}:${l.name.slice(0,8).padEnd(8," ")}${l.ending}${l.standard} ${k[n.chContr[o][7]>>1]}${k[n.chContr[o][11]>>1]}${$t[n.chContr[o][1]>>5]} ${k[n.chContr[o][91]>>1]}${k[n.chContr[o][93]>>1]}${k[n.chContr[o][94]>>1]}${k[n.chContr[o][74]>>1]} ${n.chContr[o][65]>63?"O":"X"}${k[n.chContr[o][5]>>1]} ${K(n.chPitch[o])} ${X(n.chContr[o][10])}:`,n.chKeyPr[o].forEach(function(f,d){f>0&&(i[c]+=` <span style="opacity:${Math.round(f/1.27)/100}">${Pt[d%12]}${St[Math.floor(d/12)]}</span>`)}),c++}}),n.texts.length>0){let h=0;for(let o=i.length-1;o>=c;o--)i[o]=(n.texts[h]||"").padEnd(100," "),h++}if(s<=n.letter.expire){let h=n.letter.text.padEnd(32," "),o=i.length-2;for(let l=0;l<2;l++)i[l+o]=`${(i[l+o]||"").slice(0,82).padEnd(81)} <span class="letter"> ${h.slice(l*16,l*16+16).padEnd(" ",16)} </span>`}if(e.clearRect(0,0,e.canvas.width,e.canvas.height),e){e.fillStyle="#202020";let h;s<=n.bitmap.expire?h=n.bitmap.bitmap:(h=new Array(256),n.strength.forEach(function(o,l){if(l<16&&n.chContr[l]?.length>0){let f=o>>4;for(let d=0;d<=f;d++)h[l+(15-d)*16]=1}})),h.forEach(function(o,l){o&&e.fillRect((l&15)*12,(l>>4)*6,11,5)})}return i.join("<br/>")}};var Ct=Object.defineProperty,I=(t,e)=>()=>(t&&(e=t(t=0)),e),M=(t,e)=>{for(var i in e)Ct(t,i,{get:e[i],enumerable:!0})},nt={};M(nt,{default:()=>rt});var rt,Ot=I(()=>{rt=async(t=[{}])=>(Array.isArray(t)||(t=[t]),new Promise((e,i)=>{let n=document.createElement("input");n.type="file";let r=[...t.map(h=>h.mimeTypes||[]).join(),t.map(h=>h.extensions||[]).join()].join();n.multiple=t[0].multiple||!1,n.accept=r||"";let s=()=>c(i),a=h=>{typeof c=="function"&&c(),e(h)},c=t[0].legacySetup&&t[0].legacySetup(a,s,n);n.addEventListener("change",()=>{a(n.multiple?Array.from(n.files):n.files[0])}),n.click()}))}),at={};M(at,{default:()=>st});var it,st,Dt=I(()=>{it=async t=>{let e=await t.getFile();return e.handle=t,e},st=async(t=[{}])=>{Array.isArray(t)||(t=[t]);let e=[];t.forEach((r,s)=>{e[s]={description:r.description||"",accept:{}},r.mimeTypes?r.mimeTypes.map(a=>{e[s].accept[a]=r.extensions||[]}):e[s].accept["*/*"]=r.extensions||[]});let i=await window.showOpenFilePicker({id:t[0].id,startIn:t[0].startIn,types:e,multiple:t[0].multiple||!1,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),n=await Promise.all(i.map(it));return t[0].multiple?n:n[0]}}),ot={};M(ot,{default:()=>lt});var lt,Ut=I(()=>{lt=async(t=[{}])=>(Array.isArray(t)||(t=[t]),t[0].recursive=t[0].recursive||!1,new Promise((e,i)=>{let n=document.createElement("input");n.type="file",n.webkitdirectory=!0;let r=()=>a(i),s=c=>{typeof a=="function"&&a(),e(c)},a=t[0].legacySetup&&t[0].legacySetup(s,r,n);n.addEventListener("change",()=>{let c=Array.from(n.files);t[0].recursive?t[0].recursive&&t[0].skipDirectory&&(c=c.filter(h=>h.webkitRelativePath.split("/").every(o=>!t[0].skipDirectory({name:o,kind:"directory"})))):c=c.filter(h=>h.webkitRelativePath.split("/").length===2),s(c)}),n.click()}))}),ct={};M(ct,{default:()=>ht});var V,ht,Rt=I(()=>{V=async(t,e,i=t.name,n)=>{let r=[],s=[];for await(let a of t.values()){let c=`${i}/${a.name}`;a.kind==="file"?s.push(a.getFile().then(h=>(h.directoryHandle=t,h.handle=a,Object.defineProperty(h,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):a.kind==="directory"&&e&&(!n||!n(a))&&r.push(V(a,e,c,n))}return[...(await Promise.all(r)).flat(),...await Promise.all(s)]},ht=async(t={})=>{t.recursive=t.recursive||!1;let e=await window.showDirectoryPicker({id:t.id,startIn:t.startIn});return V(e,t.recursive,void 0,t.skipDirectory)}}),ft={};M(ft,{default:()=>dt});async function Bt(t,e){let i=t.getReader(),n=new ReadableStream({start(s){return a();async function a(){return i.read().then(({done:c,value:h})=>{if(c){s.close();return}return s.enqueue(h),a()})}}}),r=new Response(n);return i.releaseLock(),new Blob([await r.blob()],{type:e})}var dt,Nt=I(()=>{dt=async(t,e={})=>{Array.isArray(e)&&(e=e[0]);let i=document.createElement("a"),n=t;"body"in t&&(n=await Bt(t.body,t.headers.get("content-type"))),i.download=e.fileName||"Untitled",i.href=URL.createObjectURL(n);let r=()=>a(reject),s=()=>{typeof a=="function"&&a()},a=e.legacySetup&&e.legacySetup(s,r,i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),30*1e3),s(null)}),i.click(),null}}),ut={};M(ut,{default:()=>pt});var pt,Vt=I(()=>{pt=async(t,e=[{}],i=null,n=!1)=>{Array.isArray(e)||(e=[e]),e[0].fileName=e[0].fileName||"Untitled";let r=[];if(e.forEach((c,h)=>{r[h]={description:c.description||"",accept:{}},c.mimeTypes?(h===0&&(t.type?c.mimeTypes.push(t.type):t.headers&&t.headers.get("content-type")&&c.mimeTypes.push(t.headers.get("content-type"))),c.mimeTypes.map(o=>{r[h].accept[o]=c.extensions||[]})):t.type&&(r[h].accept[t.type]=c.extensions||[])}),i)try{await i.getFile()}catch(c){if(i=null,n)throw c}let s=i||await window.showSaveFilePicker({suggestedName:e[0].fileName,id:e[0].id,startIn:e[0].startIn,types:r,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),a=await s.createWritable();return"stream"in t?(await t.stream().pipeTo(a),s):"body"in t?(await t.body.pipeTo(a),s):(await a.write(blob),await a.close(),s)}}),Ft=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),F=Ft,Gt=F?Promise.resolve().then(()=>(Dt(),at)):Promise.resolve().then(()=>(Ot(),nt));async function G(...t){return(await Gt).default(...t)}var Ee=F?Promise.resolve().then(()=>(Rt(),ct)):Promise.resolve().then(()=>(Ut(),ot));var be=F?Promise.resolve().then(()=>(Vt(),ut)):Promise.resolve().then(()=>(Nt(),ft));var v={},S=[];S[2]="x5d";S[9]="gm";var x=C("b.mode"),mt=[];x.to=function(t){x.forEach(function(e){e.classList.off("active")}),t>-1&&x[t].classList.on("active")};x.forEach(function(t,e,i){mt[e]=t.title,t.addEventListener("click",function(){tuiVis.switchMode(t.title,!0),x.to(e)})});var T=C("b.demo");T.to=function(t){T.forEach(function(e){e.classList.off("active")}),t>-1&&T[t].classList.on("active")};T.forEach(function(t,e,i){t.addEventListener("click",async function(){y.pause(),v[t.title]?.midi||(v[t.title]={},m.innerHTML=`Loading demo ${t.innerText.toUpperCase()}.${"<br/>".repeat(23)}`,v[t.title].midi=await(await fetch(`./demo/${t.title}.mid`)).blob(),v[t.title].wave=await(await fetch(`./demo/${t.title}.opus`)).blob()),m.innerHTML=`Demo ${t.innerText.toUpperCase()} ready.${"<br/>".repeat(23)}`,y.currentTime=0,tuiVis.reset(),tuiVis.loadFile(v[t.title].midi),p&&URL.revokeObjectURL(p),p=v[t.title].wave,y.src=URL.createObjectURL(p),S[e]?.length>0&&tuiVis.switchMode(S[e]),T.to(e)})});self.tuiVis=new et;tuiVis.addEventListener("reset",function(t){});tuiVis.addEventListener("mode",function(t){x.to(mt.indexOf(t.data))});var p,jt=JSON.parse('{"extensions":[".mid",".MID"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}'),Kt=JSON.parse('{"mimeTypes":["audio/*"],"startIn":"music","id":"audioOpener","description":"Open an audio file"}');b("#openMidi").addEventListener("click",async function(){T.to(-1),tuiVis.reset(),tuiVis.loadFile(await G(jt))});b("#openAudio").addEventListener("click",async function(){p&&URL.revokeObjectURL(p),p=await G(Kt),y.src=URL.createObjectURL(p)});var E=b("#bmDisp"),Xt=E.getContext("2d"),y=b("#audioPlayer"),m=b("#display");E.style.left=`${m.offsetLeft+m.offsetWidth-E.offsetWidth}px`;E.style.top=`${m.offsetTop}px`;y.onended=function(){tuiVis.reset()};(async function(){tuiVis.reset();let t=await(await fetch("./demo/KANDI8.mid")).blob();v.KANDI8={},v.KANDI8.midi=t,tuiVis.loadFile(t),p&&URL.revokeObjectURL(p),p=await(await fetch("./demo/KANDI8.opus")).blob(),v.KANDI8.wave=p,y.src=URL.createObjectURL(p),m.innerHTML=`${"<br/>".repeat(23)}`})();var Pe=setInterval(function(){y.paused||(m.innerHTML=tuiVis.render(y.currentTime-(self.audioDelay||0),Xt))},20);addEventListener("resize",function(){E.style.left=`${m.offsetLeft+m.offsetWidth-E.offsetWidth}px`,E.style.top=`${m.offsetTop}px`});})();
