"use strict";(()=>{var ut=Object.create;var B=Object.defineProperty;var pt=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var gt=Object.getPrototypeOf,vt=Object.prototype.hasOwnProperty;var yt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var wt=(t,e,i,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of mt(e))!vt.call(t,n)&&n!==i&&B(t,n,{get:()=>e[n],enumerable:!(r=pt(e,n))||r.enumerable});return t};var kt=(t,e,i)=>(i=t!=null?ut(gt(t)):{},wt(e||!t||!t.__esModule?B(i,"default",{value:t,enumerable:!0}):i,t));var H=yt((Qt,D)=>{(function(){"use strict";let t={debug:!1,parse:function(e,i){if(e instanceof Uint8Array)return t.Uint8(e);if(typeof e=="string")return t.Base64(e);if(e instanceof HTMLElement&&e.type==="file")return t.addListener(e,i);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,i){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(e===void 0||!(e instanceof HTMLElement)||e.tagName!=="INPUT"||e.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;i=i||function(){},e.addEventListener("change",function(r){if(!r.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let n=new FileReader;n.readAsArrayBuffer(r.target.files[0]),n.onload=function(s){i(t.Uint8(new Uint8Array(s.target.result)))}})},Base64:function(e){let i=function(s){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(s=s.replace(/^.*?base64,/,""),s=String(s).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(s))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");s+="==".slice(2-(3&s.length));let c,l="",o,d,h=0;for(;h<s.length;)c=a.indexOf(s.charAt(h++))<<18|a.indexOf(s.charAt(h++))<<12|(o=a.indexOf(s.charAt(h++)))<<6|(d=a.indexOf(s.charAt(h++))),l+=o===64?String.fromCharCode(c>>16&255):d===64?String.fromCharCode(c>>16&255,c>>8&255):String.fromCharCode(c>>16&255,c>>8&255,255&c);return l}(e=String(e));var r=i.length;let n=new Uint8Array(new ArrayBuffer(r));for(let s=0;s<r;s++)n[s]=i.charCodeAt(s);return t.Uint8(n)},Uint8:function(n){let i={data:null,pointer:0,movePointer:function(o){return this.pointer+=o,this.pointer},readInt:function(o){if((o=Math.min(o,this.data.byteLength-this.pointer))<1)return-1;let d=0;if(1<o)for(let h=1;h<=o-1;h++)d+=this.data.getUint8(this.pointer)*Math.pow(256,o-h),this.pointer++;return d+=this.data.getUint8(this.pointer),this.pointer++,d},readStr:function(o){let d="";for(let h=1;h<=o;h++)d+=String.fromCharCode(this.readInt(1));return d},backOne:function(){this.pointer--},readIntVLV:function(){let o=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)o=this.readInt(1);else{let h=[];for(;128<=this.data.getUint8(this.pointer);)h.push(this.readInt(1)-128);var d=this.readInt(1);for(let u=1;u<=h.length;u++)o+=h[h.length-u]*Math.pow(128,u);o+=d}return o}};if(i.data=new DataView(n.buffer,n.byteOffset,n.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let r={};r.formatType=i.readInt(2),r.tracks=i.readInt(2),r.track=[];var n=i.readInt(1),s=i.readInt(1);128<=n?(r.timeDivision=[],r.timeDivision[0]=n-128,r.timeDivision[1]=s):r.timeDivision=256*n+s;for(let o=1;o<=r.tracks;o++){r.track[o-1]={event:[]};var a,c=i.readInt(4);if(c===-1)break;if(c!==1297379947)return!1;i.readInt(4);let d=0,h=!1,u,f;for(;!h&&(d++,r.track[o-1].event[d-1]={},r.track[o-1].event[d-1].deltaTime=i.readIntVLV(),(u=i.readInt(1))!==-1);)if(128<=u?f=u:(u=f,i.movePointer(-1)),u===255){r.track[o-1].event[d-1].type=255,r.track[o-1].event[d-1].metaType=i.readInt(1);var l=i.readIntVLV();switch(r.track[o-1].event[d-1].metaType){case 47:case-1:h=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:r.track[o-1].event[d-1].data=i.readStr(l);break;case 33:case 89:case 81:r.track[o-1].event[d-1].data=i.readInt(l);break;case 84:r.track[o-1].event[d-1].data=[],r.track[o-1].event[d-1].data[0]=i.readInt(1),r.track[o-1].event[d-1].data[1]=i.readInt(1),r.track[o-1].event[d-1].data[2]=i.readInt(1),r.track[o-1].event[d-1].data[3]=i.readInt(1),r.track[o-1].event[d-1].data[4]=i.readInt(1);break;case 88:r.track[o-1].event[d-1].data=[],r.track[o-1].event[d-1].data[0]=i.readInt(1),r.track[o-1].event[d-1].data[1]=i.readInt(1),r.track[o-1].event[d-1].data[2]=i.readInt(1),r.track[o-1].event[d-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(r.track[o-1].event[d-1].data=this.customInterpreter(r.track[o-1].event[d-1].metaType,i,l)),this.customInterpreter!==null&&r.track[o-1].event[d-1].data!==!1||(i.readInt(l),r.track[o-1].event[d-1].data=i.readInt(l),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((u=u.toString(16).split(""))[1]||u.unshift("0"),r.track[o-1].event[d-1].type=parseInt(u[0],16),r.track[o-1].event[d-1].channel=parseInt(u[1],16),r.track[o-1].event[d-1].type){case 15:this.customInterpreter!==null&&(r.track[o-1].event[d-1].data=this.customInterpreter(r.track[o-1].event[d-1].type,i,!1)),this.customInterpreter!==null&&r.track[o-1].event[d-1].data!==!1||(a=i.readIntVLV(),r.track[o-1].event[d-1].data=i.readInt(a),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:r.track[o-1].event[d-1].data=[],r.track[o-1].event[d-1].data[0]=i.readInt(1),r.track[o-1].event[d-1].data[1]=i.readInt(1);break;case 12:case 13:r.track[o-1].event[d-1].data=i.readInt(1);break;case-1:h=!0;break;default:if(this.customInterpreter!==null&&(r.track[o-1].event[d-1].data=this.customInterpreter(r.track[o-1].event[d-1].metaType,i,!1)),this.customInterpreter===null||r.track[o-1].event[d-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return r},customInterpreter:null};if(typeof D<"u")D.exports=t;else{let e=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;e.MidiParser=t}})()});DOMTokenList.prototype.on=function(t){!this.contains(t)&&this.toggle(t)};DOMTokenList.prototype.off=function(t){this.contains(t)&&this.toggle(t)};var y=function(t,e=document){return e?.querySelector(t)},P=function(t,e=document){return Array.from(e?.querySelectorAll(t))};var M=class{#t={};addEventListener(t,e){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(e)}removeEventListener(t,e){if(this.#t[t]){let i=this.#t[t].indexOf(e);i>-1&&this.#t[t].splice(i,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,e){let i=new Event(t),r=this;i.data=e,this.#t[t]?.length>0&&this.#t[t].forEach(function(n){n?.call(r,i)}),this[`on${t}`]&&this[`on${t}`](i)}};var F=function(t,e){let i=Math.min(t.length,e.length),r=t.slice(0,i),n=e.slice(0,i),s=0,a=0;for(;a<i&&s==0;)s=Math.sign(r[a]-n[a]),a++;return s},j=function(){this.pool=[],this.point=function(t,e=!1){if(this.pool.length>0){let i=this.pool.length,r=1<<Math.floor(Math.log2(i)),n=r,s=64;for(;r>=1&&s>=0;){if(s<=0)throw new Error("TTL reached.");if(n==i)n-=r;else{let c=F(t,this.pool[n]);switch(c){case 0:{s=0;break}case 1:{n+r<=i&&(n+=r);break}case-1:{n!=0&&(n-=r);break}default:console.warn(`Unexpected result ${c}.`)}}r=r>>1,s--}let a=!0;if(n>=this.pool.length)a=!1;else{let c=this;this.pool[n].forEach(function(l,o,d){a&&l!=t[o]&&(a=!1)}),!a&&F(t,this.pool[n])>0&&n++}return a||e?n:-1}else return e?0:-1},this.add=function(t,e){return t.data=e,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let e=this.point(t);if(e>-1)return this.pool[e].data;this.default(t)},this.run=function(t,...e){let i=this.point(t);i>-1?this.pool[i].data(t.slice(this.pool[i].length),...e):this.default(t,...e)}};var S=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw"],K={};S.forEach(function(t,e){K[t]=e});var G=[[0,0,0,0,0,0,0,56,82,81],[0,0,0,0,0,127,0,0,0,0]],bt=[0,3,4,5,6,7,81,84,88,89],w=function(t,e,i){i[e]=0},It=function(t){let e=[[]];return t?.forEach(function(i){i==247||(i==240?e.push([]):e[e.length-1].push(i))}),e},X=class extends M{#t=0;#n=new Array(256);#i=0;#a=new Array(64);#r=new Uint8ClampedArray(8192);#h=new Uint8ClampedArray(64);#s=new Uint8ClampedArray(8192);#e=new Uint16Array(512);#g=new Int16Array(64);#f=0;#u=0;#p=100;#c="";#m=0;#d=[];#v={8:function(t){let e=t.part*128+t.data[0],i=this.#e.indexOf(e);i>-1&&(this.#e[i]=0,this.#s[e]=0)},9:function(t){this.#a[t.part]=!0;let e=t.part*128+t.data[0];if(t.data[1]>0){let i=0;for(;this.#e[i]>0;)i++;i<512?(this.#e[i]=e,this.#s[e]=t.data[1]):console.error("Polyphony exceeded.")}else{let i=this.#e.indexOf(e);i>-1&&(this.#e[i]=0,this.#s[e]=0)}},10:function(t){let e=t.part*128+t.data[0];this.#e.indexOf(e)>-1&&(this.#s[e]=data[1])},11:function(t){this.#a[t.part]=!0,t.data[0]==0&&t.part%16==9&&this.#t==K.gs&&(t.data[1]=120),this.#r[t.part*128+t.data[0]]=t.data[1]},12:function(t){this.#a[t.part]=!0,this.#h[t.part]=t.data},13:function(t){let e=this;this.#e.forEach(function(i){let r=i>>7;t.part==r&&(this.#s[i]=t.data)}),console.info(t)},14:function(t){this.#g[t.part]=t.data[1]*128+t.data[0]-8192},15:function(t){let e=this;It(t.data).forEach(function(i){e.#o.run(i)})},255:function(t){if((this.#d[t.meta]||console.debug).call(this,t.data),bt.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#o;#y;#l=[];getActive(){return this.#a.slice()}getCc(t){let e=t*128,i=Array.from(this.#r).slice(e,e+128);return i[0]=i[0]||this.#f,i[32]=i[32]||this.#u,i}getPitch(){return Array.from(this.#g)}getProgram(){return Array.from(this.#h)}getTexts(){return this.#l.slice()}getVel(t){let e=new Map,i=this;return this.#e.forEach(function(r){let n=r>>7,s=r&127;t==n&&i.#s[r]>0&&e.set(s,i.#s[r])}),e}getBitmap(){return{bitmap:this.#n.slice(),expire:this.#i}}getLetter(){return{text:this.#c,expire:this.#m}}getMode(){return S[this.#t]}getMaster(){return{volume:this.#p}}init(){this.dispatchEvent("mode","?"),this.#t=0,this.#f=0,this.#u=0,this.#a.forEach(w),this.#r.forEach(w),this.#h.forEach(w),this.#s.forEach(w),this.#e.forEach(w),this.#p=100,this.#l=[],this.#m=0,this.#c="",this.#i=0,this.#n.forEach(w),this.#r[1152]=127;for(let t=0;t<64;t++)this.#r[t*128+7]=127,this.#r[t*128+11]=127,this.#r[t*128+74]=127,this.#r[t*128+10]=127}switchMode(t,e=!1){let i=S.indexOf(t);if(i>-1)(this.#t==0||e)&&(this.#t=i,this.#f=G[0][i],this.#u=G[1][i],this.dispatchEvent("mode",t));else throw new Error(`Unknown mode ${t}`)}runJson(t){return this.#v[t.type].call(this,t)}runRaw(t){}constructor(){super();let t=this;self.seeReg=function(e){return Array.from(t.#r).slice(e*128,e*128+128)},this.#o=new j,this.#o.default=console.debug,this.#d[1]=function(e){this.#l.unshift(e)},this.#d[2]=function(e){this.#l.unshift(`Copyrite: ${e}`)},this.#d[3]=function(e){this.#l.unshift(`Trk.Info: ${e}`)},this.#o.add([126,127,9,1],function(){t.switchMode("gm",!0),console.info("MIDI reset: GM")}).add([126,127,9,3],function(){t.switchMode("g2",!0),console.info("MIDI reset: GM2")}).add([65,16,22,18,127,1],function(){t.switchMode("mt32",!0),console.info("MIDI reset: MT-32")}).add([65,16,66,18,64,0,127,0,65],function(){t.switchMode("gs",!0),console.info("MIDI reset: GS")}).add([66,48,66,52,0],function(e){t.switchMode("ns5r",!0),console.info("KORG reset:",e)}).add([67,16,76,0,0,126,0],function(e){t.switchMode("xg",!0),console.info("MIDI reset: XG")}),this.#o.add([127,127,4,1],function(e){t.switchMode("gm"),t.#p=(e[1]<<7+e[0])/163.83}),this.#o.add([67,16,76,6,0],function(e){let i=e[0];t.#c=" ".repeat(i),t.#m=Date.now()+3200,e.slice(1).forEach(function(r){t.#c+=String.fromCharCode(r)})}).add([67,16,76,7,0,0],function(e){for(t.#i=Date.now()+3200;iMsg.length<48;)e.unshift(0);e.forEach(function(i,r){let n=Math.floor(r/16),s=r%16,a=(s*3+n)*7,c=7,l=0;for(a-=s*5,n==2&&(c=2);l<c;)t.#n[a+l]=i>>6-l&1,l++})}),this.#o.add([65,16,69,18,16,1,0],function(e){t.#i=Date.now()+3200,e.forEach(function(i,r){if(r<64){let n=Math.floor(r/16),s=r%16,a=(s*4+n)*5,c=5,l=0;for(a-=s*4,n==3&&(c=1);l<c;)t.#n[a+l]=i>>4-l&1,l++}})})}};var $=kt(H(),1);var q=class{#t=!1;constructor(t,e,i,r){this.#t=t,this.start=e,this.end=i,this.data=r}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},O=class extends q{constructor(t,e,i){super(!0,t,e,i)}},z=class extends q{constructor(t,e){super(!1,t,t,e)}},C=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,e){return t.start==e.start?0:(+(t.start>e.start)<<1)-1}),this.forEach(function(t,e){t.index=e})}step(t,e=!1){let i=[];if(e)for(let r=0;r<this.length&&!(this[r].start>t);r++){if(this[r].end<t)continue;i.push(this[r])}else{let r=this.getRange(t-1,t),n=this;r.forEach(function(s){s.index>n.#t&&(i.push(s),n.#t=s.index)})}return i}getRange(t,e){t>e&&([t,e]=[e,t]);let i=[],r=-1,n=Math.ceil(Math.sqrt(this.length)),s=!0;for(let a=0;a<this.length;a+=n)this[a+n]?r<0&&this[a+n].start>=t&&(r=a):r=r<0?a:r;for(;s;)this[r]?.end<e?this[r].start>=t&&i.push(this[r]):s=!1,r++;return i}};var Et=0xffffffffffff,W=function(t){let e=new C,i=this,r=t.timeDivision,n=120,s=new C,a=0,c=0;s.push(new O(0,Et,[120,0])),t.track.forEach(function(h){a=0,h.event.forEach(function(u){a+=u.deltaTime,u.type==255&&u?.metaType==81&&(n=6e7/u.data,s[s.length-1]&&s.push(new O(a,0xffffffffffff,[n,0])))})}),s.fresh(),s.forEach(function(h,u,f){u>0&&(f[u-1].end=h.start)});let l=120;s.forEach(function(h,u,f){h.end==h.start?f.splice(f.indexOf(h),1):l==h.data[0]&&(f[u-1].end=h.end,f.splice(f.indexOf(h),1)),l=h.data[0]});let o=0,d=120;return s.forEach(function(h){let u=h.start,f=u/d/r*60+o;d=h.data[0],o=f-u/d/r*60,h.data[1]=o}),console.debug("All tempo changes: ",s),n=120,a=0,c=0,t.track.forEach(function(h,u){a=0,c=0,h.event.forEach(function(f,x){a+=f.deltaTime;let T=s.step(a,!0)[0];T&&(n=T.data[0],c=T.data[1]);let L={type:f.type,data:f.data,track:u,part:0};f.type>14?L.meta=f.metaType:L.part=f.channel,e.push(new z(a/n/r*60+c,L))})}),e.fresh(),e};var xt=["MSB","PRG","LSB"];var Z=class{#t=[];get(t=0,e=0,i=0){let r,n=Array.from(arguments);n[0]==127&&n[2]==0&&n[1]>111&&(n[1]=0),n[0]==0&&n[2]>111&&n[2]<120&&(n[2]=0);let s=" ";for(;!(r?.length>0);)r=this.#t[n[1]||0][(n[0]<<7)+n[2]],r||(n[2]=0,s="^",this.#t[n[1]||0][n[0]<<7]||(n[0]=0,s="*"));s!=" "&&self.debugMode&&(r="");let a="??";switch(n[0]){case 0:{n[2]==0?a="GM":n[2]<120?a="XG":n[2]==127&&(a="MT");break}case 56:{a="AG";break}case 61:case 83:{a="AI";break}case 62:case 82:{a="XD";break}case 81:{a="RW";break}case 64:case 121:case 126:case 127:{a="XG";break}case 120:a="GS";default:n[0]<40&&(a="GS")}return{name:r||(t||0).toString().padStart(3,"0")+" "+(e||0).toString().padStart(3,"0")+" "+(i||0).toString().padStart(3,"0"),ending:s,standard:a}}load(t){let e=this,i=[];t.split(`
`).forEach(function(r,n){let s=r.split("	"),a=[];n==0?(s.forEach(function(c,l){i[xt.indexOf(c)]=l}),console.info(`Bank map significance: ${i}`)):s.forEach(function(c,l){l>2?(e.#t[a[i[1]]]=e.#t[a[i[1]]]||[],e.#t[a[i[1]]][(a[i[0]]<<7)+a[i[2]]]=s[3]):a.push(parseInt(s[l]))})})}async loadFiles(...t){this.#t=[];let e=this;for(let i=0;i<t.length;i++)await fetch(`./data/bank/${t[i]}.tsv`).then(function(r){return console.info(`Parsing voice map: ${t[i]}`),r.text()}).then(function(r){e.load.call(e,r)})}constructor(...t){this.loadFiles(...t)}};var J=function(t){let e=Array.from("----");if(t>0)for(let i=0;t>0;i++)e[i]=t<1024?"=":">",t-=2048;else if(t<0)for(let i=3;t<0;i--)e[i]=t>=-1024?"=":"<",t+=2048;return e.join("")},Y=function(t){let e=Array.from("----");if(t>64)for(let i=0;t>64;i++)e[i]=t<72?"=":">",t-=16;else if(t<64)for(let i=3;t<64;i--)e[i]=t>=56?"=":"<",t+=16;return e.join("")};var Mt=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],At="!0123456789";var v="0123456789_aAbBcCdDeEfFgGhHiIjJ-kKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ",Tt=["-","~","+","|"],Lt={"?":"UnkwnStd",gm:"GnrlMIDI",g2:"GrlMIDI2",xg:"YamahaXG",gs:"RolandGS",mt32:"RlndMT32",ag10:"KorgAG10",x5d:"Korg X5D","05rw":"Korg05RW",ns5r:"KorgNS5R"};$.default.customInterpreter=function(t,e,i){let r=[],n=i==!1?e.readIntVLV():i;t==127&&(n=1);for(let s=0;s<n;s++){let a=e.readInt(1);if(r.push(a),a!=247){if(a!=240){if(a>127)return console.debug(`Early termination: ${r}`),e.backOne(),e.backOne(),r}}}return r};var Pt=class extends M{#t=new X;#n;#i="";voices=new Z("xg","gs","ns5r");#a=[];reset(){this.dispatchEvent("reset"),this.#n?.resetIndex(),this.#t.init(),this.#i=""}async loadFile(t){this.#n=W($.default.parse(new Uint8Array(await t.arrayBuffer())))}switchMode(t,e=!1){this.#t.switchMode(t,e)}getMode(){return this.#t.mode}render(t){let e=this.#n.step(t),i=0,r=new Set,n=this,s=[];e.forEach(function(u){let f=u.data;f.type==9&&(f.data[1]>0?r.add(f.part*128+f.data[0]):r.has(f.part*128+f.data[0])&&i++),u.data.type==8&&r.has(f.part*128+f.data[0])&&i++;let x=n.#t.runJson(f);switch(x?.reply){case"meta":{s.push(x);break}}x?.reply&&delete x.reply}),s?.length>0&&this.dispatchEvent("meta",s);let a=this.#t.getActive(),c=[],l=n.#t.getPitch(),o=[],d=n.#t.getProgram(),h=0;return a.forEach(function(u,f){u&&(c[f]=n.#t.getVel(f),o[f]=n.#t.getCc(f),h+=c[f].size)}),{extraPoly:i,curPoly:h,chInUse:a,chKeyPr:c,chPitch:l,chProgr:d,chContr:o,eventCount:e.length,title:this.#i,bitmap:this.#t.getBitmap(),letter:this.#t.getLetter(),texts:this.#t.getTexts(),master:this.#t.getMaster(),mode:this.#t.getMode()}}constructor(){super();let t=this;this.addEventListener("meta",function(e){e?.data?.forEach(function(i){(t.#a[i.meta]||console.debug).call(t,i.meta,i.data)})}),this.#t.addEventListener("mode",function(e){t.dispatchEvent("mode",e.data)}),this.#a[3]=function(e,i){t.#i?.length<1&&(t.#i=i)}}},_=class extends Pt{constructor(){super()}render(t,e){let i=new Array(24),r=super.render(t),n=this,s=Date.now();i[0]=`${r.eventCount.toString().padStart(3,"0")} Poly:${(r.curPoly+r.extraPoly).toString().padStart(3,"0")}/512 Vol:${Math.floor(r.master.volume)}.${Math.round(r.master.volume%1*100).toString().padStart(2,"0")}%`,i[1]=`Mode:${Lt[r.mode]} Title:${r.title||"N/A"}`,i[2]="Ch:VoiceNme#St VEM RCDB PP PiBd Pan : Note";let a=3;if(r.chInUse.forEach(function(c,l){if(c){let o=n.voices.get(r.chContr[l][0],r.chProgr[l],r.chContr[l][32]);i[a]=`${(l+1).toString().padStart(2,"0")}:${o.name.padEnd(8," ")}${o.ending}${o.standard} ${v[r.chContr[l][7]>>1]}${v[r.chContr[l][11]>>1]}${Tt[r.chContr[l][1]>>5]} ${v[r.chContr[l][91]>>1]}${v[r.chContr[l][93]>>1]}${v[r.chContr[l][94]>>1]}${v[r.chContr[l][74]>>1]} ${r.chContr[l][65]>63?"O":"X"}${v[r.chContr[l][5]>>1]} ${J(r.chPitch[l])} ${Y(r.chContr[l][10])}:`,r.chKeyPr[l].forEach(function(d,h){d>0&&(i[a]+=` <span style="opacity:${Math.round(d/1.27)/100}">${Mt[h%12]}${At[Math.floor(h/12)]}</span>`)}),a++}}),r.texts.length>0){let c=0;for(let l=i.length-1;l>=a;l--)i[l]=(r.texts[c]||"").padEnd(100," "),c++}if(s<=r.letter.expire){let c=r.letter.text.padEnd(32," "),l=i.length-2;for(let o=0;o<2;o++)i[o+l]=`${(i[o+l]||"").slice(0,82).padEnd(81)} <span class="letter"> ${c.slice(o*16,o*16+16).padEnd(" ",16)} </span>`}return e.clearRect(0,0,e.canvas.width,e.canvas.height),e&&s<=r.bitmap.expire&&(e.fillStyle="#202020",r.bitmap.bitmap.forEach(function(c,l){c&&e.fillRect(l%16*12,Math.floor(l/16)*6,10,4)})),i.join("<br/>")}};var St=Object.defineProperty,k=(t,e)=>()=>(t&&(e=t(t=0)),e),b=(t,e)=>{for(var i in e)St(t,i,{get:e[i],enumerable:!0})},tt={};b(tt,{default:()=>et});var et,Dt=k(()=>{et=async(t=[{}])=>(Array.isArray(t)||(t=[t]),new Promise((e,i)=>{let r=document.createElement("input");r.type="file";let n=[...t.map(l=>l.mimeTypes||[]).join(),t.map(l=>l.extensions||[]).join()].join();r.multiple=t[0].multiple||!1,r.accept=n||"";let s=()=>c(i),a=l=>{typeof c=="function"&&c(),e(l)},c=t[0].legacySetup&&t[0].legacySetup(a,s,r);r.addEventListener("change",()=>{a(r.multiple?Array.from(r.files):r.files[0])}),r.click()}))}),it={};b(it,{default:()=>rt});var Q,rt,Ot=k(()=>{Q=async t=>{let e=await t.getFile();return e.handle=t,e},rt=async(t=[{}])=>{Array.isArray(t)||(t=[t]);let e=[];t.forEach((n,s)=>{e[s]={description:n.description||"",accept:{}},n.mimeTypes?n.mimeTypes.map(a=>{e[s].accept[a]=n.extensions||[]}):e[s].accept["*/*"]=n.extensions||[]});let i=await window.showOpenFilePicker({id:t[0].id,startIn:t[0].startIn,types:e,multiple:t[0].multiple||!1,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),r=await Promise.all(i.map(Q));return t[0].multiple?r:r[0]}}),nt={};b(nt,{default:()=>at});var at,Ct=k(()=>{at=async(t=[{}])=>(Array.isArray(t)||(t=[t]),t[0].recursive=t[0].recursive||!1,new Promise((e,i)=>{let r=document.createElement("input");r.type="file",r.webkitdirectory=!0;let n=()=>a(i),s=c=>{typeof a=="function"&&a(),e(c)},a=t[0].legacySetup&&t[0].legacySetup(s,n,r);r.addEventListener("change",()=>{let c=Array.from(r.files);t[0].recursive?t[0].recursive&&t[0].skipDirectory&&(c=c.filter(l=>l.webkitRelativePath.split("/").every(o=>!t[0].skipDirectory({name:o,kind:"directory"})))):c=c.filter(l=>l.webkitRelativePath.split("/").length===2),s(c)}),r.click()}))}),st={};b(st,{default:()=>ot});var U,ot,$t=k(()=>{U=async(t,e,i=t.name,r)=>{let n=[],s=[];for await(let a of t.values()){let c=`${i}/${a.name}`;a.kind==="file"?s.push(a.getFile().then(l=>(l.directoryHandle=t,l.handle=a,Object.defineProperty(l,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):a.kind==="directory"&&e&&(!r||!r(a))&&n.push(U(a,e,c,r))}return[...(await Promise.all(n)).flat(),...await Promise.all(s)]},ot=async(t={})=>{t.recursive=t.recursive||!1;let e=await window.showDirectoryPicker({id:t.id,startIn:t.startIn});return U(e,t.recursive,void 0,t.skipDirectory)}}),lt={};b(lt,{default:()=>ct});async function Ut(t,e){let i=t.getReader(),r=new ReadableStream({start(s){return a();async function a(){return i.read().then(({done:c,value:l})=>{if(c){s.close();return}return s.enqueue(l),a()})}}}),n=new Response(r);return i.releaseLock(),new Blob([await n.blob()],{type:e})}var ct,Rt=k(()=>{ct=async(t,e={})=>{Array.isArray(e)&&(e=e[0]);let i=document.createElement("a"),r=t;"body"in t&&(r=await Ut(t.body,t.headers.get("content-type"))),i.download=e.fileName||"Untitled",i.href=URL.createObjectURL(r);let n=()=>a(reject),s=()=>{typeof a=="function"&&a()},a=e.legacySetup&&e.legacySetup(s,n,i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),30*1e3),s(null)}),i.click(),null}}),dt={};b(dt,{default:()=>ht});var ht,Vt=k(()=>{ht=async(t,e=[{}],i=null,r=!1)=>{Array.isArray(e)||(e=[e]),e[0].fileName=e[0].fileName||"Untitled";let n=[];if(e.forEach((c,l)=>{n[l]={description:c.description||"",accept:{}},c.mimeTypes?(l===0&&(t.type?c.mimeTypes.push(t.type):t.headers&&t.headers.get("content-type")&&c.mimeTypes.push(t.headers.get("content-type"))),c.mimeTypes.map(o=>{n[l].accept[o]=c.extensions||[]})):t.type&&(n[l].accept[t.type]=c.extensions||[])}),i)try{await i.getFile()}catch(c){if(i=null,r)throw c}let s=i||await window.showSaveFilePicker({suggestedName:e[0].fileName,id:e[0].id,startIn:e[0].startIn,types:n,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),a=await s.createWritable();return"stream"in t?(await t.stream().pipeTo(a),s):"body"in t?(await t.body.pipeTo(a),s):(await a.write(blob),await a.close(),s)}}),Nt=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),R=Nt,Bt=R?Promise.resolve().then(()=>(Ot(),it)):Promise.resolve().then(()=>(Dt(),tt));async function V(...t){return(await Bt).default(...t)}var ye=R?Promise.resolve().then(()=>($t(),st)):Promise.resolve().then(()=>(Ct(),nt));var we=R?Promise.resolve().then(()=>(Vt(),dt)):Promise.resolve().then(()=>(Rt(),lt));var m={},N=[];N[2]="x5d";var I=P("b.mode"),ft=[];I.to=function(t){I.forEach(function(e){e.classList.off("active")}),t>-1&&I[t].classList.on("active")};I.forEach(function(t,e,i){ft[e]=t.title,t.addEventListener("click",function(){tuiVis.switchMode(t.title,!0),I.to(e)})});var E=P("b.demo");E.to=function(t){E.forEach(function(e){e.classList.off("active")}),t>-1&&E[t].classList.on("active")};E.forEach(function(t,e,i){t.addEventListener("click",async function(){g.pause(),m[t.title]?.midi||(m[t.title]={},A.innerHTML=`Loading demo ${t.innerText.toUpperCase()}.${"<br/>".repeat(23)}`,m[t.title].midi=await(await fetch(`./demo/${t.title}.mid`)).blob(),m[t.title].wave=await(await fetch(`./demo/${t.title}.opus`)).blob()),A.innerHTML=`Demo ${t.innerText.toUpperCase()} ready.${"<br/>".repeat(23)}`,g.currentTime=0,tuiVis.reset(),tuiVis.loadFile(m[t.title].midi),p&&URL.revokeObjectURL(p),p=m[t.title].wave,g.src=URL.createObjectURL(p),N[e]?.length>0&&tuiVis.switchMode(N[e]),E.to(e)})});self.tuiVis=new _;tuiVis.addEventListener("reset",function(t){});tuiVis.addEventListener("mode",function(t){I.to(ft.indexOf(t.data))});var p,Ft=JSON.parse('{"extensions":[".mid",".MID"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}'),jt=JSON.parse('{"mimeTypes":["audio/*"],"startIn":"music","id":"audioOpener","description":"Open an audio file"}');y("#openMidi").addEventListener("click",async function(){E.to(-1),tuiVis.reset(),tuiVis.loadFile(await V(Ft))});y("#openAudio").addEventListener("click",async function(){p&&URL.revokeObjectURL(p),p=await V(jt),g.src=URL.createObjectURL(p)});var Gt=y("#bmDisp"),Kt=Gt.getContext("2d"),g=y("#audioPlayer"),A=y("#display");g.onended=function(){tuiVis.reset()};(async function(){tuiVis.reset();let t=await(await fetch("./demo/KANDI8.mid")).blob();m.KANDI8={},m.KANDI8.midi=t,tuiVis.loadFile(t),p&&URL.revokeObjectURL(p),p=await(await fetch("./demo/KANDI8.opus")).blob(),m.KANDI8.wave=p,g.src=URL.createObjectURL(p),A.innerHTML=`Demo A ready.${"<br/>".repeat(23)}`})();var Me=setInterval(function(){g.paused||(A.innerHTML=tuiVis.render(g.currentTime-(self.audioDelay||0),Kt))},20);})();
