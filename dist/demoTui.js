"use strict";(()=>{var mt=Object.create;var j=Object.defineProperty;var gt=Object.getOwnPropertyDescriptor;var yt=Object.getOwnPropertyNames;var vt=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty;var kt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var bt=(t,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of yt(e))!wt.call(t,r)&&r!==i&&j(t,r,{get:()=>e[r],enumerable:!(n=gt(e,r))||n.enumerable});return t};var It=(t,e,i)=>(i=t!=null?mt(vt(t)):{},bt(e||!t||!t.__esModule?j(i,"default",{value:t,enumerable:!0}):i,t));var q=kt((te,O)=>{(function(){"use strict";let t={debug:!1,parse:function(e,i){if(e instanceof Uint8Array)return t.Uint8(e);if(typeof e=="string")return t.Base64(e);if(e instanceof HTMLElement&&e.type==="file")return t.addListener(e,i);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,i){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(e===void 0||!(e instanceof HTMLElement)||e.tagName!=="INPUT"||e.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;i=i||function(){},e.addEventListener("change",function(n){if(!n.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let r=new FileReader;r.readAsArrayBuffer(n.target.files[0]),r.onload=function(s){i(t.Uint8(new Uint8Array(s.target.result)))}})},Base64:function(e){let i=function(s){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(s=s.replace(/^.*?base64,/,""),s=String(s).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(s))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");s+="==".slice(2-(3&s.length));let c,l="",o,d,f=0;for(;f<s.length;)c=a.indexOf(s.charAt(f++))<<18|a.indexOf(s.charAt(f++))<<12|(o=a.indexOf(s.charAt(f++)))<<6|(d=a.indexOf(s.charAt(f++))),l+=o===64?String.fromCharCode(c>>16&255):d===64?String.fromCharCode(c>>16&255,c>>8&255):String.fromCharCode(c>>16&255,c>>8&255,255&c);return l}(e=String(e));var n=i.length;let r=new Uint8Array(new ArrayBuffer(n));for(let s=0;s<n;s++)r[s]=i.charCodeAt(s);return t.Uint8(r)},Uint8:function(r){let i={data:null,pointer:0,movePointer:function(o){return this.pointer+=o,this.pointer},readInt:function(o){if((o=Math.min(o,this.data.byteLength-this.pointer))<1)return-1;let d=0;if(1<o)for(let f=1;f<=o-1;f++)d+=this.data.getUint8(this.pointer)*Math.pow(256,o-f),this.pointer++;return d+=this.data.getUint8(this.pointer),this.pointer++,d},readStr:function(o){let d="";for(let f=1;f<=o;f++)d+=String.fromCharCode(this.readInt(1));return d},backOne:function(){this.pointer--},readIntVLV:function(){let o=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)o=this.readInt(1);else{let f=[];for(;128<=this.data.getUint8(this.pointer);)f.push(this.readInt(1)-128);var d=this.readInt(1);for(let h=1;h<=f.length;h++)o+=f[f.length-h]*Math.pow(128,h);o+=d}return o}};if(i.data=new DataView(r.buffer,r.byteOffset,r.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let n={};n.formatType=i.readInt(2),n.tracks=i.readInt(2),n.track=[];var r=i.readInt(1),s=i.readInt(1);128<=r?(n.timeDivision=[],n.timeDivision[0]=r-128,n.timeDivision[1]=s):n.timeDivision=256*r+s;for(let o=1;o<=n.tracks;o++){n.track[o-1]={event:[]};var a,c=i.readInt(4);if(c===-1)break;if(c!==1297379947)return!1;i.readInt(4);let d=0,f=!1,h,u;for(;!f&&(d++,n.track[o-1].event[d-1]={},n.track[o-1].event[d-1].deltaTime=i.readIntVLV(),(h=i.readInt(1))!==-1);)if(128<=h?u=h:(h=u,i.movePointer(-1)),h===255){n.track[o-1].event[d-1].type=255,n.track[o-1].event[d-1].metaType=i.readInt(1);var l=i.readIntVLV();switch(n.track[o-1].event[d-1].metaType){case 47:case-1:f=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:n.track[o-1].event[d-1].data=i.readStr(l);break;case 33:case 89:case 81:n.track[o-1].event[d-1].data=i.readInt(l);break;case 84:n.track[o-1].event[d-1].data=[],n.track[o-1].event[d-1].data[0]=i.readInt(1),n.track[o-1].event[d-1].data[1]=i.readInt(1),n.track[o-1].event[d-1].data[2]=i.readInt(1),n.track[o-1].event[d-1].data[3]=i.readInt(1),n.track[o-1].event[d-1].data[4]=i.readInt(1);break;case 88:n.track[o-1].event[d-1].data=[],n.track[o-1].event[d-1].data[0]=i.readInt(1),n.track[o-1].event[d-1].data[1]=i.readInt(1),n.track[o-1].event[d-1].data[2]=i.readInt(1),n.track[o-1].event[d-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(n.track[o-1].event[d-1].data=this.customInterpreter(n.track[o-1].event[d-1].metaType,i,l)),this.customInterpreter!==null&&n.track[o-1].event[d-1].data!==!1||(i.readInt(l),n.track[o-1].event[d-1].data=i.readInt(l),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((h=h.toString(16).split(""))[1]||h.unshift("0"),n.track[o-1].event[d-1].type=parseInt(h[0],16),n.track[o-1].event[d-1].channel=parseInt(h[1],16),n.track[o-1].event[d-1].type){case 15:this.customInterpreter!==null&&(n.track[o-1].event[d-1].data=this.customInterpreter(n.track[o-1].event[d-1].type,i,!1)),this.customInterpreter!==null&&n.track[o-1].event[d-1].data!==!1||(a=i.readIntVLV(),n.track[o-1].event[d-1].data=i.readInt(a),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:n.track[o-1].event[d-1].data=[],n.track[o-1].event[d-1].data[0]=i.readInt(1),n.track[o-1].event[d-1].data[1]=i.readInt(1);break;case 12:case 13:n.track[o-1].event[d-1].data=i.readInt(1);break;case-1:f=!0;break;default:if(this.customInterpreter!==null&&(n.track[o-1].event[d-1].data=this.customInterpreter(n.track[o-1].event[d-1].metaType,i,!1)),this.customInterpreter===null||n.track[o-1].event[d-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return n},customInterpreter:null};if(typeof O<"u")O.exports=t;else{let e=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;e.MidiParser=t}})()});DOMTokenList.prototype.on=function(t){!this.contains(t)&&this.toggle(t)};DOMTokenList.prototype.off=function(t){this.contains(t)&&this.toggle(t)};var b=function(t,e=document){return e?.querySelector(t)},C=function(t,e=document){return Array.from(e?.querySelectorAll(t))};var T=class{#t={};addEventListener(t,e){this.#t[t]||(this.#t[t]=[]),this.#t[t].unshift(e)}removeEventListener(t,e){if(this.#t[t]){let i=this.#t[t].indexOf(e);i>-1&&this.#t[t].splice(i,1),this.#t[t].length<1&&delete this.#t[t]}}dispatchEvent(t,e){let i=new Event(t),n=this;i.data=e,this.#t[t]?.length>0&&this.#t[t].forEach(function(r){r?.call(n,i)}),this[`on${t}`]&&this[`on${t}`](i)}};var K=function(t,e){let i=Math.min(t.length,e.length),n=t.slice(0,i),r=e.slice(0,i),s=0,a=0;for(;a<i&&s==0;)s=Math.sign(n[a]-r[a]),a++;return s},L=function(){this.pool=[],this.point=function(t,e=!1){if(this.pool.length>0){let i=this.pool.length,n=1<<Math.floor(Math.log2(i)),r=n,s=64;for(;n>=1&&s>=0;){if(s<=0)throw new Error("TTL reached.");if(r==i)r-=n;else{let c=K(t,this.pool[r]);switch(c){case 0:{s=0;break}case 1:{r+n<=i&&(r+=n);break}case-1:{r!=0&&(r-=n);break}default:console.warn(`Unexpected result ${c}.`)}}n=n>>1,s--}let a=!0;if(r>=this.pool.length)a=!1;else{let c=this;this.pool[r].forEach(function(l,o,d){a&&l!=t[o]&&(a=!1)}),!a&&K(t,this.pool[r])>0&&r++}return a||e?r:-1}else return e?0:-1},this.add=function(t,e){return t.data=e,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match for "${t}". Default action not defined.`)},this.get=function(t){let e=this.point(t);if(e>-1)return this.pool[e].data;this.default(t)},this.run=function(t,...e){let i=this.point(t);i>-1?this.pool[i].data(t.slice(this.pool[i].length),...e):this.default(t,...e)}};var S=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw"],D={};S.forEach(function(t,e){D[t]=e});var X=[[0,0,0,0,0,0,0,56,82,81],[0,0,0,0,0,127,0,0,0,0]],Et=[0,32,81,84,88,89],v=function(t,e,i){i[e]=0},Mt=function(t){let e=[[]];return t?.forEach(function(i){i==247||(i==240?e.push([]):e[e.length-1].push(i))}),e},W=function(t,e="",i="",n=2){return t?`${e}${t.toString().padStart(n,"0")}${i}`:""},H=class extends T{#t=0;#l=new Array(256);#n=0;#r=new Array(64);#a=new Uint8ClampedArray(8192);#p=new Uint8ClampedArray(64);#c=new Uint8ClampedArray(8192);#i=new Uint16Array(512);#w=new Int16Array(64);#f=new Array(64);#m=0;#g=0;#y=100;#h=0;#u="";#v=0;#s=[];#o=[];#k={8:function(t){let e=t.part*128+t.data[0],i=this.#i.indexOf(e);i>-1&&(this.#i[i]=0,this.#c[e]=0)},9:function(t){this.#r[t.part]=1;let e=t.part*128+t.data[0];if(t.data[1]>0){let i=0;for(;this.#i[i]>0;)i++;i<512?(this.#i[i]=e,this.#c[e]=t.data[1]):console.error("Polyphony exceeded.")}else{let i=this.#i.indexOf(e);i>-1&&(this.#i[i]=0,this.#c[e]=0)}},10:function(t){let e=t.part*128+t.data[0];this.#i.indexOf(e)>-1&&(this.#c[e]=data[1])},11:function(t){this.#r[t.part]=1,t.data[0]==0&&t.part%16==9&&this.#t==D.gs&&(t.data[1]=120),this.#a[t.part*128+t.data[0]]=t.data[1]},12:function(t){this.#r[t.part]=1,this.#p[t.part]=t.data,this.#f[t.part]=0},13:function(t){let e=this;this.#i.forEach(function(i){let n=i>>7;t.part==n&&(e.#c[i]=t.data)}),console.info(t)},14:function(t){this.#w[t.part]=t.data[1]*128+t.data[0]-8192},15:function(t){let e=this;Mt(t.data).forEach(function(i){e.#d.run(i)})},255:function(t){if((this.#o[t.meta]||console.debug).call(this,t.data),Et.indexOf(t.meta)>-1)return t.reply="meta",t;self.debugMode&&console.debug(t)}};#d;#b;#e;getActive(){let t=this.#r.slice();return this.#t==D.mt32&&(t[0]=0),t}getCc(t){let e=t*128,i=Array.from(this.#a).slice(e,e+128);return i[0]=i[0]||this.#m,i[32]=i[32]||this.#g,i}getPitch(){return Array.from(this.#w)}getProgram(){return Array.from(this.#p)}getTexts(){return this.#s.slice()}getVel(t){let e=new Map,i=this;return this.#i.forEach(function(n){let r=n>>7,s=n&127;t==r&&i.#c[n]>0&&e.set(s,i.#c[n])}),e}getBitmap(){return{bitmap:this.#l.slice(),expire:this.#n}}getCustomNames(){return this.#f.slice()}getLetter(){return{text:this.#u,expire:this.#v}}getMode(){return S[this.#t]}getMaster(){return{volume:this.#y}}init(){this.dispatchEvent("mode","?"),this.#t=0,this.#m=0,this.#g=0,this.#h=0,this.#r.forEach(v),this.#a.forEach(v),this.#p.forEach(v),this.#c.forEach(v),this.#i.forEach(v),this.#y=100,this.#s=[],this.#v=0,this.#u="",this.#n=0,this.#l.forEach(v),this.#f.forEach(v),this.#a[1152]=127;for(let t=0;t<64;t++)this.#a[t*128+7]=127,this.#a[t*128+11]=127,this.#a[t*128+74]=127,this.#a[t*128+10]=127}switchMode(t,e=!1){let i=S.indexOf(t);if(i>-1)(this.#t==0||e)&&(this.#t=i,this.#m=X[0][i],this.#g=X[1][i],this.dispatchEvent("mode",t));else throw new Error(`Unknown mode ${t}`)}runJson(t){return this.#k[t.type].call(this,t)}runRaw(t){}constructor(){super();let t=this;self.seeReg=function(e){return Array.from(t.#a).slice(e*128,e*128+128)},this.#d=new L,this.#b=new L,this.#e=new L,this.#d.default=console.debug,this.#o[1]=function(e){this.#s.unshift(e)},this.#o[2]=function(e){this.#s.unshift(`Copyrite: ${e}`)},this.#o[3]=function(e){this.#s.unshift(`Trk.Info: ${e}`)},this.#o[4]=function(e){this.#s.unshift(`${W(this.#h,""," ")}Instrmnt: ${e}`)},this.#o[5]=function(e){this.#s.unshift(`C.Lyrics: ${e}`)},this.#o[6]=function(e){this.#s.unshift(`${W(this.#h,""," ")}C.Marker: ${e}`)},this.#o[7]=function(e){this.#s.unshift(`CuePoint: ${e}`)},this.#o[32]=function(e){this.#h=e[0]+1},this.#d.add([126,127,9,1],function(){t.switchMode("gm",!0),console.info("MIDI reset: GM")}).add([126,127,9,3],function(){t.switchMode("g2",!0),console.info("MIDI reset: GM2")}).add([65,16,22,18,127,1],function(){t.switchMode("mt32",!0),console.info("MIDI reset: MT-32")}).add([65,16,66,18,64,0,127,0,65],function(){t.switchMode("gs",!0),console.info("MIDI reset: GS")}).add([66,48,66,52,0],function(e){t.switchMode("ns5r",!0),console.info("KORG reset:",e)}).add([67,16,76,0,0,126,0],function(e){t.switchMode("xg",!0),console.info("MIDI reset: XG")}),this.#d.add([127,127,4,1],function(e){t.switchMode("gm"),t.#y=(e[1]<<7+e[0])/163.83}),this.#d.add([67,16,76,6,0],function(e){let i=e[0];t.#u=" ".repeat(i),t.#v=Date.now()+3200,e.slice(1).forEach(function(n){t.#u+=String.fromCharCode(n)})}).add([67,16,76,7,0,0],function(e){for(t.#n=Date.now()+3200;iMsg.length<48;)e.unshift(0);e.forEach(function(i,n){let r=Math.floor(n/16),s=n%16,a=(s*3+r)*7,c=7,l=0;for(a-=s*5,r==2&&(c=2);l<c;)t.#l[a+l]=i>>6-l&1,l++})}),this.#d.add([65,1],function(e){t.switchMode("mt32"),t.#e.run(e,1)}).add([65,2],function(e){t.switchMode("mt32"),t.#e.run(e,2)}).add([65,3],function(e){t.switchMode("mt32"),t.#e.run(e,3)}).add([65,4],function(e){t.switchMode("mt32"),t.#e.run(e,4)}).add([65,5],function(e){t.switchMode("mt32"),t.#e.run(e,5)}).add([65,6],function(e){t.switchMode("mt32"),t.#e.run(e,6)}).add([65,7],function(e){t.switchMode("mt32"),t.#e.run(e,7)}).add([65,8],function(e){t.switchMode("mt32"),t.#e.run(e,8)}).add([65,9],function(e){t.switchMode("mt32"),t.#r[9]=1,t.#e.run(e,9)}),this.#e.add([22,18,2,0,0],function(e,i){let n="";e.slice(0,10).forEach(function(r){r>31&&(n+=String.fromCharCode(r))}),t.#f[i]=n,console.debug(`MT-32 tone properties on channel ${i+1} (${n}): ${e.slice(10)}`)}),this.#d.add([65,16,69,18,16,1,0],function(e){t.#n=Date.now()+3200,e.forEach(function(i,n){if(n<64){let r=Math.floor(n/16),s=n%16,a=(s*4+r)*5,c=5,l=0;for(a-=s*4,r==3&&(c=1);l<c;)t.#l[a+l]=i>>4-l&1,l++}})})}};var N=It(q(),1);var z=class{#t=!1;constructor(t,e,i,n){this.#t=t,this.start=e,this.end=i,this.data=n}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#t}},U=class extends z{constructor(t,e,i){super(!0,t,e,i)}},Z=class extends z{constructor(t,e){super(!1,t,t,e)}},R=class extends Array{#t=-1;constructor(){super(...arguments)}resetIndex(t){this.#t=-1}fresh(){this.sort(function(t,e){return t.start==e.start?0:(+(t.start>e.start)<<1)-1}),this.forEach(function(t,e){t.index=e})}step(t,e=!1){let i=[];if(e)for(let n=0;n<this.length&&!(this[n].start>t);n++){if(this[n].end<t)continue;i.push(this[n])}else{let n=this.getRange(t-1,t),r=this;n.forEach(function(s){s.index>r.#t&&(i.push(s),r.#t=s.index)})}return i}getRange(t,e){t>e&&([t,e]=[e,t]);let i=[],n=-1,r=Math.ceil(Math.sqrt(this.length)),s=!0;for(let a=0;a<this.length;a+=r)this[a+r]?n<0&&this[a+r].start>=t&&(n=a):n=n<0?a:n;for(;s;)this[n]?.end<e?this[n].start>=t&&i.push(this[n]):s=!1,n++;return i}};var xt=0xffffffffffff,J=function(t){let e=new R,i=this,n=t.timeDivision,r=120,s=new R,a=0,c=0;s.push(new U(0,xt,[120,0])),t.track.forEach(function(f){a=0,f.event.forEach(function(h){a+=h.deltaTime,h.type==255&&h?.metaType==81&&(r=6e7/h.data,s[s.length-1]&&s.push(new U(a,0xffffffffffff,[r,0])))})}),s.fresh(),s.forEach(function(f,h,u){h>0&&(u[h-1].end=f.start)});let l=120;s.forEach(function(f,h,u){h>0&&(f.end==f.start?u.splice(u.indexOf(f),1):l==f.data[0]&&(u[h-1].end=f.end,u.splice(u.indexOf(f),1)),l=f.data[0])});let o=0,d=120;return s.forEach(function(f){let h=f.start,u=h/d/n*60+o;d=f.data[0],o=u-h/d/n*60,f.data[1]=o}),console.debug("All tempo changes: ",s),r=120,a=0,c=0,t.track.forEach(function(f,h){a=0,c=0,f.event.forEach(function(u,A){a+=u.deltaTime;let P=s.step(a,!0)[0];P&&(r=P.data[0],c=P.data[1]);let $={type:u.type,data:u.data,track:h,part:0};u.type>14?$.meta=u.metaType:$.part=u.channel,e.push(new Z(a/r/n*60+c,$))})}),e.fresh(),e};var At=["MSB","PRG","LSB"];var Y=class{#t=[];get(t=0,e=0,i=0){let n,r=Array.from(arguments);r[0]==127&&r[2]==0&&r[1]>111&&(r[1]=0),r[0]==0&&r[2]>111&&r[2]<120&&(r[2]=0);let s=" ";for(;!(n?.length>0);)n=this.#t[r[1]||0][(r[0]<<7)+r[2]],n||(r[2]=0,s="^",this.#t[r[1]||0][r[0]<<7]||(r[0]=0,s="*"));s!=" "&&self.debugMode&&(n="");let a="??";switch(r[0]){case 0:{r[2]==0?a="GM":r[2]<120?a="XG":r[2]==127&&(a="MT");break}case 56:{a="AG";break}case 61:case 83:{a="AI";break}case 62:case 82:{a="XD";break}case 81:{a="RW";break}case 64:case 121:case 126:{a="XG";break}case 127:{a=i==127?"MT":"XG";break}case 120:a="GS";default:r[0]<40&&(a="GS")}return{name:n||(t||0).toString().padStart(3,"0")+" "+(e||0).toString().padStart(3,"0")+" "+(i||0).toString().padStart(3,"0"),ending:s,standard:a}}load(t){let e=this,i=[];t.split(`
`).forEach(function(n,r){let s=n.split("	"),a=[];r==0?(s.forEach(function(c,l){i[At.indexOf(c)]=l}),console.info(`Bank map significance: ${i}`)):s.forEach(function(c,l){l>2?(e.#t[a[i[1]]]=e.#t[a[i[1]]]||[],e.#t[a[i[1]]][(a[i[0]]<<7)+a[i[2]]]=s[3]):a.push(parseInt(s[l]))})})}async loadFiles(...t){this.#t=[];let e=this;for(let i=0;i<t.length;i++)await fetch(`./data/bank/${t[i]}.tsv`).then(function(n){return console.info(`Parsing voice map: ${t[i]}`),n.text()}).then(function(n){e.load.call(e,n)})}constructor(...t){this.loadFiles(...t)}};var _=function(t){let e=Array.from("----");if(t>0)for(let i=0;t>0;i++)e[i]=t<1024?"=":">",t-=2048;else if(t<0)for(let i=3;t<0;i--)e[i]=t>=-1024?"=":"<",t+=2048;return e.join("")},Q=function(t){let e=Array.from("----");if(t>64)for(let i=0;t>64;i++)e[i]=t<72?"=":">",t-=16;else if(t<64)for(let i=3;t<64;i--)e[i]=t>=56?"=":"<",t+=16;return e.join("")};var Tt=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],Lt="!0123456789";var w="0123456789_aAbBcCdDeEfFgGhHiIjJ-kKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ",Pt=["-","~","+","|"],$t={"?":"UnkwnStd",gm:"GnrlMIDI",g2:"GrlMIDI2",xg:"YamahaXG",gs:"RolandGS",mt32:"RlndMT32",ag10:"KorgAG10",x5d:"Korg X5D","05rw":"Korg05RW",ns5r:"KorgNS5R"};N.default.customInterpreter=function(t,e,i){let n=[],r=i==!1?e.readIntVLV():i;t==127&&(r=1);for(let s=0;s<r;s++){let a=e.readInt(1);if(n.push(a),a!=247){if(a!=240){if(a>127)return console.debug(`Early termination: ${n}`),e.backOne(),e.backOne(),n}}}return n};var Ct=class extends T{#t=new H;#l;#n="";voices=new Y("xg","gs","ns5r");#r=[];reset(){this.dispatchEvent("reset"),this.#l?.resetIndex(),this.#t.init(),this.#n=""}async loadFile(t){this.#l=J(N.default.parse(new Uint8Array(await t.arrayBuffer())))}switchMode(t,e=!1){this.#t.switchMode(t,e)}getMode(){return this.#t.mode}render(t){let e=this.#l.step(t),i=0,n=new Set,r=this,s=[];e.forEach(function(h){let u=h.data;u.type==9&&(u.data[1]>0?n.add(u.part*128+u.data[0]):n.has(u.part*128+u.data[0])&&i++),h.data.type==8&&n.has(u.part*128+u.data[0])&&i++;let A=r.#t.runJson(u);switch(A?.reply){case"meta":{s.push(A);break}}A?.reply&&delete A.reply}),s?.length>0&&this.dispatchEvent("meta",s);let a=this.#t.getActive(),c=[],l=r.#t.getPitch(),o=[],d=r.#t.getProgram(),f=0;return a.forEach(function(h,u){h&&(c[u]=r.#t.getVel(u),o[u]=r.#t.getCc(u),f+=c[u].size)}),{extraPoly:i,curPoly:f,chInUse:a,chKeyPr:c,chPitch:l,chProgr:d,chContr:o,eventCount:e.length,title:this.#n,bitmap:this.#t.getBitmap(),letter:this.#t.getLetter(),names:this.#t.getCustomNames(),texts:this.#t.getTexts(),master:this.#t.getMaster(),mode:this.#t.getMode()}}constructor(){super();let t=this;this.addEventListener("meta",function(e){e?.data?.forEach(function(i){(t.#r[i.meta]||console.debug).call(t,i.meta,i.data)})}),this.#t.addEventListener("mode",function(e){t.dispatchEvent("mode",e.data)}),this.#r[3]=function(e,i){t.#n?.length<1&&(t.#n=i)}}},tt=class extends Ct{#t=new Array(64);constructor(){super();for(let t=0;t<this.#t.length;t++)this.#t[t]=0,console.info("a")}render(t,e){let i=new Array(24),n=super.render(t),r=this,s=Date.now();i[0]=`${n.eventCount.toString().padStart(3,"0")} Poly:${(n.curPoly+n.extraPoly).toString().padStart(3,"0")}/512 Vol:${Math.floor(n.master.volume)}.${Math.round(n.master.volume%1*100).toString().padStart(2,"0")}%`,i[1]=`Mode:${$t[n.mode]} Title:${n.title||"N/A"}`,i[2]="Ch:VoiceNme#St VEM RCDB PP PiBd Pan : Note";let a=3;if(this.#t.forEach(function(c,l,o){o[l]=c>>1}),n.chInUse.forEach(function(c,l){if(c){let o=r.voices.get(n.chContr[l][0],n.chProgr[l],n.chContr[l][32]);n.names[l]&&(o.name=n.names[l],o.ending="~"),i[a]=`${(l+1).toString().padStart(2,"0")}:${o.name.slice(0,8).padEnd(8," ")}${o.ending}${o.standard} ${w[n.chContr[l][7]>>1]}${w[n.chContr[l][11]>>1]}${Pt[n.chContr[l][1]>>5]} ${w[n.chContr[l][91]>>1]}${w[n.chContr[l][93]>>1]}${w[n.chContr[l][94]>>1]}${w[n.chContr[l][74]>>1]} ${n.chContr[l][65]>63?"O":"X"}${w[n.chContr[l][5]>>1]} ${_(n.chPitch[l])} ${Q(n.chContr[l][10])}:`,n.chKeyPr[l].forEach(function(d,f){if(d>0){let h=Math.max(r.#t[l],d);r.#t[l]=h-r.#t[l]>32?r.#t[l]+48:h,i[a]+=` <span style="opacity:${Math.round(d/1.27)/100}">${Tt[f%12]}${Lt[Math.floor(f/12)]}</span>`}}),a++}}),n.texts.length>0){let c=0;for(let l=i.length-1;l>=a;l--)i[l]=(n.texts[c]||"").padEnd(100," "),c++}if(s<=n.letter.expire){let c=n.letter.text.padEnd(32," "),l=i.length-2;for(let o=0;o<2;o++)i[o+l]=`${(i[o+l]||"").slice(0,82).padEnd(81)} <span class="letter"> ${c.slice(o*16,o*16+16).padEnd(" ",16)} </span>`}if(e.clearRect(0,0,e.canvas.width,e.canvas.height),e){e.fillStyle="#202020";let c;s<=n.bitmap.expire?c=n.bitmap.bitmap:(c=new Array(256),r.#t.forEach(function(l,o){if(o<16&&n.chContr[o]?.length>0){let d=Math.floor(l*n.chContr[o][7]*n.chContr[o][11]/129032);for(let f=0;f<=d;f++)c[o+(15-f)*16]=1}})),c.forEach(function(l,o){l&&e.fillRect(o%16*12,Math.floor(o/16)*6,11,5)})}return i.join("<br/>")}};var St=Object.defineProperty,I=(t,e)=>()=>(t&&(e=t(t=0)),e),E=(t,e)=>{for(var i in e)St(t,i,{get:e[i],enumerable:!0})},it={};E(it,{default:()=>nt});var nt,Dt=I(()=>{nt=async(t=[{}])=>(Array.isArray(t)||(t=[t]),new Promise((e,i)=>{let n=document.createElement("input");n.type="file";let r=[...t.map(l=>l.mimeTypes||[]).join(),t.map(l=>l.extensions||[]).join()].join();n.multiple=t[0].multiple||!1,n.accept=r||"";let s=()=>c(i),a=l=>{typeof c=="function"&&c(),e(l)},c=t[0].legacySetup&&t[0].legacySetup(a,s,n);n.addEventListener("change",()=>{a(n.multiple?Array.from(n.files):n.files[0])}),n.click()}))}),rt={};E(rt,{default:()=>at});var et,at,Ot=I(()=>{et=async t=>{let e=await t.getFile();return e.handle=t,e},at=async(t=[{}])=>{Array.isArray(t)||(t=[t]);let e=[];t.forEach((r,s)=>{e[s]={description:r.description||"",accept:{}},r.mimeTypes?r.mimeTypes.map(a=>{e[s].accept[a]=r.extensions||[]}):e[s].accept["*/*"]=r.extensions||[]});let i=await window.showOpenFilePicker({id:t[0].id,startIn:t[0].startIn,types:e,multiple:t[0].multiple||!1,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),n=await Promise.all(i.map(et));return t[0].multiple?n:n[0]}}),st={};E(st,{default:()=>ot});var ot,Ut=I(()=>{ot=async(t=[{}])=>(Array.isArray(t)||(t=[t]),t[0].recursive=t[0].recursive||!1,new Promise((e,i)=>{let n=document.createElement("input");n.type="file",n.webkitdirectory=!0;let r=()=>a(i),s=c=>{typeof a=="function"&&a(),e(c)},a=t[0].legacySetup&&t[0].legacySetup(s,r,n);n.addEventListener("change",()=>{let c=Array.from(n.files);t[0].recursive?t[0].recursive&&t[0].skipDirectory&&(c=c.filter(l=>l.webkitRelativePath.split("/").every(o=>!t[0].skipDirectory({name:o,kind:"directory"})))):c=c.filter(l=>l.webkitRelativePath.split("/").length===2),s(c)}),n.click()}))}),lt={};E(lt,{default:()=>ct});var V,ct,Rt=I(()=>{V=async(t,e,i=t.name,n)=>{let r=[],s=[];for await(let a of t.values()){let c=`${i}/${a.name}`;a.kind==="file"?s.push(a.getFile().then(l=>(l.directoryHandle=t,l.handle=a,Object.defineProperty(l,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):a.kind==="directory"&&e&&(!n||!n(a))&&r.push(V(a,e,c,n))}return[...(await Promise.all(r)).flat(),...await Promise.all(s)]},ct=async(t={})=>{t.recursive=t.recursive||!1;let e=await window.showDirectoryPicker({id:t.id,startIn:t.startIn});return V(e,t.recursive,void 0,t.skipDirectory)}}),dt={};E(dt,{default:()=>ft});async function Nt(t,e){let i=t.getReader(),n=new ReadableStream({start(s){return a();async function a(){return i.read().then(({done:c,value:l})=>{if(c){s.close();return}return s.enqueue(l),a()})}}}),r=new Response(n);return i.releaseLock(),new Blob([await r.blob()],{type:e})}var ft,Vt=I(()=>{ft=async(t,e={})=>{Array.isArray(e)&&(e=e[0]);let i=document.createElement("a"),n=t;"body"in t&&(n=await Nt(t.body,t.headers.get("content-type"))),i.download=e.fileName||"Untitled",i.href=URL.createObjectURL(n);let r=()=>a(reject),s=()=>{typeof a=="function"&&a()},a=e.legacySetup&&e.legacySetup(s,r,i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),30*1e3),s(null)}),i.click(),null}}),ht={};E(ht,{default:()=>ut});var ut,Bt=I(()=>{ut=async(t,e=[{}],i=null,n=!1)=>{Array.isArray(e)||(e=[e]),e[0].fileName=e[0].fileName||"Untitled";let r=[];if(e.forEach((c,l)=>{r[l]={description:c.description||"",accept:{}},c.mimeTypes?(l===0&&(t.type?c.mimeTypes.push(t.type):t.headers&&t.headers.get("content-type")&&c.mimeTypes.push(t.headers.get("content-type"))),c.mimeTypes.map(o=>{r[l].accept[o]=c.extensions||[]})):t.type&&(r[l].accept[t.type]=c.extensions||[])}),i)try{await i.getFile()}catch(c){if(i=null,n)throw c}let s=i||await window.showSaveFilePicker({suggestedName:e[0].fileName,id:e[0].id,startIn:e[0].startIn,types:r,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),a=await s.createWritable();return"stream"in t?(await t.stream().pipeTo(a),s):"body"in t?(await t.body.pipeTo(a),s):(await a.write(blob),await a.close(),s)}}),Ft=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),B=Ft,Gt=B?Promise.resolve().then(()=>(Ot(),rt)):Promise.resolve().then(()=>(Dt(),it));async function F(...t){return(await Gt).default(...t)}var we=B?Promise.resolve().then(()=>(Rt(),lt)):Promise.resolve().then(()=>(Ut(),st));var ke=B?Promise.resolve().then(()=>(Bt(),ht)):Promise.resolve().then(()=>(Vt(),dt));var g={},G=[];G[2]="x5d";var M=C("b.mode"),pt=[];M.to=function(t){M.forEach(function(e){e.classList.off("active")}),t>-1&&M[t].classList.on("active")};M.forEach(function(t,e,i){pt[e]=t.title,t.addEventListener("click",function(){tuiVis.switchMode(t.title,!0),M.to(e)})});var x=C("b.demo");x.to=function(t){x.forEach(function(e){e.classList.off("active")}),t>-1&&x[t].classList.on("active")};x.forEach(function(t,e,i){t.addEventListener("click",async function(){y.pause(),g[t.title]?.midi||(g[t.title]={},m.innerHTML=`Loading demo ${t.innerText.toUpperCase()}.${"<br/>".repeat(23)}`,g[t.title].midi=await(await fetch(`./demo/${t.title}.mid`)).blob(),g[t.title].wave=await(await fetch(`./demo/${t.title}.opus`)).blob()),m.innerHTML=`Demo ${t.innerText.toUpperCase()} ready.${"<br/>".repeat(23)}`,y.currentTime=0,tuiVis.reset(),tuiVis.loadFile(g[t.title].midi),p&&URL.revokeObjectURL(p),p=g[t.title].wave,y.src=URL.createObjectURL(p),G[e]?.length>0&&tuiVis.switchMode(G[e]),x.to(e)})});self.tuiVis=new tt;tuiVis.addEventListener("reset",function(t){});tuiVis.addEventListener("mode",function(t){M.to(pt.indexOf(t.data))});var p,jt=JSON.parse('{"extensions":[".mid",".MID"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}'),Kt=JSON.parse('{"mimeTypes":["audio/*"],"startIn":"music","id":"audioOpener","description":"Open an audio file"}');b("#openMidi").addEventListener("click",async function(){x.to(-1),tuiVis.reset(),tuiVis.loadFile(await F(jt))});b("#openAudio").addEventListener("click",async function(){p&&URL.revokeObjectURL(p),p=await F(Kt),y.src=URL.createObjectURL(p)});var k=b("#bmDisp"),Xt=k.getContext("2d"),y=b("#audioPlayer"),m=b("#display");k.style.left=`${m.offsetLeft+m.offsetWidth-k.offsetWidth}px`;k.style.top=`${m.offsetTop}px`;y.onended=function(){tuiVis.reset()};(async function(){tuiVis.reset();let t=await(await fetch("./demo/KANDI8.mid")).blob();g.KANDI8={},g.KANDI8.midi=t,tuiVis.loadFile(t),p&&URL.revokeObjectURL(p),p=await(await fetch("./demo/KANDI8.opus")).blob(),g.KANDI8.wave=p,y.src=URL.createObjectURL(p),m.innerHTML=`Demo A ready.${"<br/>".repeat(23)}`})();var Ae=setInterval(function(){y.paused||(m.innerHTML=tuiVis.render(y.currentTime-(self.audioDelay||0),Xt))},20);addEventListener("resize",function(){k.style.left=`${m.offsetLeft+m.offsetWidth-k.offsetWidth}px`,k.style.top=`${m.offsetTop}px`});})();
