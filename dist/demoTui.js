"use strict";(()=>{var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty;var __commonJS=(cb,mod)=>function(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target,mod));var require_main_min=__commonJS({"libs/midi-parser@colxi/main.min.js"(exports,module){(function(){"use strict";let n={debug:!1,parse:function(e,t){if(e instanceof Uint8Array)return n.Uint8(e);if(typeof e=="string")return n.Base64(e);if(e instanceof HTMLElement&&e.type==="file")return n.addListener(e,t);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,r){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(e===void 0||!(e instanceof HTMLElement)||e.tagName!=="INPUT"||e.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;r=r||function(){},e.addEventListener("change",function(e2){if(!e2.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let t=new FileReader;t.readAsArrayBuffer(e2.target.files[0]),t.onload=function(e3){r(n.Uint8(new Uint8Array(e3.target.result)))}})},Base64:function(e){let t=function(e2){var t2="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(e2=e2.replace(/^.*?base64,/,""),e2=String(e2).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(e2))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");e2+="==".slice(2-(3&e2.length));let r2,a2="",n2,i,d2=0;for(;d2<e2.length;)r2=t2.indexOf(e2.charAt(d2++))<<18|t2.indexOf(e2.charAt(d2++))<<12|(n2=t2.indexOf(e2.charAt(d2++)))<<6|(i=t2.indexOf(e2.charAt(d2++))),a2+=n2===64?String.fromCharCode(r2>>16&255):i===64?String.fromCharCode(r2>>16&255,r2>>8&255):String.fromCharCode(r2>>16&255,r2>>8&255,255&r2);return a2}(e=String(e));var r=t.length;let a=new Uint8Array(new ArrayBuffer(r));for(let e2=0;e2<r;e2++)a[e2]=t.charCodeAt(e2);return n.Uint8(a)},Uint8:function(e){let i={data:null,pointer:0,movePointer:function(e2){return this.pointer+=e2,this.pointer},readInt:function(t2){if((t2=Math.min(t2,this.data.byteLength-this.pointer))<1)return-1;let r=0;if(1<t2)for(let e2=1;e2<=t2-1;e2++)r+=this.data.getUint8(this.pointer)*Math.pow(256,t2-e2),this.pointer++;return r+=this.data.getUint8(this.pointer),this.pointer++,r},readStr:function(t2){let r="";for(let e2=1;e2<=t2;e2++)r+=String.fromCharCode(this.readInt(1));return r},backOne:function(){this.pointer--},readIntVLV:function(){let r=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)r=this.readInt(1);else{let t2=[];for(;128<=this.data.getUint8(this.pointer);)t2.push(this.readInt(1)-128);var e2=this.readInt(1);for(let e3=1;e3<=t2.length;e3++)r+=t2[t2.length-e3]*Math.pow(128,e3);r+=e2}return r}};if(i.data=new DataView(e.buffer,e.byteOffset,e.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let d2={};d2.formatType=i.readInt(2),d2.tracks=i.readInt(2),d2.track=[];var e=i.readInt(1),t=i.readInt(1);128<=e?(d2.timeDivision=[],d2.timeDivision[0]=e-128,d2.timeDivision[1]=t):d2.timeDivision=256*e+t;for(let n2=1;n2<=d2.tracks;n2++){d2.track[n2-1]={event:[]};var s,o2=i.readInt(4);if(o2===-1)break;if(o2!==1297379947)return!1;i.readInt(4);let e2=0,t2=!1,r,a;for(;!t2&&(e2++,d2.track[n2-1].event[e2-1]={},d2.track[n2-1].event[e2-1].deltaTime=i.readIntVLV(),(r=i.readInt(1))!==-1);)if(128<=r?a=r:(r=a,i.movePointer(-1)),r===255){d2.track[n2-1].event[e2-1].type=255,d2.track[n2-1].event[e2-1].metaType=i.readInt(1);var c=i.readIntVLV();switch(d2.track[n2-1].event[e2-1].metaType){case 47:case-1:t2=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:d2.track[n2-1].event[e2-1].data=i.readStr(c);break;case 33:case 89:case 81:d2.track[n2-1].event[e2-1].data=i.readInt(c);break;case 84:d2.track[n2-1].event[e2-1].data=[],d2.track[n2-1].event[e2-1].data[0]=i.readInt(1),d2.track[n2-1].event[e2-1].data[1]=i.readInt(1),d2.track[n2-1].event[e2-1].data[2]=i.readInt(1),d2.track[n2-1].event[e2-1].data[3]=i.readInt(1),d2.track[n2-1].event[e2-1].data[4]=i.readInt(1);break;case 88:d2.track[n2-1].event[e2-1].data=[],d2.track[n2-1].event[e2-1].data[0]=i.readInt(1),d2.track[n2-1].event[e2-1].data[1]=i.readInt(1),d2.track[n2-1].event[e2-1].data[2]=i.readInt(1),d2.track[n2-1].event[e2-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(d2.track[n2-1].event[e2-1].data=this.customInterpreter(d2.track[n2-1].event[e2-1].metaType,i,c)),this.customInterpreter!==null&&d2.track[n2-1].event[e2-1].data!==!1||(i.readInt(c),d2.track[n2-1].event[e2-1].data=i.readInt(c),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((r=r.toString(16).split(""))[1]||r.unshift("0"),d2.track[n2-1].event[e2-1].type=parseInt(r[0],16),d2.track[n2-1].event[e2-1].channel=parseInt(r[1],16),d2.track[n2-1].event[e2-1].type){case 15:this.customInterpreter!==null&&(d2.track[n2-1].event[e2-1].data=this.customInterpreter(d2.track[n2-1].event[e2-1].type,i,!1)),this.customInterpreter!==null&&d2.track[n2-1].event[e2-1].data!==!1||(s=i.readIntVLV(),d2.track[n2-1].event[e2-1].data=i.readInt(s),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:d2.track[n2-1].event[e2-1].data=[],d2.track[n2-1].event[e2-1].data[0]=i.readInt(1),d2.track[n2-1].event[e2-1].data[1]=i.readInt(1);break;case 12:case 13:d2.track[n2-1].event[e2-1].data=i.readInt(1);break;case-1:t2=!0;break;default:if(this.customInterpreter!==null&&(d2.track[n2-1].event[e2-1].data=this.customInterpreter(d2.track[n2-1].event[e2-1].metaType,i,!1)),this.customInterpreter===null||d2.track[n2-1].event[e2-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return d2},customInterpreter:null};if(typeof module<"u")module.exports=n;else{let e=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;e.MidiParser=n}})()}});DOMTokenList.prototype.on=function(classNme){!this.contains(classNme)&&this.toggle(classNme)};DOMTokenList.prototype.off=function(classNme){this.contains(classNme)&&this.toggle(classNme)};var $e=function(selector,source=document){return source?.querySelector(selector)},$a=function(selector,source=document){return Array.from(source?.querySelectorAll(selector))};var textedPitchBend=function(number){let result=Array.from("----");if(number>0)for(let c=0;number>0;c++)result[c]=number<1024?"=":">",number-=2048;else if(number<0)for(let c=3;number<0;c--)result[c]=number>=-1024?"=":"<",number+=2048;return result.join("")},textedPanning=function(number){if(number==128)return"<<>>";let result=Array.from("----");if(number>64)for(let c=0;number>64;c++)result[c]=number<72?"=":">",number-=16;else if(number<64)for(let c=3;number<64;c--)result[c]=number>=56?"=":"<",number+=16;return result.join("")};var CustomEventSource=class{#eventListeners={};addEventListener(type,callback){this.#eventListeners[type]||(this.#eventListeners[type]=[]),this.#eventListeners[type].unshift(callback)}removeEventListener(type,callback){if(this.#eventListeners[type]){let index=this.#eventListeners[type].indexOf(callback);index>-1&&this.#eventListeners[type].splice(index,1),this.#eventListeners[type].length<1&&delete this.#eventListeners[type]}}dispatchEvent(type,data2){let eventObj=new Event(type),upThis=this;eventObj.data=data2,this.#eventListeners[type]?.length>0&&this.#eventListeners[type].forEach(function(e){e?.call(upThis,eventObj)}),this[`on${type}`]&&this[`on${type}`](eventObj)}};var compArr=function(a,b){let minL=Math.min(a.length,b.length),c=a.slice(0,minL),d2=b.slice(0,minL),result=0,pointer=0;for(;pointer<minL&&result==0;)result=Math.sign(c[pointer]-d2[pointer]),pointer++;return result},BinaryMatch=function(){this.pool=[],this.point=function(prefix,insert=!1){if(this.pool.length>0){let bound=this.pool.length,bs=1<<Math.floor(Math.log2(bound)),pp=bs,ttl=64;for(;bs>=1&&ttl>=0;){if(ttl<=0)throw new Error("TTL reached.");if(pp==bound)pp-=bs;else{let result=compArr(prefix,this.pool[pp]);switch(result){case 0:{ttl=0;break}case 1:{pp+bs<=bound&&(pp+=bs);break}case-1:{pp!=0&&(pp-=bs);break}default:console.warn(`Unexpected result ${result}.`)}}bs=bs>>1,ttl--}let match=!0;if(pp>=this.pool.length)match=!1;else{let upThis=this;this.pool[pp].forEach(function(e,i,a){match&&e!=prefix[i]&&(match=!1)}),!match&&compArr(prefix,this.pool[pp])>0&&pp++}return match||insert?pp:-1}else return insert?0:-1},this.add=function(prefix,data2){return prefix.data=data2,this.pool.splice(this.point(prefix,!0),0,prefix),this},this.default=function(info){console.warn(`No match for "${info}". Default action not defined.`)},this.get=function(prefix){let idx=this.point(prefix);if(idx>-1)return this.pool[idx].data;this.default(prefix)},this.run=function(prefix,...additional){let idx=this.point(prefix);idx>-1?this.pool[idx].data(prefix.slice(this.pool[idx].length),...additional):this.default(prefix,...additional)}};var sgCrit=["MSB","PRG","LSB"];var halfHex=function(n){let segA=Math.floor(n/10),segB=n%10;return`${segA.toString(16)}${segB}`},VoiceBank=class{#bankInfo;strictMode=!1;get(msb=0,prg=0,lsb=0,mode){let bankName,args=Array.from(arguments);switch(mode){case"xg":msb==32||msb==33?args[2]+=4:msb==80?args[0]=96:msb==81?args[0]=97:msb==82&&(args[0]=98);case"gs":{msb==0&&lsb<5&&(args[2]=0);break}case"sg":{msb==8&&lsb==0&&(args[2]=5);break}}let ending=" ",sect="M",useLsb=!1,baseShift=0;switch(args[0]){case 0:{args[2]==127?sect="MT-a":args[2]==126?sect="MT-b":args[2]==7?sect="GM-k":args[2]==5?sect="SG-a":args[2]==4?sect="SP-l":args[2]==0||mode=="gs"&&args[2]<5?sect="GM-a":(sect="y",useLsb=!0);break}case 8:{mode=="sg"?sect="GM-s":sect="r:";break}case 48:{sect=`yM${(args[2]>>3).toString().padStart(2,"0")}`,useLsb=!0;break}case 56:{sect="GM-b";break}case 61:case 120:{sect="rDrm";break}case 62:{sect="kDrm";break}case 63:{let kLsb=args[2];sect=kLsb<10?"kP:":"kC:",sect+=kLsb%10;break}case 64:{sect="ySFX";break}case 80:case 81:case 82:case 83:{sect=`Prg${"UABC"[args[0]-80]}`;break}case 88:case 89:case 90:case 91:{sect=`Cmb${"UABC"[args[0]-88]}`;break}case 96:{sect=args[2]==106?"AP-a":"PF",args[2]>63&&(baseShift=63),useLsb=!0;break}case 97:{sect="VL:",useLsb=!0,baseShift=112;break}case 98:{sect="SG-a";break}case 121:{sect="GM-",useLsb=!0;break}case 122:{sect="lDrm";break}case 126:{sect="yDrS";break}case 127:{args[2]==127?sect="rDrm":sect="yDrm";break}default:args[0]<48?sect="r:":sect="M"}for(sect.length<4&&(sect+=`${(useLsb?lsb:msb)-baseShift}`.padStart(4-sect.length,"0"));!(bankName?.length>=0);)bankName=this.#bankInfo[args[1]||0][(args[0]<<7)+args[2]],bankName||(this.strictMode?(bankName="",ending="?"):this.#bankInfo[args[1]||0][args[0]<<7]?args[0]==0?(args[2]=0,ending="^"):args[2]<1?(args[0]=0,ending="*"):(args[2]--,ending="^"):msb==48?(args[0]=0,args[2]=0,ending="!"):msb==62?(args[1]--,ending=" ",args[1]<1&&!bankName?.length&&(args[0]=0,ending="!")):msb<64?mode=="xg"&&msb==16?(bankName=`Voice${(lsb*128+prg+1).toString().padStart(3,"0")}`,ending=" "):args[0]==0?(args[2]=0,ending="^"):args[2]<1?(args[0]=0,ending="*"):args[2]--:msb==80?(bankName=`PrgU:${prg.toString().padStart(3,"0")}`,ending="!"):msb==88?(bankName=`CmbU:${prg.toString().padStart(3,"0")}`,ending="!"):msb==121?(bankName=`GM2Vox0${lsb}`,ending="#"):msb==122?(args[1]==32?args[1]==0:args[1]%=7,bankName=this.#bankInfo[args[1]||0][(args[0]<<7)+args[2]],bankName?ending=" ":(bankName="",ending="*")):args[1]==0?(bankName=`${msb.toString().padStart(3,"0")} ${prg.toString().padStart(3,"0")} ${lsb.toString().padStart(3,"0")}`,ending="!"):args[0]==0?(args[2]=0,ending="^"):args[2]>0?args[2]--:args[1]>0?(args[1]=0,ending="!"):(args[0]=0,ending="?"));(mode=="gs"||mode=="ns5r")&&ending=="^"&&(ending=" "),msb==127&&ending=="^"&&(ending=" "),ending!=" "&&self.debugMode&&(bankName="");let standard="??";switch(args[0]){case 0:{args[2]==0?standard="GM":args[2]==5||args[2]==7?standard="KG":args[2]<120?standard="XG":args[2]==127&&(standard="MT");break}case 48:{standard="MU";break}case 56:{standard="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{standard="AI";break}case 62:case 82:case 90:{standard="XD";break}case 63:standard="KR";case 64:case 126:{standard="XG";break}case 81:{standard="RW";break}case 96:{standard=args[2]==106?"AP":"PF";break}case 97:{standard="VL";break}case 98:{standard="SG";break}case 120:{standard="GS";break}case 121:{standard="G2";break}case 122:{standard="KG";break}case 127:{standard=args[2]==127?"MT":prg==0?"GM":"XG";break}default:args[0]<48&&(args[0]==16&&mode=="xg"?standard="XG":standard="GS")}return{name:bankName||`${halfHex(msb||0)} ${halfHex(prg||0)} ${halfHex(lsb||0)}`,ending,sect,standard}}async load(text,allowOverwrite,name2){let upThis=this,sig=[],loadCount=0,allCount=0;text.split(`
`).forEach(function(e,i){let assign=e.split("	"),to=[];i==0?assign.forEach(function(e0,i0){sig[sgCrit.indexOf(e0)]=i0}):assign.forEach(async function(e1,i1){i1>2?(upThis.#bankInfo[to[sig[1]]]=upThis.#bankInfo[to[sig[1]]]||[],(!upThis.#bankInfo[to[sig[1]]][(to[sig[0]]<<7)+to[sig[2]]]?.length||allowOverwrite)&&(upThis.#bankInfo[to[sig[1]]][(to[sig[0]]<<7)+to[sig[2]]]=assign[3],loadCount++),allCount++):to.push(parseInt(assign[i1]))})}),allowOverwrite||console.debug(`Map "${name2||"(internal)"}": ${allCount} total, ${loadCount} loaded.`)}clearRange(options){let prg=options.prg!=null?options.prg.constructor==Array?options.prg:[options.prg,options.prg]:[0,127],msb=options.msb!=null?options.msb.constructor==Array?options.msb:[options.msb,options.msb]:[0,127],lsb=options.lsb!=null?options.lsb.constructor==Array?options.lsb:[options.lsb,options.lsb]:[0,127];for(let cMsb=msb[0];cMsb<=msb[1];cMsb++){let precalMsb=cMsb<<7;for(let cLsb=lsb[0];cLsb<=lsb[1];cLsb++){let precalBnk=precalMsb+cLsb;for(let cPrg=prg[0];cPrg<=prg[1];cPrg++)delete this.#bankInfo[cPrg][precalBnk]}}}init(){this.#bankInfo=[];for(let prg=0;prg<128;prg++)this.#bankInfo.push([""])}async loadFiles(...type){this.init();let upThis=this;type.forEach(async function(e,i){await fetch(`./data/bank/${e}.tsv`).then(function(response){return response.text()}).then(text=>{upThis.load(text,!1,e)})})}constructor(...args){this.loadFiles(...args)}};var xgEffType=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),xgPartMode=["melodic","drum","drum set 1","drum set 2","drum set 3","drum set 4"],xgDelOffset=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],xgNormFreq=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],xgLfoFreq=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],getXgRevTime=function(data2){let a=.1,b=-.3;return data2>66?(a=5,b=315):data2>56?(a=1,b=47):data2>46&&(a=.5,b=18.5),a*data2-b},getXgDelayOffset=function(data2){return data2>105?xgDelOffset[data2-106]:data2>100?data2*1.1-100:data2/10},xgSgVocals=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),xgSgMap={};`hi*,
ka,\u304B
ki,\u304D
ku,\u304F
ke,\u3051
ko,\u3053
ky,\u304D!
kw,\u304Fl
tsu,\u3064
ts,\u3064l
sa,\u3055
si,\u3059\u3043
su,\u3059
se,\u305B
so,\u305D
shi,\u3057
sh,\u3057!
ta,\u305F
ti,\u3066\u3043
tu,\u3068\u3045
te,\u3066
to,\u3068
tchy,\u3061!
tchi,\u3061
na,\u306A
ni,\u306B
nu,\u306C
ne,\u306D
no,\u306E
ny,\u306B!
nn,\u3093
ha,\u306F
hi,\u3072
hu,\u307B\u3045
he,\u3078
ho,\u307B
hy,\u3072!
fa,\u3075\u3041
fi,\u3075\u3043
fu,\u3075
fe,\u3075\u3047
fo,\u3075\u3049
ma,\u307E
mi,\u307F
mu,\u3080
me,\u3081
mo,\u3082
my,\u307F!
mm,
ra,\u3089
ri,\u308A
ru,\u308B
re,\u308C
ro,\u308D
ry,\u308A!
wa,\u308F
wi,\u3046\u3043
we,\u3046\u3047
wo,\u3092
nga,\u30AC
ngi,\u30AE
ngu,\u30B0
nge,\u30B2
ngo,\u30B4
ngy,\u30AE!
ng,
ga,\u304C
gi,\u304E
gu,\u3050
ge,\u3052
go,\u3054
gy,\u304E!
gw,\u3050l
za,\u3056
zi,\u305A\u3043
zu,\u305A
ze,\u305C
zo,\u305E
ja,\u3058\u3083
ji,\u3058
ju,\u3058\u3085
je,\u3058\u3047
jo,\u3058\u3087
jy,\u3058!
da,\u3060
di,\u3067\u3043
du,\u3069\u3045
de,\u3067
do,\u3069
dy,\u3067!
ba,\u3070
bi,\u3073
bu,\u3076
be,\u3079
bo,\u307C
by,\u3073!
va,\u3094\u3041
vi,\u3094\u3043
vu,\u3094
ve,\u3094\u3047
vo,\u3094\u3049
pa,\u3071
pi,\u3074
pu,\u3077
pe,\u30DA
po,\u307D
py,\u3074!
!ya,\u3083
!yu,\u3085
!ye,\u3047
!yo,\u3087
ya,\u3084
yu,\u3086
ye,\u3044\u3047
yo,\u3088
!a,\u3083
!u,\u3085
!e,\u3047
!o,\u3087
!a,\u3083
!u,\u3085
!e,\u3047
!o,\u3087
la,\u3041
li,\u3043
lu,\u3045
le,\u3047
lo,\u3049
a,\u3042
i,\u3044
u,\u3046
e,\u3048
o,\u304A
*,\u3063
~,
^,
_,`.split(`
`).forEach(e=>{let param=e.split(",");xgSgMap[param[0]]=param[1]});var getSgKana=function(seq){let target=seq;seq[0]=="*"&&(target=target.slice(1)),["aa","ii","uu","ee","oo"].forEach(e=>{for(;target.indexOf(e)>-1;)target=target.replace(e,e[0])});for(let mark in xgSgMap)target=target.replaceAll(mark,xgSgMap[mark]);target.indexOf("\u3093")==0&&target.length>1&&(target=target.slice(1));let youOn=target.indexOf("!");return youOn>-1&&target.length>1&&(target=target.slice(youOn+1)),target};var gsRevType=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],gsChoType=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],gsDelType=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var gsEfx={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},gsEfxDesc={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},getGsEfx=function(arr){return gsEfx[(arr[0]<<8)+arr[1]]||`0x${arr[0].toString(16).padStart(2,"0")}${arr[1].toString(16).padStart(2,"0")}`},getGsEfxDesc=function(arr,param,value){let id=(arr[0]<<16)+(arr[1]<<8)+param,target=gsEfxDesc[id]||{},desc=target[0];if(desc?.length)return desc+=`: ${(target[1]||function(){})(value)||value}`,desc},mt32DefProg=[68,48,95,78,41,3,110,122,0];var toDecibel=function(data2=64){return Math.round(2e3*Math.log10(data2/64))/100},customInterpreter=function(type,file,rawMtLen){let u8Data=[],metaLength=rawMtLen==!1?file.readIntVLV():rawMtLen;type==0||type==127;for(let c=0;c<metaLength;c++){let byte=file.readInt(1);if(u8Data.push(byte),byte!=247){if(byte!=240){if(byte>127)return console.debug(`Early termination: ${u8Data}`),u8Data.pop(),file.backOne(),file.backOne(),new Uint8Array(u8Data)}}}return new Uint8Array(u8Data)},gsChecksum=function(sequence){let checksum=0;return sequence.forEach(e=>{checksum+=e,checksum=checksum&127}),~checksum+1&127},korgFilter=function(korgArr,iterator){let realData=0;for(let pointer=0;pointer<korgArr.length;pointer++)pointer%8!=0&&(iterator(korgArr[pointer],realData,korgArr),realData++)},x5dSendLevel=function(sendParam){return Math.floor(sendParam*14.2)};var modeIdx=["?","gm","gs","xg","g2","mt32","ns5r","ag10","x5d","05rw","krs","k11","sg"],substList=[[0,0,0,0,121,0,0,56,82,81,63,0,0],[0,0,4,0,0,127,0,0,0,0,0,0,0]],drumMsb=[120,127,120,127,120,127,61,62,62,62,120,122,122],passedMeta=[0,3,81,84,88],eventTypes={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},useRpnMap={0:0,1:1,2:3,5:4},rpnCap=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],useNormNrpn=[36,37];var ccAccepted=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,12,13,16,17,18,19],nrpnCcMap=[33,99,100,32,102,8,9,10],modeMap={};modeIdx.forEach((e,i)=>{modeMap[e]=i});var ccToPos2={length:ccAccepted.length};ccAccepted.forEach((e,i)=>{ccToPos2[e]=i});var sysExSplitter=function(seq){let seqArr=[],seqStart=0;return seq?.forEach(function(e,i){e==247?seqArr.push(seq.subarray(seqStart,i)):e==240&&(seqStart=i+1)}),self.debugMode&&console.info(seqArr),seqArr},showTrue=function(data2,prefix="",suffix="",length=2){return data2?`${prefix}${data2.toString().padStart(length,"0")}${suffix}`:""},allocated={ch:128,cc:ccAccepted.length,nn:128,pl:512,tr:256,cmt:14,rpn:6},OctaviaDevice=class extends CustomEventSource{#mode=0;#bitmapPage=0;#bitmapExpire=0;#bitmapStore=new Array(11);get#bitmap(){return this.#bitmapStore[this.#bitmapPage]}set#bitmap(value){this.#bitmapStore[this.#bitmapPage]=value}#chActive=new Uint8Array(allocated.ch);#chReceive=new Uint8Array(allocated.ch);#cc=new Uint8ClampedArray(allocated.ch*allocated.cc);#prg=new Uint8ClampedArray(allocated.ch);#velo=new Uint8ClampedArray(allocated.ch*allocated.nn);#mono=new Uint8Array(allocated.ch);#poly=new Uint16Array(allocated.pl);#pitch=new Int16Array(allocated.ch);#rawStrength=new Uint8Array(allocated.ch);#dataCommit=0;#rpn=new Uint8Array(allocated.ch*allocated.rpn);#nrpn=new Int8Array(allocated.ch*useNormNrpn.length);#bnCustom=new Uint8Array(allocated.ch);#cmTPatch=new Uint8Array(128);#cmTTimbre=new Uint8Array(allocated.cmt*8);#cmPatch=new Uint8Array(1024);#cmTimbre=new Uint8Array(allocated.cmt*64);#subMsb=0;#subLsb=0;#masterVol=100;#metaChannel=0;#noteLength=500;#convertLastSyllable=0;#letterDisp="";#letterExpire=0;#modeKaraoke=!1;#receiveTree;#gsEfxSto=new Uint8Array(2);#metaTexts=[];#trkRedir=new Uint8Array(allocated.ch);#trkAsReq=new Uint8Array(allocated.tr);baseBank=new VoiceBank("gm","gm2","xg","gs","ns5r","gmega","plg-150vl","plg-150pf","plg-100sg","kross");userBank=new VoiceBank("gm");chRedir(part,track,noConquer){if(this.#trkAsReq[track])return(this.#trkAsReq[track]-1)*16+part;if([modeMap.gs,modeMap.ns5r].indexOf(this.#mode)>-1){if(noConquer==1)return part;let shift=0,unmet=!0;for(;unmet;)this.#trkRedir[part+shift]==0?(this.#trkRedir[part+shift]=track,console.debug(`Assign track ${track} to channel ${part+shift+1}.`),unmet=!1):this.#trkRedir[part+shift]==track?unmet=!1:(shift+=16,shift>=128&&(shift=0,unmet=!1));return part+shift}else return part}#metaRun=[];#metaSeq;#ua={ano:part=>{this.#poly.forEach((e,i,a)=>{let ch=e>>7;e==0&&this.#velo[0]==0||ch==part&&(this.#velo[e]=0,a[i]=0)})}};#runChEvent={8:function(det){let rawNote=det.channel*128+det.data[0],polyIdx=this.#poly.indexOf(rawNote);polyIdx>-1&&(this.#poly[polyIdx]=0,this.#velo[rawNote]=0)},9:function(det){let part=det.channel;this.#chActive[part]=1;let rawNote=part*128+det.data[0];if(det.data[1]>0){let place=0;for(;this.#poly[place]>0;)place++;place<this.#poly.length?(this.#poly[place]=rawNote,this.#velo[rawNote]=det.data[1],this.#rawStrength[part]<det.data[1]&&(this.#rawStrength[part]=det.data[1])):console.error("Polyphony exceeded.")}else{let polyIdx=this.#poly.indexOf(rawNote);polyIdx>-1&&(this.#poly[polyIdx]=0,this.#velo[rawNote]=0)}},10:function(det){let rawNote=det.channel*128+det.data[0];this.#poly.indexOf(rawNote)>-1&&(this.#velo[rawNote]=data[1])},11:function(det){let part=det.channel;this.#chActive[part]=1;let chOffset=part*allocated.cc;switch(det.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#ua.ano(part),this.#pitch[part]=0;let chOff=part*allocated.cc;this.#cc[chOff+ccToPos2[1]]=0,this.#cc[chOff+ccToPos2[5]]=0,this.#cc[chOff+ccToPos2[64]]=0,this.#cc[chOff+ccToPos2[65]]=0,this.#cc[chOff+ccToPos2[66]]=0,this.#cc[chOff+ccToPos2[67]]=0,this.#cc[chOff+ccToPos2[11]]=127,this.#cc[chOff+ccToPos2[101]]=127,this.#cc[chOff+ccToPos2[100]]=127,this.#cc[chOff+ccToPos2[99]]=127,this.#cc[chOff+ccToPos2[98]]=127;return}case 123:{this.#ua.ano(part);return}case 124:{this.#ua.ano(part);return}case 125:{this.#ua.ano(part);return}case 126:{this.#mono[part]=1,this.#ua.ano(part);return}case 127:{this.#mono[part]=0,this.#ua.ano(part);return}}if(ccToPos2[det.data[0]]==null)console.warn(`cc${det.data[0]} is not accepted.`);else{switch(det.data[0]){case 0:{if(self.debugMode&&console.debug(`${modeIdx[this.#mode]}, CH${part+1}: ${det.data[1]}`),this.#mode==0)det.data[1]<48?(this.#cc[chOffset]>119&&(det.data[1]=this.#cc[chOffset],det.data[1]=120,console.debug(`Forced channel ${part+1} to stay drums.`)),det.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${det.data[1]}`),this.switchMode("gs"))):det.data[1]==62?this.switchMode("x5d"):det.data[1]==63&&this.switchMode("krs");else if(this.#mode==modeMap.gs)det.data[1]<56&&this.#cc[chOffset]>119&&(det.data[1]=this.#cc[chOffset],det.data[1]=120,console.debug(`Forced channel ${part+1} to stay drums.`));else if(this.#mode==modeMap.gm)det.data[1]<48&&this.#cc[chOffset]>119&&(det.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${part+1} to stay drums.`));else if(this.#mode==modeMap.x5d){if(det.data[1]>0&&det.data[1]<8)this.switchMode("05rw",!0);else if(det.data[1]==56){let agCount=0;for(let c=0;c<16;c++){let d2=this.#cc[allocated.cc*c];(d2==56||d2==62)&&agCount++}agCount>14&&this.switchMode("ag10",!0)}}break}case 6:{if(this.#dataCommit){let msb=this.#cc[chOffset+ccToPos2[99]],lsb=this.#cc[chOffset+ccToPos2[98]];if(msb==1){let toCc=nrpnCcMap.indexOf(lsb);if(toCc>-1)this.#cc[chOffset+ccToPos2[71+toCc]]=det.data[1],console.debug(`Redirected NRPN 1 ${lsb} to cc${71+toCc}.`);else{let nrpnIdx=useNormNrpn.indexOf(lsb);nrpnIdx>-1&&(this.#nrpn[part*10+nrpnIdx]=det.data[1]-64),console.debug(`CH${part+1} voice NRPN ${lsb} commit`)}}}else{let rpnIndex=useRpnMap[this.#cc[chOffset+ccToPos2[100]]];this.#cc[chOffset+ccToPos2[101]]==0&&rpnIndex!=null&&(console.debug(`CH${part+1} RPN 0 ${this.#cc[chOffset+ccToPos2[100]]} commit: ${det.data[1]}`),det.data[1]=Math.min(Math.max(det.data[1],rpnCap[rpnIndex][0]),rpnCap[rpnIndex][1]),this.#rpn[part*allocated.rpn+rpnIndex]=det.data[1])}break}case 38:{this.#dataCommit||this.#cc[chOffset+101]==0&&useRpnMap[this.#cc[chOffset+100]]!=null&&(this.#rpn[part*allocated.rpn+useRpnMap[this.#cc[chOffset+100]]+1]=det.data[1]);break}case 98:case 99:{this.#dataCommit=1;break}case 100:case 101:{this.#dataCommit=0;break}}this.#cc[chOffset+ccToPos2[det.data[0]]]=det.data[1]}},12:function(det){let part=det.channel;this.#chActive[part]=1,this.#prg[part]=det.data,this.#bnCustom[part]=0,self.debugMode&&console.debug(`T:${det.track} C:${part} P:${det.data}`)},13:function(det){let upThis=this,part=det.channel;this.#poly.forEach(function(e){let realCh=e>>7;part==realCh&&(upThis.#velo[e]=det.data)})},14:function(det){let part=det.channel;this.#pitch[part]=det.data[1]*128+det.data[0]-8192},15:function(det){sysExSplitter(det.data).forEach(seq=>{let manId=seq[0],deviceId=seq[1];(this.#seMan[manId]||function(){console.debug(`Unknown manufacturer ${manId}.`)})(deviceId,seq.subarray(2),det.track)})},248:function(det){},250:function(det){},251:function(det){},252:function(det){},254:function(det){},255:function(det){if((this.#metaRun[det.meta]||function(data2,track,meta){}).call(this,det.data,det.track,det.meta),det.meta!=32&&(this.#metaChannel=0),passedMeta.indexOf(det.meta)>-1)return det.reply="meta",det;self.debugMode&&console.debug(det)}};#seMan={64:(id,msg,track)=>{this.#seKg.run(msg,track,id)},65:(id,msg,track)=>{if(msg[0]<16)this.#seGs.run(msg,track,id),console.warn("Unknown device SysEx!");else{let sentCs=msg[msg.length-1],calcCs=gsChecksum(msg.subarray(2,msg.length-1));sentCs==calcCs?this.#seGs.run(msg.subarray(0,msg.length-1),track,id):console.warn(`Bad GS checksum ${sentCs}. Should be ${calcCs}.`)}},66:(id,msg,track)=>{this.#seAi.run(msg,track,id)},67:(id,msg,track)=>{this.#seXg.run(msg,track,id)},68:(id,msg,track)=>{this.#seCs.run(msg,track,id)},71:(id,msg,track)=>{this.#seSg.run(msg,track,id)},126:(id,msg,track)=>{this.#seUnr.run(msg,track,id)},127:(id,msg,track)=>{this.switchMode("gm"),this.#seUr.run(msg,track,id)}};#seUnr;#seUr;#seXg;#seGs;#seAi;#seKg;#seSg;#seCs;buildRchTree(){let tree=[];this.#chReceive.forEach((e,i)=>{tree[e]?.constructor||(tree[e]=[]),tree[e].push(i)}),this.#receiveTree=tree}getActive(){let result=this.#chActive.slice();return this.#mode==modeMap.mt32,result}getCc(channel){let start=channel*allocated.cc,arr=this.#cc.slice(start,start+allocated.cc);return arr[ccToPos2[0]]=arr[ccToPos2[0]]||this.#subMsb,arr[ccToPos2[32]]=arr[ccToPos2[32]]||this.#subLsb,arr}getCcAll(){let arr=this.#cc.slice();for(let c=0;c<allocated.ch;c++){let chOff=c*allocated.cc;arr[chOff+ccToPos2[0]]=arr[chOff+ccToPos2[0]]||this.#subMsb,arr[chOff+ccToPos2[32]]=arr[chOff+ccToPos2[32]]||this.#subLsb}return arr}getPitch(){return this.#pitch}getProgram(){return this.#prg}getTexts(){return this.#metaTexts.slice()}getVel(channel){let notes=new Map,upThis=this;return this.#poly.forEach(function(e){let realCh=Math.floor(e/128),realNote=e%128;channel==realCh&&upThis.#velo[e]>0&&notes.set(realNote,upThis.#velo[e])}),notes}getBitmap(){return{bitmap:this.#bitmap,expire:this.#bitmapExpire}}getLetter(){return{text:this.#letterDisp,expire:this.#letterExpire}}getMode(){return modeIdx[this.#mode]}getMaster(){return{volume:this.#masterVol}}getRawStrength(){let upThis=this;return this.#poly.forEach(function(e){let channel=Math.floor(e/128);upThis.#velo[e]>upThis.#rawStrength[channel]&&(upThis.#rawStrength[channel]=upThis.#velo[e])}),this.#rawStrength}getStrength(){let str=[],upThis=this;return this.getRawStrength().forEach(function(e,i){str[i]=Math.floor(e*upThis.#cc[i*allocated.cc+ccToPos2[7]]*upThis.#cc[i*allocated.cc+ccToPos2[11]]*upThis.#masterVol/803288)}),str}getRpn(){return this.#rpn}getNrpn(){return this.#nrpn}getVoice(msbO,prgO,lsbO,mode){let msb=msbO||this.#subMsb,prg=prgO,lsb=lsbO||this.#subLsb;modeIdx[this.#mode]=="ns5r"&&msb>0&&msb<56&&(lsb=3);let bank=this.userBank.get(msb,prg,lsb,mode);if(modeIdx[this.#mode]=="mt32"&&bank.name.indexOf("MT-m:")==0){let patch=parseInt(bank.name.slice(5)),timbreOff=patch*allocated.cmt,userBank="";this.#cmTimbre.subarray(timbreOff,timbreOff+10).forEach(e=>{e>31&&(userBank+=String.fromCharCode(e))}),this.userBank.load(`MSB	LSB	PRG
0	127	${prg}	${userBank}`,!0),bank.name=userBank,bank.ending=" "}return(bank.ending!=" "||!bank.name.length)&&(bank=this.baseBank.get(msb,prg,lsb,mode)),bank}getChVoice(part){let voice=this.getVoice(this.#cc[part*allocated.cc+ccToPos2[0]],this.#prg[part],this.#cc[part*allocated.cc+ccToPos2[32]],modeIdx[this.#mode]);if(this.#bnCustom[part])switch(this.#mode){case modeMap.mt32:voice.ending="~",voice.name="",this.#cmTTimbre.subarray(14*(part-1),14*(part-1)+10).forEach(e=>{e>31&&(voice.name+=String.fromCharCode(e))})}return voice}init(type=0){this.dispatchEvent("mode","?"),this.#mode=0,this.#subMsb=0,this.#subLsb=0,this.#metaChannel=0,this.#chActive.fill(0),this.#cc.fill(0),this.#prg.fill(0),this.#velo.fill(0),this.#poly.fill(0),this.#rawStrength.fill(0),this.#pitch.fill(0),this.#nrpn.fill(0),this.#masterVol=100,this.#metaTexts=[],this.#noteLength=500,this.#convertLastSyllable=0,this.#letterExpire=0,this.#letterDisp="",this.#bitmapExpire=0,this.#bitmapPage=0,this.#bitmap.fill(0),this.#modeKaraoke=!1,this.#chReceive.forEach(function(e,i,a){a[i]=i}),this.buildRchTree(),this.#trkRedir.fill(0),this.#trkAsReq.fill(0),this.#cc[allocated.cc*9]=drumMsb[0],this.#cc[allocated.cc*25]=drumMsb[0],this.#cc[allocated.cc*41]=drumMsb[0],this.#cc[allocated.cc*57]=drumMsb[0],this.#gsEfxSto.fill(0),this.#cmPatch.fill(0),this.#cmTimbre.fill(0),this.#cmTPatch.fill(0),this.#cmTTimbre.fill(0),this.#bnCustom.fill(0),this.userBank.clearRange({msb:0,lsb:127,prg:[0,127]});for(let ch=0;ch<allocated.ch;ch++){let chOff=ch*allocated.cc;this.#cc[chOff+ccToPos2[7]]=100,this.#cc[chOff+ccToPos2[11]]=127,this.#cc[chOff+ccToPos2[10]]=64,this.#cc[chOff+ccToPos2[71]]=64,this.#cc[chOff+ccToPos2[72]]=64,this.#cc[chOff+ccToPos2[73]]=64,this.#cc[chOff+ccToPos2[74]]=64,this.#cc[chOff+ccToPos2[75]]=64,this.#cc[chOff+ccToPos2[76]]=64,this.#cc[chOff+ccToPos2[77]]=64,this.#cc[chOff+ccToPos2[78]]=64,this.#cc[chOff+ccToPos2[91]]=40,this.#cc[chOff+ccToPos2[101]]=127,this.#cc[chOff+ccToPos2[100]]=127,this.#cc[chOff+ccToPos2[99]]=127,this.#cc[chOff+ccToPos2[98]]=127;let rpnOff=ch*allocated.rpn;this.#rpn[rpnOff]=2,this.#rpn[rpnOff+1]=64,this.#rpn[rpnOff+2]=0,this.#rpn[rpnOff+3]=64,this.#rpn[rpnOff+4]=0,this.#rpn[rpnOff+5]=0}}switchMode(mode,forced=!1){let idx=modeIdx.indexOf(mode);if(idx>-1){if(this.#mode==0||forced){this.#mode=idx,this.#bitmapPage=0,this.#subMsb=substList[0][idx],this.#subLsb=substList[1][idx];for(let ch=0;ch<allocated.ch;ch++)drumMsb.indexOf(this.#cc[ch*allocated.cc])>-1&&(this.#cc[ch*allocated.cc]=drumMsb[idx]);switch(idx){case modeMap.mt32:{mt32DefProg.forEach((e,i)=>{let ch=i+1;this.#chActive[ch]||(this.#prg[ch]=e,this.#cc[ch*allocated.cc+ccToPos2[91]]=127)});break}}this.dispatchEvent("mode",mode)}}else throw new Error(`Unknown mode ${mode}`)}newStrength(){this.#rawStrength.fill(0)}runJson(json){if(json.type>14)return this.#runChEvent[json.type].call(this,json);{let rcvPart=this.chRedir(json.part,json.track),executed=!1;this.#receiveTree[rcvPart]?.forEach(e=>{json.channel=e,executed=!0,this.#runChEvent[json.type].call(this,json)}),executed||console.warn(`${eventTypes[json.type]?eventTypes[json.type]:json.type}${[11,12].includes(json.type)?(json.data[0]!=null?json.data[0]:json.data).toString():""} event sent to CH${rcvPart+1} without any recipient.`)}this.#metaTexts.length>100&&this.#metaTexts.splice(100,this.#metaTexts.length-99)}runRaw(midiArr){}constructor(){super();let upThis=this;this.#bitmap=new Uint8Array(256),this.#bitmapStore[10]=new Uint8Array(512),this.#metaSeq=new BinaryMatch,this.userBank.strictMode=!0,this.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),this.#metaRun[1]=function(data2){switch(data2.slice(0,2)){case"@I":{this.#modeKaraoke=!0,this.#metaTexts.unshift(`Kar.Info: ${data2.slice(2)}`);break}case"@K":{this.#modeKaraoke=!0,this.#metaTexts.unshift("Karaoke mode active."),console.debug(`Karaoke mode active: ${data2.slice(2)}`);break}case"@L":{this.#modeKaraoke=!0,this.#metaTexts.unshift(`Language: ${data2.slice(2)}`);break}case"@T":{this.#modeKaraoke=!0,this.#metaTexts.unshift(`Ka.Title: ${data2.slice(2)}`);break}case"@V":{this.#modeKaraoke=!0,this.#metaTexts.unshift(`Kara.Ver: ${data2.slice(2)}`);break}default:this.#modeKaraoke?data2[0]=="\\"?this.#metaTexts.unshift(`@ ${data2.slice(1)}`):data2[0]=="/"?this.#metaTexts.unshift(data2.slice(1)):this.#metaTexts[0]+=data2:(this.#metaTexts[0]=data2,this.#metaTexts.unshift(""))}},this.#metaRun[2]=function(data2){this.#metaTexts.unshift(`Copyrite: ${data2}`)},this.#metaRun[3]=function(data2,track){track<1&&this.#metaChannel<1&&this.#metaTexts.unshift(`TrkTitle: ${data2}`)},this.#metaRun[4]=function(data2,track){this.#metaTexts.unshift(`${showTrue(this.#metaChannel,""," ")}Instrmnt: ${data2}`)},this.#metaRun[5]=function(data2){data2.trim()==""?this.#metaTexts.unshift(""):this.#metaTexts[0]+=`${data2}`},this.#metaRun[6]=function(data2){this.#metaTexts.unshift(`${showTrue(this.#metaChannel,""," ")}C.Marker: ${data2}`)},this.#metaRun[7]=function(data2){this.#metaTexts.unshift(`CuePoint: ${data2}`)},this.#metaRun[32]=function(data2){this.#metaChannel=data2[0]+1},this.#metaRun[33]=function(data2,track){console.debug(`Track ${track} requests to get assigned to output ${data2}.`),upThis.#trkAsReq[track]=data2+1},this.#metaRun[81]=function(data2,track){upThis.#noteLength=data2/1e3},this.#metaRun[127]=function(data2,track){upThis.#metaSeq.run(data2,track)},this.#metaSeq.add([67,0,1],function(msg,track){upThis.#trkAsReq[track]=msg[0]+1}),this.#seUnr=new BinaryMatch,this.#seUr=new BinaryMatch,this.#seXg=new BinaryMatch,this.#seGs=new BinaryMatch,this.#seAi=new BinaryMatch,this.#seKg=new BinaryMatch,this.#seSg=new BinaryMatch,this.#seCs=new BinaryMatch,this.#seUnr.add([9],msg=>{upThis.switchMode(["gm","?","g2"][msg[0]-1],!0),upThis.#modeKaraoke=upThis.#modeKaraoke||!1,console.info(`MIDI reset: ${["GM","Init","GM2"][msg[0]-1]}`),msg[0]==2&&upThis.init()}),this.#seUr.add([4,1],msg=>{upThis.#masterVol=((msg[1]<<7)+msg[0])/16383*100}).add([4,3],msg=>((msg[1]<<7)+msg[0]-8192)/8192).add([4,4],msg=>msg[1]-64),this.#seXg.add([76,0,0],msg=>{switch(msg[0]){case 126:{upThis.switchMode("xg",!0),upThis.#modeKaraoke=!1,console.info("MIDI reset: XG");break}default:{let mTune=[0,0,0,0],writeTune=(e,i)=>{mTune[i]=e};if(msg.subarray(1).forEach((e,i)=>{let addr=i+msg[0];[writeTune,writeTune,writeTune,writeTune,e2=>{this.#masterVol=e2*129/16383*100},e2=>{},e2=>{}][addr](e,i)}),msg[0]<4){let rTune=0;mTune.forEach(e=>{rTune=rTune<<4,rTune+=e}),rTune-=1024}}}}).add([76,2,1],msg=>{let dPref="XG ";msg[0]<32?(dPref+="reverb ",msg.subarray(1).forEach((e,i)=>{([e2=>{console.info(`${dPref}main type: ${xgEffType[e2]}`)},e2=>{console.debug(`${dPref}sub type: ${e2+1}`)},e2=>{console.debug(`${dPref}time: ${getXgRevTime(e2)}s`)},e2=>{console.debug(`${dPref}diffusion: ${e2}`)},e2=>{console.debug(`${dPref}initial delay: ${e2}`)},e2=>{console.debug(`${dPref}HPF cutoff: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}LPF cutoff: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}width: ${e2}`)},e2=>{console.debug(`${dPref}height: ${e2}`)},e2=>{console.debug(`${dPref}depth: ${e2}`)},e2=>{console.debug(`${dPref}wall type: ${e2}`)},e2=>{console.debug(`${dPref}dry/wet: ${e2}`)},e2=>{console.debug(`${dPref}send: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}pan: ${e2-64}`)},!1,!1,e2=>{console.debug(`${dPref}delay: ${e2}`)},e2=>{console.debug(`${dPref}density: ${e2}`)},e2=>{console.debug(`${dPref}balance: ${e2}`)},e2=>{},e2=>{console.debug(`${dPref}feedback: ${e2}`)},e2=>{}][msg[0]+i]||function(){console.warn(`Unknown XG reverb address: ${msg[0]}.`)})(e)})):msg[0]<64?(dPref+="chorus ",msg.subarray(1).forEach((e,i)=>{([e2=>{console.info(`${dPref}main type: ${xgEffType[e2]}`)},e2=>{console.debug(`${dPref}sub type: ${e2+1}`)},e2=>{console.debug(`${dPref}LFO: ${xgLfoFreq[e2]}Hz`)},e2=>{},e2=>{console.debug(`${dPref}feedback: ${e2}`)},e2=>{console.debug(`${dPref}delay offset: ${getXgDelayOffset(e2)}ms`)},e2=>{},e2=>{console.debug(`${dPref}low: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}low: ${e2-64}dB`)},e2=>{console.debug(`${dPref}high: ${xgNormFreq[e2]}Hz`)},e2=>{console.debug(`${dPref}high: ${e2-64}dB`)},e2=>{console.debug(`${dPref}dry/wet: ${e2}`)},e2=>{console.debug(`${dPref}send: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}pan: ${e2-64}`)},e2=>{console.debug(`${dPref}to reverb: ${toDecibel(e2)}dB`)},!1,e2=>{},e2=>{},e2=>{},e2=>{console.debug(`${dPref}LFO phase diff: ${(e2-64)*3}deg`)},e2=>{console.debug(`${dPref}input mode: ${e2?"stereo":"mono"}`)},e2=>{}][msg[0]-32+i]||function(){console.warn(`Unknown XG chorus address: ${msg[0]}.`)})(e)})):msg[0]<86?(dPref+="variation ",msg[0]==64&&console.info(`${dPref}type: ${xgEffType[msg[1]]}${msg[2]>0?" "+(msg[2]+1):""}`)):msg[0]<97?(dPref+="variation ",msg.subarray(1).forEach((e,i)=>{[e2=>{console.debug(`${dPref}send: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}pan: ${e2-64}`)},e2=>{console.debug(`${dPref}to reverb: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}to chorus: ${toDecibel(e2)}dB`)},e2=>{console.debug(`${dPref}connection: ${e2?"system":"insertion"}`)},e2=>{console.debug(`${dPref}channel: CH${e2+1}`)},e2=>{console.debug(`${dPref}mod wheel: ${e2-64}`)},e2=>{console.debug(`${dPref}bend wheel: ${e2-64}`)},e2=>{console.debug(`${dPref}channel after touch: ${e2-64}`)},e2=>{console.debug(`${dPref}AC1: ${e2-64}`)},e2=>{console.debug(`${dPref}AC2: ${e2-64}`)}][msg[0]-86+i](e)})):msg[0]>111&&msg[0]<118?dPref+="variation ":console.warn(`Unknown XG variation address: ${msg[0]}`)}).add([76,2,64],msg=>{msg.subarray(1).forEach((e,i)=>{let c=i+msg[0];if(c==0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][e]}`);else{let band=c-1>>2,prop=c-1&3,dPref=`XG EQ ${band} ${["gain","freq","Q","shape"][prop]}: `;[()=>{console.debug(`${dPref}${e-64}dB`)},()=>{console.debug(`${dPref}${e} (raw)`)},()=>{console.debug(`${dPref}${e/10}`)},()=>{console.debug(`${dPref}${["shelf","peak"][+!!e]}`)}][prop]()}})}).add([76,3],msg=>{}).add([76,6,0],msg=>{let offset=msg[0];upThis.#letterDisp=" ".repeat(offset),upThis.#letterExpire=Date.now()+3200,msg.subarray(1).forEach(function(e){upThis.#letterDisp+=String.fromCharCode(e)}),upThis.#letterDisp=upThis.#letterDisp.padEnd(32," ")}).add([76,7,0],msg=>{let offset=msg[0];upThis.#bitmapExpire=Date.now()+3200,upThis.#bitmap.fill(0);let workArr=msg.subarray(1);for(let index=0;index<offset;index++)workArr.unshift(0);workArr.forEach(function(e,i){let ln=Math.floor(i/16),co=i%16,pt=(co*3+ln)*7,threshold=7,bi=0;for(pt-=co*5,ln==2&&(threshold=2);bi<threshold;)upThis.#bitmap[pt+bi]=e>>6-bi&1,bi++})}).add([76,8],(msg,track)=>{let part=upThis.chRedir(msg[0],track,!0),id=msg[1],chOff=allocated.cc*part,dPref=`XG CH${part+1} `,errMsg=`Unknown XG part address ${id}.`;msg.subarray(2).forEach((e,i)=>{id<1?console.debug(errMsg):id<41?([()=>{upThis.#cc[chOff+ccToPos2[0]]=e},()=>{upThis.#cc[chOff+ccToPos2[32]]=e},()=>{upThis.#prg[part]=e},()=>{let ch=upThis.chRedir(e,track,!0);upThis.#chReceive[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))},()=>{upThis.#mono[part]=+!e},()=>{},()=>{upThis.#cc[chOff+ccToPos2[0]]=e>1?127:0,console.debug(`${dPref}type: ${xgPartMode[e]}`)},()=>{upThis.#rpn[allocated.rpn*part+3]=e},!1,!1,()=>{upThis.#cc[chOff+ccToPos2[7]]=e},!1,!1,()=>{upThis.#cc[chOff+ccToPos2[10]]=e||128},!1,!1,()=>{upThis.#cc[chOff+ccToPos2[11]]=e},()=>{upThis.#cc[chOff+ccToPos2[93]]=e},()=>{upThis.#cc[chOff+ccToPos2[91]]=e},()=>{upThis.#cc[chOff+ccToPos2[94]]=e},()=>{upThis.#cc[chOff+ccToPos2[76]]=e},()=>{upThis.#cc[chOff+ccToPos2[77]]=e},()=>{upThis.#cc[chOff+ccToPos2[78]]=e},()=>{upThis.#cc[chOff+ccToPos2[74]]=e},()=>{upThis.#cc[chOff+ccToPos2[71]]=e},()=>{upThis.#cc[chOff+ccToPos2[73]]=e},()=>{upThis.#cc[chOff+ccToPos2[75]]=e},()=>{upThis.#cc[chOff+ccToPos2[72]]=e}][id+i-1]||(()=>{}))():id<48?console.debug(errMsg):id<111?id>102&&id<105&&(upThis.#cc[chOff+ccToPos2[[5,65][id&1]]]=e):id<114?console.debug(errMsg):id<116?console.debug(`${dPref}EQ ${["bass","treble"][id&1]} gain: ${e-64}dB`):id<118?console.debug(errMsg):id<120?console.debug(`${dPref}EQ ${["bass","treble"][id&1]} freq: ${e}`):console.debug(errMsg)})}).add([76,10],msg=>{}).add([76,16],msg=>{}).add([76,17,0,0],msg=>{}).add([73,0,0],(msg,track)=>{let offset=msg[0];msg.subarray(1).forEach((e,i)=>{let ri=offset+i;ri==8?console.debug(`MU1000 set LCD contrast to ${e}.`):ri>9&&ri<15&&[()=>{upThis.dispatchEvent("channelactive",e)},()=>{e<8?upThis.dispatchEvent("channelmin",e<<4):upThis.dispatchEvent("channelreset")},()=>{e<8?upThis.dispatchEvent("channelmax",(e<<4)+15):upThis.dispatchEvent("channelreset")},()=>{upThis.dispatchEvent("channelreset")}][ri-10]()})}).add([93,3],(msg,track)=>{let part=upThis.chRedir(msg[0],track,!0),dPref=`PLG-100SG CH${part+1} `,timeNow=Date.now();if(msg[1]==0){let vocal="",length=0;msg.subarray(2).forEach((e,i)=>{i%2==0?vocal+=xgSgVocals[e]||e.toString().padStart("0"):length+=e*13}),timeNow>=upThis.#convertLastSyllable&&upThis.#metaTexts.unshift("SG Lyric: "),upThis.#metaTexts[0]+=`${getSgKana(vocal)}`,upThis.#convertLastSyllable=timeNow+Math.ceil(length/2)+upThis.#noteLength,self.debugMode&&console.debug(`${dPref}vocals: ${vocal}`)}else console.warn(`Unknown PLG-100SG data: ${msg}`)}).add([112],msg=>{console.debug(`XG plugin PLG1-${["00VL","00SG","00DX"][msg[0]]} enabled for channel ${msg[2]+1}.`)}),this.#seXg.add([76,48],msg=>{}).add([76,49],msg=>{}).add([76,50],msg=>{}).add([76,51],msg=>{}),this.#seGs.add([66,18,0,0,127],msg=>{upThis.switchMode("gs",!0),upThis.#cc[allocated.cc*9]=120,upThis.#cc[allocated.cc*25]=120,upThis.#cc[allocated.cc*41]=120,upThis.#cc[allocated.cc*57]=120,upThis.#subLsb=3,upThis.#modeKaraoke=!1,upThis.#trkRedir.fill(0),console.info(`GS system to ${["single","dual"][msg[0]]} mode.`)}).add([66,18,64,0],msg=>{switch(msg[0]){case 127:{upThis.switchMode("gs",!0),upThis.#cc[allocated.cc*9]=120,upThis.#cc[allocated.cc*25]=120,upThis.#cc[allocated.cc*41]=120,upThis.#cc[allocated.cc*57]=120,upThis.#modeKaraoke=!1,upThis.#trkRedir.fill(0),console.info("MIDI reset: GS");break}default:{let mTune=[0,0,0,0],writeTune=(e,i)=>{mTune[i]=e};if(msg.subarray(1).forEach((e,i)=>{let addr=i+msg[0];[writeTune,writeTune,writeTune,writeTune,e2=>{this.#masterVol=e2*129/16383*100},e2=>{},e2=>{}][addr](e,i)}),msg[0]<4){let rTune=0;mTune.forEach(e=>{rTune=rTune<<4,rTune+=e}),rTune-=1024}}}}).add([66,18,64,1],msg=>{let offset=msg[0];if(offset<16){let string="".padStart(offset," ");msg.subarray(1).forEach((e,i)=>{string+=String.fromCharCode(Math.max(32,e))}),string=string.padEnd(16," "),console.debug(`GS patch name: ${string}`)}else offset<48||(offset<65?msg.subarray(1).forEach((e,i)=>{let dPref=`GS ${offset+i>55?"chorus":"reverb"} `;([()=>{console.info(`${dPref}type: ${gsRevType[e]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${dPref}predelay: ${e}ms`)},()=>{console.info(`${dPref}type: ${gsChoType[e]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${dPref}to reverb: ${toDecibel(e)}`)},()=>{console.debug(`${dPref}to delay: ${toDecibel(e)}`)}][offset+i-48]||(()=>{}))()}):offset<80?console.debug(`Unknown GS patch address: ${offset}`):offset<91?msg.subarray(1).forEach((e,i)=>{let dPref="GS delay ";([()=>{console.info(`${dPref}type: ${gsDelType[e]}`)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${dPref}to reverb: ${toDecibel(e)}`)}][offset+i-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${offset}`))}).add([66,18,64,2],msg=>{let dPref="GS EQ ";msg.subarray(1).forEach((e,i)=>{([()=>{console.debug(`${dPref}low freq: ${[200,400][e]}Hz`)},()=>{console.debug(`${dPref}low gain: ${e-64}dB`)},()=>{console.debug(`${dPref}high freq: ${[3e3,6e3][e]}Hz`)},()=>{console.debug(`${dPref}high gain: ${e-64}dB`)}][msg[0]+i]||function(){console.warn(`Unknown GS EQ address: ${msg[0]+i}`)})()})}).add([66,18,64,3],msg=>{let dPref="GS EFX ",prefDesc=function(e,i){let desc=getGsEfxDesc(upThis.#gsEfxSto,i,e);desc&&console.debug(`${dPref}${getGsEfx(upThis.#gsEfxSto)} ${desc}`)};msg.subarray(1).forEach((e,i)=>{([()=>{upThis.#gsEfxSto[0]=e},()=>{upThis.#gsEfxSto[1]=e,console.info(`${dPref}type: ${getGsEfx(upThis.#gsEfxSto)}`)},!1,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,prefDesc,()=>{console.debug(`${dPref}to reverb: ${toDecibel(e)}dB`)},()=>{console.debug(`${dPref}to chorus: ${toDecibel(e)}dB`)},()=>{console.debug(`${dPref}to delay: ${toDecibel(e)}dB`)},!1,()=>{console.debug(`${dPref}1 source: ${e}`)},()=>{console.debug(`${dPref}1 depth: ${e-64}`)},()=>{console.debug(`${dPref}2 source: ${e}`)},()=>{console.debug(`${dPref}2 depth: ${e-64}`)},()=>{console.debug(`${dPref}to EQ: ${e?"ON":"OFF"}`)}][msg[0]+i]||function(e2,i2){console.warn(`Unknown GS EFX address: ${i2}`)})(e,msg[0]+i)})}).add([66,18,65],msg=>{}).add([69,18,16],msg=>{switch(msg[0]){case 0:{upThis.#letterExpire=Date.now()+3200;let offset=msg[1];upThis.#letterDisp=" ".repeat(offset),msg.subarray(2).forEach(function(e){e<128&&(upThis.#letterDisp+=String.fromCharCode(e))});break}case 32:{upThis.#bitmapExpire=Date.now()+3200,msg[1]==0&&(upThis.#bitmapPage=Math.max(Math.min(msg[2]-1,9),0));break}default:if(msg[0]<11){upThis.#bitmapExpire=Date.now()+3200,upThis.#bitmapStore[msg[0]-1]?.length||(upThis.#bitmapStore[msg[0]-1]=new Uint8Array(256));let target=upThis.#bitmapStore[msg[0]-1],offset=msg[1];target.fill(0);let workArr=msg.subarray(2);for(let index=0;index<offset;index++)workArr.unshift(0);workArr.forEach(function(e,i){let ln=Math.floor(i/16),co=i%16,pt=(co*4+ln)*5,threshold=5,bi=0;for(pt-=co*4,ln==3&&(threshold=1);bi<threshold;)target[pt+bi]=e>>4-bi&1,bi++})}else console.warn(`Unknown GS display section: ${msg[0]}`)}});let gsPartSec=function(msg,part,track){let offset=msg[0],chOff=allocated.cc*part,rpnOff=allocated.rpn*part,dPref=`GS CH${part+1} `;offset<3?msg.subarray(1).forEach((e,i)=>{[()=>{upThis.#cc[chOff+ccToPos2[0]]=e},()=>{upThis.#prg[part]=e},()=>{let ch=upThis.chRedir(e,track,!0);upThis.#chReceive[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))}][offset+i]()}):offset<19||(offset<44?msg.subarray(1).forEach((e,i)=>{([()=>{upThis.#mono[part]=+!e},!1,()=>{upThis.#cc[chOff+ccToPos2[0]]=e?120:0,console.debug(`${dPref}type: ${e?"drum ":"melodic"}${e||""}`)},()=>{upThis.#rpn[rpnOff+3]=e},!1,()=>{upThis.#cc[chOff+ccToPos2[7]]=e},!1,!1,()=>{upThis.#cc[chOff+ccToPos2[10]]=e||128},!1,!1,()=>{console.debug(`${dPref}CC 1: cc${e}`)},()=>{console.debug(`${dPref}CC 2: cc${e}`)},()=>{upThis.#cc[chOff+ccToPos2[93]]=e},()=>{upThis.#cc[chOff+ccToPos2[91]]=e},!1,!1,()=>{upThis.#rpn[rpnOff+1]=e},()=>{upThis.#rpn[rpnOff+2]=e},()=>{upThis.#cc[chOff+ccToPos2[94]]=e}][offset+i-19]||(()=>{}))()}):offset<76||console.debug(`Unknown GS part address: ${offset}`))},gsMiscSec=function(msg,part){let offset=msg[0],dPref=`GS CH${part+1} `;offset<2?msg.subarray(1).forEach((e,i)=>{[()=>{upThis.#cc[allocated.cc*part+ccToPos2[32]]=e},()=>{}][offset+i]()}):offset<32?console.warn(`Unknown GS misc address: ${offset}`):offset<35?msg.subarray(1).forEach((e,i)=>{[()=>{console.debug(`${dPref}EQ: o${["ff","n"][e]}`)},()=>{},()=>{console.debug(`${dPref}EFX: o${["ff","n"][e]}`)}][offset+i-32]()}):console.warn(`Unknown GS misc address: ${offset}`)};this.#seGs.add([66,18,64,16],(msg,track)=>{gsPartSec(msg,upThis.chRedir(9,track,!0),track)}).add([66,18,64,17],(msg,track)=>{gsPartSec(msg,upThis.chRedir(0,track,!0),track)}).add([66,18,64,18],(msg,track)=>{gsPartSec(msg,upThis.chRedir(1,track,!0),track)}).add([66,18,64,19],(msg,track)=>{gsPartSec(msg,upThis.chRedir(2,track,!0),track)}).add([66,18,64,20],(msg,track)=>{gsPartSec(msg,upThis.chRedir(3,track,!0),track)}).add([66,18,64,21],(msg,track)=>{gsPartSec(msg,upThis.chRedir(4,track,!0),track)}).add([66,18,64,22],(msg,track)=>{gsPartSec(msg,upThis.chRedir(5,track,!0),track)}).add([66,18,64,23],(msg,track)=>{gsPartSec(msg,upThis.chRedir(6,track,!0),track)}).add([66,18,64,24],(msg,track)=>{gsPartSec(msg,upThis.chRedir(7,track,!0),track)}).add([66,18,64,25],(msg,track)=>{gsPartSec(msg,upThis.chRedir(8,track,!0),track)}).add([66,18,64,26],(msg,track)=>{gsPartSec(msg,upThis.chRedir(10,track,!0),track)}).add([66,18,64,27],(msg,track)=>{gsPartSec(msg,upThis.chRedir(11,track,!0),track)}).add([66,18,64,28],(msg,track)=>{gsPartSec(msg,upThis.chRedir(12,track,!0),track)}).add([66,18,64,29],(msg,track)=>{gsPartSec(msg,upThis.chRedir(13,track,!0),track)}).add([66,18,64,30],(msg,track)=>{gsPartSec(msg,upThis.chRedir(14,track,!0),track)}).add([66,18,64,31],(msg,track)=>{gsPartSec(msg,upThis.chRedir(15,track,!0),track)}).add([66,18,64,64],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(9,track,!0))}).add([66,18,64,65],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(0,track,!0))}).add([66,18,64,66],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(1,track,!0))}).add([66,18,64,67],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(2,track,!0))}).add([66,18,64,68],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(3,track,!0))}).add([66,18,64,69],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(4,track,!0))}).add([66,18,64,70],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(5,track,!0))}).add([66,18,64,71],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(6,track,!0))}).add([66,18,64,72],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(7,track,!0))}).add([66,18,64,73],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(8,track,!0))}).add([66,18,64,74],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(10,track,!0))}).add([66,18,64,75],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(11,track,!0))}).add([66,18,64,76],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(12,track,!0))}).add([66,18,64,77],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(13,track,!0))}).add([66,18,64,78],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(14,track,!0))}).add([66,18,64,79],(msg,track)=>{gsMiscSec(msg,upThis.chRedir(15,track,!0))}),this.#seAi.add([54,76,0],(msg,track)=>{upThis.switchMode("x5d",!0);let name2="",msb=82,prg=0,lsb=0,voiceMap="MSB	PRG	LSB	NME";korgFilter(msg,function(e,i){if(i<16400){let p2=i%164;switch(!0){case p2<10:{e>31&&(name2+=String.fromCharCode(e));break}case p2==11:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Voice","")}`,prg++,name2="";break}}prg>99&&(msb=90,prg=0)}}),upThis.userBank.clearRange({msb:82,prg:[0,99],lsb:0}),upThis.userBank.load(voiceMap)}).add([54,77,0],(msg,track)=>{upThis.switchMode("x5d",!0);let name2="",msb=90,prg=0,lsb=0,voiceMap="MSB	PRG	LSB	NME";korgFilter(msg,function(e,i){if(i<13600){let p2=i%136;switch(!0){case p2<10:{e>31&&(name2+=String.fromCharCode(e));break}case p2==11:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Combi","")}`,prg++,name2="";break}}}}),upThis.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),upThis.userBank.load(voiceMap)}).add([54,104],(msg,track)=>{upThis.switchMode("x5d",!0),korgFilter(msg,function(e,i){if(i<192){let part=upThis.chRedir(Math.floor(i/12),track,!0),chOff=part*allocated.cc;switch(i%12){case 0:{upThis.#prg[part]=e,e>0&&(upThis.#chActive[part]=1);break}case 1:{upThis.#cc[chOff+ccToPos2[7]]=e;break}case 2:{upThis.#rpn[part*allocated.rpn+3]=e>127?256-e:64+e;break}case 3:{upThis.#rpn[part*allocated.rpn+1]=e>127?256-e:64+e;break}case 4:{e<31&&(upThis.#cc[chOff+ccToPos2[10]]=Math.round((e-15)*4.2+64));break}case 5:{let choSend=e>>4,revSend=e&15;upThis.#cc[chOff+ccToPos2[91]]=x5dSendLevel(revSend),upThis.#cc[chOff+ccToPos2[93]]=x5dSendLevel(choSend);break}case 10:{upThis.#cc[chOff]=e&3?82:56;break}case 11:{let midiCh=upThis.chRedir(e&15,track,!0),trkSw=e>>4;upThis.#chReceive[part]=e,(midiCh!=part||trkSw)&&(console.info(`X5D Part CH${part+1} receives from CH${midiCh+1}.`),upThis.buildRchTree())}}}else{let part=upThis.chRedir(i-192,track,!0)}})}),this.#seGs.add([22,18,127],msg=>{upThis.switchMode("mt32",!0),upThis.#modeKaraoke=!1,upThis.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(msg,track,id)=>{upThis.switchMode("mt32");let part=upThis.chRedir(id,track,!0),offset=msg[1];msg.subarray(2).forEach((e,i)=>{let ri=i+offset;upThis.#cmTPatch[ri+(part-1)*16]=e,([!1,()=>{let timbreGroup=upThis.#cmTPatch[part-1<<4];if(timbreGroup<3)if(upThis.#bnCustom[part]=1,timbreGroup==2)for(let c=0;c<name.length;c++)upThis.#cmTTimbre[(part-1)*allocated.cmt+c]=upThis.#cmTimbre[e*allocated.cmt+c];else{let name2=upThis.baseBank.get(0,e+(timbreGroup<<6),127,"mt32").name;for(let c=0;c<name2.length;c++)upThis.#cmTTimbre[(part-1)*allocated.cmt+c]=name2.charCodeAt(c)}},()=>{upThis.#rpn[part*allocated.rpn+3]=e+40},()=>{upThis.#rpn[part*allocated.rpn+1]=e+14},()=>{upThis.#rpn[part*allocated.rpn]=e},!1,()=>{upThis.#cc[allocated.cc*part+ccToPos2[91]]=e?127:0},!1,()=>{upThis.#cc[allocated.cc*part+ccToPos2[7]]=e},()=>{upThis.#cc[allocated.cc*part+ccToPos2[10]]=Math.ceil(e*9.05)}][ri]||(()=>{}))()})}).add([22,18,1],(msg,track,id)=>{upThis.switchMode("mt32");let part=upThis.chRedir(id,track,!0)}).add([22,18,2],(msg,track,id)=>{upThis.switchMode("mt32");let part=upThis.chRedir(id,track,!0),offset=msg[1]+(msg[0]<<7);offset<10&&(upThis.#bnCustom[part]=1),msg.subarray(2).forEach((e,i)=>{let ri=i+offset;ri<14&&(upThis.#cmTTimbre[(part-1)*allocated.cmt+ri]=e)})}).add([22,18,3],(msg,track,id)=>{if(upThis.switchMode("mt32"),msg[0]){let offset=msg[1]-16}else{let offset=msg[1];msg.subarray(2).forEach((e,i)=>{let ri=i+offset;upThis.#cmTPatch[ri]=e;let part=upThis.chRedir(1+ri>>4,track,!0),ptr=ri&15;([!1,()=>{let timbreGroup=upThis.#cmTPatch[part-1<<4];if(timbreGroup<3)if(upThis.#bnCustom[part]=1,timbreGroup==2)for(let c=0;c<name.length;c++)upThis.#cmTTimbre[(part-1)*allocated.cmt+c]=upThis.#cmTimbre[e*allocated.cmt+c];else{let name2=upThis.baseBank.get(0,e+(timbreGroup<<6),127,"mt32").name;for(let c=0;c<name2.length;c++)upThis.#cmTTimbre[(part-1)*allocated.cmt+c]=name2.charCodeAt(c)}},()=>{upThis.#rpn[part*allocated.rpn+3]=e+40},()=>{upThis.#rpn[part*allocated.rpn+1]=e+14},()=>{upThis.#rpn[part*allocated.rpn]=e},!1,()=>{upThis.#cc[allocated.cc*part+ccToPos2[91]]=e?127:0},!1,()=>{upThis.#cc[allocated.cc*part+ccToPos2[7]]=e},()=>{upThis.#cc[allocated.cc*part+ccToPos2[10]]=Math.ceil(e*9.05)}][ptr]||(()=>{}))()})}}).add([22,18,4],(msg,track,id)=>{upThis.switchMode("mt32");let offsetTotal=msg[1]+(msg[0]<<7);msg.subarray(2).forEach((e,i)=>{let ri=i+offsetTotal,part=upThis.chRedir(Math.floor(ri/246+1),track,!0),offset=ri%246;offset<14&&(upThis.#cmTTimbre[(part-1)*allocated.cmt+offset]=e),offset<10&&(upThis.#bnCustom[part]=1)})}).add([22,18,5],(msg,track,id)=>{upThis.switchMode("mt32");let offset=(msg[0]<<7)+msg[1];msg.subarray(2).forEach((e,i)=>{let realIndex=offset+i,patch=Math.floor(realIndex/8),slot=realIndex&7,patchOff=patch*8;upThis.#cmPatch[realIndex]=e,([!1,()=>{let timbreGroup=upThis.#cmPatch[patchOff];if(timbreGroup<3){let name2="";if(timbreGroup==2){let timbreOff=allocated.cmt*patch;name2=`MT-m:${e.toString().padStart(3,"0")}`}else name2=upThis.baseBank.get(0,e+(timbreGroup<<6),127,"mt32").name;upThis.userBank.clearRange({msb:0,lsb:127,prg:patch}),upThis.userBank.load(`MSB	LSB	PRG	NME
000	127	${patch}	${name2}`,!0)}}][slot]||(()=>{}))()})}).add([22,18,8],(msg,track,id)=>{upThis.switchMode("mt32");let offset=((msg[0]&1)<<7)+msg[1];msg.subarray(2).forEach((e,i)=>{let ri=offset+i;ri<allocated.cmt&&(upThis.#cmTimbre[(msg[0]>>1)*allocated.cmt+ri]=e)})}).add([22,18,16],(msg,track,id)=>{upThis.switchMode("mt32");let offset=msg[1],updateRch=!1,setMidiRch=function(e,i){upThis.#chReceive[i-12]=e,updateRch=!0};msg.subarray(2).forEach((e,i)=>{let ri=i+offset;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,setMidiRch,()=>{upThis.#masterVol=e}][ri]||(()=>{}))(e,i)}),updateRch&&upThis.buildRchTree()}).add([22,18,32],msg=>{upThis.switchMode("mt32");let offset=msg[1],text=" ".repeat(offset);msg.subarray(2).forEach(e=>{e>31&&(text+=String.fromCharCode(e))}),upThis.#letterDisp=text.padStart(20," "),upThis.#letterExpire=Date.now()+3200}).add([22,18,82],(msg,track)=>{let partBase=upThis.chRedir(0,track,!0);for(let part=0;part<16;part++)upThis.#ua.ano(partBase+part),part&&part<10&&(upThis.#prg[partBase+part]=mt32DefProg[part-1]);console.info("MT-32 alt reset complete.")}),this.#seAi.add([66,0],(msg,track)=>{upThis.switchMode("ns5r",!0),upThis.#modeKaraoke=!1,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][msg[0]]} mode.`)}).add([66,1],(msg,track)=>{upThis.switchMode(["ns5r","05rw"][msg[0]],!0),upThis.#modeKaraoke=!1}).add([66,18,0,0],(msg,track)=>{let offset=msg[0];switch(offset){case 124:case 126:case 127:{upThis.switchMode("ns5r",!0),upThis.#modeKaraoke=!1;break}case 125:break;default:if(offset<10){let mTune=[0,0,0,0],writeTune=(e,i)=>{mTune[i]=e};if(msg.subarray(1).forEach((e,i)=>{[writeTune,writeTune,writeTune,writeTune,()=>{upThis.#masterVol=e*129/16383*100},()=>e-64,()=>e-64,()=>{},()=>{},()=>{}][offset+i]()}),msg[0]<4){let rTune=0;mTune.forEach(e=>{rTune=rTune<<4,rTune+=e}),rTune-=1024}}}}).add([66,18,0,1],(msg,track)=>{}).add([66,18,0,2],(msg,track)=>{}).add([66,18,1],(msg,track)=>{let part=upThis.chRedir(msg[0],track,!0),chOff=part*allocated.cc,offset=msg[1],dPref=`NS5R CH${part+1}`;msg.subarray(2).forEach((e,i)=>{let c=offset+i;c<3?[()=>{upThis.#cc[chOff+ccToPos2[0]]=e},()=>{upThis.#cc[chOff+ccToPos2[32]]=e},()=>{upThis.#prg[part]=e}][c]():c<8||(c<14?[()=>{let ch=upThis.chRedir(e,track,!0);upThis.#chReceive[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))},()=>{upThis.#mono[part]=+!e},()=>{console.debug(`${dPref}type: ${xgPartMode[e]}`)},()=>{upThis.#rpn[allocated.rpn*part+3]=e},()=>{},()=>{}][c-8]():c<16||(c<33?[()=>{upThis.#cc[chOff+ccToPos2[7]]=e},()=>{upThis.#cc[chOff+ccToPos2[11]]=e},()=>{},()=>{},()=>{upThis.#cc[chOff+ccToPos2[10]]=e||128},()=>{},()=>{},()=>{upThis.#cc[chOff+ccToPos2[93]]=e},()=>{upThis.#cc[chOff+ccToPos2[91]]=e},()=>{upThis.#cc[chOff+ccToPos2[76]]=e},()=>{upThis.#cc[chOff+ccToPos2[77]]=e},()=>{upThis.#cc[chOff+ccToPos2[78]]=e},()=>{upThis.#cc[chOff+ccToPos2[74]]=e},()=>{upThis.#cc[chOff+ccToPos2[71]]=e},()=>{upThis.#cc[chOff+ccToPos2[73]]=e},()=>{upThis.#cc[chOff+ccToPos2[75]]=e},()=>{upThis.#cc[chOff+ccToPos2[72]]=e}][c-16]():c<112||c<114&&[()=>{upThis.#cc[chOff+ccToPos2[5]]=e},()=>{upThis.#cc[chOff+ccToPos2[65]]=e}][c-112]()))})}).add([66,18,8,0],(msg,track)=>{}).add([66,52],(msg,track)=>{upThis.switchMode("ns5r",!0),upThis.#modeKaraoke=!1}).add([66,53],(msg,track)=>{upThis.switchMode("ns5r",!0),upThis.#modeKaraoke=!1,korgFilter(msg,function(e,i){switch(!0){case i<2944:{let part=upThis.chRedir(Math.floor(i/92),track,!0),chOff=part*allocated.cc;switch(i%92){case 0:{upThis.#cc[chOff+ccToPos2[0]]=e;break}case 1:{upThis.#cc[chOff+ccToPos2[32]]=e;break}case 2:{upThis.#prg[part]=e,e>0&&(upThis.#chActive[part]=1);break}case 3:{let ch=upThis.chRedir(e,track,!0);upThis.#chReceive[part]=ch,part!=ch&&(console.info(`NS5R CH${part+1} receives from CH${ch+1}.`),upThis.buildRchTree())}case 7:break;case 8:{upThis.#rpn[part*allocated.rpn+3]=e<40||e>88?e+(e>63?-192:64):e;break}case 9:case 10:{upThis.#cc[chOff+ccToPos2[7]]=e;break}case 11:{upThis.#cc[chOff+ccToPos2[11]]=e;break}case 14:{upThis.#cc[chOff+ccToPos2[10]]=e||128;break}case 19:{upThis.#cc[chOff+ccToPos2[93]]=e;break}case 20:{upThis.#cc[chOff+ccToPos2[91]]=e;break}case 84:{upThis.#cc[chOff+ccToPos2[65]]=e;break}case 85:{upThis.#cc[chOff+ccToPos2[5]]=e;break}}break}case i<3096:break;case i<3134:break;case i<8566:break}})}).add([66,54],(msg,track)=>{upThis.switchMode("ns5r",!0);let name2="",msb=80,prg=0,lsb=0,voiceMap="MSB	PRG	LSB	NME";korgFilter(msg,function(e,i){let p2=i%158;switch(!0){case p2<10:{e>31&&(name2+=String.fromCharCode(e));break}case p2==11:{msb=e;break}case p2==12:{lsb=e;break}case p2==13:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Voice","")}`,prg++,name2="";break}}}),upThis.userBank.clearRange({msb:80,lsb:0}),upThis.userBank.load(voiceMap)}).add([66,55],(msg,track)=>{upThis.switchMode("ns5r",!0);let name2="",msb=88,prg=0,lsb=0,voiceMap="MSB	PRG	LSB	NME";korgFilter(msg,function(e,i){let p2=i%126;switch(!0){case p2<10:{e>31&&(name2+=String.fromCharCode(e));break}case p2==11:break;case p2==12:break;case p2==13:{voiceMap+=`
${msb}	${prg}	${lsb}	${name2.trim().replace("Init Combi","")}`,prg++,name2="";break}}}),upThis.userBank.clearRange({msb:88,lsb:0}),upThis.userBank.load(voiceMap)}).add([66,125],msg=>{upThis.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][msg[0]]||"white")}).add([76],(msg,track,id)=>{upThis.#seAi.run([66,...msg],track,id)}),this.#seKg.add([16,0,8,0],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],dPref="K11 ";([()=>{upThis.switchMode("k11",!0),upThis.#modeKaraoke=!1,upThis.#subLsb=e?4:0,console.info("MIDI reset: GMega/K11")},()=>{console.debug(`${dPref}reverb type: ${e}`)},()=>{console.debug(`${dPref}reverb time: ${e}`)},()=>{console.debug(`${dPref}reverb time: ${e}`)},()=>{console.debug(`${dPref}reverb predelay: ${e}`)},()=>{console.debug(`${dPref}reverb predelay: ${e}`)},()=>{console.debug(`${dPref}depth high: ${e}`)},()=>{console.debug(`${dPref}depth high: ${e}`)},()=>{console.debug(`${dPref}depth low: ${e}`)},()=>{console.debug(`${dPref}depth low: ${e}`)}][msg[0]]||(()=>{}))()}).add([16,0,8,1],(msg,track,id)=>{let part=upThis.chRedir(msg[1],track,!0),chOff=allocated.cc*part,rpnOff=allocated.rpn*part,e=(msg[3]<<4)+msg[4],dPref=`K11 CH${part+1} `;([()=>{e<128?(upThis.#cc[chOff+ccToPos2[0]]=0,upThis.#prg[part]=e):(upThis.#cc[chOff+ccToPos2[0]]=122,upThis.#prg[part]=e-128)},()=>{let ch=upThis.chRedir(e,track,!0);upThis.#chReceive[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`${dPref}receives from CH${ch+1}`))},()=>{upThis.#cc[chOff+ccToPos2[7]]=e},()=>{upThis.#chActive[part]=e},()=>{upThis.#cc[chOff+ccToPos2[10]]=e},()=>{upThis.#rpn[rpnOff+3]=e+40},()=>{upThis.#rpn[rpnOff+1]=e>>1,upThis.#rpn[rpnOff+2]=e&1},()=>{upThis.#cc[chOff+ccToPos2[91]]=e?127:0},()=>{},()=>{upThis.#cc[chOff+ccToPos2[74]]=e},()=>{upThis.#cc[chOff+ccToPos2[73]]=e},()=>{upThis.#cc[chOff+ccToPos2[72]]=e}][msg[0]]||(()=>{}))()}).add([16,0,9,0],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],dPref="GMLX ";([()=>{console.debug(`${dPref}reverb type: ${e}`)},()=>{console.debug(`${dPref}reverb time: ${e}`)},()=>{console.debug(`${dPref}reverb predelay: ${e}`)},()=>{console.debug(`${dPref}depth high: ${e}`)},()=>{console.debug(`${dPref}depth low: ${e}`)}][msg[0]]||(()=>{}))()}).add([16,0,9,3],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],part=upThis.chRedir(msg[1],track,!0),chOff=part*allocated.cc;[()=>{e<128?(upThis.#cc[chOff+ccToPos2[0]]=0,upThis.#cc[chOff+ccToPos2[32]]=0,upThis.#prg[part]=e):e<160?(upThis.#cc[chOff+ccToPos2[0]]=0,upThis.#cc[chOff+ccToPos2[32]]=7,upThis.#prg[part]=e-100):(upThis.#cc[chOff+ccToPos2[0]]=122,upThis.#cc[chOff+ccToPos2[32]]=0,upThis.#prg[part]=e-160)},()=>{let ch=upThis.chRedir(e,track,!0);upThis.#chReceive[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`GMLX CH${part+1} receives from CH${ch+1}`))}][msg[0]]()}).add([16,0,9,4],(msg,track,id)=>{let e=(msg[2]<<4)+msg[3],part=upThis.chRedir(msg[1],track,!0),chOff=part*allocated.cc,rpnOff=part*allocated.rpn,dPref=`GMLX CH${part+1} `;[()=>{upThis.#chActive[part]=e},()=>{upThis.#cc[chOff+ccToPos2[7]]=e},()=>{upThis.#cc[chOff+ccToPos2[10]]=e},()=>{upThis.#cc[chOff+ccToPos2[91]]=e?127:0},()=>{upThis.#rpn[rpnOff+3]=e+40},()=>{upThis.#rpn[rpnOff+1]=e},()=>{upThis.#rpn[rpnOff]=e},()=>{}][msg[0]]()}),this.#seSg.add([66,93,64],(msg,track,id)=>{let e=msg[2];switch(msg[0]){case 0:{switch(msg[1]){case 4:{upThis.#masterVol=e*129/16383*100;break}case 5:{e-64;break}case 6:{console.debug(`SG global reverb: ${e?"on":"off"}`);break}case 127:{upThis.switchMode("sg",!0);break}}break}case 1:{switch(msg[1]){case 48:{console.debug(`SG reverb type: ${gsRevType[e]}`);break}}break}default:if(msg[0]>>4==1){let part=upThis.chRedir(msg[0]&15,track,!0);if(msg[1]==2){let ch=upThis.chRedir(e,track,!0);upThis.#chReceive[part]=ch,part!=ch&&(upThis.buildRchTree(),console.info(`SG CH${part+1} receives from CH${ch+1}`))}else msg[1]==19&&(upThis.#cc[allocated.cc*part+ccToPos2[7]]=e)}else console.warn(`Unknown AKAI SG SysEx: ${msg}`)}}),this.#seCs.add([9],(msg,track,id)=>{console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremelo","phaser","rotary speaker","enhancer","flanger","EQ"][msg[0]]||"off"}`)})}};var import_main_min=__toESM(require_main_min(),1);var TimedEvent=class{#ranged=!1;constructor(ranged,start,end,data2){this.#ranged=ranged,this.start=start,this.end=end,this.data=data2}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#ranged}},RangeEvent=class extends TimedEvent{constructor(start,end,data2){super(!0,start,end,data2)}},PointEvent=class extends TimedEvent{constructor(start,data2){super(!1,start,start,data2)}},TimedEvents=class extends Array{#index=-1;constructor(){super(...arguments)}resetIndex(pointer){this.#index=-1}fresh(){this.sort(function(a,b){return a.start==b.start?0:(+(a.start>b.start)<<1)-1}),this.forEach(function(e,i){e.index=i})}step(time,allowRepeat=!1){let array=[];if(allowRepeat)for(let index=0;index<this.length&&!(this[index].start>time);index++){if(this[index].end<time)continue;array.push(this[index])}else{let rawArray=this.getRange(this.#index==-1?0:time-1,time),upThis=this;rawArray.forEach(function(e){e.index>upThis.#index&&(array.push(e),upThis.#index=e.index)})}return array}getRange(start,end){start>end&&([start,end]=[end,start]);let array=[],index=-1,chunk=Math.ceil(Math.sqrt(this.length)),working=!0;for(let c=0;c<this.length;c+=chunk)this[c+chunk]?index<0&&this[c+chunk].start>=start&&(index=c):index=index<0?c:index;for(;working;)this[index]?.end<end?this[index].start>=start&&array.push(this[index]):working=!1,index++;return array}};var veryBig=0xffffffffffff,rawToPool=function(midiJson){let list=new TimedEvents,upThis=this,timeDiv=midiJson.timeDivision,tempo=120,tempoChanges=new TimedEvents,pointer=0,pointerOffset=0;tempoChanges.push(new RangeEvent(0,veryBig,[120,0])),midiJson.track.forEach(function(e0){pointer=0,e0.event.forEach(function(e1){pointer+=e1.deltaTime,e1.type==255&&e1?.metaType==81&&(tempo=6e7/e1.data,tempoChanges[tempoChanges.length-1]&&tempoChanges.push(new RangeEvent(pointer,0xffffffffffff,[tempo,0])))})}),tempoChanges.fresh(),tempoChanges.forEach(function(e,i,a){i>0&&(a[i-1].end=e.start)});let tTempo=120;tempoChanges.forEach(function(e,i,a){i>0&&(e.end==e.start?a.splice(a.indexOf(e),1):tTempo==e.data[0]&&(a[i-1].end=e.end,a.splice(a.indexOf(e),1)),tTempo=e.data[0])});let cOffset=0,cTempo=120;return tempoChanges.forEach(function(e){let cPointer=e.start,curTime=cPointer/cTempo/timeDiv*60+cOffset;cTempo=e.data[0],cOffset=curTime-cPointer/cTempo/timeDiv*60,e.data[1]=cOffset}),console.debug("All tempo changes: ",tempoChanges),tempo=120,pointer=0,pointerOffset=0,midiJson.track.forEach(function(e0,i0){pointer=0,pointerOffset=0;let movedTrk=i0+1;e0.event.forEach(function(e1,i1){pointer+=e1.deltaTime;let changeData=tempoChanges.step(pointer,!0)[0];changeData&&(tempo=changeData.data[0],pointerOffset=changeData.data[1]);let appendObj={type:e1.type,data:e1.data,track:movedTrk,part:0};e1.type>14?appendObj.meta=e1.metaType:appendObj.part=e1.channel,list.push(new PointEvent(pointer/tempo/timeDiv*60+pointerOffset,appendObj))})}),list.fresh(),self.midiEvents=list,console.debug(`Parsed a type ${midiJson.formatType} MIDI sequence.`),list};import_main_min.default.customInterpreter=customInterpreter;var RootDisplay=class extends CustomEventSource{#midiState=new OctaviaDevice;#midiPool;#titleName="";#metaRun=[];#mimicStrength=new Uint8ClampedArray(64);#noteBInt=.5;#noteTempo=120;#noteNomin=4;#noteDenom=4;#noteBarOffset=0;#noteTime=0;smoothingAtk=0;smoothingDcy=0;reset(){this.dispatchEvent("reset"),this.#midiPool?.resetIndex(),this.#midiState.init(),this.#titleName="",this.#noteBInt=.5,this.#noteTempo=120,this.#noteNomin=4,this.#noteDenom=4,this.#noteBarOffset=0,this.#noteTime=0}async loadFile(blob2){this.#midiPool=rawToPool(import_main_min.default.parse(new Uint8Array(await blob2.arrayBuffer())))}switchMode(modeName,forced=!1){this.#midiState.switchMode(modeName,forced)}getMode(){return this.#midiState.getMode()}getVoice(){return this.#midiState.getVoice(...arguments)}getChVoice(ch){return this.#midiState.getChVoice(ch)}get noteProgress(){return this.#noteTime/this.#noteBInt}get noteOverall(){return this.noteProgress-this.#noteBarOffset}get noteBar(){return Math.floor(this.noteOverall/this.#noteNomin)}get noteBeat(){let beat=this.noteOverall%this.#noteNomin;return beat<0&&(beat+=this.#noteNomin),beat}getTimeSig(){return[this.#noteNomin,this.#noteDenom]}getTempo(){return this.#noteTempo}sendCmd(raw){this.#midiState.runJson(raw)}render(time){time>this.#noteTime&&(this.#noteTime=time);let events=this.#midiPool?.step(time)||[],extraPoly=0,notes=new Set,upThis=this,metaReplies=[];upThis.#midiState.newStrength(),events.forEach(function(e){let raw=e.data;raw.type==9&&(raw.data[1]>0?notes.add(raw.part*128+raw.data[0]):notes.has(raw.part*128+raw.data[0])&&extraPoly++),e.data.type==8&&notes.has(raw.part*128+raw.data[0])&&extraPoly++;let reply=upThis.#midiState.runJson(raw);switch(reply?.reply){case"meta":{metaReplies.push(reply);break}}reply?.reply&&delete reply.reply});let writeStrength=this.#midiState.getStrength();writeStrength.forEach(function(e,i){let diff=e-upThis.#mimicStrength[i];diff>=0?upThis.#mimicStrength[i]+=Math.ceil(diff-diff*upThis.smoothingAtk):upThis.#mimicStrength[i]+=Math.ceil(diff-diff*upThis.smoothingDcy)}),metaReplies?.length>0&&this.dispatchEvent("meta",metaReplies);let chInUse=this.#midiState.getActive(),chKeyPr=[],chPitch=upThis.#midiState.getPitch(),chContr=upThis.#midiState.getCcAll(),chProgr=upThis.#midiState.getProgram(),curPoly=0;return chInUse.forEach(function(e,i){e&&(chKeyPr[i]=upThis.#midiState.getVel(i),curPoly+=chKeyPr[i].size)}),{extraPoly,curPoly,chInUse,chKeyPr,chPitch,chProgr,chContr,eventCount:events.length,title:this.#titleName,bitmap:this.#midiState.getBitmap(),letter:this.#midiState.getLetter(),texts:this.#midiState.getTexts(),master:this.#midiState.getMaster(),mode:this.#midiState.getMode(),strength:this.#mimicStrength.slice(),velo:writeStrength,rpn:this.#midiState.getRpn(),tSig:this.getTimeSig(),tempo:this.getTempo(),noteBar:this.noteBar,noteBeat:this.noteBeat}}constructor(atk=.5,dcy=.5){super();let upThis=this;this.smoothingAtk=atk,this.smoothingDcy=dcy,this.addEventListener("meta",function(raw){raw?.data?.forEach(function(e){(upThis.#metaRun[e.meta]||console.debug).call(upThis,e.meta,e.data)})}),this.#midiState.addEventListener("mode",function(ev){upThis.dispatchEvent("mode",ev.data)}),this.#midiState.addEventListener("channelactive",function(ev){upThis.dispatchEvent("channelactive",ev.data)}),this.#midiState.addEventListener("channelmin",function(ev){upThis.dispatchEvent("channelmin",ev.data)}),this.#midiState.addEventListener("channelmax",function(ev){upThis.dispatchEvent("channelmax",ev.data)}),this.#midiState.addEventListener("channelreset",function(ev){upThis.dispatchEvent("channelreset")}),this.#metaRun[3]=function(type,data2){upThis.#titleName?.length<1&&(upThis.#titleName=data2)},this.#metaRun[81]=function(type,data2){let noteProgress=upThis.noteProgress,lastBInt=upThis.#noteBInt||.5;upThis.#noteTempo=6e7/data2,upThis.#noteBInt=data2/1e6,upThis.#noteBarOffset+=noteProgress*(lastBInt/upThis.#noteBInt)-noteProgress},this.#metaRun[88]=function(type,data2){let noteProgress=upThis.noteProgress,noteOverall=upThis.noteOverall,curBar=upThis.noteBar,curBeat=upThis.noteBeat,oldNomin=upThis.#noteNomin,oldDenom=upThis.#noteDenom;upThis.#noteNomin=data2[0],upThis.#noteDenom=1<<data2[1];let metroClick=24*(32/data2[3])/data2[2];if(oldNomin!=upThis.#noteNomin){let targetBar=curBar;upThis.#noteBarOffset-=targetBar*(upThis.#noteNomin-oldNomin),curBeat+1>=oldNomin&&(oldNomin<upThis.#noteNomin?upThis.#noteBarOffset-=Math.ceil(upThis.#noteNomin-curBeat-1):upThis.#noteBarOffset+=upThis.#noteNomin)}}}};var blankFont=new Uint8Array(40),shiftIndex=0,shiftLoading,shiftLoader=setInterval(()=>{shiftLoading&&(blankFont[shiftIndex]=!blankFont[shiftIndex],shiftIndex++,shiftIndex>34&&(shiftIndex=0))},1e3/50);Uint8Array.prototype.render=function(receiveFunc){let x2=0,y2=0,w2=this.width||5,h2=this.height||8;for(let i=0;i<this.length;i++)receiveFunc(this[i],x2,y2,this),x2++,x2>=w2&&(x2=0,y2++)};var noteNames=["C~","C#","D~","Eb","E~","F~","F#","G~","Ab","A~","Bb","B~"],noteRegion="!0123456789";var map="0123456789_aAbBcCdDeEfFgGhHiIjJ-kKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ",waveMap=["-","~","+","|"],modeNames={"?":"UnkwnStd",gm:"GnrlMIDI",g2:"GrlMIDI2",xg:"YamahaXG",gs:"RolandGS",mt32:"RlndMT32",ag10:"KorgAG10",x5d:"Korg X5D","05rw":"Korg05RW",ns5r:"KorgNS5R",krs:"KorgKros",k11:"KawaiK11",sg:"AkaiPrSG"};var TuiDisplay=class extends RootDisplay{#maxPoly=0;constructor(){super(),this.addEventListener("reset",()=>{this.#maxPoly=0})}render(time,ctx){let fields=new Array(24),sum=super.render(time),upThis=this,timeNow=Date.now(),cramTempo=Math.round(sum.tempo*100)/100,curPoly=sum.curPoly+sum.extraPoly;this.#maxPoly<curPoly&&(this.#maxPoly=curPoly),fields[0]=`${sum.eventCount.toString().padStart(3,"0")} ${curPoly.toString().padStart(3,"0")}:${this.#maxPoly.toString().padStart(3,"0")}/512 TSig:${sum.tSig[0]}/${sum.tSig[1]} Bar:${(sum.noteBar+1).toString().padStart(3,"0")}/${Math.floor(sum.noteBeat)+1} Tempo:${Math.floor(cramTempo)}.${Math.floor(cramTempo%1*100).toString().padStart(2,"0")} Vol:${Math.floor(sum.master.volume)}.${Math.round(sum.master.volume%1*100).toString().padStart(2,"0")}%`,fields[1]=`Mode:${modeNames[sum.mode]} Title:${sum.title||"N/A"}`,fields[2]="Ch:VoiceNme#St VEM RCDB PP PiBd Pan : Note";let line=3,maxCh=0;if(sum.chInUse.forEach(function(e,i){if(e){maxCh=i;let chOffset=i*ccToPos2.length;if(line<fields.length-5&&i>=(self.minCh||0)){let voiceName=upThis.getChVoice(i);fields[line]=`${(i+1).toString().padStart(2,"0")}:${voiceName.name.slice(0,8).padEnd(8," ")}${voiceName.ending}${voiceName.standard} ${map[sum.chContr[chOffset+ccToPos2[7]]>>1]}${map[sum.chContr[chOffset+ccToPos2[11]]>>1]}${waveMap[sum.chContr[chOffset+ccToPos2[1]]>>5]} ${map[sum.chContr[chOffset+ccToPos2[91]]>>1]}${map[sum.chContr[chOffset+ccToPos2[93]]>>1]}${map[sum.chContr[chOffset+ccToPos2[94]]>>1]}${map[sum.chContr[chOffset+ccToPos2[74]]>>1]} ${sum.chContr[chOffset+ccToPos2[65]]>63?"O":"X"}${map[sum.chContr[chOffset+ccToPos2[5]]>>1]} ${textedPitchBend(sum.chPitch[i])} ${textedPanning(sum.chContr[chOffset+ccToPos2[10]])}:`,sum.chKeyPr[i].forEach(function(e1,i1){e1>0&&(fields[line]+=` <span style="opacity:${Math.round(e1/1.27)/100}">${noteNames[i1%12]}${noteRegion[Math.floor(i1/12)]}</span>`)}),line++}}}),sum.texts.length>0){let metaLine=0,st=fields.length-1;for(;st>=line;)sum.texts[metaLine]?.length&&(fields[st]=(sum.texts[metaLine]||"").padEnd(100," ")),(sum.texts[metaLine]?.length>0||sum.texts[metaLine]?.length==null)&&st--,metaLine++}if(timeNow<=sum.letter.expire){let letterDisp=sum.letter.text.padEnd(32," "),startLn=fields.length-2;for(let st=0;st<2;st++)fields[st+startLn]=`${(fields[st+startLn]||"").slice(0,82).padEnd(81," ")} <span class="letter"> ${letterDisp.slice(st*16,st*16+16).padEnd(" ",16)} </span>`}if(ctx){ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.fillStyle="#202020";let renderer;timeNow<=sum.bitmap.expire?renderer=sum.bitmap.bitmap:(renderer=new Array(256),maxCh<16?sum.strength.forEach(function(e,i){if(i<16){let strength=e>>4;for(let dot=0;dot<=strength;dot++)renderer[i+(15-dot)*16]=1}}):sum.strength.forEach(function(e,i){if(i<32){let strength=e>>5;for(let dot=0;dot<=strength;dot++)renderer[i+((i>15?6:15)-dot)*16]=1}})),renderer.forEach(function(e,i){e&&ctx.fillRect((i&15)*12,(i>>4)*6,11,5)})}return fields.join("<br/>")}};var startA=Math.PI*255/180,endA=Math.PI*285/180;CanvasRenderingContext2D.prototype.radial=function(centreX,centreY,angle,startR,stopR){let adjAngle=angle-1.5707963267948966,vSin=Math.sin(adjAngle),vCos=Math.cos(adjAngle);this.beginPath(),this.moveTo(centreX+vSin*startR,centreY+vCos*startR),this.lineTo(centreX+vSin*stopR,centreY+vCos*stopR),this.stroke()};var cmpWidth=7;var pdsX=cmpWidth*(17+2),pdsY=cmpWidth*(7+3)+1;var T=Object.defineProperty,f=(e,t)=>()=>(e&&(t=e(e=0)),t),d=(e,t)=>{for(var i in t)T(e,i,{get:t[i],enumerable:!0})},y={};d(y,{default:()=>E});var E,p=f(()=>{E=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,i)=>{let r=document.createElement("input");r.type="file";let l=[...e.map(s=>s.mimeTypes||[]).join(),e.map(s=>s.extensions||[]).join()].join();r.multiple=e[0].multiple||!1,r.accept=l||"";let n=()=>c(i),a=s=>{typeof c=="function"&&c(),t(s)},c=e[0].legacySetup&&e[0].legacySetup(a,n,r);r.addEventListener("change",()=>{a(r.multiple?Array.from(r.files):r.files[0])}),r.click()}))}),w={};d(w,{default:()=>I});var N,I,h=f(()=>{N=async e=>{let t=await e.getFile();return t.handle=e,t},I=async(e=[{}])=>{Array.isArray(e)||(e=[e]);let t=[];e.forEach((l,n)=>{t[n]={description:l.description||"",accept:{}},l.mimeTypes?l.mimeTypes.map(a=>{t[n].accept[a]=l.extensions||[]}):t[n].accept["*/*"]=l.extensions||[]});let i=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(i.map(N));return e[0].multiple?r:r[0]}}),o={};d(o,{default:()=>M});var M,A=f(()=>{M=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,i)=>{let r=document.createElement("input");r.type="file",r.webkitdirectory=!0;let l=()=>a(i),n=c=>{typeof a=="function"&&a(),t(c)},a=e[0].legacySetup&&e[0].legacySetup(n,l,r);r.addEventListener("change",()=>{let c=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(c=c.filter(s=>s.webkitRelativePath.split("/").every(S=>!e[0].skipDirectory({name:S,kind:"directory"})))):c=c.filter(s=>s.webkitRelativePath.split("/").length===2),n(c)}),r.click()}))}),x={};d(x,{default:()=>B});var v,B,g=f(()=>{v=async(e,t,i=e.name,r)=>{let l=[],n=[];for await(let a of e.values()){let c=`${i}/${a.name}`;a.kind==="file"?n.push(a.getFile().then(s=>(s.directoryHandle=e,s.handle=a,Object.defineProperty(s,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>c})))):a.kind==="directory"&&t&&(!r||!r(a))&&l.push(v(a,t,c,r))}return[...(await Promise.all(l)).flat(),...await Promise.all(n)]},B=async(e={})=>{e.recursive=e.recursive||!1;let t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn});return v(t,e.recursive,void 0,e.skipDirectory)}}),k={};d(k,{default:()=>W});async function $(e,t){let i=e.getReader(),r=new ReadableStream({start(n){return a();async function a(){return i.read().then(({done:c,value:s})=>{if(c){n.close();return}return n.enqueue(s),a()})}}}),l=new Response(r);return i.releaseLock(),new Blob([await l.blob()],{type:t})}var W,P=f(()=>{W=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);let i=document.createElement("a"),r=e;"body"in e&&(r=await $(e.body,e.headers.get("content-type"))),i.download=t.fileName||"Untitled",i.href=URL.createObjectURL(r);let l=()=>a(reject),n=()=>{typeof a=="function"&&a()},a=t.legacySetup&&t.legacySetup(n,l,i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),30*1e3),n(null)}),i.click(),null}}),j={};d(j,{default:()=>q});var q,L=f(()=>{q=async(e,t=[{}],i=null,r=!1)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";let l=[];if(t.forEach((c,s)=>{l[s]={description:c.description||"",accept:{}},c.mimeTypes?(s===0&&(e.type?c.mimeTypes.push(e.type):e.headers&&e.headers.get("content-type")&&c.mimeTypes.push(e.headers.get("content-type"))),c.mimeTypes.map(m=>{l[s].accept[m]=c.extensions||[]})):e.type&&(l[s].accept[e.type]=c.extensions||[])}),i)try{await i.getFile()}catch(c){if(i=null,r)throw c}let n=i||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:l,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1}),a=await n.createWritable();return"stream"in e?(await e.stream().pipeTo(a),n):"body"in e?(await e.body.pipeTo(a),n):(await a.write(blob),await a.close(),n)}}),F=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.location+""}catch{return!1}else if("showOpenFilePicker"in self)return"showOpenFilePicker";return!1})(),u=F,U=u?Promise.resolve().then(()=>(h(),w)):Promise.resolve().then(()=>(p(),y));async function _(...e){return(await U).default(...e)}var D=u?Promise.resolve().then(()=>(g(),x)):Promise.resolve().then(()=>(A(),o));var z=u?Promise.resolve().then(()=>(L(),j)):Promise.resolve().then(()=>(P(),k));var import_main_min2=__toESM(require_main_min(),1);import_main_min2.default.customInterpreter=customInterpreter;var getBridge=function(){return new BroadcastChannel("cc.ltgc.octavia:MainInput")};var demoBlobs={},demoModes=[];demoModes[9]="gm";var useMidiBus=!1;self.minCh=0;var stSwitch=$a("b.mode"),stSwitchMode=[];stSwitch.to=function(i){stSwitch.forEach(function(e){e.classList.off("active")}),i>-1&&stSwitch[i].classList.on("active")};stSwitch.forEach(function(e,i,a){stSwitchMode[i]=e.title,e.addEventListener("click",function(){tuiVis.switchMode(e.title,!0),stSwitch.to(i)})});var stDemo=$a("b.demo");stDemo.to=function(i){stDemo.forEach(function(e){e.classList.off("active")}),i>-1&&stDemo[i].classList.on("active")};stDemo.forEach(function(e,i,a){e.addEventListener("click",async function(){useMidiBus=!1,midwIndicator.classList.off("active"),audioPlayer.pause(),demoBlobs[e.title]?.midi||(demoBlobs[e.title]={},textDisplay.innerHTML=`Loading demo ${e.innerText.toUpperCase()}.${"<br/>".repeat(23)}`,demoBlobs[e.title].midi=await(await fetch(`./demo/${e.title}.mid`)).blob(),demoBlobs[e.title].wave=await(await fetch(`./demo/${e.title}.opus`)).blob()),textDisplay.innerHTML=`Demo ${e.innerText.toUpperCase()} ready.${"<br/>".repeat(23)}`,audioPlayer.currentTime=0,tuiVis.reset(),tuiVis.loadFile(demoBlobs[e.title].midi),audioBlob&&URL.revokeObjectURL(audioBlob),audioBlob=demoBlobs[e.title].wave,audioPlayer.src=URL.createObjectURL(audioBlob),demoModes[i]?.length>0&&tuiVis.switchMode(demoModes[i]),stDemo.to(i)})});self.tuiVis=new TuiDisplay;tuiVis.addEventListener("reset",function(e){minCh=0});tuiVis.addEventListener("mode",function(ev){stSwitch.to(stSwitchMode.indexOf(ev.data))});var midwIndicator=$e("#openMidw"),audioBlob,propsMid=JSON.parse('{"extensions":[".mid",".MID",".kar",".KAR",".syx",".SYX"],"startIn":"music","id":"midiOpener","description":"Open a MIDI file"}'),propsAud=JSON.parse('{"mimeTypes":["audio/*"],"startIn":"music","id":"audioOpener","description":"Open an audio file"}');$e("#openMidi").addEventListener("click",async function(){useMidiBus=!1,midwIndicator.classList.off("active");let file=await _(propsMid),fileSplit=file.name.lastIndexOf("."),ext="";fileSplit>-1&&(ext=file.name.slice(fileSplit+1).toLowerCase()),ext=="syx"?tuiVis.sendCmd({type:15,track:0,data:new Uint8Array(await file.arrayBuffer())}):(stDemo.to(-1),tuiVis.reset(),tuiVis.loadFile(file))});$e("#openAudio").addEventListener("click",async function(){useMidiBus=!1,midwIndicator.classList.off("active"),audioBlob&&URL.revokeObjectURL(audioBlob),audioBlob=await _(propsAud),audioPlayer.src=URL.createObjectURL(audioBlob)});midwIndicator.addEventListener("click",function(){stDemo.to(-1),audioBlob&&URL.revokeObjectURL(audioBlob),audioBlob=null,audioPlayer.src="",tuiVis.reset(),useMidiBus=!0,midwIndicator.classList.on("active")});var dispCanvas=$e("#bmDisp"),dispCtx=dispCanvas.getContext("2d");dispCanvas.addEventListener("wheel",function(ev){ev.deltaY>0?minCh<48&&minCh++:minCh>0&&minCh--});dispCanvas.addEventListener("mouseup",function(ev){ev.layerY>47?minCh<48&&(minCh=1+(minCh>>4)<<4):ev.layerY<47&&minCh>0&&(minCh<16&&(minCh=16),minCh=(minCh>>4)-1<<4)});var audioPlayer=$e("#audioPlayer"),textDisplay=$e("#display");dispCanvas.style.left=`${textDisplay.offsetLeft+textDisplay.offsetWidth-dispCanvas.offsetWidth}px`;dispCanvas.style.top=`${textDisplay.offsetTop}px`;audioPlayer.onended=function(){tuiVis.reset()};(async function(){tuiVis.reset();let midiBlob=await(await fetch("./demo/KANDI8.mid")).blob();demoBlobs.KANDI8={},demoBlobs.KANDI8.midi=midiBlob,tuiVis.loadFile(midiBlob),audioBlob&&URL.revokeObjectURL(audioBlob),audioBlob=await(await fetch("./demo/KANDI8.opus")).blob(),demoBlobs.KANDI8.wave=audioBlob,audioPlayer.src=URL.createObjectURL(audioBlob),textDisplay.innerHTML=`${"<br/>".repeat(23)}`})();var renderThread=setInterval(function(){(!audioPlayer.paused||useMidiBus)&&(textDisplay.innerHTML=tuiVis.render(audioPlayer.currentTime-(self.audioDelay||0),dispCtx))},20);getBridge().addEventListener("message",function(ev){useMidiBus&&tuiVis.sendCmd(ev.data)});addEventListener("resize",function(){dispCanvas.style.left=`${textDisplay.offsetLeft+textDisplay.offsetWidth-dispCanvas.offsetWidth}px`,dispCanvas.style.top=`${textDisplay.offsetTop}px`});})();
//# sourceMappingURL=demoTui.js.map
